<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ä¸€çº¿æ”»åŸç‹®</title>
  
  <subtitle>åå¹´ç£¨ä¸€å‰‘ï¼Œä¸€æ­¥ä¸€æ­¥è„šè¸å®åœ°çš„è€•ç§</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://researchlab.github.io/"/>
  <updated>2019-08-24T14:25:55.674Z</updated>
  <id>http://researchlab.github.io/</id>
  
  <author>
    <name>Lee Hong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>minikubeä»æœ¬åœ°docker registry æ‹‰å–é•œåƒçš„ä¸¤ç§æ–¹æ³•</title>
    <link href="http://researchlab.github.io/2019/08/24/minikube-pull-image-from-docker-registry/"/>
    <id>http://researchlab.github.io/2019/08/24/minikube-pull-image-from-docker-registry/</id>
    <published>2019-08-24T19:47:33.000Z</published>
    <updated>2019-08-24T14:25:55.674Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨macä¸­ç”¨minikubeæ­å»ºäº†ä¸€ä¸ªk8sç¯å¢ƒï¼Œä½†æ˜¯æ¯æ¬¡æ‹‰å–é•œåƒéƒ½å¾ˆæ…¢ç”šè‡³å¤±è´¥, æœ¬æ–‡æ€»ç»“ä¸¤ç§ä»æœ¬åœ°ç§æœ‰é•œåƒä»“åº“æ‹‰å–é•œåƒçš„æ–¹æ³•å®è·µ, å…ˆå°†é•œåƒåœ¨å®¿ä¸»æœºä¸Šç¿»å¢™æ‹‰å–åˆ°æœ¬åœ°, å†ç”±minikube è™šæœºä¸­çš„k8s æ¥æ‹‰å–æœ¬åœ°é•œåƒ, è¿™æ ·å³å¯è§£å†³ä¹‹å‰çš„æ‹‰å–é•œåƒå¤±è´¥ï¼Œä¹Ÿå¯æå‡æ‹‰å–é•œåƒçš„é€Ÿåº¦;<br><a id="more"></a></p><h2 id="ä¸¤ç§æ–¹æ¡ˆ"><a href="#ä¸¤ç§æ–¹æ¡ˆ" class="headerlink" title="ä¸¤ç§æ–¹æ¡ˆ"></a>ä¸¤ç§æ–¹æ¡ˆ</h2><ol><li>æŠŠç§æœ‰é•œåƒä»“åº“docker registry æ­å»ºåœ¨å®¿ä¸»æœºä¸Š, k8sä»æœ¬åœ°å®¿ä¸»æœºä¸Šæ‹‰å–é•œåƒ;</li><li>æŠŠæœ¬åœ°é•œåƒæ¨é€åˆ°minikubeçš„ç§æœ‰é•œåƒä»“åº“ä¸Š, k8sä»minikubeçš„ç§æœ‰é•œåƒä»“åº“(k8sçš„æœ¬åœ°ç§æœ‰é•œåƒä»“åº“)æ‹‰å–é•œåƒ;</li></ol><h2 id="æ–¹æ¡ˆä¸€-k8sä»å®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒ"><a href="#æ–¹æ¡ˆä¸€-k8sä»å®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒ" class="headerlink" title="æ–¹æ¡ˆä¸€: k8sä»å®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒ"></a>æ–¹æ¡ˆä¸€: k8sä»å®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒ</h2><ol><li>æ­å»ºå®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“; </li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash </span></span><br><span class="line"></span><br><span class="line">docker pull registry</span><br><span class="line"></span><br><span class="line">docker run -d -p 5000:5000 -v $(pwd):/var/lib/registry --restart always --name registry registry:2</span><br></pre></td></tr></table></figure><ol start="2"><li>éªŒè¯ç§æœ‰é•œåƒä»“åº“</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:5000/v2/_catalog</span><br><span class="line">&#123;"repositories":[]&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>æ¨é€é•œåƒåˆ°ç§æœ‰é•œåƒä»“åº“</li></ol><p>å¯¹docker ä½œå‡ºå¦‚ä¸‹é…ç½®ï¼Œå¹¶é‡å¯ä½¿å…¶ç”Ÿæ•ˆ,</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "insecure-registries" : [</span><br><span class="line">    "10.21.71.237:5000"</span><br><span class="line">  ],</span><br><span class="line">  "debug" : true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>10.21.71.237 æ˜¯å®¿ä¸»æœºip </p></blockquote><blockquote><p>mac é…ç½®è·¯å¾„:  å·¥å…·æ â€“&gt; docker â€“&gt; Preferences â€“&gt; Daemon â€“&gt; basic â€“&gt; Insecure registries åŠ ä¸Šä¸€è¡Œ:  10.21.71.237:5000</p></blockquote><p>ä¸ºé•œåƒæ‰“tag, å¹¶æ¨é€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  docker tag luksa/kubia 10.21.71.237:5000/kubia-local</span><br><span class="line">âœ  docker push 10.21.71.237:5000/kubia-local</span><br><span class="line">The push refers to repository [10.21.71.237:5000/kubia-local]</span><br><span class="line">5ef1e33458c5: Pushed</span><br><span class="line">dff19e36a9d2: Pushed</span><br><span class="line">28e6af096bca: Pushed</span><br><span class="line">d84d07ed960c: Pushed</span><br><span class="line">894dceed4a75: Pushed</span><br><span class="line">f078de0e3e2b: Pushed</span><br><span class="line">e6562eb04a92: Pushed</span><br><span class="line">596280599f68: Pushed</span><br><span class="line">5d6cbe0dbcf9: Pushed</span><br><span class="line">latest: digest: sha256:0d41ead4dbf022881deafdea4cc3c5a46e0315ebd5805b40f8bbcb7d8b745575 size: 2213</span><br></pre></td></tr></table></figure><p>4 é…ç½®minikube å¹¶é‡å¯</p><p>minikube é…ç½®å¦‚ä¸‹, å¹¶é‡å¯(é‡å¯æ—¶ç¡®ä¿ç¿»å¢™VPNå¼€å¯)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">minikube delete &amp;&amp; minikube start --cpus=2 --memory=4096 --disk-size=10g \</span><br><span class="line">--docker-env http_proxy=10.21.71.237:1087 \</span><br><span class="line">--docker-env https_proxy=10.21.71.237:1087 \</span><br><span class="line">--docker-env no_proxy=192.168.99.0/24 \</span><br><span class="line">--registry-mirror=https://registry.docker-cn.com \</span><br><span class="line">  --insecure-registry=10.21.71.237:5000</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºäº†ä½¿å¾—minikube è™šæœºä¸­çš„k8s èƒ½æ‹‰å–åˆ°å®¿ä¸»æœºç§æœ‰é•œåƒ éœ€è¦ä¸Šè¿°ä¸¤é¡¹é…ç½®  â€“registry-mirror å’Œ â€“insecure-registry</p></blockquote><p>5 k8s æ‹‰å–å®¿ä¸»æœºç§æœ‰é•œåƒä»“åº“é•œåƒ</p><p>k8s pod æ–‡ä»¶å¦‚ä¸‹,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  k8s cat kubia-local.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: kubia-local-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - image: 10.21.71.237:5000/kubia-local</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      name: kubia-local-mike</span><br><span class="line">      ports:</span><br><span class="line">      - containerPort: 8080</span><br><span class="line">        protocol: TCP</span><br></pre></td></tr></table></figure></p><p>åˆ›å»º kubia-local pod ,</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">âœ  k8s kubectl create -f kubia-local.yaml</span><br><span class="line">âœ  k8s kubectl describe pod kubia-local-pod</span><br><span class="line">Name:               kubia-local-pod</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               minikube/10.0.2.15</span><br><span class="line">Start Time:         Sat, 24 Aug 2019 19:38:29 +0800</span><br><span class="line">Labels:             &lt;none&gt;</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 172.17.0.7</span><br><span class="line">Containers:</span><br><span class="line">  kubia-local-mike:</span><br><span class="line">    Container ID:   docker://fc4df4e9328fb4896672cd4c2504d1a950294ced574200d607e778a72ba8100a</span><br><span class="line">    Image:          10.21.71.237:5000/kubia-local</span><br><span class="line">    Image ID:       docker-pullable://10.21.71.237:5000/kubia-local@sha256:0d41ead4dbf022881deafdea4cc3c5a46e0315ebd5805b40f8bbcb7d8b745575</span><br><span class="line">    Port:           8080/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Sat, 24 Aug 2019 19:41:14 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-qkm5t (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-qkm5t:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-qkm5t</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age    From               Message</span><br><span class="line">  ----    ------     ----   ----               -------</span><br><span class="line">  Normal  Scheduled  6m44s  default-scheduler  Successfully assigned default/kubia-local-pod to minikube</span><br><span class="line">  Normal  Pulling    6m43s  kubelet, minikube  Pulling image "10.21.71.237:5000/kubia-local"</span><br><span class="line">  Normal  Pulled     4m     kubelet, minikube  Successfully pulled image "10.21.71.237:5000/kubia-local"</span><br><span class="line">  Normal  Created    4m     kubelet, minikube  Created container kubia-local-mike</span><br><span class="line">  Normal  Started    3m59s  kubelet, minikube  Started container kubia-local-mike</span><br><span class="line">âœ  k8s kubectl get po</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubia-local-pod   1/1     Running   0          7m22s</span><br></pre></td></tr></table></figure><p>é€šè¿‡ k8s port-forward ç«¯å£è½¬å‘æœºåˆ¶ å¯æ–¹ä¾¿ä¸´æ—¶å¯¹podä¸­çš„æœåŠ¡è¿›è¡Œè®¿é—®</p><p>ç«¯å£è½¬å‘<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  k8s kubectl port-forward kubia-local-pod 8888:8080</span><br><span class="line">Forwarding from 127.0.0.1:8888 -&gt; 8080</span><br></pre></td></tr></table></figure></p><p>æœ¬åœ°è®¿é—®k8s podä¸­çš„æœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ curl localhost:8888</span><br><span class="line">You've hit kubia-local-pod</span><br></pre></td></tr></table></figure><h2 id="æ–¹æ¡ˆäºŒ-k8sä»minikube-è™šæœºæœ¬åœ°ç§æœ‰é•œåƒä»“åº“ç›´æ¥æ‹‰å–é•œåƒ"><a href="#æ–¹æ¡ˆäºŒ-k8sä»minikube-è™šæœºæœ¬åœ°ç§æœ‰é•œåƒä»“åº“ç›´æ¥æ‹‰å–é•œåƒ" class="headerlink" title="æ–¹æ¡ˆäºŒ k8sä»minikube è™šæœºæœ¬åœ°ç§æœ‰é•œåƒä»“åº“ç›´æ¥æ‹‰å–é•œåƒ"></a>æ–¹æ¡ˆäºŒ k8sä»minikube è™šæœºæœ¬åœ°ç§æœ‰é•œåƒä»“åº“ç›´æ¥æ‹‰å–é•œåƒ</h2><p><a href="https://minikube.sigs.k8s.io/docs/tasks/docker_registry/" target="_blank" rel="noopener">https://minikube.sigs.k8s.io/docs/tasks/docker_registry/</a></p><p><a href="https://blog.hasura.io/sharing-a-local-registry-for-minikube-37c7240d0615/" target="_blank" rel="noopener">https://blog.hasura.io/sharing-a-local-registry-for-minikube-37c7240d0615/</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>æœ¬æ–‡æ€»ç»“äº†ä¸¤ç§ä»æœ¬åœ°æ‹‰å–é•œåƒçš„æ–¹æ¡ˆ;</li><li>æ¨èä½¿ç”¨æ–¹æ¡ˆä¸€, æ›´æ–¹ä¾¿;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨macä¸­ç”¨minikubeæ­å»ºäº†ä¸€ä¸ªk8sç¯å¢ƒï¼Œä½†æ˜¯æ¯æ¬¡æ‹‰å–é•œåƒéƒ½å¾ˆæ…¢ç”šè‡³å¤±è´¥, æœ¬æ–‡æ€»ç»“ä¸¤ç§ä»æœ¬åœ°ç§æœ‰é•œåƒä»“åº“æ‹‰å–é•œåƒçš„æ–¹æ³•å®è·µ, å…ˆå°†é•œåƒåœ¨å®¿ä¸»æœºä¸Šç¿»å¢™æ‹‰å–åˆ°æœ¬åœ°, å†ç”±minikube è™šæœºä¸­çš„k8s æ¥æ‹‰å–æœ¬åœ°é•œåƒ, è¿™æ ·å³å¯è§£å†³ä¹‹å‰çš„æ‹‰å–é•œåƒå¤±è´¥ï¼Œä¹Ÿå¯æå‡æ‹‰å–é•œåƒçš„é€Ÿåº¦;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="k8s" scheme="http://researchlab.github.io/categories/k8s/"/>
    
    
      <category term="minikube" scheme="http://researchlab.github.io/tags/minikube/"/>
    
  </entry>
  
  <entry>
    <title>mac åˆ©ç”¨minikubeæ­å»ºk8sç¯å¢ƒ</title>
    <link href="http://researchlab.github.io/2019/08/13/mac-install-minikube/"/>
    <id>http://researchlab.github.io/2019/08/13/mac-install-minikube/</id>
    <published>2019-08-13T21:22:03.000Z</published>
    <updated>2019-08-24T14:25:55.670Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨macä¸Šåˆ©ç”¨minikube æ­å»ºk8sç¯å¢ƒæˆ–å¤šæˆ–å°‘ä¼šå› ä¸ºpullé•œåƒå¤±è´¥è€Œæ­å»ºä¸æˆåŠŸ, æœ¬æ–‡ä»‹ç»ä¸¤ç§åœ¨macä¸Šåˆ©ç”¨minikube æ­å»ºk8sç¯å¢ƒçš„æ–¹æ³•; ä¸€ç§æ˜¯é€šè¿‡VPNç¿»å¢™åˆ©ç”¨å®˜æ–¹minikube æ­å»ºk8s ç¯å¢ƒï¼Œ å¦å¤–ä¸€ç§æ˜¯å€ŸåŠ©é˜¿é‡Œäº‘çš„minikubeç‰ˆæœ¬æ¥æ­å»ºk8sç¯å¢ƒ;<br><a id="more"></a></p><h2 id="åˆ©ç”¨å®˜æ–¹minikubeæ­å»ºk8sç¯å¢ƒ"><a href="#åˆ©ç”¨å®˜æ–¹minikubeæ­å»ºk8sç¯å¢ƒ" class="headerlink" title="åˆ©ç”¨å®˜æ–¹minikubeæ­å»ºk8sç¯å¢ƒ"></a>åˆ©ç”¨å®˜æ–¹minikubeæ­å»ºk8sç¯å¢ƒ</h2><p>1 å®‰è£…minikube </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew cask install minikube virtualbox</span><br></pre></td></tr></table></figure><p>2 è®¾ç½®VPN</p><p><img src="/2019/08/13/mac-install-minikube/vpn.png" alt=""></p><p>3 ç¼–å†™æ‰§è¡Œè„šæœ¬ run.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">minikube delete &amp;&amp; minikube start --cpus=2 --memory=4096 --disk-size=10g \</span><br><span class="line">--docker-env http_proxy=æœ¬æœºIP:1087 \</span><br><span class="line">--docker-env https_proxy=æœ¬æœºIP:1087 \</span><br><span class="line">--docker-env no_proxy=192.168.99.0/24</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>æœ¬æœºIP</code> å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å¾—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ifconfig |grep inet |grep -v 127.0.0.1</span></span><br><span class="line">inet6 fe80::cf3:df1b:2dc0:6e96%en0 prefixlen 64 secured scopeid 0x5</span><br><span class="line">inet 192.168.11.234 netmask 0xffffff00 broadcast 192.168.11.255</span><br><span class="line">inet6 fe80::71:c740:8d33:ce8f%utun1 prefixlen 64 scopeid 0xc</span><br><span class="line">inet 192.168.99.1 netmask 0xffffff00 broadcast 192.168.99.255</span><br></pre></td></tr></table></figure><p>4 æ‰§è¡Œè„šæœ¬å¯åŠ¨minikube æ­å»ºk8s</p><blockquote><p>æ‰§è¡Œè„šæœ¬æ—¶ è®°å¾—å·²å¼€å¯VPN </p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">âœ  sh run.sh</span><br><span class="line">There is a newer version of minikube available (v1.3.0).  Download it here:</span><br><span class="line">https://github.com/kubernetes/minikube/releases/tag/v1.3.0</span><br><span class="line"></span><br><span class="line">To disable this notification, run the following:</span><br><span class="line">minikube config set WantUpdateNotification false</span><br><span class="line">ğŸ”¥  Deleting "minikube" from virtualbox ...</span><br><span class="line">ğŸ’”  The "minikube" cluster has been deleted.</span><br><span class="line">ğŸ˜„  minikube v1.0.0 on darwin (amd64)</span><br><span class="line">ğŸ¤¹  Downloading Kubernetes v1.14.0 images in the background ...</span><br><span class="line">ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=4096MB, Disk=10000MB) ...</span><br><span class="line">ğŸ“¶  "minikube" IP address is 192.168.99.129</span><br><span class="line">ğŸ³  Configuring Docker as the container runtime ...</span><br><span class="line">    â–ª env http_proxy=192.168.11.234:1087</span><br><span class="line">    â–ª env https_proxy=192.168.11.234:1087</span><br><span class="line">    â–ª env no_proxy=192.168.99.0/24</span><br><span class="line">ğŸ³  Version of container runtime is 18.06.2-ce</span><br><span class="line">âŒ›  Waiting for image downloads to complete ...</span><br><span class="line">âœ¨  Preparing Kubernetes environment ...</span><br><span class="line">ğŸšœ  Pulling images required by Kubernetes v1.14.0 ...</span><br><span class="line">ğŸš€  Launching Kubernetes v1.14.0 using kubeadm ...</span><br><span class="line">âŒ›  Waiting for pods: apiserver proxy etcd scheduler controller dns</span><br><span class="line">ğŸ”‘  Configuring cluster permissions ...</span><br><span class="line">ğŸ¤”  Verifying component health .....</span><br><span class="line">ğŸ’—  kubectl is now configured to use "minikube"</span><br><span class="line">ğŸ„  Done! Thank you for using minikube!</span><br><span class="line">âœ  minikube status</span><br><span class="line">host: Running</span><br><span class="line">kubelet: Running</span><br><span class="line">apiserver: Running</span><br><span class="line">kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.129</span><br><span class="line">âœ  kubectl get nodes -o wide</span><br><span class="line">NAME       STATUS   ROLES    AGE    VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE            KERNEL-VERSION   CONTAINER-RUNTIME</span><br><span class="line">minikube   Ready    master   5m7s   v1.14.0   10.0.2.15     &lt;none&gt;        Buildroot 2018.05   4.15.0           docker://18.6.2</span><br><span class="line">âœ kubectl cluster-info</span><br><span class="line">Kubernetes master is running at https://192.168.99.129:8443</span><br><span class="line">KubeDNS is running at https://192.168.99.129:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span><br><span class="line">âœ  kubectl get svc -o wide</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE     SELECTOR</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   5m24s   &lt;none&gt;</span><br><span class="line">âœ  minikube addons list</span><br><span class="line">- addon-manager: enabled</span><br><span class="line">- dashboard: enabled</span><br><span class="line">- default-storageclass: enabled</span><br><span class="line">- efk: disabled</span><br><span class="line">- freshpod: disabled</span><br><span class="line">- gvisor: disabled</span><br><span class="line">- heapster: disabled</span><br><span class="line">- ingress: enabled</span><br><span class="line">- logviewer: disabled</span><br><span class="line">- metrics-server: disabled</span><br><span class="line">- nvidia-driver-installer: disabled</span><br><span class="line">- nvidia-gpu-device-plugin: disabled</span><br><span class="line">- registry: disabled</span><br><span class="line">- registry-creds: disabled</span><br><span class="line">- storage-provisioner: enabled</span><br><span class="line">- storage-provisioner-gluster: disabled</span><br><span class="line">âœ</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨é˜¿é‡Œäº‘minikube-æ­å»ºk8sç¯å¢ƒ"><a href="#åˆ©ç”¨é˜¿é‡Œäº‘minikube-æ­å»ºk8sç¯å¢ƒ" class="headerlink" title="åˆ©ç”¨é˜¿é‡Œäº‘minikube æ­å»ºk8sç¯å¢ƒ"></a>åˆ©ç”¨é˜¿é‡Œäº‘minikube æ­å»ºk8sç¯å¢ƒ</h2><p>1 é˜¿é‡Œäº‘minikubeæ­å»ºk8sç¯å¢ƒ åšå®¢æ–‡ç« <br><a href="https://yq.aliyun.com/articles/221687" target="_blank" rel="noopener">https://yq.aliyun.com/articles/221687</a></p><p>2 å®‰è£…ç‰ˆæœ¬é˜¿é‡Œäº‘minikube</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">curl -Lo minikube http://kubernetes.oss-cn-hangzhou.aliyuncs.com/minikube/releases/v1.2.0/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</span><br></pre></td></tr></table></figure><p>3 å¯åŠ¨minikube æ­å»ºk8sç¯å¢ƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ minikube start --registry-mirror=https://registry.docker-cn.com</span><br><span class="line">ğŸ˜„  minikube v1.2.0 on darwin (amd64)</span><br><span class="line">âœ…  using image repository registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=2048MB, Disk=20000MB) ...</span><br><span class="line">ğŸ³  Configuring environment for Kubernetes v1.15.0 on Docker 18.09.6</span><br><span class="line">ğŸšœ  Pulling images ...</span><br><span class="line">ğŸš€  Launching Kubernetes ...</span><br><span class="line">âŒ›  Verifying: apiserver proxy etcd scheduler controller dns</span><br><span class="line">ğŸ„  Done! kubectl is now configured to use "minikube"</span><br><span class="line">âœ  ~ minikube status</span><br><span class="line">mhost: Running</span><br><span class="line">kubelet: Running</span><br><span class="line">apiserver: Running</span><br><span class="line">kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.130</span><br><span class="line">âœ  ~ kubectl cluster-info</span><br><span class="line">kubeKubernetes master is running at https://192.168.99.130:8443</span><br><span class="line">KubeDNS is running at https://192.168.99.130:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span><br><span class="line">âœ  ~ kubectl get nodes -o wide</span><br><span class="line">NAME       STATUS   ROLES    AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE              KERNEL-VERSION   CONTAINER-RUNTIME</span><br><span class="line">minikube   Ready    master   2m41s   v1.15.0   10.0.2.15     &lt;none&gt;        Buildroot 2018.05.3   4.15.0           docker://18.9.6</span><br><span class="line">âœ  minikube dashboard</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>æœ¬æ–‡æ€»ç»“äº†é€šè¿‡å®˜æ–¹å’Œé˜¿é‡Œäº‘ä¸¤ä¸ªminikubeç‰ˆæœ¬æ­å»ºk8sç¯å¢ƒçš„æ–¹å¼;</li><li>å¹³æ—¶åœ¨macä¸Šå­¦ä¹ k8sæ¨èä½¿ç”¨é˜¿é‡Œäº‘minikubeç‰ˆæœ¬ï¼Œè¿™æ ·æ›´æ–¹ä¾¿ä¸‹è½½é•œåƒ;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨macä¸Šåˆ©ç”¨minikube æ­å»ºk8sç¯å¢ƒæˆ–å¤šæˆ–å°‘ä¼šå› ä¸ºpullé•œåƒå¤±è´¥è€Œæ­å»ºä¸æˆåŠŸ, æœ¬æ–‡ä»‹ç»ä¸¤ç§åœ¨macä¸Šåˆ©ç”¨minikube æ­å»ºk8sç¯å¢ƒçš„æ–¹æ³•; ä¸€ç§æ˜¯é€šè¿‡VPNç¿»å¢™åˆ©ç”¨å®˜æ–¹minikube æ­å»ºk8s ç¯å¢ƒï¼Œ å¦å¤–ä¸€ç§æ˜¯å€ŸåŠ©é˜¿é‡Œäº‘çš„minikubeç‰ˆæœ¬æ¥æ­å»ºk8sç¯å¢ƒ;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="k8s" scheme="http://researchlab.github.io/categories/k8s/"/>
    
    
      <category term="minikube" scheme="http://researchlab.github.io/tags/minikube/"/>
    
  </entry>
  
  <entry>
    <title>install rabbitmq for centos7</title>
    <link href="http://researchlab.github.io/2019/06/06/install-rabbitmq/"/>
    <id>http://researchlab.github.io/2019/06/06/install-rabbitmq/</id>
    <published>2019-06-06T17:16:04.000Z</published>
    <updated>2019-08-24T14:25:55.670Z</updated>
    
    <content type="html"><![CDATA[<p>RabbitMQ is the most widely deployed open source message broker.</p><p>RabbitMQ is lightweight and easy to deploy on premises and in the cloud. It supports multiple messaging protocols. RabbitMQ can be deployed in distributed and federated configurations to meet high-scale, high-availability requirements.</p><a id="more"></a><h2 id="basic-env"><a href="#basic-env" class="headerlink" title="basic env"></a>basic env</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release</span><br><span class="line">CentOS Linux release 7.2.1511 (Core)</span><br></pre></td></tr></table></figure><h2 id="install-list"><a href="#install-list" class="headerlink" title="install list"></a>install list</h2><ul><li><p>erlang <a href="http://erlang.org/download/otp_src_22.0.tar.gz" target="_blank" rel="noopener">otp_src_22.0.tar.gz</a></p></li><li><p>rabbitmq-server <a href="https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.15" target="_blank" rel="noopener">rabbitmq-server-generic-unix-3.7.15.tar.xz</a></p></li></ul><blockquote><p>rabbitmq-server ç‰ˆæœ¬è¦ä¸erlang ç‰ˆæœ¬ç›¸åŒ¹é…ï¼Œå¦åˆ™rabbitmq-server å¯åŠ¨å¤±è´¥ï¼Œä¼šæç¤º<code>noproc</code>;</p></blockquote><h2 id="pre-env"><a href="#pre-env" class="headerlink" title="pre-env"></a>pre-env</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make gcc gcc-c++ kernel-devel m4 ncurses-devel openssl-devel unixODBC-devel</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœæç¤ºè¦å®‰è£… wxWidgets wx-config, å®‰è£…å¦‚ä¸‹,</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/wxWidgets/wxWidgets/releases/download/v3.0.4/wxWidgets-3.0.4.tar.bz2</span><br><span class="line"></span><br><span class="line">yum install -y bzip2</span><br><span class="line"></span><br><span class="line">tar -jxvf wxWidgets-3.1.2.tar.bz2 &amp;&amp; cd wxWidgets-3.1.2</span><br><span class="line"></span><br><span class="line">./configure --prefix=/opt/wx &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">export WX=/opt/wx</span><br><span class="line">export PATH=$PATH:$WX/bin:$WX/lib</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="install-erlang"><a href="#install-erlang" class="headerlink" title="install erlang"></a>install erlang</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf otp_src_22.0.tar.gz  &amp;&amp; cd otp_src_22.0</span><br><span class="line"></span><br><span class="line">./configure --prefix=/opt/erlang --without-javac</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">export ERLANG=/opt/erlang</span><br><span class="line">export PATH=$PATH:$ERLANG/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>éªŒè¯erlang æ˜¯å¦æŒ‰ç…§æˆåŠŸ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># erl version</span><br><span class="line">Erlang/OTP 22 [erts-10.4] [source] [64-bit] [smp:16:16] [ds:16:16:10] [async-threads:1] [hipe]</span><br><span class="line"></span><br><span class="line">Eshell V10.4  (abort with ^G)</span><br><span class="line">1&gt; halt().</span><br><span class="line">#</span><br></pre></td></tr></table></figure><h2 id="install-rabbitmq-server"><a href="#install-rabbitmq-server" class="headerlink" title="install rabbitmq-server"></a>install rabbitmq-server</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf rabbitmq-server-generic-unix-3.7.15.tar.xz &amp;&amp; mv rabbitmq-server-generic-unix-3.7.15 rabbitmq</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line">export PATH=$PATH:/opt/rabbitmq/sbin</span><br><span class="line">export RABBITMQ_HOME=/opt/rabbitmq</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="start-rabbitmq-server"><a href="#start-rabbitmq-server" class="headerlink" title="start rabbitmq-server"></a>start rabbitmq-server</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-server -detached</span><br><span class="line"></span><br><span class="line">rabbitmqctl status</span><br><span class="line"></span><br><span class="line">rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure><h2 id="enable-rabbitmq-web-management"><a href="#enable-rabbitmq-web-management" class="headerlink" title="enable rabbitmq-web-management"></a>enable rabbitmq-web-management</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin 123456</span><br><span class="line">rabbitmqctl set_user tags admin administrator</span><br><span class="line">rabbitmqctl set_user_tags admin administrator</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ“ä½œåï¼Œ å°±å¯ä»¥åœ¨æµè§ˆå™¨ç«¯è®¿é—® <a href="http://ip:15672" target="_blank" rel="noopener">http://ip:15672</a> ç„¶åé€šè¿‡admin 123456 ç™»å½•äº†ï¼›</p><h2 id="config"><a href="#config" class="headerlink" title="config"></a>config</h2><blockquote><p>å®˜æ–¹å‚è€ƒæ–‡æ¡£: <a href="https://www.rabbitmq.com/configure.html#configuration-file" target="_blank" rel="noopener">https://www.rabbitmq.com/configure.html#configuration-file</a></p></blockquote><p>é…ç½®æ–‡ä»¶ç®€å•ç†è§£å°±æ˜¯åˆ›å»ºä¿©æ–‡ä»¶rabbitmq-env.confï¼Œrabbitmq.configç„¶åéƒ½æ‰”åˆ°/etc/rabbitmqç›®å½•ä¸‹å³å¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@test02 rabbitmq]# pwd</span><br><span class="line">/opt/rabbitmq/etc/rabbitmq</span><br><span class="line">[root@test02 rabbitmq]# ls</span><br><span class="line">enabled_plugins  rabbitmq.config  rabbitmq-env.conf</span><br><span class="line">[root@test02 rabbitmq]# more rabbitmq-env.conf</span><br><span class="line">RABBITMQ_MNESIA_BASE=/usr/local/rabbitmq-server/data</span><br><span class="line">RABBITMQ_LOG_BASE=/usr/local/rabbitmq-server/log</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;RabbitMQ is the most widely deployed open source message broker.&lt;/p&gt;
&lt;p&gt;RabbitMQ is lightweight and easy to deploy on premises and in the cloud. It supports multiple messaging protocols. RabbitMQ can be deployed in distributed and federated configurations to meet high-scale, high-availability requirements.&lt;/p&gt;
    
    </summary>
    
      <category term="MQ" scheme="http://researchlab.github.io/categories/MQ/"/>
    
    
      <category term="rabbitmq" scheme="http://researchlab.github.io/tags/rabbitmq/"/>
    
  </entry>
  
  <entry>
    <title>ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´© - è§£å†³æ–¹æ¡ˆåˆ†æ</title>
    <link href="http://researchlab.github.io/2019/02/26/cache-invalidation-analysis-solution/"/>
    <id>http://researchlab.github.io/2019/02/26/cache-invalidation-analysis-solution/</id>
    <published>2019-02-26T09:53:45.000Z</published>
    <updated>2019-08-24T14:25:55.658Z</updated>
    
    <content type="html"><![CDATA[<p>è®¾è®¡ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿï¼Œä¸å¾—ä¸è¦è€ƒè™‘çš„é—®é¢˜å°±æ˜¯: ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ä¸å¤±æ•ˆæ—¶çš„é›ªå´©æ•ˆåº”ã€‚<br><a id="more"></a></p><h2 id="ç¼“å­˜ç©¿é€"><a href="#ç¼“å­˜ç©¿é€" class="headerlink" title="ç¼“å­˜ç©¿é€"></a>ç¼“å­˜ç©¿é€</h2><p>ç¼“å­˜ç©¿é€æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œç”±äºç¼“å­˜æ˜¯ä¸å‘½ä¸­æ—¶è¢«åŠ¨å†™çš„ï¼Œå¹¶ä¸”å‡ºäºå®¹é”™è€ƒè™‘ï¼Œå¦‚æœä»å­˜å‚¨å±‚æŸ¥ä¸åˆ°æ•°æ®åˆ™ä¸å†™å…¥ç¼“å­˜ï¼Œè¿™å°†å¯¼è‡´è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ°å­˜å‚¨å±‚å»æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ã€‚åœ¨æµé‡å¤§æ—¶ï¼Œå¯èƒ½DBå°±æŒ‚æ‰äº†ï¼Œè¦æ˜¯æœ‰äººåˆ©ç”¨ä¸å­˜åœ¨çš„keyé¢‘ç¹æ”»å‡»æˆ‘ä»¬çš„åº”ç”¨ï¼Œè¿™å°±æ˜¯æ¼æ´ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>æœ‰å¾ˆå¤šç§æ–¹æ³•å¯ä»¥æœ‰æ•ˆåœ°è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œæœ€å¸¸è§çš„åˆ™æ˜¯é‡‡ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå°†æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„æ•°æ®å“ˆå¸Œåˆ°ä¸€ä¸ªè¶³å¤Ÿå¤§çš„bitmapä¸­ï¼Œä¸€ä¸ªä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ä¼šè¢« è¿™ä¸ªbitmapæ‹¦æˆªæ‰ï¼Œä»è€Œé¿å…äº†å¯¹åº•å±‚å­˜å‚¨ç³»ç»Ÿçš„æŸ¥è¯¢å‹åŠ›ã€‚å¦å¤–ä¹Ÿæœ‰ä¸€ä¸ªæ›´ä¸ºç®€å•ç²—æš´çš„æ–¹æ³•ï¼ˆæˆ‘ä»¬é‡‡ç”¨çš„å°±æ˜¯è¿™ç§ï¼‰ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢è¿”å›çš„æ•°æ®ä¸ºç©ºï¼ˆä¸ç®¡æ˜¯æ•° æ®ä¸å­˜åœ¨ï¼Œè¿˜æ˜¯ç³»ç»Ÿæ•…éšœï¼‰ï¼Œæˆ‘ä»¬ä»ç„¶æŠŠè¿™ä¸ªç©ºç»“æœè¿›è¡Œç¼“å­˜ï¼Œä½†å®ƒçš„è¿‡æœŸæ—¶é—´ä¼šå¾ˆçŸ­ï¼Œæœ€é•¿ä¸è¶…è¿‡äº”åˆ†é’Ÿã€‚</p><h2 id="ç¼“å­˜é›ªå´©"><a href="#ç¼“å­˜é›ªå´©" class="headerlink" title="ç¼“å­˜é›ªå´©"></a>ç¼“å­˜é›ªå´©</h2><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨æˆ‘ä»¬è®¾ç½®ç¼“å­˜æ—¶é‡‡ç”¨äº†ç›¸åŒçš„è¿‡æœŸæ—¶é—´ï¼Œå¯¼è‡´ç¼“å­˜åœ¨æŸä¸€æ—¶åˆ»åŒæ—¶å¤±æ•ˆï¼Œè¯·æ±‚å…¨éƒ¨è½¬å‘åˆ°DBï¼ŒDBç¬æ—¶å‹åŠ›è¿‡é‡é›ªå´©ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>ç¼“å­˜å¤±æ•ˆæ—¶çš„é›ªå´©æ•ˆåº”å¯¹åº•å±‚ç³»ç»Ÿçš„å†²å‡»éå¸¸å¯æ€•ã€‚å¤§å¤šæ•°ç³»ç»Ÿè®¾è®¡è€…è€ƒè™‘ç”¨åŠ é”æˆ–è€…é˜Ÿåˆ—çš„æ–¹å¼ä¿è¯ç¼“å­˜çš„å•çº¿ ç¨‹ï¼ˆè¿›ç¨‹ï¼‰å†™ï¼Œä»è€Œé¿å…å¤±æ•ˆæ—¶å¤§é‡çš„å¹¶å‘è¯·æ±‚è½åˆ°åº•å±‚å­˜å‚¨ç³»ç»Ÿä¸Šã€‚è¿™é‡Œåˆ†äº«ä¸€ä¸ªç®€å•æ–¹æ¡ˆå°±æ—¶è®²ç¼“å­˜å¤±æ•ˆæ—¶é—´åˆ†æ•£å¼€ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼Œæ¯”å¦‚1-5åˆ†é’Ÿéšæœºï¼Œè¿™æ ·æ¯ä¸€ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´çš„é‡å¤ç‡å°±ä¼šé™ä½ï¼Œå°±å¾ˆéš¾å¼•å‘é›†ä½“å¤±æ•ˆçš„äº‹ä»¶ã€‚</p><h2 id="ç¼“å­˜å‡»ç©¿"><a href="#ç¼“å­˜å‡»ç©¿" class="headerlink" title="ç¼“å­˜å‡»ç©¿"></a>ç¼“å­˜å‡»ç©¿</h2><p>å¯¹äºä¸€äº›è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyï¼Œå¦‚æœè¿™äº›keyå¯èƒ½ä¼šåœ¨æŸäº›æ—¶é—´ç‚¹è¢«è¶…é«˜å¹¶å‘åœ°è®¿é—®ï¼Œæ˜¯ä¸€ç§éå¸¸â€œçƒ­ç‚¹â€çš„æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜: ç¼“å­˜è¢«â€œå‡»ç©¿â€çš„é—®é¢˜ï¼Œè¿™ä¸ªå’Œç¼“å­˜é›ªå´©çš„åŒºåˆ«åœ¨äºè¿™é‡Œé’ˆå¯¹æŸä¸€keyç¼“å­˜ï¼Œå‰è€…åˆ™æ˜¯å¾ˆå¤škeyã€‚</p><p>ç¼“å­˜åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸçš„æ—¶å€™ï¼Œæ°å¥½åœ¨è¿™ä¸ªæ—¶é—´ç‚¹å¯¹è¿™ä¸ªKeyæœ‰å¤§é‡çš„å¹¶å‘è¯·æ±‚è¿‡æ¥ï¼Œè¿™äº›è¯·æ±‚å‘ç°ç¼“å­˜è¿‡æœŸä¸€èˆ¬éƒ½ä¼šä»åç«¯DBåŠ è½½æ•°æ®å¹¶å›è®¾åˆ°ç¼“å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¤§å¹¶å‘çš„è¯·æ±‚å¯èƒ½ä¼šç¬é—´æŠŠåç«¯DBå‹å®ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ-2"><a href="#è§£å†³æ–¹æ¡ˆ-2" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>1.ä½¿ç”¨äº’æ–¥é”(mutex key)<br>ä¸šç•Œæ¯”è¾ƒå¸¸ç”¨çš„åšæ³•ï¼Œæ˜¯ä½¿ç”¨mutexã€‚ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯åœ¨ç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼ˆåˆ¤æ–­æ‹¿å‡ºæ¥çš„å€¼ä¸ºç©ºï¼‰ï¼Œä¸æ˜¯ç«‹å³å»load dbï¼Œè€Œæ˜¯å…ˆä½¿ç”¨ç¼“å­˜å·¥å…·çš„æŸäº›å¸¦æˆåŠŸæ“ä½œè¿”å›å€¼çš„æ“ä½œï¼ˆæ¯”å¦‚Redisçš„SETNXæˆ–è€…Memcacheçš„ADDï¼‰å»setä¸€ä¸ªmutex keyï¼Œå½“æ“ä½œè¿”å›æˆåŠŸæ—¶ï¼Œå†è¿›è¡Œload dbçš„æ“ä½œå¹¶å›è®¾ç¼“å­˜ï¼›å¦åˆ™ï¼Œå°±é‡è¯•æ•´ä¸ªgetç¼“å­˜çš„æ–¹æ³•ã€‚</p><p>SETNXï¼Œæ˜¯ã€ŒSET if Not eXistsã€çš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸å­˜åœ¨çš„æ—¶å€™æ‰è®¾ç½®ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥å®ç°é”çš„æ•ˆæœã€‚åœ¨redis2.6.1ä¹‹å‰ç‰ˆæœ¬æœªå®ç°setnxçš„è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥è¿™é‡Œç»™å‡ºä¸¤ç§ç‰ˆæœ¬ä»£ç å‚è€ƒ: </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2.6.1å‰å•æœºç‰ˆæœ¬é”</span></span><br><span class="line"><span class="function">String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;  </span><br><span class="line">   String value = redis.get(key);  </span><br><span class="line">   <span class="keyword">if</span> (value  == null) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (redis.setnx(key_mutex, <span class="string">"1"</span>)) &#123;  </span><br><span class="line">        <span class="comment">// 3 min timeout to avoid mutex holder crash  </span></span><br><span class="line">        redis.expire(key_mutex, <span class="number">3</span> * <span class="number">60</span>)  </span><br><span class="line">        value = db.get(key);  </span><br><span class="line">        redis.<span class="built_in">set</span>(key, value);  </span><br><span class="line">        redis.<span class="keyword">delete</span>(key_mutex);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="comment">//å…¶ä»–çº¿ç¨‹ä¼‘æ¯50æ¯«ç§’åé‡è¯•  </span></span><br><span class="line">        Thread.sleep(<span class="number">50</span>);  </span><br><span class="line">        get(key);  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(key)</span> </span>&#123;</span><br><span class="line">      String value = redis.get(key);</span><br><span class="line">      <span class="keyword">if</span> (value == null) &#123; <span class="comment">//ä»£è¡¨ç¼“å­˜å€¼è¿‡æœŸ</span></span><br><span class="line">          <span class="comment">//è®¾ç½®3minçš„è¶…æ—¶ï¼Œé˜²æ­¢delæ“ä½œå¤±è´¥çš„æ—¶å€™ï¼Œä¸‹æ¬¡ç¼“å­˜è¿‡æœŸä¸€ç›´ä¸èƒ½load db</span></span><br><span class="line">  <span class="keyword">if</span> (redis.setnx(key_mutex, <span class="number">1</span>, <span class="number">3</span> * <span class="number">60</span>) == <span class="number">1</span>) &#123;  <span class="comment">//ä»£è¡¨è®¾ç½®æˆåŠŸ</span></span><br><span class="line">               value = db.get(key);</span><br><span class="line">                      redis.<span class="built_in">set</span>(key, value, expire_secs);</span><br><span class="line">                      redis.del(key_mutex);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;  <span class="comment">//è¿™ä¸ªæ—¶å€™ä»£è¡¨åŒæ—¶å€™çš„å…¶ä»–çº¿ç¨‹å·²ç»load dbå¹¶å›è®¾åˆ°ç¼“å­˜äº†ï¼Œè¿™æ—¶å€™é‡è¯•è·å–ç¼“å­˜å€¼å³å¯</span></span><br><span class="line">                      sleep(<span class="number">50</span>);</span><br><span class="line">                      get(key);  <span class="comment">//é‡è¯•</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> value;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>memcacheä»£ç ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (memcache.get(key) == null) &#123;  </span><br><span class="line">    <span class="comment">// 3 min timeout to avoid mutex holder crash  </span></span><br><span class="line">    <span class="keyword">if</span> (memcache.add(key_mutex, <span class="number">3</span> * <span class="number">60</span> * <span class="number">1000</span>) == <span class="literal">true</span>) &#123;  </span><br><span class="line">        value = db.get(key);  </span><br><span class="line">        memcache.<span class="built_in">set</span>(key, value);  </span><br><span class="line">        memcache.<span class="keyword">delete</span>(key_mutex);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        sleep(<span class="number">50</span>);  </span><br><span class="line">        retry();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="â€œæå‰â€ä½¿ç”¨äº’æ–¥é”-mutex-key-ï¼š"><a href="#â€œæå‰â€ä½¿ç”¨äº’æ–¥é”-mutex-key-ï¼š" class="headerlink" title="â€œæå‰â€ä½¿ç”¨äº’æ–¥é”(mutex key)ï¼š"></a>â€œæå‰â€ä½¿ç”¨äº’æ–¥é”(mutex key)ï¼š</h2><p>åœ¨valueå†…éƒ¨è®¾ç½®1ä¸ªè¶…æ—¶å€¼(timeout1), timeout1æ¯”å®é™…çš„memcache timeout(timeout2)å°ã€‚å½“ä»cacheè¯»å–åˆ°timeout1å‘ç°å®ƒå·²ç»è¿‡æœŸæ—¶å€™ï¼Œé©¬ä¸Šå»¶é•¿timeout1å¹¶é‡æ–°è®¾ç½®åˆ°cacheã€‚ç„¶åå†ä»æ•°æ®åº“åŠ è½½æ•°æ®å¹¶è®¾ç½®åˆ°cacheä¸­ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">v = memcache.get(key);  </span><br><span class="line">if (v == null) &#123;  </span><br><span class="line">    if (memcache.add(key_mutex, 3 * 60 * 1000) == true) &#123;  </span><br><span class="line">        value = db.get(key);  </span><br><span class="line">        memcache.set(key, value);  </span><br><span class="line">        memcache.delete(key_mutex);  </span><br><span class="line">    &#125; else &#123;  </span><br><span class="line">        sleep(50);  </span><br><span class="line">        retry();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125; else &#123;  </span><br><span class="line">    if (v.timeout &lt;= now()) &#123;  </span><br><span class="line">        if (memcache.add(key_mutex, 3 * 60 * 1000) == true) &#123;  </span><br><span class="line">            // extend the timeout for other threads  </span><br><span class="line">            v.timeout += 3 * 60 * 1000;  </span><br><span class="line">            memcache.set(key, v, KEY_TIMEOUT * 2);  </span><br><span class="line">  </span><br><span class="line">            // load the latest value from db  </span><br><span class="line">            v = db.get(key);  </span><br><span class="line">            v.timeout = KEY_TIMEOUT;  </span><br><span class="line">            memcache.set(key, value, KEY_TIMEOUT * 2);  </span><br><span class="line">            memcache.delete(key_mutex);  </span><br><span class="line">        &#125; else &#123;  </span><br><span class="line">            sleep(50);  </span><br><span class="line">            retry();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="â€œæ°¸è¿œä¸è¿‡æœŸâ€ï¼š"><a href="#â€œæ°¸è¿œä¸è¿‡æœŸâ€ï¼š" class="headerlink" title="â€œæ°¸è¿œä¸è¿‡æœŸâ€ï¼š"></a>â€œæ°¸è¿œä¸è¿‡æœŸâ€ï¼š</h2><p>è¿™é‡Œçš„â€œæ°¸è¿œä¸è¿‡æœŸâ€åŒ…å«ä¸¤å±‚æ„æ€ï¼š</p><blockquote><p>(1) ä»redisä¸Šçœ‹ï¼Œç¡®å®æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™å°±ä¿è¯äº†ï¼Œä¸ä¼šå‡ºç°çƒ­ç‚¹keyè¿‡æœŸé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯â€œç‰©ç†â€ä¸è¿‡æœŸã€‚</p></blockquote><blockquote><p>(2) ä»åŠŸèƒ½ä¸Šçœ‹ï¼Œå¦‚æœä¸è¿‡æœŸï¼Œé‚£ä¸å°±æˆé™æ€çš„äº†å—ï¼Ÿæ‰€ä»¥æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´å­˜åœ¨keyå¯¹åº”çš„valueé‡Œï¼Œå¦‚æœå‘ç°è¦è¿‡æœŸäº†ï¼Œé€šè¿‡ä¸€ä¸ªåå°çš„å¼‚æ­¥çº¿ç¨‹è¿›è¡Œç¼“å­˜çš„æ„å»ºï¼Œä¹Ÿå°±æ˜¯â€œé€»è¾‘â€è¿‡æœŸ</p></blockquote><p> ä»å®æˆ˜çœ‹ï¼Œè¿™ç§æ–¹æ³•å¯¹äºæ€§èƒ½éå¸¸å‹å¥½ï¼Œå”¯ä¸€ä¸è¶³çš„å°±æ˜¯æ„å»ºç¼“å­˜æ—¶å€™ï¼Œå…¶ä½™çº¿ç¨‹(éæ„å»ºç¼“å­˜çš„çº¿ç¨‹)å¯èƒ½è®¿é—®çš„æ˜¯è€æ•°æ®ï¼Œä½†æ˜¯å¯¹äºä¸€èˆ¬çš„äº’è”ç½‘åŠŸèƒ½æ¥è¯´è¿™ä¸ªè¿˜æ˜¯å¯ä»¥å¿å—ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">String get(final String key) &#123;</span><br><span class="line">        V v = redis.get(key);</span><br><span class="line">        String value = v.getValue();</span><br><span class="line">        long timeout = v.getTimeout();</span><br><span class="line">        if (v.timeout &lt;= System.currentTimeMillis()) &#123;</span><br><span class="line">            // å¼‚æ­¥æ›´æ–°åå°å¼‚å¸¸æ‰§è¡Œ</span><br><span class="line">            threadPool.execute(new Runnable() &#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    String keyMutex = &quot;mutex:&quot; + key;</span><br><span class="line">                    if (redis.setnx(keyMutex, &quot;1&quot;)) &#123;</span><br><span class="line">                        // 3 min timeout to avoid mutex holder crash</span><br><span class="line">                        redis.expire(keyMutex, 3 * 60);</span><br><span class="line">                        String dbValue = db.get(key);</span><br><span class="line">                        redis.set(key, dbValue);</span><br><span class="line">                        redis.delete(keyMutex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        return value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="èµ„æºä¿æŠ¤ï¼š"><a href="#èµ„æºä¿æŠ¤ï¼š" class="headerlink" title="èµ„æºä¿æŠ¤ï¼š"></a>èµ„æºä¿æŠ¤ï¼š</h2><p>é‡‡ç”¨netflixçš„hystrixï¼Œå¯ä»¥åšèµ„æºçš„éš”ç¦»ä¿æŠ¤ä¸»çº¿ç¨‹æ± ï¼Œå¦‚æœæŠŠè¿™ä¸ªåº”ç”¨åˆ°ç¼“å­˜çš„æ„å»ºä¹Ÿæœªå°ä¸å¯ã€‚</p><p>å››ç§è§£å†³æ–¹æ¡ˆï¼šæ²¡æœ‰æœ€ä½³åªæœ‰æœ€åˆé€‚</p><table><thead><tr><th>è§£å†³æ–¹æ¡ˆ</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>ç®€å•åˆ†å¸ƒå¼äº’æ–¥é”ï¼ˆmutex keyï¼‰</td><td>1.æ€è·¯ç®€å•<br>2.ä¿è¯ä¸€è‡´æ€§</td><td>1.ä»£ç å¤æ‚åº¦å¢å¤§<br>2.å­˜åœ¨æ­»é”çš„é£é™©<br>3.å­˜åœ¨çº¿ç¨‹æ± é˜»å¡çš„é£é™©</td></tr><tr><td>â€œæå‰â€ä½¿ç”¨äº’æ–¥é”</td><td>1.ä¿è¯ä¸€è‡´æ€§<br></td><td>åŒä¸Š</td></tr><tr><td>ä¸è¿‡æœŸ(æœ¬æ–‡)</td><td>1.å¼‚æ­¥æ„å»ºç¼“å­˜, ä¸ä¼šé˜»å¡çº¿ç¨‹æ± </td><td>1.ä¸ä¿è¯ä¸€è‡´æ€§ã€‚<br>2.ä»£ç å¤æ‚åº¦å¢å¤§(æ¯ä¸ªvalueéƒ½è¦ç»´æŠ¤ä¸€ä¸ªtimekey)ã€‚<br>3.å ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´(æ¯ä¸ªvalueéƒ½è¦ç»´æŠ¤ä¸€ä¸ªtimekey)ã€‚</td></tr><tr><td>èµ„æºéš”ç¦»ç»„ä»¶hystrix(æœ¬æ–‡)</td><td>1.hystrixæŠ€æœ¯æˆç†Ÿ,æœ‰æ•ˆä¿è¯åç«¯ã€‚<br>2.hystrixç›‘æ§å¼ºå¤§ã€‚</td><td>1. éƒ¨åˆ†è®¿é—®å­˜åœ¨é™çº§ç­–ç•¥ã€‚</td></tr></tbody></table><p>å››ç§æ–¹æ¡ˆæ¥æºç½‘ç»œï¼Œè¯¦æ–‡è¯·é“¾æ¥ï¼š<a href="http://carlosfu.iteye.com/blog/2269687?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io" target="_blank" rel="noopener">http://carlosfu.iteye.com/blog/2269687?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é’ˆå¯¹ä¸šåŠ¡ç³»ç»Ÿï¼Œæ°¸è¿œéƒ½æ˜¯å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œæ²¡æœ‰æœ€å¥½ï¼Œåªæœ‰æœ€åˆé€‚ã€‚<br>æœ€åï¼Œå¯¹äºç¼“å­˜ç³»ç»Ÿå¸¸è§çš„ç¼“å­˜æ»¡äº†å’Œæ•°æ®ä¸¢å¤±é—®é¢˜ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡åˆ†æï¼Œé€šå¸¸æˆ‘ä»¬é‡‡ç”¨LRUç­–ç•¥å¤„ç†æº¢å‡ºï¼ŒRedisçš„RDBå’ŒAOFæŒä¹…åŒ–ç­–ç•¥æ¥ä¿è¯ä¸€å®šæƒ…å†µä¸‹çš„æ•°æ®å®‰å…¨ã€‚</p><h2 id="å‚è€ƒæ¥æº"><a href="#å‚è€ƒæ¥æº" class="headerlink" title="å‚è€ƒæ¥æº"></a>å‚è€ƒæ¥æº</h2><p>[1] <a href="https://blog.csdn.net/zeb_perfect/article/details/54135506" target="_blank" rel="noopener">https://blog.csdn.net/zeb_perfect/article/details/54135506</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®¾è®¡ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿï¼Œä¸å¾—ä¸è¦è€ƒè™‘çš„é—®é¢˜å°±æ˜¯: ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ä¸å¤±æ•ˆæ—¶çš„é›ªå´©æ•ˆåº”ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="DevOps" scheme="http://researchlab.github.io/categories/DevOps/"/>
    
    
      <category term="cache-invalid" scheme="http://researchlab.github.io/tags/cache-invalid/"/>
    
  </entry>
  
  <entry>
    <title>ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹æ·±å…¥å­¦ä¹ golang channel</title>
    <link href="http://researchlab.github.io/2018/11/08/producer-consumer-go-channel/"/>
    <id>http://researchlab.github.io/2018/11/08/producer-consumer-go-channel/</id>
    <published>2018-11-08T19:53:14.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹æ¢ç©¶å›é¡¾golang channelæ³¨æ„äº‹é¡¹; å®ä¾‹æ¢ç©¶no bufferåŠbuffer channel;<br><a id="more"></a></p><h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><p>golang channel åˆ†ä¸ºæ— ç¼“å†²channelåŠç¼“å†²channel, å…·ä½“ä½“ç°åœ¨åˆ›å»ºchannelæ—¶æ˜¯å¦åˆ¶å®šchannel size, </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//no buffer channel</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//buffer channel</span></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span> bufSize)</span><br></pre></td></tr></table></figure><ul><li>æ— ç¼“å†²channel é»˜è®¤channelå¤§å°ä¸º1, å†™å…¥ä¸€ä¸ªå€¼åéœ€è¦è¢«è¯»å–ä¹‹åæ‰èƒ½ç»§ç»­å†™å…¥, å¦åˆ™å†™é˜»å¡;</li><li>ç¼“å†²channel çš„å¤§å°æ˜¯åˆå§‹æ—¶çš„bufSize, å¯è¿ç»­å†™å…¥bufSizeå€¼, ç„¶åç­‰å¾…è¯»å–, å½“len(channel) &lt; bufSizeæ—¶æ‰å¯ä»¥ç»§ç»­å†™å…¥, å¦åˆ™å†™é˜»å¡;</li><li>channel ä¸­æ²¡æœ‰å€¼æ—¶ åˆ™è¯»é˜»å¡;</li><li>channel å¸¸ç”¨åœ¨åŒæ­¥, pipe, æ— é”è®¾è®¡ç­‰åœºæ™¯ä¸­;</li></ul><h3 id="å†™å€¼"><a href="#å†™å€¼" class="headerlink" title="å†™å€¼"></a>å†™å€¼</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch &lt;- in</span><br></pre></td></tr></table></figure><ul><li>éå†™é˜»å¡æ—¶å¯ä»¥å†™å…¥å€¼;</li></ul><h3 id="è¯»å€¼"><a href="#è¯»å€¼" class="headerlink" title="è¯»å€¼"></a>è¯»å€¼</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">out := &lt;-ch </span><br><span class="line"></span><br><span class="line">out, ok := &lt;- ch</span><br></pre></td></tr></table></figure><ul><li>éè¯»é˜»å¡æ—¶å¯ä»¥è¯»å–å€¼;</li><li>å½“ok ä¸ºfalseæ—¶, è¡¨ç¤ºchannelå·²è¢«å…³é—­;</li></ul><h3 id="å…³é—­"><a href="#å…³é—­" class="headerlink" title="å…³é—­"></a>å…³é—­</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">close</span>(ch)</span><br></pre></td></tr></table></figure><ul><li>åªè¦å½“å†™channelå†™å…¥å®Œæ¯•ååˆ™åº”ç«‹å³å…³é—­channel; è€Œè¯»channelåˆ™å¯ä»¥ä¸éœ€è¦å¤„ç†;</li></ul><blockquote><p>æ›´å¤šå‚è€ƒ<a href="https://tour.golang.org/concurrency/4" target="_blank" rel="noopener">Range and close</a></p></blockquote><h3 id="forå¾ªç¯è¯»"><a href="#forå¾ªç¯è¯»" class="headerlink" title="forå¾ªç¯è¯»"></a>forå¾ªç¯è¯»</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> x := <span class="keyword">range</span> ch &#123;</span><br><span class="line">        <span class="comment">//do something with x</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>å½“ä½¿ç”¨for range ä»ç®¡é“è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œç®¡é“æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆå¾ªç¯ä¼šé˜»å¡ï¼Œåªæœ‰å½“ç®¡é“è¢«å…³é—­çš„æ—¶å€™ï¼Œfor å¾ªç¯æ‰ä¼šç»“æŸ</li></ul><h2 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//producer_consumer.go</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">N = <span class="number">100000</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Producer</span><span class="params">(out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; N; i++ &#123;</span><br><span class="line">out &lt;- i</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">close</span>(out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Consumer</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, out <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> x := <span class="keyword">range</span> in &#123;</span><br><span class="line">out &lt;- x</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">close</span>(out)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•case </p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//producer_consumer_test.go</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">producerconsumer</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>, out <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> Producer(in)</span><br><span class="line"><span class="keyword">go</span> Consumer(in, out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x := <span class="keyword">range</span> out &#123;</span><br><span class="line">_ = x</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNoBufferChan</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">in, out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">producerconsumer(in, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestBufferChan</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">bufLen := <span class="number">100</span></span><br><span class="line">in, out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, bufLen), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, bufLen)</span><br><span class="line">producerconsumer(in, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkNoBufferChan</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">in, out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line">producerconsumer(in, out)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkBufferChan</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">bufLen := <span class="number">100</span></span><br><span class="line">in, out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, bufLen), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, bufLen)</span><br><span class="line">producerconsumer(in, out)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>output </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">âœ  make bench</span><br><span class="line">[Benchmark] running Benchmark</span><br><span class="line">=== RUN   TestCloseWriteChanException</span><br><span class="line">--- PASS: TestCloseWriteChanException (2.01s)</span><br><span class="line">=== RUN   TestCloseReadChanException</span><br><span class="line">--- PASS: TestCloseReadChanException (1.00s)</span><br><span class="line">=== RUN   TestNoBufferChan</span><br><span class="line">--- PASS: TestNoBufferChan (0.09s)</span><br><span class="line">=== RUN   TestBufferChan</span><br><span class="line">--- PASS: TestBufferChan (0.02s)</span><br><span class="line">goos: darwin</span><br><span class="line">goarch: amd64</span><br><span class="line">pkg: github.com/researchlab/experiments/channel</span><br><span class="line">BenchmarkNoBufferChan-8         20  84429085 ns/op</span><br><span class="line">BenchmarkBufferChan-8           50  22295688 ns/op</span><br><span class="line">PASS</span><br><span class="line">ok  github.com/researchlab/experiments/channel6.045s</span><br></pre></td></tr></table></figure><p>æ›´å¤šåˆ†æåŠå®Œæ•´æºç å¯å‚è§ <a href="https://github.com/researchlab/experiments/tree/master/channel" target="_blank" rel="noopener">github-channel</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>å›é¡¾äº†channelä¸¤ç§ç±»å‹(no buffer/buffer channel);</li><li>åªæœ‰å†™channeléœ€è¦close, è€Œè¯»channel åˆ™å¯ä»¥ä¸éœ€è¦å…³å¿ƒ; éœ€è¦æ³¨æ„channel åœ¨å¤šä¸ªgoroutineä¸­çš„closeé—®é¢˜;</li><li>channel æ˜¯éå¸¸å¸¸ç”¨çš„ä¸€ç§ç»“æœ, å¸¸è§äºä¸šåŠ¡åŒæ­¥, buffer pipe, timeout, æ— é”è®¾è®¡ç­‰åœºæ™¯ä¸­; </li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹æ¢ç©¶å›é¡¾golang channelæ³¨æ„äº‹é¡¹; å®ä¾‹æ¢ç©¶no bufferåŠbuffer channel;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="http://researchlab.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="http://researchlab.github.io/tags/golang/"/>
    
      <category term="channel" scheme="http://researchlab.github.io/tags/channel/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸“é¢˜16 äº‹åŠ¡éš”ç¦»çº§åˆ«åŠACIDçŸ¥è¯†å›é¡¾</title>
    <link href="http://researchlab.github.io/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/"/>
    <id>http://researchlab.github.io/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/</id>
    <published>2018-11-07T19:10:48.000Z</published>
    <updated>2019-08-24T14:25:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>äº‹åŠ¡æŒ‡çš„æ˜¯æ»¡è¶³<code>ACID</code>ç‰¹æ€§çš„ä¸€ç»„æ“ä½œ,<code>mysql</code>ä¸­å¯ä»¥é€šè¿‡<code>commit</code>æäº¤ä¸€ä¸ªäº‹åŠ¡,ä¹Ÿå¯ä»¥ä½¿ç”¨<code>rollback</code>è¿›è¡Œå›æ»šã€‚ åœ¨å¹¶å‘åœºæ™¯ä¸­å¾ˆéš¾ä¿è¯äº‹åŠ¡çš„<code>Isolation</code>ç‰¹æ€§, å³æ— æ³•ä¿è¯ä¸´ç•Œèµ„æºçš„æ’å®ƒæ€§æ“ä½œ, ä»è€Œå¼•å‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜, ä¸´ç•Œèµ„æºäº’æ–¥é—®é¢˜æ˜¾ç„¶éœ€è¦å€ŸåŠ©åŠ é”æ¥è§£å†³, åœ¨å¹¶å‘äº‹åŠ¡ä¸­å°±éœ€è¦ç”¨é”çš„å¹¶å‘æ§åˆ¶æ¥å¤„ç†;<br><a id="more"></a><br>æ ¹æ®åœ¨äº‹åŠ¡å¤„ç†ä¸­å¯¹ä¸´ç•Œèµ„æºåŠ é”åŠé‡Šæ”¾é”çš„é˜¶æ®µä¸åŒ,å¯åˆ†ä¸ºä¸‰ç§åŠ é”æ–¹å¼, å³<code>mysql</code>çš„<code>ä¸‰çº§å°é”åè®®</code>, <code>ä¸‰çº§å°é”åè®®</code>å¯åˆ†åˆ«è§£å†³æ•°æ®ä¸¢å¤±, è„è¯», ä¸å¯é‡å¤è¯»é—®é¢˜,å³<code>mysql</code>äº‹åŠ¡éš”ç¦»çº§åˆ«çš„è¯»æœªæäº¤, è¯»å·²æäº¤, å¯é‡è¯»; </p><p>æ­¤å¤–è¿˜æœ‰ç¬¬å››ç§éš”ç¦»çº§åˆ«, å³äº‹åŠ¡ä¸²è¡ŒåŒ–, å³æŠŠå¹¶è¡Œè½¬æ¢ä¸ºä¸²è¡Œ; ä¸‹æ–‡å°†é€šè¿‡å®é™…æ¡ˆä¾‹åˆ†æç²¾è¦å›é¡¾äº‹åŠ¡åŠäº‹åŠ¡éš”ç¦»çº§åˆ«ç­‰ç›¸å…³çŸ¥è¯†; </p><blockquote><p> å®é™…æƒ…å†µä¸‹, åœ¨è¯»å·²æäº¤åŠå¯é‡è¯»è¯»ä¸¤ä¸­éš”ç¦»çº§åˆ«ä¸‹, <code>mysql</code>/Oracle/PgSQLç­‰æ˜¯åˆ©ç”¨MVCCæ¥å¤„ç†äº‹åŠ¡ï¼Œé˜²æ­¢åŠ é”ï¼Œæ¥æé«˜è®¿é—®æ•ˆç‡;</p></blockquote><h2 id="äº‹åŠ¡å‘½ä»¤"><a href="#äº‹åŠ¡å‘½ä»¤" class="headerlink" title="äº‹åŠ¡å‘½ä»¤"></a>äº‹åŠ¡å‘½ä»¤</h2><h3 id="æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«"><a href="#æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«" class="headerlink" title="æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«"></a>æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dev@testdb&gt;show variables like '%iso%';</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">+<span class="comment">-----------------------+-----------------+</span></span><br><span class="line"></span><br><span class="line">dev@testdb&gt;select @@transaction_isolation;</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dev@testdb&gt;set transaction isolation level repeatable read;</span><br><span class="line">dev@testdb&gt;set transaction_isolation='read-uncommitted';</span><br><span class="line">dev@testdb&gt;set transaction_isolation='read-committed';</span><br><span class="line">dev@testdb&gt;set transaction_isolation='serializable';</span><br><span class="line">dev@testdb&gt;set transaction_isolation='repeatable-read';</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹ç³»ç»Ÿé”æƒ…å†µ"><a href="#æŸ¥çœ‹ç³»ç»Ÿé”æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹ç³»ç»Ÿé”æƒ…å†µ"></a>æŸ¥çœ‹ç³»ç»Ÿé”æƒ…å†µ</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dev@testdb&gt;show status like 'innodb_row_lock%';</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line">| Innodb_row_lock_current_waits | 0     |</span><br><span class="line">| Innodb_row_lock_time          | 0     |</span><br><span class="line">| Innodb_row_lock_time_avg      | 0     |</span><br><span class="line">| Innodb_row_lock_time_max      | 0     |</span><br><span class="line">| Innodb_row_lock_waits         | 0     |</span><br><span class="line">+<span class="comment">-------------------------------+-------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹å½“å‰ç³»ç»Ÿé”çš„æƒ…å†µ, å½“ç³»ç»Ÿé”äº‰ç”¨æ¯”è¾ƒä¸¥é‡çš„æ—¶å€™, <code>Innodb_row_lock_waits</code>å’Œ<code>Innodb_row_lock_time_avg</code>çš„å€¼ä¼šæ¯”è¾ƒé«˜;</li></ul><h3 id="äº‹åŠ¡æäº¤åŠå›æ»š"><a href="#äº‹åŠ¡æäº¤åŠå›æ»š" class="headerlink" title="äº‹åŠ¡æäº¤åŠå›æ»š"></a>äº‹åŠ¡æäº¤åŠå›æ»š</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">commit, rollbackç”¨æ¥ç¡®ä¿æ•°æ®åº“æœ‰è¶³å¤Ÿçš„å‰©ä½™ç©ºé—´;</span></span><br><span class="line"><span class="comment">commit,rollbackåªèƒ½ç”¨äºDMLæ“ä½œ, å³insertã€updateã€delet;</span></span><br><span class="line"><span class="comment">rollbackæ“ä½œæ’¤é”€ä¸Šä¸€ä¸ªcommitã€rollbackä¹‹åçš„äº‹åŠ¡ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span></span><br><span class="line">(</span><br><span class="line">Â PROD_ID <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">Â PROD_DESC <span class="built_in">varchar</span>(<span class="number">25</span>) Â <span class="literal">null</span>,</span><br><span class="line">Â <span class="keyword">COST</span> <span class="built_in">decimal</span>(<span class="number">6</span>,<span class="number">2</span>) Â <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line">Â </span><br><span class="line"><span class="comment">/*ç¦æ­¢è‡ªåŠ¨æäº¤*/</span></span><br><span class="line"><span class="keyword">set</span> autocommit=<span class="number">0</span>;</span><br><span class="line">Â </span><br><span class="line"><span class="comment">/*è®¾ç½®äº‹åŠ¡ç‰¹æ€§,å¿…é¡»åœ¨æ‰€æœ‰äº‹åŠ¡å¼€å§‹å‰è®¾ç½®*/</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">transaction</span> <span class="keyword">read</span> <span class="keyword">only</span>; Â <span class="comment">/*è®¾ç½®äº‹åŠ¡åªè¯»*/</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">transaction</span> <span class="keyword">read</span> write; Â <span class="comment">/*è®¾ç½®äº‹åŠ¡å¯è¯»ã€å†™*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="comment">/*å¼€å§‹ä¸€æ¬¡äº‹åŠ¡*/</span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="string">'4456'</span>,<span class="string">'mr right'</span>,<span class="number">46.97</span>);</span><br><span class="line"><span class="keyword">commit</span>; Â  Â  <span class="comment">/*ä½ç½®1*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="string">'3345'</span>,<span class="string">'mr wrong'</span>,<span class="number">54.90</span>);</span><br><span class="line"><span class="keyword">rollback</span>; Â  Â <span class="comment">/*å›åˆ°ä½ç½®1,(ä½ç½®2);ä¸Šæ¬¡commitå¤„*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="string">'1111'</span>,<span class="string">'mr wan'</span>,<span class="number">89.76</span>);</span><br><span class="line"><span class="keyword">rollback</span>; Â  Â <span class="comment">/*å›åˆ°ä½ç½®2,ä¸Šæ¬¡rollbackå¤„*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="comment">/*æµ‹è¯•ä¿å­˜ç‚¹savepoint*/</span></span><br><span class="line"><span class="keyword">savepoint</span> point1;</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">test</span></span><br><span class="line"><span class="keyword">set</span> PROD_ID=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">rollback</span> <span class="keyword">to</span> point1; Â <span class="comment">/*å›åˆ°ä¿å­˜ç‚¹point1*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="keyword">release</span> <span class="keyword">savepoint</span> point1; <span class="comment">/*åˆ é™¤ä¿å­˜ç‚¹*/</span></span><br><span class="line">Â </span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure><h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><h3 id="åŸå­æ€§-Atomicity"><a href="#åŸå­æ€§-Atomicity" class="headerlink" title="åŸå­æ€§(Atomicity)"></a><strong>åŸå­æ€§(Atomicity)</strong></h3><p>åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡åŒ…å«çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸ,è¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚å¤±è´¥å›æ»šçš„æ“ä½œäº‹åŠ¡,å°†ä¸èƒ½å¯¹äº‹åŠ¡æœ‰ä»»ä½•å½±å“ã€‚</p><h3 id="ä¸€è‡´æ€§-Consistency"><a href="#ä¸€è‡´æ€§-Consistency" class="headerlink" title="ä¸€è‡´æ€§(Consistency)"></a><strong>ä¸€è‡´æ€§(Consistency)</strong></h3><p>ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€,ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åéƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚<br>ä¾‹å¦‚: Aå’ŒBè¿›è¡Œè½¬è´¦æ“ä½œ,Aæœ‰200å—é’±,Bæœ‰300å—é’±;å½“Aè½¬äº†100å—é’±ç»™Bä¹‹å,ä»–ä»¬2ä¸ªäººçš„æ€»é¢è¿˜æ˜¯500å—é’±,ä¸ä¼šæ”¹å˜ã€‚</p><h3 id="éš”ç¦»æ€§-Isolation"><a href="#éš”ç¦»æ€§-Isolation" class="headerlink" title="éš”ç¦»æ€§(Isolation)"></a><strong>éš”ç¦»æ€§(Isolation)</strong></h3><p>éš”ç¦»æ€§æ˜¯æŒ‡å½“å¤šä¸ªç”¨æˆ·å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶,æ¯”å¦‚åŒæ—¶è®¿é—®ä¸€å¼ è¡¨,æ•°æ®åº“æ¯ä¸€ä¸ªç”¨æˆ·å¼€å¯çš„äº‹åŠ¡,ä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ“ä½œå¹²æ‰°(ä¹Ÿå°±æ˜¯äº‹åŠ¡ä¹‹é—´çš„éš”ç¦»),<font color="red">å¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´,åº”å½“ç›¸äº’éš”ç¦»</font>ã€‚<br>ä¾‹å¦‚:åŒæ—¶æœ‰T1å’ŒT2ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡,ä»T1è§’åº¦æ¥çœ‹,T2è¦ä¸åœ¨T1æ‰§è¡Œä¹‹å‰å°±å·²ç»ç»“æŸ,è¦ä¹ˆåœ¨T1æ‰§è¡Œå®Œæˆåæ‰å¼€å§‹ã€‚å°†å¤šä¸ªäº‹åŠ¡éš”ç¦»å¼€,æ¯ä¸ªäº‹åŠ¡éƒ½ä¸èƒ½è®¿é—®åˆ°å…¶ä»–äº‹åŠ¡æ“ä½œè¿‡ç¨‹ä¸­çš„çŠ¶æ€;å°±å¥½æ¯”ä¸Šé”æ“ä½œ,åªæœ‰ä¸€ä¸ªäº‹åŠ¡åšå®Œäº†,å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ‰èƒ½æ‰§è¡Œã€‚</p><h3 id="æŒä¹…æ€§-Durability"><a href="#æŒä¹…æ€§-Durability" class="headerlink" title="æŒä¹…æ€§(Durability)"></a><strong>æŒä¹…æ€§(Durability)</strong></h3><p>æŒä¹…æ€§æ˜¯æŒ‡äº‹åŠ¡çš„æ“ä½œ,ä¸€æ—¦æäº¤,å¯¹äºæ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜æ˜¯æ°¸ä¹…æ€§çš„,å³ä½¿æ•°æ®åº“å‘ç”Ÿæ•…éšœä¹Ÿä¸èƒ½ä¸¢å¤±å·²æäº¤äº‹åŠ¡æ‰€å®Œæˆçš„æ”¹å˜ã€‚</p><h2 id="éš”ç¦»çº§åˆ«"><a href="#éš”ç¦»çº§åˆ«" class="headerlink" title="éš”ç¦»çº§åˆ«"></a>éš”ç¦»çº§åˆ«</h2><h3 id="æœªæäº¤è¯»-READ-UNCOMMITTED"><a href="#æœªæäº¤è¯»-READ-UNCOMMITTED" class="headerlink" title="æœªæäº¤è¯»(READ UNCOMMITTED)"></a><strong>æœªæäº¤è¯»(READ UNCOMMITTED)</strong></h3><p>ä¸å­˜åœ¨äº‹åŠ¡éš”ç¦»çº§åˆ«çš„æ—¶, ä¼šé€ æˆæ•°æ®ä¸¢å¤±é—®é¢˜,<br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/ru0.png" alt=""><br>å¾ˆæ˜æ˜¾çš„çœ‹å‡º,æ—ºè´¢å¯¹Aæ·»åŠ çš„20å—ä¸ç¿¼è€Œé£äº†,è¿™å°±æ˜¯â€æ•°æ®ä¸¢å¤±â€,å¯¹äº‹åŠ¡ä¸åŠ ä»»ä½•é”(ä¸å­˜åœ¨äº‹åŠ¡éš”ç¦»),å°±ä¼šå¯¼è‡´è¿™ç§é—®é¢˜ã€‚</p><p>æœªæäº¤è¯»äº‹åŠ¡éš”ç¦»çº§åˆ«,<br>æœªæäº¤äº‹åŠ¡éš”ç¦»çº§åˆ«æ»¡è¶³<font color="red">ä¸€çº§å°é”åè®®, å³å†™æ•°æ®çš„æ—¶å€™æ·»åŠ ä¸€ä¸ªXé”(æ’ä»–é”),ä¹Ÿå°±æ˜¯åœ¨å†™æ•°æ®çš„æ—¶å€™ä¸å…è®¸å…¶ä»–äº‹åŠ¡è¿›è¡Œå†™æ“ä½œ,ä½†æ˜¯è¯»ä¸å—é™åˆ¶,è¯»ä¸åŠ é”</font>ã€‚<br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/ru1.png" alt=""><br>è¿™æ ·å°±å¯ä»¥è§£å†³äº†å¤šä¸ªäººä¸€èµ·å†™æ•°æ®è€Œå¯¼è‡´äº†â€æ•°æ®ä¸¢å¤±â€çš„é—®é¢˜,ä½†æ˜¯ä¼šå¼•å‘æ–°çš„é—®é¢˜â€”â€”è„è¯»ã€‚</p><p><font color="red">è„è¯»:è¯»å–äº†åˆ«äººæœªæäº¤çš„æ•°æ®</font>ã€‚<br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/ru2.png" alt=""><br>å› è€Œå¼•å…¥äº†å¦å¤–ä¸€ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«â€”â€”è¯»å·²æäº¤,</p><h3 id="è¯»å·²æäº¤-READ-COMMITTED"><a href="#è¯»å·²æäº¤-READ-COMMITTED" class="headerlink" title="è¯»å·²æäº¤(READ COMMITTED)"></a><strong>è¯»å·²æäº¤(READ COMMITTED)</strong></h3><p>è¯»å·²æäº¤æ»¡è¶³<font color="red">äºŒçº§å°é”åè®®, å³å†™æ•°æ®çš„æ—¶å€™åŠ ä¸ŠXé”(æ’ä»–é”),è¯»æ•°æ®çš„æ—¶å€™æ·»åŠ Sé”(å…±äº«é”),ä¸”å¦‚æœä¸€ä¸ªæ•°æ®åŠ äº†Xé”å°±æ²¡æ³•åŠ Sé”;åŒç†å¦‚æœåŠ äº†Sé”å°±æ²¡æ³•åŠ Xé”,ä½†æ˜¯ä¸€ä¸ªæ•°æ®å¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªSé”(å› ä¸ºåªæ˜¯è¯»æ•°æ®),å¹¶ä¸”è§„å®šSé”è¯»å–æ•°æ®,ä¸€æ—¦è¯»å–å®Œæˆå°±ç«‹åˆ»é‡Šæ”¾Sé”(ä¸ç®¡åç»­æ˜¯å¦è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ“ä½œ,åªè¦æ˜¯è¯»å–äº†Sé”çš„æ•°æ®å,å°±ç«‹åˆ»é‡Šæ”¾Sé”)ã€‚</font><br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/rc1.png" alt=""><br>è¿™æ ·å°±è§£å†³äº†è„è¯»çš„é—®é¢˜,ä½†æ˜¯åˆæœ‰æ–°çš„é—®é¢˜å‡ºç°â€”â€”ä¸å¯é‡å¤è¯»ã€‚</p><p>ä¸å¯é‡å¤è¯»:åŒä¸€ä¸ªäº‹åŠ¡å¯¹æ•°æ®çš„å¤šæ¬¡è¯»å–çš„ç»“æœä¸ä¸€è‡´ã€‚<br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/rc2.png" alt=""><br>è§£å†³æ–¹æ³•â€”â€”å¼•å…¥éš”ç¦»çº§åˆ«æ›´é«˜äº‹åŠ¡éš”ç¦»:å¯é‡å¤è¯»</p><h3 id="å¯é‡å¤è¯»-REPEATABLE-READ"><a href="#å¯é‡å¤è¯»-REPEATABLE-READ" class="headerlink" title="å¯é‡å¤è¯»(REPEATABLE READ)"></a><strong>å¯é‡å¤è¯»(REPEATABLE READ)</strong></h3><p>å¯é‡å¤è¯»æ»¡è¶³<font color="red">ç¬¬ä¸‰çº§å°é”åè®®, å³å¯¹Sé”è¿›è¡Œä¿®æ”¹,ä¹‹å‰çš„Sé”æ˜¯:è¯»å–äº†æ•°æ®ä¹‹åå°±ç«‹åˆ»é‡Šæ”¾Sé”,ç°åœ¨ä¿®æ”¹æ˜¯:åœ¨è¯»å–æ•°æ®çš„æ—¶å€™åŠ ä¸ŠSé”,ä½†æ˜¯è¦ç›´åˆ°äº‹åŠ¡å‡†å¤‡æäº¤äº†æ‰é‡Šæ”¾è¯¥Sé”,Xé”è¿˜æ˜¯ä¸€è‡´ã€‚</font><br><img src="/2018/11/07/mysql-16-transaction-isolation-level-and-acid-review/rr1.png" alt=""><br>è¿™æ ·å°±è§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜äº†,ä½†æ˜¯åˆæœ‰æ–°çš„é—®é¢˜å‡ºç°â€”â€”å¹»è¯»ã€‚</p><p>ä¾‹å¦‚: æœ‰ä¸€æ¬¡æ—ºè´¢å¯¹ä¸€ä¸ªâ€å­¦ç”Ÿè¡¨â€è¿›è¡Œæ“ä½œ,é€‰å–äº†å¹´é¾„æ˜¯18å²çš„æ‰€æœ‰è¡Œ, ç”¨Xé”é”ä½, å¹¶ä¸”åšäº†ä¿®æ”¹ã€‚</p><p>æ”¹å®Œä»¥åæ—ºè´¢å†æ¬¡é€‰æ‹©æ‰€æœ‰å¹´é¾„æ˜¯18å²çš„è¡Œ, æƒ³åšä¸€ä¸ªç¡®è®¤, æ²¡æƒ³åˆ°æœ‰ä¸€è¡Œç«Ÿç„¶æ²¡æœ‰ä¿®æ”¹ï¼</p><p>åŸæ¥å°±åœ¨æ—ºè´¢æŸ¥è¯¢å¹¶ä¿®æ”¹çš„çš„æ—¶å€™, å°å¼ºä¹Ÿå¯¹å­¦ç”Ÿè¡¨è¿›è¡Œæ“ä½œ, ä»–æ’å…¥äº†ä¸€ä¸ªæ–°çš„è¡Œ,å…¶ä¸­çš„å¹´é¾„ä¹Ÿæ˜¯18å²ï¼ è™½ç„¶ä¸¤ä¸ªäººçš„ä¿®æ”¹éƒ½æ²¡æœ‰é—®é¢˜, äº’ä¸å½±å“, ä½†æœ€ç»ˆç»“æœå¹¶éé¢„æœŸ, å³å¹»è¯»é—®é¢˜;</p><p>è§£å†³å¹»è¯»çš„æ–¹å¼â€”â€”ä¸²è¡ŒåŒ–</p><h3 id="å¯ä¸²è¡ŒåŒ–-SERIALIZABLE"><a href="#å¯ä¸²è¡ŒåŒ–-SERIALIZABLE" class="headerlink" title="å¯ä¸²è¡ŒåŒ–(SERIALIZABLE)"></a><strong>å¯ä¸²è¡ŒåŒ–(SERIALIZABLE)</strong></h3><p>äº‹åŠ¡åªèƒ½ä¸€ä»¶ä¸€ä»¶çš„è¿›è¡Œ,ä¸èƒ½å¹¶å‘è¿›è¡Œã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><table><thead><tr><th style="text-align:left">éš”ç¦»çº§åˆ«</th><th style="text-align:left">æ•°æ®ä¸¢å¤±</th><th style="text-align:left">è„è¯»</th><th style="text-align:left">ä¸å¯é‡å¤è¯»</th><th style="text-align:left">å¹»è¯»</th></tr></thead><tbody><tr><td style="text-align:left">è¯»æœªæäº¤</td><td style="text-align:left">NO</td><td style="text-align:left">YES</td><td style="text-align:left">YES</td><td style="text-align:left">YES</td></tr><tr><td style="text-align:left">è¯»å·²æäº¤</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td><td style="text-align:left">YES</td><td style="text-align:left">YES</td></tr><tr><td style="text-align:left">å¯é‡å¤è¯»</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td><td style="text-align:left">YES</td></tr><tr><td style="text-align:left">äº‹åŠ¡ä¸²è¡ŒåŒ–æ‰§è¡Œ</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td><td style="text-align:left">NO</td></tr></tbody></table><blockquote><p><code>mysql</code>é»˜è®¤çš„éš”ç¦»çº§åˆ«æ˜¯:å¯é‡å¤è¯»ã€‚</p></blockquote><blockquote><p>oracleä¸­åªæ”¯æŒ2ä¸ªéš”ç¦»çº§åˆ«:è¯»å·²æäº¤å’Œä¸²è¡ŒåŒ–, é»˜è®¤æ˜¯è¯»å·²æäº¤ã€‚</p></blockquote><blockquote><p>éš”ç¦»çº§åˆ«çš„è®¾ç½®åªå¯¹å½“å‰é“¾æ¥æœ‰æ•ˆ;</p></blockquote><h2 id="é”ç²’åº¦"><a href="#é”ç²’åº¦" class="headerlink" title="é”ç²’åº¦"></a>é”ç²’åº¦</h2><p><code>mysql</code>ä¸åŒå­˜å‚¨å¼•æ“æ”¯æŒçš„é”ç²’åº¦ä¸åŒ, InnoDBå­˜å‚¨å¼•æ“æ”¯æŒè¡¨é”åŠè¡Œé”, InnoDBå­˜å‚¨å¼•æ“å¯æ”¯æŒä¸‰ç§è¡Œé”å®šæ–¹å¼, <font color="red">é»˜è®¤åŠ é”æ–¹å¼æ˜¯next-key é”</font>ã€‚</p><ol><li>è¡Œé”(Record Lock):é”ç›´æ¥åŠ åœ¨ç´¢å¼•è®°å½•ä¸Šé¢ï¼Œé”ä½çš„æ˜¯keyã€‚ è¡Œé”åˆåˆ†ä¸ºå…±äº«é”(S)ä¸æ’ä»–é”(X);</li><li>é—´éš™é”(Gap Lock):é”å®šç´¢å¼•è®°å½•é—´éš™ï¼Œç¡®ä¿ç´¢å¼•è®°å½•çš„é—´éš™ä¸å˜ã€‚é—´éš™é”æ˜¯é’ˆå¯¹äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»æˆ–ä»¥ä¸Šçº§åˆ«è€Œå·²çš„ã€‚</li><li>Next-Key Lock: è¡Œé”å’Œé—´éš™é”ç»„åˆèµ·æ¥å°±å«Next-Key Lockã€‚ </li></ol><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBå·¥ä½œåœ¨å¯é‡å¤è¯»(Repeatable Read)éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¹¶ä¸”ä¼šä»¥Next-Key Lockçš„æ–¹å¼å¯¹æ•°æ®è¡Œè¿›è¡ŒåŠ é”ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢å¹»è¯»çš„å‘ç”Ÿã€‚Next-Key Lockæ˜¯è¡Œé”å’Œé—´éš™é”çš„ç»„åˆï¼Œå½“InnoDBæ‰«æç´¢å¼•è®°å½•çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆå¯¹ç´¢å¼•è®°å½•åŠ ä¸Šè¡Œé”ï¼ˆRecord Lockï¼‰ï¼Œå†å¯¹ç´¢å¼•è®°å½•ä¸¤è¾¹çš„é—´éš™åŠ ä¸Šé—´éš™é”ï¼ˆGap Lockï¼‰ã€‚åŠ ä¸Šé—´éš™é”ä¹‹åï¼Œå…¶ä»–äº‹åŠ¡å°±ä¸èƒ½åœ¨è¿™ä¸ªé—´éš™ä¿®æ”¹æˆ–è€…æ’å…¥è®°å½•ã€‚</p><h2 id="é—´éš™é”"><a href="#é—´éš™é”" class="headerlink" title="é—´éš™é”"></a>é—´éš™é”</h2><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><p>é—´éš™é”æŒ‡å¯¹æŸä¸ªè®°å½•è¡ŒèŒƒå›´è¿›è¡Œé”å®š, å¦‚é”å®šç¬¬ä¸€è¡Œåˆ°ç¬¬ä¸‰è¡Œ, å³é”å®š(1,3) é‚£ç¬¬ä¸€è¡Œè‡³ç¬¬ä¸‰è¡Œä¸­é—´å°±ä¸èƒ½è¿›è¡Œå†™å…¥æ“ä½œ, åŒæ—¶ç¬¬ä¸€è¡Œè‡³ç¬¬ä¸‰è¡Œæ•°æ®ä¸èƒ½è¿›è¡Œupdate/deleteç­‰ä»»ä½•ä¿®æ”¹æ“ä½œ;</p><h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>é—´éš™é”çš„ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å¹»è¯»ï¼Œå…¶ä¸»è¦é€šè¿‡ä¸¤ä¸ªæ–¹é¢å®ç°è¿™ä¸ªç›®:</p><ol><li>é˜²æ­¢é—´éš™å†…æœ‰æ–°æ•°æ®è¢«æ’å…¥;</li><li>é˜²æ­¢å·²å­˜åœ¨çš„æ•°æ®, æ›´æ–°æˆé—´éš™å†…çš„æ•°æ®;</li></ol><p>é—´éš™é”åœ¨InnoDBçš„å”¯ä¸€ä½œç”¨å°±æ˜¯é˜²æ­¢å…¶å®ƒäº‹åŠ¡çš„æ’å…¥æ“ä½œï¼Œä»¥æ­¤æ¥è¾¾åˆ°é˜²æ­¢å¹»è¯»çš„å‘ç”Ÿï¼Œæ‰€ä»¥é—´éš™é”ä¸åˆ†ä»€ä¹ˆå…±äº«é”ä¸æ’å®ƒé”ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒInnoDBå·¥ä½œåœ¨Repeatable Readéš”ç¦»çº§åˆ«ä¸‹ï¼Œå¹¶ä¸”ä»¥Next-Key Lockçš„æ–¹å¼å¯¹æ•°æ®è¡Œè¿›è¡ŒåŠ é”ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢å¹»è¯»çš„å‘ç”Ÿã€‚Next-Key Lockæ˜¯è¡Œé”ä¸é—´éš™é”çš„ç»„åˆï¼Œå½“å¯¹æ•°æ®è¿›è¡Œæ¡ä»¶ï¼ŒèŒƒå›´æ£€ç´¢æ—¶ï¼Œå¯¹å…¶èŒƒå›´å†…ä¹Ÿè®¸å¹¶å­˜åœ¨çš„å€¼è¿›è¡ŒåŠ é”ï¼å½“æŸ¥è¯¢çš„ç´¢å¼•å«æœ‰å”¯ä¸€å±æ€§ï¼ˆå”¯ä¸€ç´¢å¼•ï¼Œä¸»é”®ç´¢å¼•ï¼‰æ—¶ï¼ŒInnodbå­˜å‚¨å¼•æ“ä¼šå¯¹next-key lockè¿›è¡Œä¼˜åŒ–ï¼Œå°†å…¶é™ä¸ºrecord lock,å³ä»…é”ä½ç´¢å¼•æœ¬èº«ï¼Œè€Œä¸æ˜¯èŒƒå›´ï¼è‹¥æ˜¯æ™®é€šè¾…åŠ©ç´¢å¼•ï¼Œåˆ™ä¼šä½¿ç”¨ä¼ ç»Ÿçš„next-key lockè¿›è¡ŒèŒƒå›´é”å®šï¼</p><p>è¦ç¦æ­¢é—´éš™é”çš„è¯ï¼Œå¯ä»¥æŠŠéš”ç¦»çº§åˆ«é™ä¸ºRead Committedï¼Œæˆ–è€…å¼€å¯å‚æ•°innodb_locks_unsafe_for_binlogã€‚</p><h2 id="RRçº§åˆ«-MVCC-GL-è§£å†³å¹»è¯»é—®é¢˜"><a href="#RRçº§åˆ«-MVCC-GL-è§£å†³å¹»è¯»é—®é¢˜" class="headerlink" title="RRçº§åˆ«+MVCC+GL è§£å†³å¹»è¯»é—®é¢˜"></a>RRçº§åˆ«+MVCC+GL è§£å†³å¹»è¯»é—®é¢˜</h2><p>åœ¨MVCCå¹¶å‘æ§åˆ¶ä¸­ï¼Œè¯»æ“ä½œå¯ä»¥åˆ†æˆä¸¤ç±»:å¿«ç…§è¯» (snapshot read)ä¸å½“å‰è¯» (current read)ã€‚</p><ol><li>å¿«ç…§è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•çš„å¯è§ç‰ˆæœ¬ (æœ‰å¯èƒ½æ˜¯å†å²ç‰ˆæœ¬)ï¼Œä¸ç”¨åŠ é”ã€‚</li><li>å½“å‰è¯»ï¼Œè¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶ä¸”ï¼Œå½“å‰è¯»è¿”å›çš„è®°å½•ï¼Œéƒ½ä¼šåŠ ä¸Šé”ï¼Œä¿è¯å…¶ä»–äº‹åŠ¡ä¸ä¼šå†å¹¶å‘ä¿®æ”¹è¿™æ¡è®°å½•ã€‚ </li></ol><p>åœ¨ä¸€ä¸ªæ”¯æŒMVCCå¹¶å‘æ§åˆ¶çš„ç³»ç»Ÿä¸­ï¼Œå“ªäº›è¯»æ“ä½œæ˜¯å¿«ç…§è¯»ï¼Ÿå“ªäº›æ“ä½œåˆæ˜¯å½“å‰è¯»å‘¢ï¼Ÿä»¥<code>mysql</code> InnoDBä¸ºä¾‹: </p><p>å¿«ç…§è¯»:ç®€å•çš„selectæ“ä½œï¼Œå±äºå¿«ç…§è¯»ï¼Œä¸åŠ é”ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> ?;</span><br></pre></td></tr></table></figure><p>å½“å‰è¯»:ç‰¹æ®Šçš„è¯»æ“ä½œï¼Œæ’å…¥/æ›´æ–°/åˆ é™¤æ“ä½œï¼Œå±äºå½“å‰è¯»ï¼Œéœ€è¦åŠ é”ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> ? <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> ? <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> <span class="keyword">values</span> (â€¦);</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">table</span> <span class="keyword">set</span> ? <span class="keyword">where</span> ?;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">table</span> <span class="keyword">where</span> ?;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰ä»¥ä¸Šçš„è¯­å¥ï¼Œéƒ½å±äºå½“å‰è¯»ï¼Œè¯»å–è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ã€‚å¹¶ä¸”ï¼Œè¯»å–ä¹‹åï¼Œè¿˜éœ€è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œå¯¹è¯»å–è®°å½•åŠ é”ã€‚å…¶ä¸­ï¼Œé™¤äº†ç¬¬ä¸€æ¡è¯­å¥ï¼Œå¯¹è¯»å–è®°å½•åŠ Sé” (å…±äº«é”)å¤–ï¼Œå…¶ä»–çš„æ“ä½œï¼Œéƒ½åŠ çš„æ˜¯Xé” (æ’å®ƒé”)ã€‚ </p><p>å›é¡¾4ç§éš”ç¦»çº§åˆ«:<br>Read Uncommited<br>å¯ä»¥è¯»å–æœªæäº¤è®°å½•ã€‚æ­¤éš”ç¦»çº§åˆ«ï¼Œä¸ä¼šä½¿ç”¨ï¼Œå¿½ç•¥ã€‚</p><p>Read Committed (RC)<br>å¿«ç…§è¯»å¿½ç•¥ï¼Œæœ¬æ–‡ä¸è€ƒè™‘ã€‚</p><p>é’ˆå¯¹å½“å‰è¯»ï¼ŒRCéš”ç¦»çº§åˆ«ä¿è¯å¯¹è¯»å–åˆ°çš„è®°å½•åŠ é” (record lock)ï¼Œå­˜åœ¨å¹»è¯»ç°è±¡ã€‚</p><p>Repeatable Read (RR)<br>å¿«ç…§è¯»å¿½ç•¥ï¼Œæœ¬æ–‡ä¸è€ƒè™‘ã€‚</p><p>é’ˆå¯¹å½“å‰è¯»ï¼ŒRRéš”ç¦»çº§åˆ«ä¿è¯å¯¹è¯»å–åˆ°çš„è®°å½•åŠ é” (è®°å½•é”)ï¼ŒåŒæ—¶ä¿è¯å¯¹è¯»å–çš„èŒƒå›´åŠ é”ï¼Œæ–°çš„æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è®°å½•ä¸èƒ½å¤Ÿæ’å…¥ (é—´éš™é”)ï¼Œä¸å­˜åœ¨å¹»è¯»ç°è±¡ã€‚</p><p>Serializable<br>ä»MVCCå¹¶å‘æ§åˆ¶é€€åŒ–ä¸ºåŸºäºé”çš„å¹¶å‘æ§åˆ¶ã€‚ä¸åŒºåˆ«å¿«ç…§è¯»ä¸å½“å‰è¯»ï¼Œæ‰€æœ‰çš„è¯»æ“ä½œå‡ä¸ºå½“å‰è¯»ï¼Œè¯»åŠ è¯»é” (Sé”)ï¼Œå†™åŠ å†™é” (Xé”)ã€‚</p><p>Serializableéš”ç¦»çº§åˆ«ä¸‹ï¼Œè¯»å†™å†²çªï¼Œå› æ­¤å¹¶å‘åº¦æ€¥å‰§ä¸‹é™ï¼Œåœ¨<code>mysql/InnoDB</code>ä¸‹ä¸å»ºè®®ä½¿ç”¨ã€‚<br>å¯¹äºå¿«ç…§è¯»æ¥è¯´ï¼Œå¹»è¯»çš„è§£å†³æ˜¯ä¾èµ–mvccè§£å†³ã€‚è€Œå¯¹äºå½“å‰è¯»åˆ™ä¾èµ–äºgap-lockè§£å†³ã€‚</p><p>æ­¤å¤–, å¯¹äºå¿«ç…§è¯»æ¥è¯´ï¼Œå¹»è¯»çš„è§£å†³æ˜¯ä¾èµ–mvccè§£å†³ã€‚è€Œå¯¹äºå½“å‰è¯»åˆ™ä¾èµ–äºgap-lockè§£å†³ã€‚</p><p>æ›´å¤šå‚è€ƒ: <a href="https://www.cnblogs.com/aspirant/p/6920987.html" target="_blank" rel="noopener">Mysql çš„InnoDBäº‹åŠ¡æ–¹é¢çš„ å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶å¦‚ä½•å®ç° MVCC</a></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>å›é¡¾äº†äº‹åŠ¡ç›¸å…³æ“ä½œå‘½ä»¤;</li><li>å›é¡¾äº†äº‹åŠ¡çš„ACIDç‰¹æ€§åŠå››çº§éš”ç¦»çº§åˆ«, ä¸‰çº§å°é”åè®®ç›¸å…³çŸ¥è¯†;</li><li>å›é¡¾é”ç²’åº¦(è¡¨é”/è¡Œé”(S/Xé”)), åŠè¡Œé”çš„ä¸‰ç§æ–¹å¼(RL,GL, NKL);</li><li>è¿›ä¸€æ­¥å›é¡¾äº†Gap Lockç›¸å…³çŸ¥è¯†;</li><li>å›é¡¾äº†Next Key Lock + MVCC åœ¨RRéš”ç¦»çº§åˆ«ä¸‹è§£å†³å¹»è¯»åŸç†;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;äº‹åŠ¡æŒ‡çš„æ˜¯æ»¡è¶³&lt;code&gt;ACID&lt;/code&gt;ç‰¹æ€§çš„ä¸€ç»„æ“ä½œ,&lt;code&gt;mysql&lt;/code&gt;ä¸­å¯ä»¥é€šè¿‡&lt;code&gt;commit&lt;/code&gt;æäº¤ä¸€ä¸ªäº‹åŠ¡,ä¹Ÿå¯ä»¥ä½¿ç”¨&lt;code&gt;rollback&lt;/code&gt;è¿›è¡Œå›æ»šã€‚ åœ¨å¹¶å‘åœºæ™¯ä¸­å¾ˆéš¾ä¿è¯äº‹åŠ¡çš„&lt;code&gt;Isolation&lt;/code&gt;ç‰¹æ€§, å³æ— æ³•ä¿è¯ä¸´ç•Œèµ„æºçš„æ’å®ƒæ€§æ“ä½œ, ä»è€Œå¼•å‘æ•°æ®ä¸€è‡´æ€§é—®é¢˜, ä¸´ç•Œèµ„æºäº’æ–¥é—®é¢˜æ˜¾ç„¶éœ€è¦å€ŸåŠ©åŠ é”æ¥è§£å†³, åœ¨å¹¶å‘äº‹åŠ¡ä¸­å°±éœ€è¦ç”¨é”çš„å¹¶å‘æ§åˆ¶æ¥å¤„ç†;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysqlä¸“é¢˜" scheme="http://researchlab.github.io/categories/mysql%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="mysql" scheme="http://researchlab.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜17 ä¸»ä»åŒæ­¥ç³»åˆ—é—®é¢˜</title>
    <link href="http://researchlab.github.io/2018/10/15/redis-17-replication/"/>
    <id>http://researchlab.github.io/2018/10/15/redis-17-replication/</id>
    <published>2018-10-15T19:03:25.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ç”¨åˆ°<code>redis</code>åšæ•°æ®æŒä¹…åŒ–è½åœ°æ•°æ®åº“æ—¶,  ä¸€èˆ¬åº”æ­å»ºä¸“å±çš„<code>redis</code>é›†ç¾¤æ¥é¿å…å•ç‚¹æ•…éšœåŠå•ç‚¹è¯»å†™æ€§èƒ½é—®é¢˜, å¦‚ä¸æ˜¯é‡åº¦<code>redis</code>ç”¨æˆ·, æ•°æ®é‡å‹åŠ›ä¸æ˜¯ç‰¹åˆ«å¤§æ—¶, ä¹Ÿå¯ä»¥è€ƒè™‘é‡‡ç”¨<code>redis</code>ä¸»ä»åŒæ­¥æ¶æ„ä»£æ›¿, æœ¬æ–‡å°†è¯•å›¾å¯¹<code>redis</code>ä¸»ä»åŒæ­¥åŸç†, æ­¥éª¤, é…ç½®é¡¹, å®è·µç­‰æ–¹é¢è¿›è¡Œå­¦ä¹ æ€»ç»“;<br><a id="more"></a></p><h5 id="ä¸»ä»åŒæ­¥ç›®çš„"><a href="#ä¸»ä»åŒæ­¥ç›®çš„" class="headerlink" title="ä¸»ä»åŒæ­¥ç›®çš„"></a>ä¸»ä»åŒæ­¥ç›®çš„</h5><blockquote><p>ä¸€æ—¦ä¸»èŠ‚ç‚¹å®•æœº, ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹çš„å¤‡ä»½å¯ä»¥éšæ—¶é¡¶ä¸Šæ¥;<br>æ‰©å±•ä¸»èŠ‚ç‚¹çš„è¯»èƒ½åŠ›, åˆ†æ‹…ä¸»èŠ‚ç‚¹è¯»å‹åŠ›;</p></blockquote><h5 id="ä¸»ä»åŒæ­¥åŸç†"><a href="#ä¸»ä»åŒæ­¥åŸç†" class="headerlink" title="ä¸»ä»åŒæ­¥åŸç†"></a>ä¸»ä»åŒæ­¥åŸç†</h5><p><code>redis</code>æ”¯æŒä¸»ä»å¤åˆ¶, <code>redis</code>çš„ä¸»ä»ç»“æ„å¯ä»¥é‡‡ç”¨ä¸€ä¸»å¤šä»æˆ–è€…çº§è”ç»“æ„, <code>redis</code>ä¸»ä»å¤åˆ¶å¯ä»¥æ ¹æ®æ˜¯å¦æ˜¯å…¨é‡åˆ†ä¸ºå…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">       /  slave-1  /  slave-2-1</span><br><span class="line">Master -  slave-2--   slave-2-2</span><br><span class="line">       \  slave-3  \  slave-2-3</span><br><span class="line">        \ ...      \  ...</span><br><span class="line">          slave-n     slave-2-n</span><br></pre></td></tr></table></figure></p><h6 id="å…¨é‡åŒæ­¥"><a href="#å…¨é‡åŒæ­¥" class="headerlink" title="å…¨é‡åŒæ­¥"></a>å…¨é‡åŒæ­¥</h6><p><code>redis</code>å…¨é‡å¤åˆ¶ä¸€èˆ¬å‘ç”Ÿåœ¨<code>slave</code>åˆå§‹åŒ–é˜¶æ®µ, è¿™æ—¶<code>slave</code>éœ€è¦å°†Masterä¸Šçš„æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶ä¸€ä»½, å…·ä½“è¿‡ç¨‹å¦‚ä¸‹,</p><ul><li>1.ä»æœåŠ¡å™¨è¿æ¥ä¸»æœåŠ¡å™¨, å‘é€<code>sync</code>å‘½ä»¤;</li><li>2.ä¸»æœåŠ¡å™¨æ¥æ”¶åˆ°<code>sync</code>å‘½åå, å¼€å§‹æ‰§è¡Œ<code>bgsave</code>å‘½ä»¤ç”ŸæˆRDBæ–‡ä»¶å¹¶ä½¿ç”¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºè®°å½•æ­¤åæ‰§è¡Œçš„æ‰€æœ‰å†™å‘½ä»¤;</li><li>3.ä¸»æœåŠ¡å™¨<code>bgsave</code>æ‰§è¡Œå®Œå, å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€å¿«ç…§æ–‡ä»¶, å¹¶åœ¨å‘é€æœŸé—´ç»§ç»­è®°å½•è¢«æ‰§è¡Œçš„å†™å‘½ä»¤;</li><li>4.ä»æœåŠ¡å™¨æ”¶åˆ°å¿«ç…§æ–‡ä»¶åä¸¢å¼ƒæ‰€æœ‰æ—§æ•°æ®, è½½å…¥æ”¶åˆ°çš„å¿«ç…§;</li><li>5.ä¸»æœåŠ¡å™¨å¿«ç…§å‘é€å®Œæ¯•åå¼€å§‹å‘ä»æœåŠ¡å™¨å‘é€ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤;</li><li>6.ä»æœåŠ¡å™¨å®Œæˆå¯¹å¿«ç…§çš„è½½å…¥, å¼€å§‹æ¥æ”¶å‘½ä»¤è¯·æ±‚, å¹¶æ‰§è¡Œæ¥è‡ªä¸»æœåŠ¡å™¨ç¼“å†²åŒºçš„å†™å‘½ä»¤;</li></ul><p>å®Œæˆä¸Šé¢å‡ ä¸ªæ­¥éª¤åå°±å®Œæˆäº†ä»æœåŠ¡å™¨æ•°æ®åˆå§‹åŒ–çš„æ‰€æœ‰æ“ä½œ, ä»æœåŠ¡å™¨æ­¤æ—¶å¯ä»¥æ¥æ”¶æ¥è‡ªç”¨æˆ·çš„è¯»è¯·æ±‚ã€‚</p><blockquote><p>è‹¥å¤šä¸ªä»æœåŠ¡å™¨åŒæ—¶å‘æ¥<code>sync</code>æŒ‡ä»¤, ä¸»æœåŠ¡å™¨ä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡<code>bgsave</code>, ç„¶åæŠŠæŒä¹…åŒ–å¥½çš„RDBæ–‡ä»¶å‘ç»™å¤šä¸ªä¸‹æ¸¸;</p></blockquote><h6 id="å¢é‡åŒæ­¥"><a href="#å¢é‡åŒæ­¥" class="headerlink" title="å¢é‡åŒæ­¥"></a>å¢é‡åŒæ­¥</h6><p>åœ¨redis2.8ä¹‹å‰, redisä»…æ”¯æŒ<code>sync</code>å…¨é‡åŒæ­¥æ“ä½œ, <code>sync</code>å‘½ä»¤æ˜¯ä¸€ä¸ªéå¸¸è€—è´¹èµ„æºçš„æ“ä½œ, ä¸ºäº†è§£å†³ä¸»ä»æœåŠ¡å™¨æ–­çº¿é‡æ¥å¸¦æ¥çš„<code>sync</code>é‡å¤å¤åˆ¶é—®é¢˜, <code>redis</code>ä»2.8ç‰ˆæœ¬å¼€å§‹, ä½¿ç”¨<code>psync</code>å‘½ä»¤ä»£æ›¿<code>sync</code>å‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„åŒæ­¥æ“ä½œã€‚<br><code>psync</code>å‘½ä»¤å…·æœ‰å®Œæ•´é‡åŒæ­¥<code>(full resynchronization)</code>å’Œå¢é‡é‡åŒæ­¥<code>(partial resynchronization)</code>ä¸¤ç§æ¨¡å¼, è€Œå¢é‡åŒæ­¥ç­–ç•¥å¤§å¤§é™ä½äº†è¿æ¥æ–­å¼€çš„æ¢å¤æˆæœ¬ã€‚å¢é‡åŒæ­¥è¿‡ç¨‹å¦‚ä¸‹,</p><ul><li>1.<code>master</code>ç«¯ä¸ºå¤åˆ¶æµç»´æŠ¤ä¸€ä¸ªå†…å­˜ç¼“å†²åŒº<code>(in-memory backlog)</code>, è®°å½•æœ€è¿‘å‘é€çš„å¤åˆ¶æµå‘½ä»¤;</li><li>2.åŒæ—¶, Masterå’Œ<code>slave</code>ä¹‹é—´éƒ½ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡<code>(replication offset)</code>å’Œå½“å‰<code>master</code>æœåŠ¡å™¨<code>ID(Masterrun id)</code>ã€‚</li><li>3.å½“ç½‘ç»œæ–­å¼€, <code>slave</code>å°è¯•é‡è¿æ—¶:<ul><li>a. å¦‚æœ<code>masterID</code>ç›¸åŒ(å³ä»æ˜¯æ–­ç½‘å‰çš„<code>master</code>æœåŠ¡å™¨), å¹¶ä¸”ä»æ–­å¼€æ—¶åˆ°å½“å‰æ—¶åˆ»çš„å†å²å‘½ä»¤ä¾ç„¶åœ¨<code>master</code>çš„å†…å­˜ç¼“å†²åŒºä¸­å­˜åœ¨, åˆ™Masterä¼šå°†ç¼ºå¤±çš„è¿™æ®µæ—¶é—´çš„æ‰€æœ‰å‘½ä»¤å‘é€ç»™<code>slave</code>æ‰§è¡Œ, ç„¶åå¤åˆ¶å·¥ä½œå°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†;</li><li>b. å¦åˆ™, ä¾ç„¶éœ€è¦å…¨é‡å¤åˆ¶æ“ä½œ;</li></ul></li></ul><blockquote><p>å¢é‡å¤åˆ¶çš„è¿‡ç¨‹ä¸»è¦æ˜¯ä¸»æœåŠ¡å™¨æ¯æ‰§è¡Œä¸€ä¸ªå†™å‘½ä»¤å°±ä¼šå‘ä»æœåŠ¡å™¨å‘é€ç›¸åŒçš„å†™å‘½ä»¤, ä»æœåŠ¡å™¨æ¥æ”¶å¹¶æ‰§è¡Œæ”¶åˆ°çš„å†™å‘½ä»¤ã€‚</p></blockquote><p>å¯è§å¢é‡é‡åŒæ­¥åŠŸèƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆ,</p><ul><li>1.ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡<code>(replication offset)</code>å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡;</li><li>2.ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒº<code>(replication backlog)</code>;</li><li>3.æœåŠ¡å™¨çš„è¿è¡Œ<code>ID(run ID)</code>ã€‚</li></ul><p><strong>1.å¤åˆ¶åç§»é‡</strong></p><p>æ‰§è¡Œå¤åˆ¶çš„åŒæ–¹â€”â€”ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡,</p><ul><li>ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­<code>N</code>ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶, å°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š<code>N</code>;</li><li>ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„<code>N</code>ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶, å°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š<code>N</code>;</li></ul><blockquote><p>ä¸»ä»åç§»é‡ç›¸åŒ, åˆ™å½“å‰ä¸»ä»å¤„äºä¸€è‡´çŠ¶æ€, åä¹‹åˆ™ä¸»ä»çŠ¶æ€ä¸ä¸€è‡´;</p></blockquote><p>ç¤ºä¾‹åˆ†æ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                          --(ç½‘ç»œæ•…éšœæ–­çº¿  )--&gt; slaveA ( offset=10086 )</span><br><span class="line">                        /</span><br><span class="line">                       /</span><br><span class="line">Master ( offset=10119 )-----(æˆåŠŸå‘é€33å­—èŠ‚)--&gt; slaveB ( offset=10119 )</span><br><span class="line">                       \</span><br><span class="line">                        \</span><br><span class="line">                          --(æˆåŠŸå‘é€33å­—èŠ‚)--&gt; slaveC ( offset=10119 )</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šç¤ºä¾‹, å‡è®¾ä»æœåŠ¡å™¨<code>A</code>åœ¨æ–­çº¿ä¹‹åå°±ç«‹å³é‡æ–°è¿æ¥ä¸»æœåŠ¡å™¨æˆåŠŸ, é‚£ä¹ˆæ¥ä¸‹æ¥, ä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€<code>psync</code>å‘½ä»¤, æŠ¥å‘Šä»æœåŠ¡å™¨Aå½“å‰çš„å¤åˆ¶åç§»é‡ä¸º<code>10086</code>, é‚£ä¹ˆè¿™æ—¶, ä¸»æœåŠ¡å™¨åº”è¯¥å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥è¿˜æ˜¯éƒ¨åˆ†é‡åŒæ­¥å‘¢ï¼Ÿå¦‚æœæ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥çš„è¯, ä¸»æœåŠ¡å™¨åˆå¦‚ä½•è¡¥å¿ä»æœåŠ¡å™¨<code>A</code>åœ¨æ–­çº¿æœŸé—´ä¸¢å¤±çš„é‚£éƒ¨åˆ†æ•°æ®å‘¢ï¼Ÿä»¥ä¸Šé—®é¢˜çš„ç­”æ¡ˆéƒ½å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºæœ‰å…³ã€‚</p><p><strong>2.å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</strong><br>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦<code>(fixed-size)</code>å…ˆè¿›å…ˆå‡º<code>(FIFO)</code>é˜Ÿåˆ—, é»˜è®¤å¤§å°ä¸º<code>1MB</code>ã€‚</p><p>å’Œæ™®é€šå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—éšç€å…ƒç´ çš„å¢åŠ å’Œå‡å°‘è€ŒåŠ¨æ€è°ƒæ•´é•¿åº¦ä¸åŒ, å›ºå®šé•¿åº¦å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—çš„é•¿åº¦æ˜¯å›ºå®šçš„, å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶, æœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡º, è€Œæ–°å…ƒç´ ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—ã€‚</p><p>å½“ä¸»æœåŠ¡å™¨å‘ä»æœåŠ¡å™¨å‘é€å‘½ä»¤æ—¶, å®ƒä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™æ‰€æœ‰ä»æœåŠ¡å™¨, è¿˜ä¼šå°†å†™å‘½ä»¤å…¥é˜Ÿåˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢, ç¤ºæ„å›¾,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">          --(å‘ä»æœåŠ¡å™¨å‘é€å‘½ä»¤)--&gt; slaveA</span><br><span class="line">        /</span><br><span class="line">       /</span><br><span class="line">Master -----(å‘ä»æœåŠ¡å™¨å‘é€å‘½ä»¤)--&gt; slave...</span><br><span class="line">       \</span><br><span class="line">        \</span><br><span class="line">          --(åŒæ­¥å°†å‘½ä»¤å†™å…¥é˜Ÿåˆ—)--&gt; | å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé˜Ÿåˆ— |</span><br></pre></td></tr></table></figure><p>å› æ­¤, ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢ä¼šä¿å­˜ç€ä¸€éƒ¨åˆ†æœ€è¿‘å‘é€çš„å†™å‘½ä»¤, å¹¶ä¸”å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡, å°±åƒä¸‹è¡¨æ‰€ç¤ºçš„é‚£æ ·,</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|åç§»é‡| 10086 | 10087 | 10088 | 10089 |</span><br><span class="line">|å­—èŠ‚å€¼|   &apos;*&apos; |   5   | &apos;\r&apos;  | &apos;\n&apos;  |</span><br></pre></td></tr></table></figure><p>å½“ä»æœåŠ¡å™¨é‡æ–°è¿ä¸Šä¸»æœåŠ¡å™¨æ—¶, ä»æœåŠ¡å™¨ä¼šé€šè¿‡<code>psync</code>å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡offsetå‘é€ç»™ä¸»æœåŠ¡å™¨, ä¸»æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå¤åˆ¶åç§»é‡æ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œä½•ç§åŒæ­¥æ“ä½œ:</p><blockquote><p>å¦‚æœ<code>offset</code>åç§»é‡ä¹‹åçš„æ•°æ®(ä¹Ÿå³æ˜¯åç§»é‡<code>offset+1</code>å¼€å§‹çš„æ•°æ®)ä»ç„¶å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢, é‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œ;</p></blockquote><blockquote><p>ç›¸å, å¦‚æœ<code>offset</code>åç§»é‡ä¹‹åçš„æ•°æ®å·²ç»ä¸å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒº, é‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚</p></blockquote><p><strong>æ ¹æ®éœ€è¦è°ƒæ•´å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°</strong></p><p><code>redis</code>ä¸ºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºè®¾ç½®çš„é»˜è®¤å¤§å°ä¸º<code>1MB</code>, å¦‚æœä¸»æœåŠ¡å™¨éœ€è¦æ‰§è¡Œå¤§é‡å†™å‘½ä»¤, åˆæˆ–è€…ä¸»ä»æœåŠ¡å™¨æ–­çº¿åé‡è¿æ¥æ‰€éœ€çš„æ—¶é—´æ¯”è¾ƒé•¿, é‚£ä¹ˆè¿™ä¸ªå¤§å°ä¹Ÿè®¸å¹¶ä¸åˆé€‚ã€‚å¦‚æœå¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°è®¾ç½®å¾—ä¸æ°å½“, é‚£ä¹ˆ<code>psync</code>å‘½ä»¤çš„å¤åˆ¶é‡åŒæ­¥æ¨¡å¼å°±ä¸èƒ½æ­£å¸¸å‘æŒ¥ä½œç”¨, å› æ­¤, æ­£ç¡®ä¼°ç®—å’Œè®¾ç½®å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°éå¸¸é‡è¦ã€‚<br>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„æœ€å°å¤§å°å¯ä»¥æ ¹æ®å…¬å¼<code>second*write_size_per_second</code>æ¥ä¼°ç®—:</p><blockquote><p>å…¶ä¸­<code>second</code>ä¸ºä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡æ—¶é—´(ä»¥ç§’è®¡ç®—);</p></blockquote><blockquote><p>è€Œ<code>write_size_per_second</code>åˆ™æ˜¯ä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿçš„å†™å‘½ä»¤æ•°æ®é‡(åè®®æ ¼å¼çš„å†™å‘½ä»¤çš„é•¿åº¦æ€»å’Œ);</p></blockquote><p>ä¾‹å¦‚, å¦‚æœä¸»æœåŠ¡å™¨å¹³å‡æ¯ç§’äº§ç”Ÿ<code>1MB</code>çš„å†™æ•°æ®, è€Œä»æœåŠ¡å™¨æ–­çº¿ä¹‹åå¹³å‡è¦<code>5ç§’</code>æ‰èƒ½é‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨, é‚£ä¹ˆå¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°å°±ä¸èƒ½ä½äº<code>5MB</code>ã€‚<br>ä¸ºäº†å®‰å…¨èµ·è§, å¯ä»¥å°†å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°è®¾ä¸º<code>2*second*write_size_per_second</code>, è¿™æ ·å¯ä»¥ä¿è¯ç»å¤§éƒ¨åˆ†æ–­çº¿æƒ…å†µéƒ½èƒ½ç”¨éƒ¨åˆ†é‡åŒæ­¥æ¥å¤„ç†ã€‚<br>å¯ä»¥æ ¹æ®å®é™…éœ€è¦, ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„<code>repl-backlog-size</code>é€‰é¡¹æ¥ä¿®æ”¹å¤åˆ¶ç§¯å‹ç¼“å†²åŒºçš„å¤§å°;</p><p><strong>3.æœåŠ¡å™¨è¿è¡ŒID</strong><br>é™¤äº†å¤åˆ¶åç§»é‡å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¹‹å¤–, å®ç°éƒ¨åˆ†é‡åŒæ­¥è¿˜éœ€è¦ç”¨åˆ°æœåŠ¡å™¨è¿è¡Œ<code>ID(run ID)</code>:</p><blockquote><p>æ¯ä¸ª<code>redis</code>æœåŠ¡å™¨, ä¸è®ºä¸»æœåŠ¡å™¨è¿˜æ˜¯ä»æœåŠ¡, éƒ½ä¼šæœ‰è‡ªå·±çš„è¿è¡Œ<code>ID</code>;</p></blockquote><blockquote><p>è¿è¡Œ<code>ID</code>åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆ, ç”±40ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ, ä¾‹å¦‚<code>53b9b28df8042fdc9ab5e3fcbbbabff1d5dce2b3</code>;</p></blockquote><p>å½“ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶æ—¶, ä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±çš„è¿è¡Œ<code>ID</code>ä¼ é€ç»™ä»æœåŠ¡å™¨, è€Œä»æœåŠ¡å™¨åˆ™ä¼šå°†è¿™ä¸ªè¿è¡Œ<code>ID</code>ä¿å­˜èµ·æ¥(æ³¨æ„å“¦, æ˜¯ä»æœåŠ¡å™¨ä¿å­˜äº†ä¸»æœåŠ¡å™¨çš„<code>ID</code>)ã€‚</p><p>å½“ä»æœåŠ¡å™¨æ–­çº¿å¹¶é‡æ–°è¿ä¸Šä¸€ä¸ªä¸»æœåŠ¡å™¨æ—¶, ä»æœåŠ¡å™¨å°†å‘å½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨å‘é€ä¹‹å‰ä¿å­˜çš„è¿è¡Œ<code>ID</code>:</p><blockquote><p>å¦‚æœä»æœåŠ¡å™¨ä¿å­˜çš„è¿è¡Œ<code>ID</code>å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ<code>ID</code>ç›¸åŒ, é‚£ä¹ˆè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„å°±æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨, ä¸»æœåŠ¡å™¨å¯ä»¥ç»§ç»­å°è¯•æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œ;</p></blockquote><blockquote><p>ç›¸ååœ°, å¦‚æœä»æœåŠ¡å™¨ä¿å­˜çš„è¿è¡Œ<code>ID</code>å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ<code>ID</code>å¹¶ä¸ç›¸åŒ, é‚£ä¹ˆè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å¹¶ä¸æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨, ä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œã€‚</p></blockquote><p><strong>psyncå‘½ä»¤</strong><br><code>psync</code>å‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§,</p><blockquote><p>å¦‚æœä»æœåŠ¡å™¨ä»¥å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨, æˆ–è€…ä¹‹å‰æ‰§è¡Œè¿‡<code>SLAVEOF NO ONE</code>å‘½ä»¤, é‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€<code>psync ? -1</code>å‘½ä»¤, ä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥(å› ä¸ºè¿™æ—¶ä¸å¯èƒ½æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥);</p></blockquote><blockquote><p>ç›¸ååœ°, å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨, é‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€<code>psync &lt;runid&gt; &lt;offset&gt;</code>å‘½ä»¤: å…¶ä¸­<code>runid</code>æ˜¯ä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ<code>ID</code>, è€Œ<code>offset</code>åˆ™æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡, æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šé€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°æ¥åˆ¤æ–­åº”è¯¥å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå“ªç§åŒæ­¥æ“ä½œã€‚</p></blockquote><h5 id="ä¸»ä»åŒæ­¥ç­–ç•¥"><a href="#ä¸»ä»åŒæ­¥ç­–ç•¥" class="headerlink" title="ä¸»ä»åŒæ­¥ç­–ç•¥"></a>ä¸»ä»åŒæ­¥ç­–ç•¥</h5><p><code>redis</code> çš„å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„, <code>redis3.0</code>å¼€å§‹æä¾›çš„<code>wait</code>æŒ‡ä»¤å¯ä»¥è®©å¼‚æ­¥å¤åˆ¶å˜èº«åŒæ­¥å¤åˆ¶, ç¡®ä¿ç³»ç»Ÿçš„å¼ºä¸€è‡´æ€§,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; set key value</span><br><span class="line">OK</span><br><span class="line">&gt; wait 1 0</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure></p><p>wait æä¾›ä¸¤ä¸ªå‚æ•°, ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»åº“çš„æ•°é‡<code>N</code>, ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ—¶é—´<code>t</code>, ä»¥æ¯«ç§’ä¸ºå•ä½ã€‚å®ƒè¡¨ç¤ºç­‰å¾…<code>wait</code>æŒ‡ä»¤ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œåŒæ­¥åˆ°<code>N</code>ä¸ªä»åº“ (ä¹Ÿå°±æ˜¯ç¡®ä¿<code>N</code>ä¸ªä»åº“çš„åŒæ­¥æ²¡æœ‰æ»å), æœ€å¤šç­‰å¾…æ—¶é—´<code>t</code>ã€‚å¦‚æœæ—¶é—´<code>t=0</code>, è¡¨ç¤ºæ— é™ç­‰å¾…ç›´åˆ°<code>N</code>ä¸ªä»åº“åŒæ­¥å®Œæˆè¾¾æˆä¸€è‡´ã€‚</p><p>å‡è®¾æ­¤æ—¶å‡ºç°äº†ç½‘ç»œåˆ†åŒº,<code>wait</code>æŒ‡ä»¤ç¬¬äºŒä¸ªå‚æ•°æ—¶é—´<code>t=0</code>, ä¸»ä»åŒæ­¥æ— æ³•ç»§ç»­è¿›è¡Œ, <code>wait</code>æŒ‡ä»¤ä¼šæ°¸è¿œé˜»å¡, <code>redis</code>æœåŠ¡å™¨å°†ä¸§å¤±å¯ç”¨æ€§ã€‚</p><p><strong>ä¸»ä»åˆšåˆšè¿æ¥çš„æ—¶å€™, è¿›è¡Œå…¨é‡åŒæ­¥; å…¨åŒæ­¥ç»“æŸå, è¿›è¡Œå¢é‡åŒæ­¥ã€‚å½“ç„¶, å¦‚æœæœ‰éœ€è¦, slaveåœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥å‘èµ·å…¨é‡åŒæ­¥ã€‚redisç­–ç•¥æ˜¯, æ— è®ºå¦‚ä½•, é¦–å…ˆä¼šå°è¯•è¿›è¡Œå¢é‡åŒæ­¥, å¦‚ä¸æˆåŠŸ, è¦æ±‚ä»æœºè¿›è¡Œå…¨é‡åŒæ­¥ã€‚</strong></p><h5 id="ä¸»ä»åŒæ­¥è¿‡ç¨‹"><a href="#ä¸»ä»åŒæ­¥è¿‡ç¨‹" class="headerlink" title="ä¸»ä»åŒæ­¥è¿‡ç¨‹"></a>ä¸»ä»åŒæ­¥è¿‡ç¨‹</h5><p>ä»æœåŠ¡å™¨æ¯æ¬¡å¯åŠ¨æ—¶, ä¼šç«‹å³é€šè¿‡<code>slaveof master-host  master-port</code> å‘ä¸»æœåŠ¡å™¨å‘èµ·ä¸»ä»å¤åˆ¶åŒæ­¥è¯·æ±‚; <code>SLAVEOF</code>å‘½ä»¤æ˜¯ä¸€ä¸ªå¼‚æ­¥å‘½ä»¤, åœ¨å®Œæˆ<code>master-host</code>å±æ€§å’Œ<code>master-port</code>å±æ€§çš„è®¾ç½®å·¥ä½œä¹‹å, ä»æœåŠ¡å™¨å°†å‘å‘é€<code>SLAVEOF</code>å‘½ä»¤çš„å®¢æˆ·ç«¯è¿”å›<code>OK</code>, è¡¨ç¤ºå¤åˆ¶æŒ‡ä»¤å·²ç»è¢«æ¥æ”¶, è€Œå®é™…çš„å¤åˆ¶å·¥ä½œå°†åœ¨<code>OK</code>è¿”å›ä¹‹åæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œã€‚ä»æœåŠ¡å™¨å¼€å§‹å‘èµ·ä¸»ä»å¤åˆ¶è¯·æ±‚åˆ°å¼€å§‹å¤åˆ¶ä¸»è¦ç»å†äº†å¦‚ä¸‹7ä¸ªæ­¥éª¤,</p><p><strong>æ­¥éª¤1</strong>: è®¾ç½®ä¸»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£, é€šè¿‡<code>slaveof</code>æŒ‡ä»¤å‘èµ·ä¸»ä»å¤åˆ¶åŒæ­¥è¯·æ±‚,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:12345&gt; SLAVEOF 127.0.0.1 6379</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></p><p><strong>æ­¥éª¤2</strong>: å»ºç«‹å¥—æ¥å­—è¿æ¥</p><p>åœ¨SLAVEOFå‘½ä»¤æ‰§è¡Œä¹‹å, ä»æœåŠ¡å™¨å°†æ ¹æ®å‘½ä»¤æ‰€è®¾ç½®çš„IPåœ°å€å’Œç«¯å£, åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥, å¦‚æœä»æœåŠ¡å™¨åˆ›å»ºçš„å¥—æ¥å­—èƒ½æˆåŠŸè¿æ¥(connect)åˆ°ä¸»æœåŠ¡å™¨, é‚£ä¹ˆä»æœåŠ¡å™¨å°†ä¸ºè¿™ä¸ªå¥—æ¥å­—å…³è”ä¸€ä¸ªä¸“é—¨ç”¨äºå¤„ç†å¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨, è¿™ä¸ªå¤„ç†å™¨å°†è´Ÿè´£æ‰§è¡Œåç»­çš„å¤åˆ¶å·¥ä½œ, æ¯”å¦‚æ¥æ”¶RDBæ–‡ä»¶, ä»¥åŠæ¥æ”¶ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„å†™å‘½ä»¤, è¯¸å¦‚æ­¤ç±»ã€‚è€Œä¸»æœåŠ¡å™¨åœ¨æ¥å—(accept)ä»æœåŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥ä¹‹å, å°†ä¸ºè¯¥å¥—æ¥å­—åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€, å¹¶å°†ä»æœåŠ¡å™¨çœ‹ä½œæ˜¯ä¸€ä¸ªè¿æ¥åˆ°ä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ¥å¯¹å¾…, è¿™æ—¶ä»æœåŠ¡å™¨å°†åŒæ—¶å…·æœ‰æœåŠ¡å™¨(server)å’Œå®¢æˆ·ç«¯(client)ä¸¤ä¸ªèº«ä»½: ä»æœåŠ¡å™¨å¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚, è€Œä¸»æœåŠ¡å™¨åˆ™ä¼šå‘ä»æœåŠ¡å™¨è¿”å›å‘½ä»¤å›å¤ã€‚</p><p><strong>æ­¥éª¤3</strong>: å‘é€PINGå‘½ä»¤</p><p>ä»æœåŠ¡å™¨æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ä¹‹å, åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€ä¸ªPINGå‘½ä»¤ã€‚</p><blockquote><p>é€šè¿‡å‘é€PINGå‘½ä»¤æ£€æŸ¥å¥—æ¥å­—çš„è¯»å†™çŠ¶æ€;</p></blockquote><blockquote><p>é€šè¿‡PINGå‘½ä»¤å¯ä»¥æ£€æŸ¥ä¸»æœåŠ¡å™¨èƒ½å¦æ­£å¸¸å¤„ç†å‘½ä»¤ã€‚</p></blockquote><p>ä»æœåŠ¡å™¨åœ¨å‘é€PINGå‘½ä»¤ä¹‹åå¯èƒ½é‡åˆ°ä»¥ä¸‹ä¸‰ç§æƒ…å†µ:</p><blockquote><p>ä¸»æœåŠ¡å™¨å‘ä»æœåŠ¡å™¨è¿”å›äº†ä¸€ä¸ªå‘½ä»¤å›å¤, ä½†ä»æœåŠ¡å™¨å´ä¸èƒ½åœ¨è§„å®šçš„æ—¶é™å†…è¯»å–å‘½ä»¤å›å¤çš„å†…å®¹(timeout), è¯´æ˜ç½‘ç»œè¿æ¥çŠ¶æ€ä¸ä½³, ä»æœåŠ¡å™¨å°†æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—;</p></blockquote><blockquote><p>å¦‚æœä¸»æœåŠ¡å™¨è¿”å›ä¸€ä¸ªé”™è¯¯, é‚£ä¹ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨æš‚æ—¶æ²¡æœ‰åŠæ³•å¤„ç†ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚, ä»æœåŠ¡å™¨ä¹Ÿå°†æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—;</p></blockquote><blockquote><p>å¦‚æœä»æœåŠ¡å™¨è¯»å–åˆ°â€PONGâ€å›å¤, é‚£ä¹ˆè¡¨ç¤ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥çŠ¶æ€æ­£å¸¸, é‚£å°±ç»§ç»­æ‰§è¡Œä¸‹é¢çš„å¤åˆ¶æ­¥éª¤ã€‚</p></blockquote><p><strong>æ­¥éª¤4</strong>: èº«ä»½éªŒè¯</p><p>ä»æœåŠ¡å™¨åœ¨æ”¶åˆ°ä¸»æœåŠ¡å™¨è¿”å›çš„â€PONGâ€å›å¤ä¹‹å, ä¸‹ä¸€æ­¥è¦åšçš„å°±æ˜¯å†³å®šæ˜¯å¦è¿›è¡Œèº«ä»½éªŒè¯:</p><p>å¦‚æœä»æœåŠ¡å™¨è®¾ç½®äº†masterauthé€‰é¡¹, é‚£ä¹ˆè¿›è¡Œèº«ä»½éªŒè¯ã€‚å¦åˆ™ä¸è¿›è¡Œèº«ä»½è®¤è¯;<br>åœ¨éœ€è¦è¿›è¡Œèº«ä»½éªŒè¯çš„æƒ…å†µä¸‹, ä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€æ¡AUTHå‘½ä»¤, å‘½ä»¤çš„å‚æ•°ä¸ºä»æœåŠ¡å™¨masterauthé€‰é¡¹çš„å€¼ã€‚</p><p>ä»æœåŠ¡å™¨åœ¨èº«ä»½éªŒè¯é˜¶æ®µå¯èƒ½é‡åˆ°çš„æƒ…å†µæœ‰ä»¥ä¸‹å‡ ç§:</p><blockquote><p>ä¸»æœåŠ¡å™¨æ²¡æœ‰è®¾ç½®requirepassé€‰é¡¹, ä»æœåŠ¡å™¨æ²¡æœ‰è®¾ç½®masterauth,é‚£ä¹ˆå°±ç»§ç»­åé¢çš„å¤åˆ¶å·¥ä½œ;</p></blockquote><blockquote><p>å¦‚æœä»æœåŠ¡å™¨çš„é€šè¿‡AUTHå‘½ä»¤å‘é€çš„å¯†ç å’Œä¸»æœåŠ¡å™¨requirepassé€‰é¡¹æ‰€è®¾ç½®çš„å¯†ç ç›¸åŒ, é‚£ä¹ˆä¹Ÿç»§ç»­åé¢çš„å·¥ä½œ, å¦åˆ™è¿”å›é”™è¯¯invaild password;</p></blockquote><blockquote><p>å¦‚æœä¸»æœåŠ¡å™¨è®¾ç½®äº†requireoassé€‰é¡¹, ä½†ä»æœåŠ¡å™¨æ²¡æœ‰è®¾ç½®masterauthé€‰é¡¹, é‚£ä¹ˆæœåŠ¡å™¨å°†è¿”å›NOAUTHé”™è¯¯ã€‚åè¿‡æ¥å¦‚æœä¸»æœåŠ¡å™¨æ²¡æœ‰è®¾ç½®requirepassé€‰é¡¹, ä½†æ˜¯ä»æœåŠ¡å™¨å´è®¾ç½®äº†materauthé€‰é¡¹, é‚£ä¹ˆä¸»æœåŠ¡å™¨è¿”å›no password is seté”™è¯¯;</p></blockquote><p>æ‰€æœ‰é”™è¯¯åˆ°åªæœ‰ä¸€ä¸ªç»“æœ: ä¸­æ­¢ç›®å‰çš„å¤åˆ¶å·¥ä½œ, å¹¶ä»åˆ›å»ºå¥—æ¥å­—å¼€å§‹é‡æ–°æ‰§è¡Œå¤åˆ¶, ç›´åˆ°èº«ä»½éªŒè¯é€šè¿‡, æˆ–è€…ä»æœåŠ¡å™¨æ”¾å¼ƒæ‰§è¡Œå¤åˆ¶ä¸ºæ­¢ã€‚</p><p><strong>æ­¥éª¤5</strong>: å‘é€ç«¯å£ä¿¡æ¯</p><p>èº«ä»½éªŒè¯æ­¥éª¤ä¹‹å, ä»æœåŠ¡å™¨å°†æ‰§è¡Œå‘½ä»¤<code>REPLCONF listening-port &lt;port-number&gt;</code>, å‘ä¸»æœåŠ¡å™¨å‘é€ä»æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£å·ã€‚</p><p>ä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤ä¹‹å, ä¼šå°†ç«¯å£å·è®°å½•åœ¨ä»æœåŠ¡å™¨æ‰€å¯¹åº”çš„å®¢æˆ·ç«¯çŠ¶æ€çš„<code>slave_listening_port</code>å±æ€§,</p><blockquote><p><code>slave_listening_port</code>å±æ€§ç›®å‰å”¯ä¸€çš„ä½œç”¨å°±æ˜¯åœ¨ä¸»æœåŠ¡å™¨æ‰§è¡Œ<code>INFO replication</code>å‘½ä»¤æ—¶æ‰“å°å‡ºä»æœåŠ¡å™¨çš„ç«¯å£å·ã€‚</p></blockquote><p><strong>æ­¥éª¤6</strong>: åŒæ­¥</p><p>åœ¨è¿™ä¸€æ­¥, ä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€<code>psync</code>å‘½ä»¤, æ‰§è¡ŒåŒæ­¥æ“ä½œ, å¹¶å°†è‡ªå·±çš„æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨æ•°æ®åº“å½“å‰æ‰€å¤„çš„çŠ¶æ€ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ‰§è¡ŒåŒæ­¥æ“ä½œå‰, åªæœ‰ä»æœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ã€‚ä½†æ˜¯æ‰§è¡ŒåŒæ­¥æ“ä½œä¹‹å, ä¸»æœåŠ¡å™¨ä¹Ÿä¼šæˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯,</p><blockquote><p>å¦‚æœ<code>psync</code>å‘½ä»¤æ‰§è¡Œçš„æ˜¯å®Œæ•´åŒæ­¥æ“ä½œ, é‚£ä¹ˆä¸»æœåŠ¡å™¨åªæœ‰æˆä¸ºäº†ä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ‰èƒ½å°†ä¿å­˜åœ¨ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ;</p></blockquote><blockquote><p>å¦‚æœ<code>psync</code>å‘½ä»¤æ‰§è¡Œçš„æ˜¯éƒ¨åˆ†åŒæ­¥æ“ä½œ, é‚£ä¹ˆä¸»æœåŠ¡å™¨åªæœ‰æˆä¸ºäº†ä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ‰èƒ½å°†ä¿å­˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸­çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ;</p></blockquote><p><strong>æ­¥éª¤7</strong>: å‘½ä»¤ä¼ æ’­</p><p>å½“å®Œæˆäº†åŒæ­¥ä¹‹å, ä¸»ä»æœåŠ¡å™¨å°±ä¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µ, è¿™æ—¶ä¸»æœåŠ¡å™¨åªè¦ä¸€ç›´å°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨, è€Œä»æœåŠ¡å™¨åªè¦ä¸€ç›´æ¥æ”¶å¹¶æ‰§è¡Œä¸»æœåŠ¡å™¨å‘æ¥çš„å†™å‘½ä»¤, å°±å¯ä»¥ä¿è¯ä¸»ä»æœåŠ¡å™¨ä¸€ç›´ä¿æŒä¸€è‡´äº†ã€‚</p><p><strong>å¿ƒè·³æ£€æµ‹</strong><br>åœ¨å‘½ä»¤ä¼ æ’­é˜¶æ®µ, ä»æœåŠ¡å™¨é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡, å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤: <code>REPLCONF ACK &lt;replication_offset&gt;</code></p><p>å…¶ä¸­<code>replication_offset</code>æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡ã€‚</p><p>å‘é€<code>REPLCONF ACK</code>å‘½ä»¤å¯¹äºä¸»ä»æœåŠ¡å™¨æœ‰ä¸‰ä¸ªä½œç”¨:</p><blockquote><p>æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€;</p></blockquote><blockquote><p>è¾…åŠ©å®ç°min-slavesé€‰é¡¹;</p></blockquote><blockquote><p>æ£€æµ‹å‘½ä»¤ä¸¢å¤±ã€‚</p></blockquote><p>æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€</p><p>å¦‚æœä¸»æœåŠ¡å™¨è¶…è¿‡ä¸€ç§’é’Ÿæ²¡æœ‰æ”¶åˆ°ä»æœåŠ¡å™¨å‘æ¥çš„<code>REPLCONF ACK</code>å‘½ä»¤, é‚£ä¹ˆä¸»æœåŠ¡å™¨å°±çŸ¥é“ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°é—®é¢˜äº†ã€‚</p><p>é€šè¿‡å‘ä¸»æœåŠ¡å™¨å‘é€<code>INFO replication</code>å‘½ä»¤, åœ¨åˆ—å‡ºçš„ä»æœåŠ¡å™¨åˆ—è¡¨çš„<code>lag</code>ä¸€æ ä¸­, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›¸åº”ä»æœåŠ¡å™¨æœ€åä¸€æ¬¡å‘ä¸»æœåŠ¡å™¨å‘é€<code>REPLCONF ACK</code>å‘½ä»¤è·ç¦»ç°åœ¨è¿‡äº†å¤šå°‘ç§’;</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">10.1.195.19:8001&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=172.28.0.1,port=6379,state=online,offset=0,lag=1</span><br><span class="line">master_replid:10c63aebd8f09c749d1b26eccb52856b6d894292</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line">10.1.195.19:8001&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">åˆšåˆšå‘é€è¿‡ REPLCONF ACKå‘½ä»¤</span></span><br><span class="line">slave1:ip=171.28.0.1,port=6379,state=online,offset=197,lag=15</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">15ç§’ä¹‹å‰å‘é€è¿‡REPLCONF ACKå‘½ä»¤</span></span><br><span class="line"></span><br><span class="line">master_repl_offset:211</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:210</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹, <code>lag</code>çš„å€¼åº”è¯¥åœ¨0ç§’æˆ–è€…1ç§’ä¹‹é—´è·³åŠ¨, å¦‚æœè¶…è¿‡1ç§’çš„è¯, é‚£ä¹ˆè¯´æ˜ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°äº†æ•…éšœã€‚</p><p><strong>è¾…åŠ©å®ç°min-slavesé…ç½®é€‰é¡¹</strong></p><p><code>redis</code>çš„<code>min-slaves-to-write</code>å’Œ<code>min-slaves-max-lag</code>ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨ä¸å®‰å…¨çš„æƒ…å†µä¸‹æ‰§è¡Œå†™å‘½ä»¤ã€‚</p><p>ä¸¾ä¸ªä¾‹å­, å¦‚æœæˆ‘ä»¬å‘ä¸»æœåŠ¡å™¨æä¾›ä»¥ä¸‹è®¾ç½®:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">min-slaves-to-write 3</span><br><span class="line">min-slaves-max-lag 10</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆåœ¨ä»æœåŠ¡å™¨çš„æ•°é‡å°‘äº3ä¸ª, æˆ–è€…ä¸‰ä¸ªä»æœåŠ¡å™¨çš„å»¶è¿Ÿ<code>(lag)</code>å€¼éƒ½å¤§äºæˆ–ç­‰äº10ç§’æ—¶, ä¸»æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤, è¿™é‡Œçš„å»¶è¿Ÿå€¼å°±æ˜¯ä¸Šé¢æåˆ°çš„<code>INFO replication</code>å‘½ä»¤çš„<code>(lag)</code>å€¼ã€‚</p><p><strong>æ£€æµ‹å‘½ä»¤ä¸¢å¤±</strong></p><p>æˆ‘ä»¬ä»å‘½ä»¤: <code>REPLCONF ACK &lt;replication_offset&gt;</code>å°±å¯ä»¥çŸ¥é“, æ¯å‘é€ä¸€æ¬¡è¿™ä¸ªå‘½ä»¤ä»æœåŠ¡å™¨éƒ½ä¼šå‘ä¸»æœåŠ¡å™¨æŠ¥å‘Šä¸€æ¬¡è‡ªå·±çš„å¤åˆ¶åç§»é‡ã€‚é‚£æ­¤æ—¶å°½ç®¡ä¸»æœåŠ¡å™¨å‘é€ç»™ä»æœåŠ¡å™¨çš„<code>SET key value</code>ä¸¢å¤±äº†ã€‚ä¹Ÿæ— æ‰€è°“, ä¸»æœåŠ¡å™¨é©¬ä¸Šå°±çŸ¥é“äº†ã€‚</p><h5 id="åŒæ­¥å®è·µ"><a href="#åŒæ­¥å®è·µ" class="headerlink" title="åŒæ­¥å®è·µ"></a>åŒæ­¥å®è·µ</h5><p><strong>0.ç¯å¢ƒå‡†å¤‡</strong><br>é€šè¿‡æ„å»ºå¦‚ä¸‹ä¸»ä»çº§è”æ¶æ„æ¥è¿›ä¸€æ­¥å®è·µ<code>redis</code>ä¸»ä»å¤åˆ¶åŒæ­¥æœºåˆ¶,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master---&gt; slave01 --&gt; slave02</span><br></pre></td></tr></table></figure></p><p>å³<code>master</code>ä¸ºä¸»æœåŠ¡å™¨, <code>slave01</code>ä¸º<code>master</code>ä»æœåŠ¡å™¨, åŒæ—¶ä¹Ÿæ˜¯<code>slave02</code>ä¸»æœåŠ¡å™¨,  ç”±äºè¦æ„å»ºå¤šä¸ª<code>redis container</code>ç¯å¢ƒ, ä¸ºæ–¹ä¾¿èµ·è§é€šè¿‡<code>docker-compose</code>æ¥å®è·µ,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">version: '3'</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  master-redis:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: master</span><br><span class="line">    ports:</span><br><span class="line">      - "8001:6379"</span><br><span class="line">    volumes:</span><br><span class="line">      - ~/workbench/docker/docker-compose/redis/conf/redis.conf:/etc/redis/redis.conf</span><br><span class="line">    entrypoint: ["redis-server", "/etc/redis/redis.conf"]</span><br><span class="line"></span><br><span class="line">  slave-redis-01:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: slave01</span><br><span class="line">    ports:</span><br><span class="line">      - "8002:6379"</span><br><span class="line">    volumes:</span><br><span class="line">      - ~/workbench/docker/docker-compose/redis/conf/redis.conf:/etc/redis/redis.conf</span><br><span class="line">    entrypoint: ["redis-server", "/etc/redis/redis.conf"]</span><br><span class="line"></span><br><span class="line">  slave-redis-02:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: slave02</span><br><span class="line">    ports:</span><br><span class="line">      - "8003:6379"</span><br><span class="line">    volumes:</span><br><span class="line">      - ~/workbench/docker/docker-compose/redis/conf/redis.conf:/etc/redis/redis.conf</span><br><span class="line">    entrypoint: ["redis-server", "/etc/redis/redis.conf"]</span><br></pre></td></tr></table></figure></p><p>å°†<code>redis.conf</code>é…ç½®åšå¦‚ä¸‹ä¿®æ”¹,</p><ul><li>å°†<code>bind 127.0.0.1</code> ä¿®æ”¹ä¸º<code>bind 0.0.0.0</code>;</li><li>å°†<code>daemonize yes</code> ä¿®æ”¹ä¸º<code>daemonize no</code>, è®©<code>redis</code>è¿è¡Œåœ¨å‰å°;</li><li>å°†<code>protected-mode yes</code>ä¿®æ”¹ä¸º<code>protected-mode no</code>, åœ¨<code>protected-mode yes</code>æ¨¡å¼ä¸‹éœ€è¦è®¾ç½®å¯†ç æ‰èƒ½è¿œç¨‹è®¿é—®, å¦åˆ™<code>redis</code>åªæ¥å—æœ¬åœ°è®¿é—®;</li></ul><p><strong>1.å‘é€<code>slaveof</code>æŒ‡ä»¤,è¯·æ±‚ä¸»ä»åŒæ­¥</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">âœ  redis docker-compose up -d</span><br><span class="line">Creating network "redis_default" with the default driver</span><br><span class="line">Creating master  ... done</span><br><span class="line">Creating slave02 ... done</span><br><span class="line">Creating slave01 ... done</span><br><span class="line">âœ  redis docker-compose ps</span><br><span class="line"> Name                Command               State           Ports</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">master    redis-server /etc/redis/re ...   Up      0.0.0.0:8001-&gt;6379/tcp</span><br><span class="line">slave01   redis-server /etc/redis/re ...   Up      0.0.0.0:8002-&gt;6379/tcp</span><br><span class="line">slave02   redis-server /etc/redis/re ...   Up      0.0.0.0:8003-&gt;6379/tcp</span><br><span class="line">âœ  redis ifconfig |grep inet |grep -v 127.0.0.1</span><br><span class="line">        inet6 ::1 prefixlen 128</span><br><span class="line">        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x1</span><br><span class="line">        inet6 fe80::475:d879:2a90:ac35%en0 prefixlen 64 secured scopeid 0x5</span><br><span class="line">        inet 10.1.195.19 netmask 0xffffff00 broadcast 10.1.195.255</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤, åˆ†åˆ«å¯åŠ¨äº†ä¸€å°<code>master</code>ä¸»æœº, ä¸¤å°<code>slave01</code>,<code>slave02</code>ä»æœº, å¹¶å¾—çŸ¥å½“å‰å®¿ä¸»æœºipä¸º<code>10.1.195.19</code></p><p>ç™»å½•ä»æœºå‘é€<code>slaveof</code>æŒ‡ä»¤, å¼€å§‹ä¸»ä»å¤åˆ¶åŒæ­¥,<br>ä¸»æœº<code>master</code> æ‰§è¡Œå‘½ä»¤,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">âœ  docker exec -it master redis-cli -h 10.1.195.19 -p 8001</span><br><span class="line">10.1.195.19:8001&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8001&gt; hmset info name mike city shanghai code 110</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8001&gt; hgetall info</span><br><span class="line">1) "name"</span><br><span class="line">2) "mike"</span><br><span class="line">3) "city"</span><br><span class="line">4) "shanghai"</span><br><span class="line">5) "code"</span><br><span class="line">6) "110"</span><br><span class="line">10.1.195.19:8001&gt;</span><br></pre></td></tr></table></figure></p><p>ä»æœº<code>slave01</code> æŸ¥è¯¢å‘½ä»¤,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">âœ  docker exec -it slave01 redis-cli -h 10.1.195.19 -p 8002</span><br><span class="line">10.1.195.19:8002&gt; slaveof no one</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8002&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8002&gt; slaveof 10.1.195.19 8001</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8002&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "info"</span><br><span class="line">10.1.195.19:8002&gt; hgetall info</span><br><span class="line">1) "name"</span><br><span class="line">2) "mike"</span><br><span class="line">3) "city"</span><br><span class="line">4) "shanghai"</span><br><span class="line">5) "code"</span><br><span class="line">6) "110"</span><br><span class="line">10.1.195.19:8002&gt;</span><br></pre></td></tr></table></figure></p><p>ä»æœº<code>slave02</code>æŸ¥è¯¢å‘½ä»¤,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">âœ  docker exec -it slave02 redis-cli -h 10.1.195.19 -p 8003</span><br><span class="line">10.1.195.19:8003&gt; slaveof no one</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8003&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8003&gt; slaveof 10.1.195.19 8002</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8003&gt; hgetall info</span><br><span class="line">1) "name"</span><br><span class="line">2) "mike"</span><br><span class="line">3) "city"</span><br><span class="line">4) "shanghai"</span><br><span class="line">5) "code"</span><br><span class="line">6) "110"</span><br><span class="line">10.1.195.19:8003&gt;</span><br></pre></td></tr></table></figure></p><ul><li><code>docker exec -it ${docker-name} redis-cli -h ${localhost-ip} -p ${port}</code>å‘½ä»¤ç™»å½•åˆ°å„ä¸ª<code>redis</code>å®ä¾‹æœåŠ¡;</li><li><code>slaveof no one</code>å‘½ä»¤å°†å½“å‰<code>redis</code>å®ä¾‹çš„ä¸»ä»æœåŠ¡;</li><li>ä»ä¸Šè¿°å®ä¾‹å¯è§, é€šè¿‡åœ¨<code>master</code>ä¸»æœºä¸­æ‰§è¡Œ<code>hmset</code>å‘½ä»¤, ç›¸åº”çš„ä»æœºä»¥åŠçº§è”ä»æœºä¹Ÿéƒ½åŒæ­¥äº†ä¸»æœºçš„æ‰§è¡Œå‘½ä»¤, ä¸Šè¿°ç¤ºä¾‹æ˜¾ç¤ºä¸»ä»å¤åˆ¶åŒæ­¥æˆåŠŸ;</li></ul><p>ä»æœºé…ç½®é»˜è®¤å¼€å¯äº†åªè¯»æ¨¡å¼<code>slave-read-only yes</code>,æ‰€ä»¥å¯¹ä»æœºè¿›è¡Œä¿®æ”¹æ“ä½œæ˜¯ä¸è®¸å¯çš„, ä¹Ÿä¸å»ºè®®è¿™ä¹ˆåš;<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.1.195.19:8003&gt; flushdb</span><br><span class="line">(error) READONLY You can't write against a read only replicx</span><br><span class="line">10.1.195.19:8003&gt;</span><br></pre></td></tr></table></figure></p><p>å½“å¯¹ä¸»æœºæ“ä½œ<code>flushdb</code>æ—¶, å¯è§ä»æœºä¹Ÿæ‰§è¡Œäº†<code>flushdb</code>å‘½ä»¤<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">10.1.195.19:8001&gt; flushdb</span><br><span class="line">OK</span><br><span class="line">10.1.195.19:8001&gt;</span><br><span class="line"></span><br><span class="line">10.1.195.19:8002&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) (empty list or set)</span><br><span class="line">10.1.195.19:8002&gt;</span><br><span class="line"></span><br><span class="line">10.1.195.19:8003&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) (empty list or set)</span><br><span class="line">10.1.195.19:8003&gt;</span><br></pre></td></tr></table></figure></p><p>å½“å…³é—­<code>master</code>æœåŠ¡å, å¯¹ä»æœºæœåŠ¡æ— å½±å“,  æ‰€ä»¥ä»æœºæœåŠ¡çš„å¯åŠ¨é¡ºåºåŠæœåŠ¡æä¾› ä¸<code>master</code>ä¸»æœºæœåŠ¡æ˜¯å¦å·²å¯åŠ¨åŠå¯åŠ¨é¡ºåºæ— å…³;</p><p>å½“ç„¶ä¸Šé¢<code>docker-compose</code>é…ç½®ä¹Ÿå¯ä»¥ç›´æ¥é…ç½®<code>slaveof</code>å‚æ•°ï¼Œ å°±ä¸éœ€è¦æ‰‹åŠ¨å»å‘èµ·å‘½ä»¤, å¯å‚çœ‹ <a href="https://github.com/researchlab/docker-envs/tree/master/redis/docker-compose-redis-replication" target="_blank" rel="noopener">docker-compose-redis-replication</a></p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li><code>redis</code>çš„ä¸»ä»åŒæ­¥æ˜¯å¼‚æ­¥è¿›è¡Œçš„, è¿™æ„å‘³ç€ä¸»ä»åŒæ­¥ä¸ä¼šå½±å“ä¸»é€»è¾‘, ä¹Ÿä¸ä¼šé™ä½<code>redis</code>çš„å¤„ç†æ€§èƒ½ã€‚</li><li>ä¸»ä»æ¶æ„ä¸­, å¯ä»¥è€ƒè™‘å…³é—­ä¸»æœåŠ¡å™¨çš„æ•°æ®æŒä¹…åŒ–åŠŸèƒ½, åªè®©ä»æœåŠ¡å™¨è¿›è¡ŒæŒä¹…åŒ–, è¿™æ ·å¯ä»¥æé«˜ä¸»æœåŠ¡å™¨çš„å¤„ç†æ€§èƒ½ã€‚</li><li>åœ¨ä¸»ä»æ¶æ„ä¸­, ä»æœåŠ¡å™¨é€šå¸¸è¢«è®¾ç½®ä¸ºåªè¯»æ¨¡å¼, è¿™æ ·å¯ä»¥é¿å…ä»æœåŠ¡å™¨çš„æ•°æ®è¢«è¯¯ä¿®æ”¹ã€‚ä½†æ˜¯ä»æœåŠ¡å™¨ä»ç„¶å¯ä»¥æ¥å—<code>config</code>ç­‰æŒ‡ä»¤, æ‰€ä»¥è¿˜æ˜¯ä¸åº”è¯¥å°†ä»æœåŠ¡å™¨ç›´æ¥æš´éœ²åˆ°ä¸å®‰å…¨çš„ç½‘ç»œç¯å¢ƒä¸­ã€‚å¦‚æœå¿…é¡»å¦‚æ­¤, é‚£å¯ä»¥è€ƒè™‘ç»™é‡è¦æŒ‡ä»¤è¿›è¡Œé‡å‘½å, æ¥é¿å…å‘½ä»¤è¢«å¤–äººè¯¯æ‰§è¡Œã€‚</li><li>ä¸»ä»åŒæ­¥åˆ†ä¸º<code>å…¨é‡åŒæ­¥</code>å’Œ<code>å¢é‡åŒæ­¥</code>, æ–‡ä¸­å¯¹<code>å…¨é‡åŒæ­¥</code>å’Œ<code>å¢é‡åŒæ­¥</code>åŸç†,å®ç°è¿‡ç¨‹è¿›è¡Œäº†é˜è¿°åˆ†æ;</li><li>è¿›ä¸€æ­¥é˜è¿°äº†ä¸»ä»ä¸åŒæ‰§è¡Œç­–ç•¥, å³ä»æœºåˆå§‹è¿æ¥ä¸»æœºæ—¶, å…ˆè¿›è¡Œå¢é‡åŒæ­¥, è‹¥å¢é‡åŒæ­¥å¤±è´¥, åˆ™è¿›è¡Œå…¨é‡åŒæ­¥,  åŒæ—¶å¯ä»¥åˆ©ç”¨<code>wait</code>æŒ‡ä»¤ å°†redisä¸»ä»åŒæ­¥çš„å¼‚æ­¥è¡Œä¸ºè½¬å˜ä¸ºåŒæ­¥è¡Œä¸º;</li><li>åˆ†æäº†ä¸»ä»åŒæ­¥è¿‡ç¨‹,  ä¸»ä»åŒæ­¥å¼€å§‹è‡³å¤åˆ¶, å¤§è‡´è¿›æ¥7ä¸ªè¿‡ç¨‹, 1.å‘èµ·<code>slaveof</code>æŒ‡ä»¤;2.å»ºç«‹å¥—æ¥å­—è¿æ¥;3.å‘é€pingæŒ‡ä»¤æµ‹è¯•è¿æ¥çŠ¶æ€;4.èº«ä»½è®¤è¯;5.å‘é€ç«¯å£ä¿¡æ¯;6.åŒæ­¥åˆå§‹åŒ–é˜¶æ®µ,ä»æœºè½½å…¥ä¸»æœºRDB,å‡†å¤‡æ¥å—ä¸»æœºå‘½ä»¤;7.å¢é‡åŒæ­¥;</li><li>é€šè¿‡docker-compose æ„å»º<code>ä¸»-ä»-ä»</code>æ¶, æ·±å…¥å®è·µåˆ†æ<code>redis</code>ä¸»ä»å¤åˆ¶åŒæ­¥è¿‡ç¨‹;</li><li>ä¸»ä»å¤åˆ¶æ˜¯ <code>redis</code> åˆ†å¸ƒå¼çš„åŸºç¡€, <code>redis</code> çš„é«˜å¯ç”¨ç¦»å¼€äº†ä¸»ä»å¤åˆ¶å°†æ— ä»è¿›è¡Œ;</li><li>ä¸è¿‡å¤åˆ¶åŠŸèƒ½ä¹Ÿä¸æ˜¯å¿…é¡»çš„, å¦‚æœä½ å°† <code>redis</code> åªç”¨æ¥åšç¼“å­˜, è·Ÿ<code>memcache</code>ä¸€æ ·æ¥å¯¹å¾…, ä¹Ÿå°±æ— éœ€è¦ä»åº“åšå¤‡ä»½, æŒ‚æ‰äº†é‡æ–°å¯åŠ¨ä¸€ä¸‹å°±è¡Œã€‚ä½†æ˜¯åªè¦ä½ ä½¿ç”¨äº† <code>redis</code> çš„æŒä¹…åŒ–åŠŸèƒ½, å°±å¿…é¡»è®¤çœŸå¯¹å¾…ä¸»ä»å¤åˆ¶, å®ƒæ˜¯ç³»ç»Ÿæ•°æ®å®‰å…¨çš„åŸºç¡€ä¿éšœ;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦ç”¨åˆ°&lt;code&gt;redis&lt;/code&gt;åšæ•°æ®æŒä¹…åŒ–è½åœ°æ•°æ®åº“æ—¶,  ä¸€èˆ¬åº”æ­å»ºä¸“å±çš„&lt;code&gt;redis&lt;/code&gt;é›†ç¾¤æ¥é¿å…å•ç‚¹æ•…éšœåŠå•ç‚¹è¯»å†™æ€§èƒ½é—®é¢˜, å¦‚ä¸æ˜¯é‡åº¦&lt;code&gt;redis&lt;/code&gt;ç”¨æˆ·, æ•°æ®é‡å‹åŠ›ä¸æ˜¯ç‰¹åˆ«å¤§æ—¶, ä¹Ÿå¯ä»¥è€ƒè™‘é‡‡ç”¨&lt;code&gt;redis&lt;/code&gt;ä¸»ä»åŒæ­¥æ¶æ„ä»£æ›¿, æœ¬æ–‡å°†è¯•å›¾å¯¹&lt;code&gt;redis&lt;/code&gt;ä¸»ä»åŒæ­¥åŸç†, æ­¥éª¤, é…ç½®é¡¹, å®è·µç­‰æ–¹é¢è¿›è¡Œå­¦ä¹ æ€»ç»“;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜16 æ•°æ®æŒä¹…åŒ–å®è·µ</title>
    <link href="http://researchlab.github.io/2018/10/13/redis-16-storage-solution-opt/"/>
    <id>http://researchlab.github.io/2018/10/13/redis-16-storage-solution-opt/</id>
    <published>2018-10-13T19:12:11.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>é€šè¿‡ç¤ºä¾‹åˆ†æï¼Œæ·±å…¥äº†è§£<code>redis</code>æ•°æ®æŒä¹…åŒ–ç­–ç•¥æ‰§è¡Œæœºåˆ¶ï¼›<br><a id="more"></a></p><h5 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h5><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">âœ docker run -itd --name lredis -p7002:6379 -v ~/workbench/docker/redis/conf/redis.conf:/etc/redis/redis.conf redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure><h5 id="ç‰ˆæœ¬æ—¥å¿—"><a href="#ç‰ˆæœ¬æ—¥å¿—" class="headerlink" title="ç‰ˆæœ¬æ—¥å¿—"></a>ç‰ˆæœ¬æ—¥å¿—</h5><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">âœ docker logs -f lredis</span><br><span class="line">1:C 24 Oct 2018 09:24:03.601 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">1:C 24 Oct 2018 09:24:03.602 # Redis version=5.0.0, bits=64, commit=00000000, modified=0, pid=1, just started</span><br><span class="line">...</span><br><span class="line">1:M 24 Oct 2018 09:24:03.606 # Server initialized</span><br><span class="line">1:M 24 Oct 2018 09:24:03.606 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &apos;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&apos; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">1:M 24 Oct 2018 09:24:03.606 * Ready to accept connections</span><br></pre></td></tr></table></figure><h5 id="RDBæ–¹å¼æŒä¹…åŒ–"><a href="#RDBæ–¹å¼æŒä¹…åŒ–" class="headerlink" title="RDBæ–¹å¼æŒä¹…åŒ–"></a>RDBæ–¹å¼æŒä¹…åŒ–</h5><hr><p><code>Redis</code>é»˜è®¤çš„æŒä¹…åŒ–æ–¹å¼æ˜¯<code>RDB</code>ï¼Œå¹¶ä¸”é»˜è®¤æ˜¯æ‰“å¼€çš„ã€‚<code>RDB</code>çš„ä¿å­˜æœ‰æ–¹å¼åˆ†ä¸º<code>ä¸»åŠ¨ä¿å­˜</code>ä¸<code>è¢«åŠ¨ä¿å­˜</code>ã€‚<code>ä¸»åŠ¨ä¿å­˜</code>å¯ä»¥åœ¨<code>redis-cli</code>ä¸­è¾“å…¥<code>save</code>å³å¯ï¼›<code>è¢«åŠ¨ä¿å­˜</code>éœ€è¦æ»¡è¶³é…ç½®æ–‡ä»¶ä¸­è®¾å®šçš„è§¦å‘æ¡ä»¶ï¼Œæ»¡è¶³è§¦å‘æ¡ä»¶åï¼Œæ•°æ®æ‰ä¼šè¢«ä¿å­˜ä¸ºå¿«ç…§ï¼Œæ­£æ˜¯å› ä¸ºè¿™æ ·æ‰è¯´<code>RDB</code>çš„æ•°æ®å®Œæ•´æ€§æ˜¯æ¯”ä¸ä¸Š<code>AOF</code>;<br>è§¦å‘ä¿å­˜æ¡ä»¶åï¼Œä¼šåœ¨æŒ‡å®šçš„ç›®å½•ç”Ÿæˆä¸€ä¸ªåä¸º<code>dump.rdb</code>çš„æ–‡ä»¶ï¼Œç­‰åˆ°ä¸‹ä¸€æ¬¡å¯åŠ¨<code>Redis</code>æ—¶ï¼Œ<code>Redis</code>ä¼šå»è¯»å–è¯¥ç›®å½•ä¸‹çš„<code>dump.rdb</code>æ–‡ä»¶ï¼Œå°†é‡Œé¢çš„æ•°æ®æ¢å¤åˆ°<code>Redis</code>;</p><p><code>dump.rdb</code>æ–‡ä»¶è·¯å¾„,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) "dir"</span><br><span class="line">2) "/data"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p><p>ç›®å‰å®˜æ–¹é»˜è®¤çš„è§¦å‘æ¡ä»¶å¯ä»¥åœ¨<code>redis.conf</code>ä¸­çœ‹åˆ°,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save 900 1              #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 300 10            #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 60 10000        #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†ä¾¿äºæµ‹è¯•ï¼Œ æŠŠä¸Šé¢é»˜è®¤çš„é…ç½®ä¿®æ”¹ä¸ºï¼Œ<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save 900 1              #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 300 10            #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 20 5        #åœ¨20ç§’ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰5ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br></pre></td></tr></table></figure></p><ol><li><strong><code>RDB</code>è¢«åŠ¨è§¦å‘ä¿å­˜å®è·µ</strong><br>input<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set a 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set b 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set c 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set d 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set e 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set f 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "a"</span><br><span class="line">   2) "e"</span><br><span class="line">   3) "b"</span><br><span class="line">   4) "d"</span><br><span class="line">   5) "f"</span><br><span class="line">   6) "c"</span><br></pre></td></tr></table></figure></li></ol><p><code>RDB</code>è¢«åŠ¨ä¿å­˜æˆåŠŸç”Ÿæˆäº†<code>rdb</code>æ–‡ä»¶åŠæ—¥å¿—,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it lredis ls /data</span><br><span class="line">dump.rdb</span><br></pre></td></tr></table></figure></p><p>æ—¥å¿—è®°å½•,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1:M 24 Oct 2018 09:47:49.394 * DB loaded from disk: 0.000 seconds</span><br><span class="line">1:M 24 Oct 2018 09:47:49.394 * Ready to accept connections</span><br><span class="line">1:M 24 Oct 2018 09:48:48.758 * 5 changes in 20 seconds. Saving...</span><br><span class="line">1:M 24 Oct 2018 09:48:48.759 * Background saving started by pid 25</span><br><span class="line">25:C 24 Oct 2018 09:48:48.768 * DB saved on disk</span><br><span class="line">25:C 24 Oct 2018 09:48:48.769 * RDB: 0 MB of memory used by copy-on-write</span><br><span class="line">1:M 24 Oct 2018 09:48:48.860 * Background saving terminated with success</span><br></pre></td></tr></table></figure></p><p>æ—¥å¿—æç¤º<code>redis</code>æ£€æµ‹åˆ°<code>20</code>ç§’å†…æœ‰è‡³å°‘<code>5</code>æ¡è®°å½•è¢«æ”¹åŠ¨ï¼Œæ»¡è¶³<code>redis.conf</code>ä¸­å¯¹äº<code>RDB</code>æ•°æ®ä¿å­˜çš„æ¡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œæ‰§è¡Œæ•°æ®ä¿å­˜æ“ä½œï¼Œå¹¶ä¸”æç¤ºå¼€è¾Ÿäº†ä¸€ä¸ª<code>25</code>çš„è¿›ç¨‹å‡ºæ¥æ‰§è¡Œä¿å­˜æ“ä½œï¼Œæœ€åæç¤ºä¿å­˜æˆåŠŸ;</p><p>ç°åœ¨å°†redisè¿›ç¨‹killï¼Œå“ªäº›æ•°æ®ä¼šè¢«ä¿å­˜ï¼Ÿ</p><p>é€šè¿‡å‘½ä»¤<code>docker restart lredis</code>æ¨¡æ‹Ÿ<code>Redis</code>å¼‚å¸¸å…³é—­ï¼Œç„¶åå†å¯åŠ¨<code>Redis</code>ï¼Œå†æ¬¡æŸ¥çœ‹ä¹‹å‰<code>set</code>è®¾ç½®çš„å†…å®¹,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "b"</span><br><span class="line">   2) "e"</span><br><span class="line">   3) "f"</span><br><span class="line">   4) "d"</span><br><span class="line">   5) "a"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p><p>å‘ç°<code>c</code>ä¸è§äº†ï¼Œ å¯è§<code>RDB</code>æ–¹å¼çš„æ•°æ®å®Œæ•´æ€§æ˜¯ä¸å¯é çš„ï¼Œé™¤éæ–­æ‰çš„é‚£ä¸€åˆ»æ­£å¥½æ˜¯æ»¡è¶³è§¦å‘æ¡ä»¶çš„æ¡æ•°;</p><p>å…³é—­<code>RDB</code>æ–¹å¼æŒä¹…åŒ–<br>ä¿®æ”¹<code>redis.conf</code>é…ç½®ä¸º,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save ""</span><br><span class="line"><span class="meta">#</span><span class="bash">save 900 1</span></span><br><span class="line"><span class="meta">#</span><span class="bash">save 300 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">save 20 5</span></span><br></pre></td></tr></table></figure></p><p>é‡å¤ä¸Šè¿°<code>RDB</code>è¢«åŠ¨ä¿å­˜è¿‡ç¨‹,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">âœ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "a"</span><br><span class="line">   2) "d"</span><br><span class="line">   3) "c"</span><br><span class="line">   4) "e"</span><br><span class="line">   5) "b"</span><br><span class="line">127.0.0.1:6379&gt; set f 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set i 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set j 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "a"</span><br><span class="line">   2) "j"</span><br><span class="line">   3) "f"</span><br><span class="line">   4) "d"</span><br><span class="line">   5) "c"</span><br><span class="line">   6) "e"</span><br><span class="line">   7) "b"</span><br><span class="line">   8) "i"</span><br><span class="line">127.0.0.1:6379&gt; exit</span><br><span class="line">âœ docker restart lredis</span><br><span class="line">lredis</span><br><span class="line">âœ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "e"</span><br><span class="line">   2) "d"</span><br><span class="line">   3) "b"</span><br><span class="line">   4) "c"</span><br><span class="line">   5) "a"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p><p>å‘ç°åé¢æ·»åŠ çš„<code>3</code>æ¡è®°å½•å¹¶æ²¡æœ‰è¢«ä¿å­˜ï¼Œæ¢å¤æ•°æ®çš„æ—¶å€™ä»…ä»…åªæ˜¯æ¢å¤äº†ä¹‹å‰çš„<code>5</code>æ¡ã€‚å¹¶ä¸”è§‚å¯Ÿ<code>Redis</code>æœåŠ¡ç«¯çª—å£æ—¥å¿—ï¼Œå¹¶æœªå‘ç°åƒä¹‹å‰ä¸€æ ·çš„è§¦å‘ä¿å­˜çš„æç¤ºï¼Œè¯æ˜<code>RDB</code>æ–¹å¼å·²ç»è¢«å…³é—­;</p><p>é€šè¿‡é…ç½®æ–‡ä»¶å…³é—­è¢«åŠ¨è§¦å‘ï¼Œé‚£ä¹ˆä¸»åŠ¨å…³é—­æ˜¯å¦è¿˜ä¼šç”Ÿæ•ˆå‘¢ï¼Ÿ</p><ol start="2"><li><strong><code>RDB</code>ä¸»åŠ¨ä¿å­˜å®è·µ</strong><br>é€šè¿‡<code>del</code>å‘½ä»¤åˆ é™¤å‡ æ¡è®°å½•ï¼Œç„¶åè¾“å…¥<code>save</code>å‘½ä»¤æ‰§è¡Œä¿å­˜æ“ä½œ,<br>input opt<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "e"</span><br><span class="line">   2) "d"</span><br><span class="line">   3) "b"</span><br><span class="line">   4) "c"</span><br><span class="line">   5) "a"</span><br><span class="line">127.0.0.1:6379&gt; del e d</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "b"</span><br><span class="line">   2) "c"</span><br><span class="line">   3) "a"</span><br><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></li></ol><p>log output<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1:M 24 Oct 2018 10:09:55.295 * Ready to accept connections</span><br><span class="line">1:M 24 Oct 2018 10:14:28.366 * DB saved on disk</span><br></pre></td></tr></table></figure></p><p>ç„¶åæ‰§è¡Œ <code>docker restart lredis</code>,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker restart lredis</span><br><span class="line">lredis</span><br><span class="line">âœ  ~ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "a"</span><br><span class="line">   2) "c"</span><br><span class="line">   3) "b"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹åˆ°å½“<code>RDB</code>è¢«åŠ¨ä¿å­˜å…³é—­åï¼Œå¯ä»¥é€šè¿‡ä¸»åŠ¨<code>save</code>ä¿å­˜æˆåŠŸ, è¯æ˜ä¸»åŠ¨å…³é—­ä¸å— é…ç½®æ–‡ä»¶çš„å½±å“;</p><p>é™¤äº†saveè¿˜æœ‰å…¶ä»–çš„ä¿å­˜æ–¹å¼ä¹ˆï¼Ÿ</p><p><code>Redis</code>æä¾›äº†<code>save</code>å’Œ<code>bgsave</code>è¿™ä¸¤ç§ä¸åŒçš„ä¿å­˜æ–¹å¼, å¹¶ä¸”è¿™ä¸¤ä¸ªæ–¹å¼åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½ä¼šè°ƒç”¨<code>rdbSave</code>å‡½æ•°ï¼Œä½†å®ƒä»¬è°ƒç”¨çš„æ–¹å¼å„æœ‰ä¸åŒ:</p><blockquote><p><code>save</code>ç›´æ¥è°ƒç”¨<code>rdbSave</code>æ–¹æ³•, é˜»å¡<code>Redis</code>ä¸»è¿›ç¨‹ï¼Œç›´åˆ°ä¿å­˜å®Œæˆä¸ºæ­¢ã€‚åœ¨ä¸»è¿›ç¨‹é˜»å¡æœŸé—´ï¼ŒæœåŠ¡å™¨ä¸èƒ½å¤„ç†å®¢æˆ·ç«¯çš„ä»»ä½•è¯·æ±‚ã€‚</p></blockquote><blockquote><p><code>bgsave</code>åˆ™<code>fork</code>å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹è´Ÿè´£è°ƒç”¨<code>rdbSave</code>ï¼Œå¹¶åœ¨ä¿å­˜å®Œæˆä¹‹åå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Œé€šçŸ¥ä¿å­˜å·²å®Œæˆã€‚å› ä¸º<code>rdbSave</code>åœ¨å­è¿›ç¨‹è¢«è°ƒç”¨ï¼Œæ‰€ä»¥ <code>Redis</code>æœåŠ¡å™¨åœ¨<code>bgsave</code>æ‰§è¡ŒæœŸé—´ä»ç„¶å¯ä»¥ç»§ç»­å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</p></blockquote><p>æ˜¾ç„¶ï¼Œ <code>save</code>æ˜¯åŒæ­¥æ“ä½œ, <code>bgsave</code>æ˜¯å¼‚æ­¥æ“ä½œã€‚bgsaveå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•å’Œsaveå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä¸€æ ·çš„,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "a"</span><br><span class="line">   2) "c"</span><br><span class="line">   3) "b"</span><br><span class="line">127.0.0.1:6379&gt; set e 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set d 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; bgsave</span><br><span class="line">Background saving started</span><br></pre></td></tr></table></figure></p><p><code>redis</code>é™¤äº†æä¾›<code>save</code>å’Œ<code>bgsave</code>æ¥ä¿å­˜æ•°æ®å¤–, è¿˜å¯ä»¥é€šè¿‡<code>shutdown</code>å‘½ä»¤æ¥ä¿å­˜æ•°æ®ï¼Œä¸è¿‡è¦è®©<code>shutdown</code>ä¿å­˜æ•°æ®ç”Ÿæ•ˆéœ€è¦æ‰“å¼€æŒä¹…åŒ–é…ç½®æ‰è¡Œï¼Œå³åº”å°†<code>redis.conf</code>ä¸­çš„é…ç½®ä»<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">save ""</span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼Œæ‰“å¼€è¢«åŠ¨ä¿å­˜æŒä¹…åŒ–é…ç½®æ‰ç”Ÿæ•ˆ;<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure></p><p>æ€»ç»“<code>RDB</code>æŒä¹…åŒ–æœ‰<code>è¢«åŠ¨ä¿å­˜</code>å’Œ<code>ä¸»åŠ¨ä¿å­˜</code>ä¸¤ç§æ–¹å¼ï¼Œ</p><blockquote><p>è¢«åŠ¨ä¿å­˜å³é€šè¿‡<code>redis.conf</code>é€šè¿‡ä¿å­˜æ¡ä»¶è§¦å‘è¢«åŠ¨ä¿å­˜ï¼Œè¿™ç§æƒ…å†µæ•°æ®æœ‰å¯èƒ½ä¸¢å¤±;<br>ä¸»åŠ¨ä¿å­˜å³é€šè¿‡æ˜¾ç¤ºæ‰§è¡Œ<code>save</code>, <code>bgsave</code>,<code>shutdown(åœ¨è¢«åŠ¨ä¿å­˜é…ç½®ä¸‹æ‰ç”Ÿæ•ˆ)</code>å‘½ä»¤ï¼Œè¿™ç§æƒ…å†µæ•°æ®ä¸ä¼šä¸¢å¤±;</p></blockquote><h5 id="AOFæ–¹å¼æŒä¹…åŒ–"><a href="#AOFæ–¹å¼æŒä¹…åŒ–" class="headerlink" title="AOFæ–¹å¼æŒä¹…åŒ–"></a>AOFæ–¹å¼æŒä¹…åŒ–</h5><hr><p><code>redis</code>é»˜è®¤æ²¡æœ‰å¼€å¯<code>AOF</code>ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶ä¸­å¼€å¯,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å°†appendonlyæ”¹ä¸º yes</span></span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure></p><p><code>AOF</code>å¯ä»¥éœ€è¦è®¾ç½®åŒæ­¥æ–¹å¼<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">appendfsync always  # æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ï¼ˆå®‰å…¨ä½†æ˜¯è´¹æ—¶ï¼‰ã€‚</span><br><span class="line">appendfsync everysec  # æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ä¸ºAOFçš„ç¼ºçœç­–ç•¥ã€‚</span><br><span class="line">appendfsync no  # ä»ä¸åŒæ­¥ã€‚é«˜æ•ˆä½†æ˜¯æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ã€‚</span><br></pre></td></tr></table></figure></p><p>æ ¹æ®ä¸Šé¢çš„è®¾ç½®é‡å¯<code>redis</code>åï¼Œå¯è§<code>data</code>ç›®å½•ä¸‹å·²åˆ›å»ºäº†<code>aof</code>ç©ºæ–‡ä»¶,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it lredis ls -lh /data</span><br><span class="line">total 4.0K</span><br><span class="line">-rw-r--r-- 1 redis redis   0 Oct 24 10:31 appendonly.aof</span><br><span class="line">-rw-r--r-- 1 redis redis 122 Oct 24 10:20 dump.rdb</span><br></pre></td></tr></table></figure></p><p>input<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name china</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set age 80</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set city "shanghai.china"</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "age"</span><br><span class="line">   2) "name"</span><br><span class="line">   3) "city"</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">âœ  ~ docker exec -it lredis cat /data/appendonly.aof</span><br><span class="line">*2</span><br><span class="line"><span class="meta">$</span><span class="bash">6</span></span><br><span class="line">SELECT</span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">4</span></span><br><span class="line">name</span><br><span class="line"><span class="meta">$</span><span class="bash">5</span></span><br><span class="line">china</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">age</span><br><span class="line"><span class="meta">$</span><span class="bash">2</span></span><br><span class="line">80</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">4</span></span><br><span class="line">city</span><br><span class="line"><span class="meta">$</span><span class="bash">14</span></span><br><span class="line">shanghai.china</span><br><span class="line">âœ  ~ docker exec -it lredis ls -lh /data</span><br><span class="line">total 8.0K</span><br><span class="line">-rw-r--r-- 1 redis redis 131 Oct 24 10:35 appendonly.aof</span><br><span class="line">-rw-r--r-- 1 redis redis 122 Oct 24 10:20 dump.rdb</span><br></pre></td></tr></table></figure></p><p>ç”±ä¸Šå¯è§, <code>appendonly.aof</code>æ–‡ä»¶ç”±<code>0</code>å¢å¤§åˆ°<code>131</code> bytes, å¯è§<code>AOF</code>æ–¹å¼æŒä¹…åŒ–æˆåŠŸäº†ï¼Œ å¯ä»¥çœ‹è§<code>appendonly.aof</code>æ–‡ä»¶ä¸­ä¸ä»…ä»…ä¿å­˜äº†è®¾ç½®çš„å˜é‡åŠå€¼ï¼Œè¿™äº›å˜é‡åŠå€¼å‰åè¿˜æœ‰ä¸€äº›ç‰¹æ®Šçš„ç¬¦å·ï¼Œè¿™æ­£æ˜¯æ ¹æ®<code>redis</code>é‡‡ç”¨çš„<code>RESP</code>æ–‡æœ¬åè®®ç”Ÿæˆçš„ï¼Œ è¯¦æƒ…å¯è§ä¹‹å‰æ€»ç»“çš„ <a href="http://researchlab.github.io/2018/10/09/redis-12-resp/">redisä¸“é¢˜12 redisé€šä¿¡åè®®</a><br>åˆ†æ<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">14</span></span><br><span class="line">shanghai.china</span><br><span class="line">å¤šå­—ç¬¦ç”¨$å¼€å¤´ï¼Œ $åè¾¹ç´§è·Ÿå­—ç¬¦ä¸²çš„é•¿åº¦, ç„¶åæ˜¯ \r\n, ç„¶åæ˜¯å­—ç¬¦ä¸²å€¼æœ¬èº«</span><br></pre></td></tr></table></figure></p><blockquote><p><code>AOF</code> åŒæ ·ä¹Ÿä¼šæŠŠ<code>del</code>ç­‰æ‰§è¡Œå‘½ä»¤ä¿å­˜åˆ°<code>AOF</code>æ–‡ä»¶ä¸­;</p></blockquote><blockquote><p>å½“å…³é—­<code>RDB</code>æŒä¹…åŒ–æ–¹å¼ï¼Œ åªæ‰“å¼€<code>AOF</code>æ–¹å¼æ—¶ï¼Œ æ˜¾ç¤ºæ‰§è¡Œ<code>save</code>å’Œ<code>bgsave</code> éƒ½ä¼šå°†å½“å‰æ•°æ®åŒæ—¶ä¿å­˜åˆ°<code>AOF</code>æ–‡ä»¶å’Œ<code>RDB</code>æ–‡ä»¶ä¸­;</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">âœ docker exec -it lredis ls -lh /data</span><br><span class="line">total 0</span><br><span class="line">-rw-r--r-- 1 redis redis 0 Oct 24 10:55 appendonly.aof</span><br><span class="line">âœ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set name china</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set age 80</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">âœ docker exec -it lredis ls -lh /data</span><br><span class="line">total 4.0K</span><br><span class="line">-rw-r--r-- 1 redis redis 87 Oct 24 10:55 appendonly.aof</span><br><span class="line">âœ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set city shanghai</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">âœ docker exec -it lredis ls -lh /data</span><br><span class="line">total 8.0K</span><br><span class="line">-rw-r--r-- 1 redis redis 124 Oct 24 10:56 appendonly.aof</span><br><span class="line">-rw-r--r-- 1 redis redis 131 Oct 24 10:56 dump.rdb</span><br><span class="line">âœ docker exec -it lredis redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set local library</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; bgsave</span><br><span class="line">Background saving started</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br><span class="line">âœ docker exec -it lredis ls -lh /data</span><br><span class="line">total 8.0K</span><br><span class="line">-rw-r--r-- 1 redis redis 161 Oct 24 10:56 appendonly.aof</span><br><span class="line">-rw-r--r-- 1 redis redis 146 Oct 24 10:56 dump.rdb</span><br><span class="line">âœ docker exec -it lredis cat /data/appendonly.aof</span><br><span class="line">*2</span><br><span class="line"><span class="meta">$</span><span class="bash">6</span></span><br><span class="line">SELECT</span><br><span class="line"><span class="meta">$</span><span class="bash">1</span></span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">4</span></span><br><span class="line">name</span><br><span class="line"><span class="meta">$</span><span class="bash">5</span></span><br><span class="line">china</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">age</span><br><span class="line"><span class="meta">$</span><span class="bash">2</span></span><br><span class="line">80</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">4</span></span><br><span class="line">city</span><br><span class="line"><span class="meta">$</span><span class="bash">8</span></span><br><span class="line">shanghai</span><br><span class="line">*3</span><br><span class="line"><span class="meta">$</span><span class="bash">3</span></span><br><span class="line">set</span><br><span class="line"><span class="meta">$</span><span class="bash">5</span></span><br><span class="line">local</span><br><span class="line"><span class="meta">$</span><span class="bash">7</span></span><br><span class="line">library</span><br></pre></td></tr></table></figure><p>ä»<code>RDB</code>æ–¹å¼åˆ‡æ¢åˆ°<code>AOF</code>æ–¹å¼<br>åœ¨<code>Redis2.2</code>æˆ–ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹ï¼Œä»<code>RDB</code>åˆ‡æ¢åˆ°<code>AOF</code>,<br>ä¸ºæœ€æ–°çš„<code>dump.rdb</code>æ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¤‡ä»½ã€å°†å¤‡ä»½æ”¾åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚æ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli config set appendonly yes</span><br><span class="line">redis-cli config set save â€œâ€</span><br></pre></td></tr></table></figure></p><blockquote><p>æ‰§è¡Œçš„ç¬¬ä¸€æ¡å‘½ä»¤å¼€å¯äº†<code>AOF</code>åŠŸèƒ½: <code>Redis</code>ä¼šé˜»å¡ç›´åˆ°åˆå§‹<code>AOF</code>æ–‡ä»¶åˆ›å»ºå®Œæˆä¸ºæ­¢, ä¹‹å<code>Redis</code>ä¼šç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚, å¹¶å¼€å§‹å°†å†™å…¥å‘½ä»¤è¿½åŠ åˆ°<code>AOF</code>æ–‡ä»¶æœ«å°¾;<br>é€šè¿‡ä¸Šè¿°<code>CONFIG SET</code>å‘½ä»¤è®¾ç½®çš„é…ç½®ï¼Œ åœ¨é‡å¯<code>redis</code>æœåŠ¡å™¨ä¹‹åå°†å¤±æ•ˆï¼Œé‡å¯ä¼šä¾ç„¶æŒ‰ç…§ä¹‹å‰çš„é…ç½®å¯åŠ¨ï¼Œæ‰€ä»¥å»ºè®®åœ¨<code>redis.conf</code>é…ç½®ä¸­ä¹Ÿåº”åŒæ­¥ä¿®æ”¹;</p></blockquote><h5 id="å¤‡ä»½å»ºè®®"><a href="#å¤‡ä»½å»ºè®®" class="headerlink" title="å¤‡ä»½å»ºè®®"></a>å¤‡ä»½å»ºè®®</h5><hr><p>ç¡®ä¿ä½ çš„æ•°æ®æœ‰å®Œæ•´çš„å¤‡ä»½ï¼Œç£ç›˜æ•…éšœã€èŠ‚ç‚¹å¤±æ•ˆç­‰é—®é¢˜é—®é¢˜å¯èƒ½è®©ä½ çš„æ•°æ®æ¶ˆå¤±ä¸è§ï¼Œ ä¸è¿›è¡Œå¤‡ä»½æ˜¯éå¸¸å±é™©çš„ã€‚<br><code>Redis</code>å¯¹äºæ•°æ®å¤‡ä»½æ˜¯éå¸¸å‹å¥½çš„ï¼Œ å› ä¸ºä½ å¯ä»¥åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ—¶å€™å¯¹<code>RDB</code>æ–‡ä»¶è¿›è¡Œå¤åˆ¶, RDB æ–‡ä»¶ä¸€æ—¦è¢«åˆ›å»º, å°±ä¸ä¼šè¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚ å½“æœåŠ¡å™¨è¦åˆ›å»ºä¸€ä¸ªæ–°çš„<code>RDB</code>æ–‡ä»¶æ—¶ï¼Œå…ˆå°†æ–‡ä»¶çš„å†…å®¹ä¿å­˜åœ¨ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶é‡Œé¢, å½“ä¸´æ—¶æ–‡ä»¶å†™å…¥å®Œæ¯•æ—¶, ç¨‹åºæ‰ä½¿ç”¨<code>rename(2)</code>åŸå­åœ°ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢åŸæ¥çš„<code>RDB</code>æ–‡ä»¶ã€‚<br>å³æ— è®ºä½•æ—¶, å¤åˆ¶<code>RDB</code>æ–‡ä»¶éƒ½æ˜¯ç»å¯¹å®‰å…¨çš„ã€‚</p><blockquote><p>åˆ›å»ºä¸€ä¸ªå®šæœŸä»»åŠ¡, æ¯å°æ—¶å°†ä¸€ä¸ª<code>RDB</code>æ–‡ä»¶å¤‡ä»½åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹, å¹¶ä¸”æ¯å¤©å°†ä¸€ä¸ª<code>RDB</code>æ–‡ä»¶å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹;</p></blockquote><blockquote><p>ç¡®ä¿å¿«ç…§çš„å¤‡ä»½éƒ½å¸¦æœ‰ç›¸åº”çš„æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯, æ¯æ¬¡æ‰§è¡Œå®šæœŸä»»åŠ¡è„šæœ¬æ—¶, ä½¿ç”¨ find å‘½ä»¤æ¥åˆ é™¤è¿‡æœŸçš„å¿«ç…§, æ¯”å¦‚ä¿ç•™æœ€è¿‘<code>48</code>å°æ—¶å†…çš„æ¯å°æ—¶å¿«ç…§, è¿˜å¯ä»¥ä¿ç•™æœ€è¿‘ä¸€ä¸¤ä¸ªæœˆçš„æ¯æ—¥å¿«ç…§;</p></blockquote><blockquote><p>è‡³å°‘æ¯å¤©ä¸€æ¬¡, å°†<code>RDB</code> å¤‡ä»½åˆ°ä½ çš„æ•°æ®ä¸­å¿ƒä¹‹å¤–, æˆ–è€…è‡³å°‘æ˜¯å¤‡ä»½åˆ°ä½ è¿è¡Œ<code>Redis</code>æœåŠ¡å™¨çš„ç‰©ç†æœºå™¨ä¹‹å¤–;</p></blockquote><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><hr><ul><li>ä¸ºå®è·µ<code>redis</code>æŒä¹…åŒ–æœºåˆ¶ï¼Œåˆ›å»ºäº†<code>docker</code>å®¹å™¨ç¯å¢ƒ;</li><li>é’ˆå¯¹<code>RDB</code>æ–¹å¼æŒä¹…åŒ–ï¼Œåˆ†åˆ«æµ‹è¯•äº†å…¶ä¸»åŠ¨ä¿å­˜å’Œè¢«åŠ¨ä¿å­˜æœºåˆ¶ï¼Œ è¢«åŠ¨ä¿å­˜å­˜åœ¨ä¸¢æ•°æ®çš„å¯èƒ½ï¼Œè€Œä¸»åŠ¨ä¿å­˜åˆ™ä¸ä¼šï¼Œ è¢«åŠ¨ä¿å­˜é€šè¿‡é…ç½®è§¦å‘ä¿å­˜æ¡ä»¶å®ç°, ä¸»åŠ¨ä¿å­˜ä¸»è¦é€šè¿‡æ˜¾ç¤ºæ‰§è¡Œ<code>save</code>,<code>bgsave</code>,<code>shutdown(éœ€å¼€å¯è¢«åŠ¨ä¿å­˜)</code>æ¥æ‰§è¡Œæ•°æ®ä¿å­˜æ“ä½œ;</li><li>é’ˆå¯¹<code>AOF</code>æ–¹å¼æŒä¹…åŒ–è¿›è¡Œäº†å®ä¾‹åˆ†ææµ‹è¯•ï¼Œ<code>AOF</code> å¼€å¯åè‡ªåŠ¨ä¿å­˜æ“ä½œè®°å½•åˆ°<code>AOF</code>æ–‡ä»¶ï¼Œ å½“æ˜¾ç¤ºæ‰§è¡Œ<code>save</code>, <code>bgsave</code>,<code>shutdown</code>æ“ä½œæ—¶ä¹Ÿä¼šè‡ªåŠ¨ä¿å­˜æ•°æ®åˆ°<code>AOF</code>å’Œ<code>RDB</code>æ–‡ä»¶ä¸­ï¼›</li><li>æ¢è®¨äº†åœ¨ä¸åœæœæƒ…å†µä¸‹ä»<code>RDB</code>æ–¹å¼åˆ‡æ¢è‡³<code>AOF</code>çš„æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†å‡ ç‚¹å¤‡ä»½å»ºè®®;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é€šè¿‡ç¤ºä¾‹åˆ†æï¼Œæ·±å…¥äº†è§£&lt;code&gt;redis&lt;/code&gt;æ•°æ®æŒä¹…åŒ–ç­–ç•¥æ‰§è¡Œæœºåˆ¶ï¼›&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜15 äº‹åŠ¡ç³»åˆ—é—®é¢˜</title>
    <link href="http://researchlab.github.io/2018/10/12/redis-15-transaction/"/>
    <id>http://researchlab.github.io/2018/10/12/redis-15-transaction/</id>
    <published>2018-10-12T15:39:41.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ºäº†ç¡®ä¿è¿ç»­å¤šä¸ªæ“ä½œçš„åŸå­æ€§, ä¸€ä¸ªæˆç†Ÿçš„æ•°æ®åº“é€šå¸¸éƒ½ä¼šæœ‰äº‹åŠ¡æ”¯æŒ, <code>Redis</code> ä¹Ÿä¸ä¾‹å¤–, <code>Redis</code> é€šè¿‡<code>MULTI</code>, <code>DISCARD</code>, <code>EXEC</code>, <code>WATCH</code>å’Œ<code>UNWATCH</code> äº”ä¸ªå‘½ä»¤æ¥å®ç°äº‹åŠ¡åŠŸèƒ½;<br><a id="more"></a></p><h5 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h5><p>äº‹åŠ¡æä¾›äº†ä¸€ç§â€å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…ï¼Œ ç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œâ€çš„æœºåˆ¶, å¹¶ä¸”äº‹åŠ¡åœ¨æ‰§è¡Œçš„æœŸé—´ä¸ä¼šä¸»åŠ¨ä¸­æ–­ â€”â€” æœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤ä¹‹å, æ‰ä¼šç»§ç»­å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å…¶ä»–å‘½ä»¤ã€‚</p><h5 id="Redisäº‹åŠ¡"><a href="#Redisäº‹åŠ¡" class="headerlink" title="Redisäº‹åŠ¡"></a><code>Redis</code>äº‹åŠ¡</h5><p>ä¸€ä¸ªåŸºæœ¬<code>Redis</code>äº‹åŠ¡ä»MULITå‘½ä»¤å¼€å§‹ä¸€ä¸ªäº‹åŠ¡, ç„¶åå°†å¤šä¸ªå‘½ä»¤å…¥é˜Ÿåˆ°äº‹åŠ¡ä¸­ï¼Œ æœ€åç”±<code>EXEC</code>å‘½ä»¤è§¦å‘äº‹åŠ¡,</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; `MULTI`</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set name mike</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incr name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set city shanghai</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get city</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; `EXEC`</span><br><span class="line">1) OK</span><br><span class="line">2) (error) ERR value is not an integer or out of range</span><br><span class="line">3) OK</span><br><span class="line">4) "mike"</span><br><span class="line">5) "shanghai"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><ul><li><code>MULTI</code>å‘½ä»¤å”¯ä¸€åšçš„å°±æ˜¯, å°†å®¢æˆ·ç«¯çš„ <code>Redis</code>_<code>MULTI</code> é€‰é¡¹æ‰“å¼€, è®©å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢åˆ°äº‹åŠ¡çŠ¶æ€;</li><li>å½“å®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€ä¸‹æ—¶ï¼Œ æ‰€æœ‰å‘é€ç»™æœåŠ¡å™¨ç«¯çš„å‘½ä»¤éƒ½ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œ; å½“å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹å, æœåŠ¡å™¨åœ¨æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„å‘½ä»¤æ—¶, ä¸ä¼šç«‹å³æ‰§è¡Œå‘½ä»¤, è€Œæ˜¯å°†è¿™äº›å‘½ä»¤å…¨éƒ¨æ”¾è¿›ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œ, ç„¶åè¿”å›QUEUED, è¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿ;</li><li>äº‹åŠ¡é˜Ÿåˆ—é‡Œçš„æ‰€æœ‰å‘½ä»¤è¢«æ‰§è¡Œå®Œä¹‹å, <code>EXEC</code>å‘½ä»¤ä¼šå°†å›å¤é˜Ÿåˆ—ä½œä¸ºè‡ªå·±çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯, å®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è¿”å›åˆ°éäº‹åŠ¡çŠ¶æ€, äº‹åŠ¡æ‰§è¡Œå®Œæ¯•;</li><li>ä»ä¸Šè¿°ç¤ºä¾‹ä¸­å¯å¾—å½“<code>incr name</code>å¤±è´¥å, ä¾ç„¶ç»§ç»­æ‰§è¡Œåç»§çš„<code>set city</code>ç­‰å‘½ä»¤ï¼Œå¯è§<code>Redis</code>äº‹åŠ¡ä¸ä¿è¯æ‰§è¡Œ<code>åŸå­æ€§</code>æ“ä½œ, ä»…æ»¡è¶³<code>éš”ç¦»æ€§</code>æ‰§è¡Œ;</li></ul><p>äº‹åŠ¡ä¸éäº‹åŠ¡çŠ¶æ€çš„åŒºåˆ«<br>äº‹åŠ¡ä¸­çš„å‘½ä»¤å’Œæ™®é€šå‘½ä»¤åœ¨æ‰§è¡Œä¸Šè¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«çš„ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸¤ç‚¹æ˜¯ï¼š</p><blockquote><p>éäº‹åŠ¡çŠ¶æ€ä¸‹çš„å‘½ä»¤ä»¥å•ä¸ªå‘½ä»¤ä¸ºå•ä½æ‰§è¡Œï¼Œå‰ä¸€ä¸ªå‘½ä»¤å’Œåä¸€ä¸ªå‘½ä»¤çš„å®¢æˆ·ç«¯ä¸ä¸€å®šæ˜¯åŒä¸€ä¸ª; è€Œäº‹åŠ¡çŠ¶æ€åˆ™æ˜¯ä»¥ä¸€ä¸ªäº‹åŠ¡ä¸ºå•ä½ï¼Œæ‰§è¡Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤:é™¤éå½“å‰äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¦åˆ™æœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å…¶ä»–å‘½ä»¤;</p></blockquote><blockquote><p>åœ¨éäº‹åŠ¡çŠ¶æ€ä¸‹, æ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœä¼šç«‹å³è¢«è¿”å›ç»™å®¢æˆ·ç«¯; è€Œäº‹åŠ¡åˆ™æ˜¯å°†æ‰€æœ‰å‘½ä»¤çš„ç»“æœé›†åˆåˆ°å›å¤é˜Ÿåˆ—ï¼Œå†ä½œä¸º<code>EXEC</code>å‘½ä»¤çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯;</p></blockquote><ul><li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¢«æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—, å…¶ä¸­çš„ä¾‹å¤–å°±æ˜¯<code>EXEC</code>, <code>DISCARD</code>, <code>MULTI</code>å’Œ<code>WATCH</code>åŠ<code>UNWATCH</code>å‘½ä»¤;</li></ul><blockquote><p><code>DISCARD</code> å‘½ä»¤ç”¨äºå–æ¶ˆä¸€ä¸ªäº‹åŠ¡, å®ƒæ¸…ç©ºå®¢æˆ·ç«¯çš„æ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—, ç„¶åå°†å®¢æˆ·ç«¯ä»äº‹åŠ¡çŠ¶æ€è°ƒæ•´å›éäº‹åŠ¡çŠ¶æ€, æœ€åè¿”å›å­—ç¬¦ä¸²OKç»™å®¢æˆ·ç«¯, è¯´æ˜äº‹åŠ¡å·²è¢«å–æ¶ˆ;</p></blockquote><blockquote><p><code>Redis</code>çš„äº‹åŠ¡æ˜¯ä¸å¯åµŒå¥—çš„, å½“å®¢æˆ·ç«¯å·²ç»å¤„äºäº‹åŠ¡çŠ¶æ€, è€Œå®¢æˆ·ç«¯åˆå†å‘æœåŠ¡å™¨å‘é€<code>MULTI</code>æ—¶, æœåŠ¡å™¨åªæ˜¯ç®€å•åœ°å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé”™è¯¯, ç„¶åç»§ç»­ç­‰å¾…å…¶ä»–å‘½ä»¤çš„å…¥é˜Ÿ; <code>MULTI</code>å‘½ä»¤çš„å‘é€ä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥, ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®;</p></blockquote><blockquote><p><code>WATCH</code>åªèƒ½åœ¨å®¢æˆ·ç«¯è¿›å…¥äº‹åŠ¡çŠ¶æ€ä¹‹å‰æ‰§è¡Œ, åœ¨äº‹åŠ¡çŠ¶æ€ä¸‹å‘é€ <code>WATCH</code> å‘½ä»¤ä¼šå¼•å‘ä¸€ä¸ªé”™è¯¯, ä½†å®ƒä¸ä¼šé€ æˆæ•´ä¸ªäº‹åŠ¡å¤±è´¥, ä¹Ÿä¸ä¼šä¿®æ”¹äº‹åŠ¡é˜Ÿåˆ—ä¸­å·²æœ‰çš„æ•°æ®(å’Œå‰é¢å¤„ç† <code>MULTI</code> çš„æƒ…å†µä¸€æ ·);</p></blockquote><blockquote><p><code>WATCH</code>å‘½ä»¤ç”¨äºåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰ç›‘è§†ä»»æ„æ•°é‡çš„é”®, å½“è°ƒç”¨<code>EXEC</code>å‘½ä»¤æ‰§è¡Œäº‹åŠ¡æ—¶, å¦‚æœä»»æ„ä¸€ä¸ªè¢«ç›‘è§†çš„é”®å·²ç»è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº†, é‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡ä¸å†æ‰§è¡Œ, ç›´æ¥è¿”å›å¤±è´¥;</p></blockquote><h5 id="ä¸MySQLäº‹åŠ¡çš„åŒºåˆ«"><a href="#ä¸MySQLäº‹åŠ¡çš„åŒºåˆ«" class="headerlink" title="ä¸MySQLäº‹åŠ¡çš„åŒºåˆ«"></a>ä¸<code>MySQL</code>äº‹åŠ¡çš„åŒºåˆ«</h5><p>åœ¨<code>MySQL</code>ä¸­åªæœ‰ä½¿ç”¨äº†Innodbæ•°æ®åº“å¼•æ“çš„æ•°æ®åº“æˆ–è¡¨æ‰æ”¯æŒäº‹åŠ¡;</p><blockquote><p>äº‹åŠ¡ä½¿ç”¨çš„ç›®çš„æ˜¯ç»Ÿä¸€ç®¡ç†insert, update, delete è¿™äº›writeæ“ä½œï¼Œä»¥æ­¤æ¥ç»´æŠ¤æ•°æ®å®Œæ•´æ€§ã€‚</p></blockquote><p><strong>å‘½ä»¤åŒºåˆ«</strong><br><code>MySQL</code></p><blockquote><p><code>BEGIN</code>: æ˜¾å¼åœ°å¼€å¯ä¸€ä¸ªäº‹åŠ¡;<br><code>COMMIT</code>: æäº¤äº‹åŠ¡ï¼Œå°†å¯¹æ•°æ®åº“è¿›è¡Œçš„æ‰€æœ‰ä¿®æ”¹å˜æˆä¸ºæ°¸ä¹…æ€§çš„;<br><code>ROLLBACK</code>: ç»“æŸç”¨æˆ·çš„äº‹åŠ¡ï¼Œå¹¶æ’¤é”€æ­£åœ¨è¿›è¡Œçš„æ‰€æœ‰æœªæäº¤çš„ä¿®æ”¹;</p></blockquote><p><code>Redis</code></p><blockquote><p><code>MULTI</code>: æ ‡è®°äº‹åŠ¡çš„å¼€å§‹;<br><code>EXEC</code>: æ‰§è¡Œäº‹åŠ¡çš„commandsé˜Ÿåˆ—;<br><code>DISCARD</code>: ç»“æŸäº‹åŠ¡ï¼Œå¹¶æ¸…é™¤commandsé˜Ÿåˆ—;</p></blockquote><p><strong>é»˜è®¤çŠ¶æ€</strong><br><code>MySQL</code></p><blockquote><p><code>MySQL</code>ä¼šé»˜è®¤å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸”ç¼ºçœè®¾ç½®æ˜¯è‡ªåŠ¨æäº¤ï¼Œå³ï¼Œæ¯æˆåŠŸæ‰§è¡Œä¸€ä¸ªSQLï¼Œä¸€ä¸ªäº‹åŠ¡å°±ä¼šé©¬ä¸Š <code>COMMIT</code>ã€‚æ‰€ä»¥ä¸èƒ½<code>ROLLBACK</code>ã€‚</p></blockquote><p><code>Redis</code></p><blockquote><p><code>Redis</code>é»˜è®¤ä¸ä¼šå¼€å¯äº‹åŠ¡ï¼Œå³commandä¼šç«‹å³æ‰§è¡Œï¼Œè€Œä¸ä¼šæ’é˜Ÿã€‚å¹¶ä¸æ”¯æŒ<code>ROLLBACK</code></p></blockquote><p><strong>ä½¿ç”¨æ–¹å¼</strong><br><code>MySQL</code>åŒ…å«ä¸¤ç§</p><blockquote><p>ç”¨<code>BEGIN</code>, <code>ROLLBACK</code>, <code>COMMIT</code> æ˜¾å¼å¼€å¯å¹¶æ§åˆ¶ä¸€ä¸ª <code>æ–°çš„</code> Transactionã€‚<br>æ‰§è¡Œå‘½ä»¤<code>SET AUTOCOMMIT=0</code>, ç”¨æ¥ç¦æ­¢å½“å‰ä¼šè¯è‡ªåŠ¨<code>COMMIT</code>, æ§åˆ¶é»˜è®¤å¼€å¯çš„äº‹åŠ¡ã€‚</p></blockquote><p><code>Redis</code></p><blockquote><p>ç”¨<code>MULTI</code>, <code>EXEC</code>, <code>DISCARD</code>, æ˜¾å¼å¼€å¯å¹¶æ§åˆ¶ä¸€ä¸ª<code>Transaction</code>(æ³¨æ„è¿™é‡Œæ²¡æœ‰å¼ºè°ƒ<code>æ–°çš„</code>, å› ä¸ºé»˜è®¤æ˜¯ä¸ä¼šå¼€å¯äº‹åŠ¡çš„);</p></blockquote><p><strong>å®ç°åŸç†</strong><br>æ˜¾ç„¶<code>Redis</code>ä¸<code>MySQL</code>ä¸­äº‹åŠ¡çš„åŒºåˆ«å…¶æ ¹æœ¬åŸå› å°±æ˜¯å®ç°ä¸åŒæ–¹å¼é€ æˆçš„;</p><p><code>MySQL</code></p><blockquote><p><code>MySQL</code>å®ç°äº‹åŠ¡ï¼Œæ˜¯åŸºäº<code>UNDO/REDO</code>æ—¥å¿—;<br><code>UNDOæ—¥å¿—</code>è®°å½•ä¿®æ”¹å‰çŠ¶æ€, <code>ROLLBACK</code>åŸºäº<code>UNDOæ—¥å¿—</code>å®ç°;<br><code>REDOæ—¥å¿—</code>è®°å½•ä¿®æ”¹åçš„çŠ¶æ€, <code>COMMIT</code>åŸºäº<code>REDOæ—¥å¿—</code>å®ç°;<br>åœ¨<code>MySQL</code>ä¸­æ— è®ºæ˜¯å¦å¼€å¯äº‹åŠ¡, æ¯ä¸€ä¸ª<code>SQL</code>éƒ½ä¼šè¢«ç«‹å³æ‰§è¡Œå¹¶è¿”å›æ‰§è¡Œç»“æœã€‚ä½†æ˜¯äº‹åŠ¡å¼€å¯åæ‰§è¡Œåçš„çŠ¶æ€åªæ˜¯è®°å½•åœ¨<code>REDOæ—¥å¿—</code>, æ‰§è¡Œ<code>COMMIT</code>, æ•°æ®æ‰ä¼šè¢«å†™å…¥ç£ç›˜ã€‚</p></blockquote><p><code>Redis</code></p><blockquote><p><code>Redis</code>å®ç°äº‹åŠ¡, æ˜¯åŸºäº<code>COMMANDS</code>é˜Ÿåˆ—;<br>å¦‚æœæ²¡æœ‰å¼€å¯äº‹åŠ¡, <code>command</code>å°†ä¼šè¢«ç«‹å³æ‰§è¡Œå¹¶è¿”å›æ‰§è¡Œç»“æœ, å¹¶ä¸”ç›´æ¥å†™å…¥ç£ç›˜;<br>å¦‚æœäº‹åŠ¡å¼€å¯, <code>command</code>ä¸ä¼šè¢«ç«‹å³æ‰§è¡Œ, è€Œæ˜¯æ’å…¥é˜Ÿåˆ—å¹¶è¿”å›æ’é˜ŸçŠ¶æ€ã€‚è°ƒç”¨<code>EXCE</code>æ‰ä¼šæ‰§è¡Œ<code>COMMANDS</code>é˜Ÿåˆ—;</p></blockquote><h5 id="ä¸æ”¯æŒå›æ»š"><a href="#ä¸æ”¯æŒå›æ»š" class="headerlink" title="ä¸æ”¯æŒå›æ»š"></a>ä¸æ”¯æŒå›æ»š</h5><p><code>Redis</code>äº‹åŠ¡ä¸æ”¯æŒå›æ»š, å®˜æ–¹è§£é‡Š, </p><blockquote><p><code>Redis</code>å‘½ä»¤åªä¼šå› ä¸ºé”™è¯¯çš„è¯­æ³•è€Œå¤±è´¥(å¹¶ä¸”è¿™äº›é—®é¢˜ä¸èƒ½åœ¨å…¥é˜Ÿæ—¶å‘ç°), æˆ–æ˜¯å‘½ä»¤ç”¨åœ¨äº†é”™è¯¯ç±»å‹çš„é”®ä¸Šé¢; ä»å®ç”¨æ€§çš„è§’åº¦æ¥è¯´, å¤±è´¥çš„å‘½ä»¤æ˜¯ç”±ç¼–ç¨‹é”™è¯¯é€ æˆçš„, è€Œè¿™äº›é”™è¯¯åº”è¯¥åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­è¢«å‘ç°, è€Œä¸åº”è¯¥å‡ºç°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­;<br>å› ä¸ºä¸éœ€è¦å¯¹å›æ»šè¿›è¡Œæ”¯æŒï¼Œæ‰€ä»¥<code>Redis</code>çš„å†…éƒ¨å¯ä»¥ä¿æŒç®€å•ä¸”å¿«é€Ÿ;</p></blockquote><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤æ‰“åŒ…, ç„¶åä¸€æ¬¡æ€§, æœ‰åºåœ°æ‰§è¡Œçš„æœºåˆ¶; ä¸”åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«ä¸­æ–­, æ‰€æœ‰äº‹åŠ¡å‘½ä»¤æ‰§è¡Œå®Œä¹‹å, äº‹åŠ¡æ‰èƒ½ç»“æŸ;</li><li>å¤šä¸ªå‘½ä»¤ä¼šè¢«å…¥é˜Ÿåˆ°äº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ‰§è¡Œ;</li><li><code>Redis</code>äº‹åŠ¡ä»…ä¿è¯äº†äº‹åŠ¡çš„éš”ç¦»æ‰§è¡Œ; ä¸ä¿è¯åŸå­æ€§ï¼š<code>Redis</code>åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š;</li><li>å¯ä»¥é€šè¿‡ç®¡é“æŠ€æœ¯å¯¹äº‹åŠ¡è¿›è¡Œä¼˜åŒ–;</li><li>é€šè¿‡<code>WATCH</code>å‘½ä»¤åœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰ç›‘æ§äº†å¤šä¸ªKeysï¼Œå€˜è‹¥åœ¨<code>WATCH</code>ä¹‹åæœ‰ä»»ä½•Keyçš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œ<code>EXEC</code>å‘½ä»¤æ‰§è¡Œçš„äº‹åŠ¡éƒ½å°†è¢«æ”¾å¼ƒï¼ŒåŒæ—¶è¿”å›Null<code>MULTI</code>-bulkåº”ç­”ä»¥é€šçŸ¥è°ƒç”¨è€…äº‹åŠ¡æ‰§è¡Œå¤±è´¥</li><li>æ‚²è§‚é”(Pessimistic Lock), é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šblockç›´åˆ°å®ƒæ‹¿åˆ°é”ã€‚ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“é‡Œè¾¹å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”;</li><li>ä¹è§‚é”(Optimistic Lock), é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹, æ‰€ä»¥ä¸ä¼šä¸Šé”, ä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ã€‚ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ï¼Œä¹è§‚é”ç­–ç•¥:æäº¤ç‰ˆæœ¬å¿…é¡»å¤§äºè®°å½•å½“å‰ç‰ˆæœ¬æ‰èƒ½æ‰§è¡Œæ›´æ–°;</li><li>å¯¹æ¯”åˆ†æäº†<code>Redis</code>äº‹åŠ¡ä¸<code>MySQL</code>äº‹åŠ¡çš„å¼‚åŒç‚¹;</li><li>ä»å®˜æ–¹è§£é‡Šä¸­é˜è¿°ä¸ºä½•<code>Redis</code>äº‹åŠ¡æ²¡æœ‰å¿…è¦æ”¯æŒå›æ»šæœºåˆ¶;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸ºäº†ç¡®ä¿è¿ç»­å¤šä¸ªæ“ä½œçš„åŸå­æ€§, ä¸€ä¸ªæˆç†Ÿçš„æ•°æ®åº“é€šå¸¸éƒ½ä¼šæœ‰äº‹åŠ¡æ”¯æŒ, &lt;code&gt;Redis&lt;/code&gt; ä¹Ÿä¸ä¾‹å¤–, &lt;code&gt;Redis&lt;/code&gt; é€šè¿‡&lt;code&gt;MULTI&lt;/code&gt;, &lt;code&gt;DISCARD&lt;/code&gt;, &lt;code&gt;EXEC&lt;/code&gt;, &lt;code&gt;WATCH&lt;/code&gt;å’Œ&lt;code&gt;UNWATCH&lt;/code&gt; äº”ä¸ªå‘½ä»¤æ¥å®ç°äº‹åŠ¡åŠŸèƒ½;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜14 æ€§èƒ½æå‡ä¹‹ç®¡é“æŠ€æœ¯</title>
    <link href="http://researchlab.github.io/2018/10/11/redis-14-pipeline/"/>
    <id>http://researchlab.github.io/2018/10/11/redis-14-pipeline/</id>
    <published>2018-10-11T15:37:51.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨<code>redisç®¡é“æŠ€æœ¯</code>å¯¹æ‰§è¡Œç»“æœæ²¡æœ‰äº’ç›¸ä¾èµ–ï¼Œå¯¹ç»“æœå“åº”ä¹Ÿæ— éœ€ç«‹å³è·å¾—çš„å‘½ä»¤é›†æ‰¹é‡æäº¤åˆ°<code>redis</code>æœåŠ¡å™¨çš„æ–¹å¼ï¼Œèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡<code>redis</code>æ€§èƒ½ï¼Œæ€§èƒ½æå‡çš„åŸå› ä¸»è¦æ˜¯TCPè¿æ¥ä¸­å‡å°‘äº†<code>äº¤äº’å¾€è¿”</code>çš„æ—¶é—´ã€‚<br><a id="more"></a></p><blockquote><p><code>Redisç®¡é“(Pipeline)</code>æœ¬èº«å¹¶ä¸æ˜¯<code>Redis</code>æœåŠ¡å™¨ç›´æ¥æä¾›çš„æŠ€æœ¯ï¼Œè¿™ä¸ªæŠ€æœ¯æœ¬è´¨ä¸Šæ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè·ŸæœåŠ¡å™¨æ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„å…³ç³»ã€‚</p></blockquote><h5 id="æ¶ˆæ¯äº¤äº’"><a href="#æ¶ˆæ¯äº¤äº’" class="headerlink" title="æ¶ˆæ¯äº¤äº’"></a>æ¶ˆæ¯äº¤äº’</h5><p><code>redis</code>æ˜¯ä½¿ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹çš„TCPæœåŠ¡å™¨ï¼Œç§°ä¸ºè¯·æ±‚/å“åº”åè®®ã€‚<br>è¿™æ„å‘³ç€é€šå¸¸ä¸€ä¸ªè¯·æ±‚æ˜¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®Œæˆçš„:</p><blockquote><p>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æŸ¥è¯¢ï¼Œå¹¶é€šå¸¸ä»¥é˜»å¡çš„æ–¹å¼ä»å¥—æ¥å­—è¯»å–æœåŠ¡å™¨å“åº”ã€‚<br>æœåŠ¡å™¨å¤„ç†å‘½ä»¤å¹¶å°†å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚</p></blockquote><p>æ¯ä¸€ä¸ª<code>redis</code>å‘½ä»¤request/responseéƒ½éœ€è¦ç»å†ä¸€ä¸ª<code>RTT</code>(Round-Trip Time å¾€è¿”æ—¶é—´), å¦‚æœéœ€è¦æ‰§è¡Œå¾ˆå¤šçŸ­å°çš„å‘½ä»¤ï¼Œè¿™äº›å¾€è¿”æ—¶é—´çš„å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œåœ¨æ­¤æƒ…å½¢ä¸‹ï¼Œredisæå‡ºäº†<code>ç®¡é“</code>æ¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p><h5 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h5><blockquote><p>å¦‚æœclientæ‰§è¡Œä¸€äº›ç›¸äº’ä¹‹é—´æ— å…³çš„å‘½ä»¤æˆ–è€…ä¸éœ€è¦è·å–å‘½ä»¤çš„è¿”å›å€¼ï¼Œé‚£ä¹ˆrediså…è®¸ä½ è¿ç»­å‘é€å¤šæ¡å‘½ä»¤ï¼Œè€Œä¸éœ€è¦ç­‰å¾…å‰é¢å‘½ä»¤æ‰§è¡Œå®Œæ¯•;</p></blockquote><blockquote><p>æ¯”å¦‚æˆ‘ä»¬æ‰§è¡Œ3æ¡INCRå‘½ä»¤ï¼Œå¦‚æœä½¿ç”¨ç®¡é“ï¼Œç†è®ºä¸Šåªéœ€è¦ä¸€ä¸ªRTT+3æ¡å‘½ä»¤çš„æ‰§è¡Œæ—¶é—´å³å¯ï¼Œå¦‚æœä¸é€‚ç”¨ç®¡é“ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦é¢å¤–çš„ä¸¤ä¸ªRTTæ—¶é—´;</p></blockquote><blockquote><p>å› æ­¤ï¼Œç®¡é“ç›¸å½“äºæ‰¹å¤„ç†è„šæœ¬ï¼Œç›¸å½“äºæ˜¯å‘½ä»¤é›†;</p></blockquote><blockquote><p>æ‰§è¡Œç®¡é“å‘½ä»¤ä¸­, <code>redis</code>å¿…é¡»åœ¨å¤„ç†å®Œæ‰€æœ‰å‘½ä»¤å‰å…ˆç¼“å­˜èµ·æ‰€æœ‰å‘½ä»¤çš„å¤„ç†ç»“æœã€‚æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šï¼Œç¼“å­˜æ¶ˆè€—å†…å­˜ä¹Ÿè¶Šå¤šã€‚æ‰€ä»¥å¹¶ä¸æ˜¯æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šè¶Šå¥½ã€‚å…·ä½“å¤šå°‘åˆé€‚éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µæµ‹è¯•ã€‚</p></blockquote><p><strong>æ³¨æ„</strong></p><blockquote><p>æ‰§è¡Œ<code>ç®¡é“</code>å‘½ä»¤æœŸé—´å°†<code>ç‹¬å </code>é“¾æ¥ï¼Œæ­¤æœŸé—´å°†ä¸èƒ½è¿›è¡Œé<code>ç®¡é“</code>ç±»å‹çš„å…¶ä»–æ“ä½œï¼Œç›´åˆ°ç®¡é“å…³é—­ï¼›</p></blockquote><blockquote><p>å¦‚æœ<code>ç®¡é“</code>çš„æŒ‡ä»¤é›†å¾ˆåºå¤§ï¼Œä¸ºäº†ä¸å¹²æ‰°é“¾æ¥ä¸­çš„å…¶ä»–æ“ä½œï¼Œå»ºè®®ä¸º<code>ç®¡é“</code>æ“ä½œæ–°å»ºClienté“¾æ¥ï¼Œè®©<code>ç®¡é“</code>å’Œå…¶ä»–æ­£å¸¸æ“ä½œåˆ†ç¦»åœ¨2ä¸ªclientä¸­; </p></blockquote><blockquote><p>ä¸è¿‡<code>ç®¡é“</code>äº‹å®ä¸Šæ‰€èƒ½å®¹å¿çš„æ“ä½œä¸ªæ•°ï¼Œå’Œsocket-outputç¼“å†²åŒºå¤§å°/è¿”å›ç»“æœçš„æ•°æ®å°ºå¯¸éƒ½æœ‰å¾ˆå¤§çš„å…³ç³»ï¼›åŒæ—¶ä¹Ÿæ„å‘³ç€æ¯ä¸ªredis-serveråŒæ—¶æ‰€èƒ½æ”¯æ’‘çš„ç®¡é“é“¾æ¥çš„ä¸ªæ•°ï¼Œä¹Ÿæ˜¯æœ‰é™çš„ï¼Œè¿™å°†å—é™äºserverçš„ç‰©ç†å†…å­˜æˆ–ç½‘ç»œæ¥å£çš„ç¼“å†²èƒ½åŠ›ã€‚</p></blockquote><h5 id="å‹åŠ›æµ‹è¯•"><a href="#å‹åŠ›æµ‹è¯•" class="headerlink" title="å‹åŠ›æµ‹è¯•"></a>å‹åŠ›æµ‹è¯•</h5><p>Redis è‡ªå¸¦äº†ä¸€ä¸ªå‹åŠ›æµ‹è¯•å·¥å…·redis-benchmarkï¼Œä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¯ä»¥è¿›è¡Œç®¡é“æµ‹è¯•ã€‚</p><p>å¯¹ä¸€ä¸ªæ™®é€šçš„<code>set</code>æŒ‡ä»¤è¿›è¡Œå‹æµ‹ï¼ŒQPS å¤§çº¦<code>6w/s</code>ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  02 docker exec -it redisbloom redis-benchmark -t set -q</span><br><span class="line">SET: 64350.06 requests per second</span><br></pre></td></tr></table></figure></p><p><code>-P</code>å‚æ•°ï¼Œè¡¨ç¤ºå•ä¸ªç®¡é“å†…å¹¶è¡Œçš„è¯·æ±‚æ•°é‡ï¼Œçœ‹ä¸‹é¢<code>P=2</code>ï¼ŒQPS è¾¾åˆ°äº†<code>8w/s</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redisbloom redis-benchmark -t set -q -P 2</span><br><span class="line">SET: 89365.51 requests per second</span><br></pre></td></tr></table></figure><p>å†çœ‹çœ‹<code>P=5</code>ï¼Œ<code>QPS</code>è¾¾åˆ°äº†<code>10w/s</code>ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">âœ  02 docker exec -it redisbloom redis-benchmark -t set -q -P 5</span><br><span class="line">SET: 106723.59 requests per second</span><br></pre></td></tr></table></figure></p><p>ä½†å¦‚æœå†ç»§ç»­æå‡<code>P</code>å‚æ•°ï¼Œå‘ç°<code>QPS</code>å·²ç»ä¸Šä¸å»äº†ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å› ä¸ºè¿™é‡Œ<code>CPU</code>å¤„ç†èƒ½åŠ›å·²ç»è¾¾åˆ°äº†ç“¶é¢ˆï¼Œ<code>Redis</code>çš„å•çº¿ç¨‹<code>CPU</code>å·²ç»é£™åˆ°äº†<code>100%</code>ï¼Œæ‰€ä»¥æ— æ³•å†ç»§ç»­æå‡äº†ã€‚</p><p>æ·±å…¥ç†è§£ç®¡é“æœ¬è´¨<br>æ¥ä¸‹æ¥æˆ‘ä»¬æ·±å…¥åˆ†æä¸€ä¸ªè¯·æ±‚äº¤äº’çš„æµç¨‹ï¼ŒçœŸå®çš„æƒ…å†µæ˜¯å®ƒå¾ˆå¤æ‚ï¼Œå› ä¸ºè¦ç»è¿‡ç½‘ç»œåè®®æ ˆï¼Œè¿™ä¸ªå°±å¾—æ·±å…¥å†…æ ¸äº†ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">client ---&gt; request  ---&gt; send buffer ---&gt; NIC ---&gt; Gateway Router ---&gt; NIC ---&gt; recv buffer ---&gt; request  ---&gt; server </span><br><span class="line">                                                                                                                 |</span><br><span class="line">client &lt;--- response &lt;--- recv buffer &lt;--- NIC &lt;--- Gateway Router &lt;--- NIC &lt;--- send buffer &lt;--- response &lt;---  V</span><br></pre></td></tr></table></figure></p><p>ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚äº¤äº’æµç¨‹å›¾,</p><ol><li>å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨<code>write</code>å°†æ¶ˆæ¯å†™åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†²<code>send buffer</code>;</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°<code>ç½‘å¡</code>ï¼Œ<code>ç½‘å¡</code>ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œè·¯ç”±ã€é€åˆ°æœåŠ¡å™¨çš„<code>ç½‘å¡</code>;</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†<code>ç½‘å¡</code>çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†²<code>recv buffer</code>;</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨<code>read</code>ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†;</li><li>æœåŠ¡å™¨è¿›ç¨‹è°ƒç”¨<code>write</code>å°†å“åº”æ¶ˆæ¯å†™åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å‘é€ç¼“å†²<code>send buffer</code>;</li><li>æœåŠ¡å™¨æ“ä½œç³»ç»Ÿå†…æ ¸å°†å‘é€ç¼“å†²çš„å†…å®¹å‘é€åˆ°<code>ç½‘å¡</code>ï¼Œ<code>ç½‘å¡</code>ç¡¬ä»¶å°†æ•°æ®é€šè¿‡ã€Œè·¯ç”±ã€é€åˆ°å®¢æˆ·ç«¯çš„<code>ç½‘å¡</code>ã€‚</li><li>å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿå†…æ ¸å°†<code>ç½‘å¡</code>çš„æ•°æ®æ”¾åˆ°å†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„æ¥æ”¶ç¼“å†²<code>recv buffer</code>;</li><li>å®¢æˆ·ç«¯è¿›ç¨‹è°ƒç”¨<code>read</code>ä»æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¶ˆæ¯è¿”å›ç»™ä¸Šå±‚ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†;</li></ol><blockquote><p><code>write</code>æ“ä½œä¸æ˜¯ç­‰åˆ°å¯¹æ–¹æ”¶åˆ°æ¶ˆæ¯æ‰ä¼šè¿”å›ã€‚<code>write</code>æ“ä½œåªè´Ÿè´£å°†æ•°æ®å†™åˆ°æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„å‘é€ç¼“å†²ç„¶åå°±è¿”å›äº†ã€‚å‰©ä¸‹çš„äº‹äº¤ç»™æ“ä½œç³»ç»Ÿå†…æ ¸å¼‚æ­¥å°†æ•°æ®é€åˆ°ç›®æ ‡æœºå™¨ã€‚ä½†æ˜¯å¦‚æœå‘é€ç¼“å†²æ»¡äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ç¼“å†²ç©ºå‡ºç©ºé—²ç©ºé—´æ¥ï¼Œè¿™ä¸ªå°±æ˜¯å†™æ“ä½œ<code>IO</code>æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p></blockquote><blockquote><p><code>read</code>æ“ä½œä¸æ˜¯ä»ç›®æ ‡æœºå™¨æ‹‰å–æ•°æ®ã€‚<code>read</code>æ“ä½œåªè´Ÿè´£å°†æ•°æ®ä»æœ¬åœ°æ“ä½œç³»ç»Ÿå†…æ ¸çš„æ¥æ”¶ç¼“å†²ä¸­å–å‡ºæ¥å°±äº†äº‹äº†ã€‚ä½†æ˜¯å¦‚æœç¼“å†²æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…æ•°æ®åˆ°æ¥ï¼Œè¿™ä¸ªå°±æ˜¯è¯»æ“ä½œ<code>IO</code>æ“ä½œçš„çœŸæ­£è€—æ—¶ã€‚</p></blockquote><p>æ‰€ä»¥å¯¹äº<code>value = redis.get(key)</code>è¿™æ ·ä¸€ä¸ªç®€å•çš„è¯·æ±‚æ¥è¯´ï¼Œ<code>write</code>æ“ä½œå‡ ä¹æ²¡æœ‰è€—æ—¶ï¼Œç›´æ¥å†™åˆ°å‘é€ç¼“å†²å°±è¿”å›ï¼Œè€Œ<code>read</code>å°±ä¼šæ¯”è¾ƒè€—æ—¶äº†ï¼Œå› ä¸ºå®ƒè¦ç­‰å¾…æ¶ˆæ¯ç»è¿‡ç½‘ç»œè·¯ç”±åˆ°ç›®æ ‡æœºå™¨å¤„ç†åçš„å“åº”æ¶ˆæ¯,å†å›é€åˆ°å½“å‰çš„å†…æ ¸è¯»ç¼“å†²æ‰å¯ä»¥è¿”å›ã€‚è¿™æ‰æ˜¯ä¸€ä¸ªç½‘ç»œæ¥å›çš„çœŸæ­£å¼€é”€ã€‚</p><p>è€Œå¯¹äºç®¡é“æ¥è¯´ï¼Œè¿ç»­çš„<code>write</code>æ“ä½œæ ¹æœ¬å°±æ²¡æœ‰è€—æ—¶ï¼Œä¹‹åç¬¬ä¸€ä¸ª<code>read</code>æ“ä½œä¼šç­‰å¾…ä¸€ä¸ªç½‘ç»œçš„æ¥å›å¼€é”€ï¼Œç„¶åæ‰€æœ‰çš„å“åº”æ¶ˆæ¯å°±éƒ½å·²ç»å›é€åˆ°å†…æ ¸çš„è¯»ç¼“å†²äº†ï¼Œåç»­çš„<code>read</code>æ“ä½œç›´æ¥å°±å¯ä»¥ä»ç¼“å†²æ‹¿åˆ°ç»“æœï¼Œç¬é—´å°±è¿”å›äº†ã€‚</p><h5 id="ç®¡é“VSäº‹åŠ¡"><a href="#ç®¡é“VSäº‹åŠ¡" class="headerlink" title="ç®¡é“VSäº‹åŠ¡"></a>ç®¡é“VSäº‹åŠ¡</h5><blockquote><p>ç®¡é“å’Œäº‹åŠ¡æ˜¯ä¸åŒçš„ï¼Œpipelineåªæ˜¯è¡¨è¾¾â€äº¤äº’â€ä¸­æ“ä½œçš„ä¼ é€’çš„æ–¹å‘æ€§ï¼Œpipelineä¹Ÿå¯ä»¥åœ¨äº‹åŠ¡ä¸­è¿è¡Œï¼Œä¹Ÿå¯ä»¥ä¸åœ¨ã€‚</p></blockquote><blockquote><p>æ— è®ºå¦‚ä½•ï¼Œpipelineä¸­å‘é€çš„æ¯ä¸ªcommandéƒ½ä¼šè¢«serverç«‹å³æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå°†ä¼šåœ¨æ­¤åçš„ç›¸åº”ç»“æœé›†ä¸­å¾—åˆ°ä¿¡æ¯ï¼›ä¹Ÿå°±æ˜¯pipelineå¹¶ä¸æ˜¯è¡¨è¾¾â€æ‰€æœ‰commandéƒ½ä¸€èµ·æˆåŠŸâ€çš„è¯­ä¹‰ï¼Œç®¡é“ä¸­å‰é¢å‘½ä»¤å¤±è´¥ï¼Œåé¢å‘½ä»¤ä¸ä¼šæœ‰å½±å“ï¼Œç»§ç»­æ‰§è¡Œã€‚</p></blockquote><blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ç®¡é“ä¸­çš„å‘½ä»¤æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå®ƒä»¬åªæ˜¯åƒç®¡é“ä¸€æ ·æµæ°´å‘ç»™serverï¼Œè€Œä¸æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œä»…æ­¤è€Œå·²; ä½†æ˜¯å¦‚æœpipelineçš„æ“ä½œè¢«å°è£…åœ¨äº‹åŠ¡ä¸­ï¼Œé‚£ä¹ˆå°†æœ‰äº‹åŠ¡æ¥ç¡®ä¿æ“ä½œçš„æˆåŠŸä¸å¤±è´¥ã€‚</p></blockquote><blockquote><p>pipeline åªæ˜¯æŠŠå¤šä¸ªredisæŒ‡ä»¤ä¸€èµ·å‘å‡ºå»ï¼Œrediså¹¶æ²¡æœ‰ä¿è¯è¿™äº›æŒ‡å®šçš„æ‰§è¡Œæ˜¯åŸå­çš„ï¼›multiç›¸å½“äºä¸€ä¸ªredisçš„transactionçš„ï¼Œä¿è¯æ•´ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œé¿å…ç”±äºä¸­é€”å‡ºé”™è€Œå¯¼è‡´æœ€åäº§ç”Ÿçš„æ•°æ®ä¸ä¸€è‡´</p></blockquote><h5 id="ç®¡é“VSè„šæœ¬"><a href="#ç®¡é“VSè„šæœ¬" class="headerlink" title="ç®¡é“VSè„šæœ¬"></a>ç®¡é“VSè„šæœ¬</h5><blockquote><p>ä½¿ç”¨ç®¡é“å¯èƒ½åœ¨æ•ˆç‡ä¸Šæ¯”ä½¿ç”¨scriptè¦å¥½ï¼Œä½†æ˜¯æœ‰çš„æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨scriptã€‚å› ä¸ºåœ¨æ‰§è¡Œåé¢çš„å‘½ä»¤æ—¶, æ— æ³•å¾—åˆ°å‰é¢å‘½ä»¤çš„ç»“æœï¼Œå°±åƒäº‹åŠ¡ä¸€æ ·ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦åœ¨åé¢å‘½ä»¤ä¸­ä½¿ç”¨å‰é¢å‘½ä»¤çš„valueç­‰ç»“æœï¼Œåˆ™åªèƒ½ä½¿ç”¨scriptæˆ–è€…äº‹åŠ¡+watch;</p></blockquote><blockquote><p>ä½¿ç”¨Redisè„šæœ¬(åœ¨Redisç‰ˆæœ¬2.6+), å¯ä»¥ä½¿ç”¨æ‰§è¡ŒæœåŠ¡å™¨ç«¯æ‰€éœ€çš„å¤§é‡å·¥ä½œçš„è„šæœ¬æ›´é«˜æ•ˆåœ°å¤„ç†ä¸€äº›pipeliningç”¨ä¾‹;</p></blockquote><blockquote><p>è„šæœ¬çš„ä¸€å¤§ä¼˜åŠ¿æ˜¯å®ƒèƒ½å¤Ÿä»¥æœ€å°çš„å»¶è¿Ÿè¯»å–å’Œå†™å…¥æ•°æ®ï¼Œä½¿å¾—è¯»å–ï¼Œè®¡ç®—ï¼Œå†™å…¥ç­‰æ“ä½œéå¸¸å¿«é€Ÿ(åœ¨è¿™ç§æƒ…å†µä¸‹, æµæ°´çº¿æ“ä½œæ— æ³•æä¾›å¸®åŠ©, å› ä¸ºå®¢æˆ·ç«¯å…ˆéœ€è¦è¯»å‘½ä»¤çš„å›åº”, å®ƒæ‰å¯ä»¥è°ƒç”¨å†™å‘½ä»¤);</p></blockquote><blockquote><p>æœ‰æ—¶ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½è¿˜æƒ³åœ¨ç®¡é“ä¸­å‘é€<code>EVAL</code>æˆ–<code>EVALSHA</code>å‘½ä»¤ã€‚è¿™æ˜¯å®Œå…¨å¯èƒ½çš„ï¼ŒRedisé€šè¿‡SCRIPT LOADå‘½ä»¤æ˜ç¡®åœ°æ”¯æŒå®ƒ(å®ƒä¿è¯å¯ä»¥è°ƒç”¨EVALSHAè€Œæ²¡æœ‰å¤±è´¥çš„é£é™©);</p></blockquote><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>ä»åˆ†æ<code>redis</code>é‡‡ç”¨<code>tcp</code>æ¶ˆæ¯åè®®å…¥æ‰‹, ä¸ºè¿›ä¸€æ­¥æå‡<code>redis</code>æ€§èƒ½çš„è§’åº¦ï¼Œæ¢è®¨äº†<code>ç®¡é“</code>æŠ€æœ¯åœ¨<code>redis</code>ä¸­çš„åº”ç”¨;  </li><li>è¿›ä¸€æ­¥åˆ†æäº†ç®¡é“çš„åŸç†, å› ä¸º<code>redis</code>éœ€è¦åœ¨å¤„ç†å®Œç®¡é“å‘½ä»¤é›†å‰æŠŠä¹‹å‰çš„ç»“æœå…ˆç¼“å­˜ä¸‹æ¥ï¼Œæ‰€ä»¥ç®¡é“å¹¶ä¸æ˜¯æ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šè¶Šå¥½ï¼Œå› ä¸ºæ‰“åŒ…çš„å‘½ä»¤è¶Šå¤šå ç”¨çš„ç¼“å­˜ä¹Ÿä¼šç›¸åº”çš„å¢å¤§, åŒæ—¶åœ¨æ‰§è¡Œç®¡é“å‘½ä»¤å®Œæˆå‰, åŒä¸€ä¸ª<code>redis</code>è¿æ¥æ— æ³•ç»§ç»­æ‰§è¡Œéç®¡é“å‘½ä»¤;</li><li>é€šè¿‡æ¶ˆæ¯äº¤äº’ç¤ºä¾‹ï¼Œ è¿›ä¸€æ­¥æ·±å…¥åˆ†æäº†ç®¡é“çš„æœ¬è´¨ï¼Œç®¡é“æ‰“åŒ…å¤šæ¡å‘½ä»¤ä¸ºå®¢æœç«¯â€“æœåŠ¡ç«¯èŠ‚çœäº†å¾€è¿”(RTT)ç­‰å¾…è€—æ—¶, å› è€Œè¿›ä¸€æ­¥æå‡äº†<code>redis</code>æ€§èƒ½;</li><li>æœ€åå¯¹æ¯”åˆ†æäº†<code>ç®¡é“</code>ä¸<code>redisäº‹åŠ¡</code>, <code>redisè„šæœ¬</code>ä¹‹é—´çš„åŒºåˆ«ï¼Œ è¿›ä¸€æ­¥é˜è¿°äº†<code>ç®¡é“</code>ï¼Œ<code>äº‹åŠ¡</code>, <code>è„šæœ¬</code>å„è‡ªé€‚ç”¨çš„åœºæ™¯;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç”¨&lt;code&gt;redisç®¡é“æŠ€æœ¯&lt;/code&gt;å¯¹æ‰§è¡Œç»“æœæ²¡æœ‰äº’ç›¸ä¾èµ–ï¼Œå¯¹ç»“æœå“åº”ä¹Ÿæ— éœ€ç«‹å³è·å¾—çš„å‘½ä»¤é›†æ‰¹é‡æäº¤åˆ°&lt;code&gt;redis&lt;/code&gt;æœåŠ¡å™¨çš„æ–¹å¼ï¼Œèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šæå‡&lt;code&gt;redis&lt;/code&gt;æ€§èƒ½ï¼Œæ€§èƒ½æå‡çš„åŸå› ä¸»è¦æ˜¯TCPè¿æ¥ä¸­å‡å°‘äº†&lt;code&gt;äº¤äº’å¾€è¿”&lt;/code&gt;çš„æ—¶é—´ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜13 æ•°æ®å­˜å‚¨ä¸æŒä¹…åŒ–</title>
    <link href="http://researchlab.github.io/2018/10/10/redis-13-data-storage-solution/"/>
    <id>http://researchlab.github.io/2018/10/10/redis-13-data-storage-solution/</id>
    <published>2018-10-10T12:36:10.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p><code>redis</code>æä¾›ä¸¤ç§æ–¹å¼è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¸€ç§æ˜¯<code>RDB</code>å¿«ç…§æŒä¹…åŒ–(åŸç†æ˜¯å°†Reidsåœ¨å†…å­˜ä¸­çš„æ•°æ®åº“è®°å½•å‹ç¼©åå®šæ—¶dumpåˆ°ç£ç›˜ä¸Šçš„<code>RDB</code>æŒä¹…åŒ–,å­˜å‚¨ç´§å‡‘)ï¼Œå¦å¤–ä¸€ç§æ˜¯<code>AOF</code>(append only file)æŒä¹…åŒ–(åŸç†æ˜¯å°†Reidsçš„æ“ä½œæ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶), <code>AOF</code> æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½<code>AOF</code>æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡Œ<code>AOF</code>é‡å†™ï¼Œç»™<code>AOF</code>æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚<br><a id="more"></a></p><h4 id="RDBå¿«ç…§åŸç†"><a href="#RDBå¿«ç…§åŸç†" class="headerlink" title="RDBå¿«ç…§åŸç†"></a><code>RDB</code>å¿«ç…§åŸç†</h4><p><code>RDB</code>(å¿«ç…§/å†…å­˜å¿«ç…§)ï¼Œå°±æ˜¯<code>redis</code>æŒ‰ç…§ä¸€å®šçš„æ—¶é—´å‘¨æœŸå°†ç›®å‰æœåŠ¡ä¸­çš„æ‰€æœ‰æ•°æ®å…¨éƒ¨å†™å…¥åˆ°ç£ç›˜ä¸­ã€‚<br>æˆ‘ä»¬çŸ¥é“<code>redis</code>æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œè¿™ä¸ªçº¿ç¨‹è¦åŒæ—¶è´Ÿè´£å¤šä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—çš„å¹¶å‘è¯»å†™æ“ä½œå’Œå†…å­˜æ•°æ®ç»“æ„çš„é€»è¾‘è¯»å†™ã€‚</p><p>åœ¨æœåŠ¡çº¿ä¸Šè¯·æ±‚çš„åŒæ—¶ï¼Œ<code>redis</code> è¿˜éœ€è¦è¿›è¡Œå†…å­˜å¿«ç…§ï¼Œå†…å­˜å¿«ç…§è¦æ±‚<code>redis</code> å¿…é¡»è¿›è¡Œæ–‡ä»¶IOæ“ä½œï¼Œå¯<strong>æ–‡ä»¶IOæ“ä½œæ˜¯ä¸èƒ½ä½¿ç”¨å¤šè·¯å¤ç”¨API</strong>ã€‚é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p><code>redis</code>ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¤šè¿›ç¨‹<code>COW(Copy On Write) æœºåˆ¶</code>æ¥å®ç°å¿«ç…§æŒä¹…åŒ–ã€‚</p><p><code>redis</code> åœ¨æŒä¹…åŒ–æ—¶ä¼š<code>fork</code>ä¸€ä¸ªå­è¿›ç¨‹ï¼Œ<strong>å¿«ç…§æŒä¹…åŒ–å®Œå…¨äº¤ç»™å­è¿›ç¨‹æ¥å¤„ç†ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</strong>ã€‚å­è¿›ç¨‹åšæ•°æ®æŒä¹…åŒ–ï¼Œå®ƒä¸ä¼šä¿®æ”¹ç°æœ‰çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œå®ƒåªæ˜¯å¯¹æ•°æ®ç»“æ„è¿›è¡Œéå†è¯»å–ï¼Œç„¶ååºåˆ—åŒ–å†™åˆ°ç£ç›˜ä¸­ã€‚ä½†æ˜¯çˆ¶è¿›ç¨‹ä¸ä¸€æ ·ï¼Œå®ƒå¿…é¡»æŒç»­æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åå¯¹å†…å­˜æ•°æ®ç»“æ„è¿›è¡Œä¸é—´æ–­çš„ä¿®æ”¹ã€‚</p><p>è¿™ä¸ªæ—¶å€™å°±ä¼šä½¿ç”¨æ“ä½œç³»ç»Ÿçš„<code>COWæœºåˆ¶</code>æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ã€‚æ•°æ®æ®µæ˜¯ç”±å¾ˆå¤šæ“ä½œç³»ç»Ÿçš„é¡µé¢ç»„åˆè€Œæˆï¼Œå½“çˆ¶è¿›ç¨‹å¯¹å…¶ä¸­ä¸€ä¸ªé¡µé¢çš„æ•°æ®è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šå°†è¢«å…±äº«çš„é¡µé¢å¤åˆ¶ä¸€ä»½åˆ†ç¦»å‡ºæ¥ï¼Œç„¶åå¯¹è¿™ä¸ªå¤åˆ¶çš„é¡µé¢è¿›è¡Œä¿®æ”¹ã€‚è¿™æ—¶å­è¿›ç¨‹ç›¸åº”çš„é¡µé¢æ˜¯æ²¡æœ‰å˜åŒ–çš„ï¼Œè¿˜æ˜¯è¿›ç¨‹äº§ç”Ÿæ—¶é‚£ä¸€ç¬é—´çš„æ•°æ®ã€‚</p><p>éšç€çˆ¶è¿›ç¨‹ä¿®æ”¹æ“ä½œçš„æŒç»­è¿›è¡Œï¼Œè¶Šæ¥è¶Šå¤šçš„å…±äº«é¡µé¢è¢«åˆ†ç¦»å‡ºæ¥ï¼Œå†…å­˜å°±ä¼šæŒç»­å¢é•¿ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šè¶…è¿‡åŸæœ‰æ•°æ®å†…å­˜çš„<code>2</code>å€å¤§å°ã€‚å¦å¤–ä¸€ä¸ª<code>redis</code>å®ä¾‹é‡Œå†·æ•°æ®å çš„æ¯”ä¾‹å¾€å¾€æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥å¾ˆå°‘ä¼šå‡ºç°æ‰€æœ‰çš„é¡µé¢éƒ½ä¼šè¢«åˆ†ç¦»ï¼Œè¢«åˆ†ç¦»çš„å¾€å¾€åªæœ‰å…¶ä¸­ä¸€éƒ¨åˆ†é¡µé¢ã€‚æ¯ä¸ªé¡µé¢çš„å¤§å°åªæœ‰<code>4K</code>ï¼Œä¸€ä¸ª <code>redis</code>å®ä¾‹é‡Œé¢ä¸€èˆ¬éƒ½ä¼šæœ‰æˆåƒä¸Šä¸‡çš„é¡µé¢ã€‚<br>åŸç†è¿‡ç¨‹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0.å‡è®¾ç°åœ¨redisæ•°æ®å­˜å‚¨åœ¨å†…å­˜çš„AåŒº;</span><br><span class="line">1.æ­¤æ—¶å› é…ç½®æˆ–æŸç§åŸå› è§¦å‘äº†RDBå¿«ç…§äº‹ä»¶;</span><br><span class="line">2.è§¦å‘RDBå¿«ç…§äº‹ä»¶åï¼Œçˆ¶è¿›ç¨‹ä¼šå…ˆforkå‡ºä¸€ä¸ªå­è¿›ç¨‹, æŠŠå¤„ç†RDBå¿«ç…§çš„äº‹æƒ…å®Œå…¨äº¤ç»™è¿™ä¸ªå­è¿›ç¨‹å¤„ç†ï¼Œè€Œçˆ¶è¿›ç¨‹åˆ™ç»§ç»­å¤„ç†æ¥è‡ªå®¢æœç«¯çš„è¯·æ±‚;</span><br><span class="line">3.å­è¿›ç¨‹ä¼šå…ˆå°†å½“å‰å†…å­˜AåŒºæ•°æ®å‹ç¼©, ç„¶ådumpåˆ·ç›˜åˆ°ä¸€ä¸ªä¸´æ—¶RDBæ–‡ä»¶ä¸­, å½“dumpå®Œæˆåï¼Œå†å°†è¿™ä¸ªä¸´æ—¶RDBæ–‡ä»¶æ›¿æ¢ä¹‹å‰çš„RDBæ–‡ä»¶, ç„¶åå­è¿›ç¨‹ç»“æŸé€€å‡º;</span><br><span class="line">4.åŒæ ·ï¼Œåœ¨å­è¿›ç¨‹å¤„ç†å¿«ç…§dumpè¿‡ç¨‹ä¸­, å¦‚æœçˆ¶è¿›ç¨‹æ¥æ”¶åˆ°æ–°çš„å®¢æœç«¯è¯·æ±‚ï¼Œåˆ™çˆ¶è¿›ç¨‹éœ€è¦å…ˆæ‹·è´ä¸€ä»½å†…å­˜AåŒºä¸­ç›¸å…³æ•°æ®é¡µçš„ä¿¡æ¯åˆ°å†…å­˜BåŒºï¼Œç„¶ååœ¨BåŒºä¸Šå®Œæˆå®¢æœç«¯çš„è¯·æ±‚; </span><br><span class="line">5.å½“çˆ¶è¿›ç¨‹å®Œæˆæ–°çš„å®¢æœç«¯è¯·æ±‚åï¼Œå‘ç°å­è¿›ç¨‹å·²ç»å®Œæˆäº†RDBå¿«ç…§å¤„ç†ï¼Œ åˆ™å°†åˆšæ‰æ›´æ–°çš„BåŒºæ•°æ®å–æ›¿æ¢AåŒºæ•°æ®, å¦‚æœå­è¿›ç¨‹è¿˜æ²¡æœ‰å®Œæˆåˆ™ç­‰å¾…;</span><br></pre></td></tr></table></figure></p><h5 id="AOF-åŸç†"><a href="#AOF-åŸç†" class="headerlink" title="AOF åŸç†"></a><code>AOF</code> åŸç†</h5><p><code>AOF</code>æ—¥å¿—å­˜å‚¨çš„æ˜¯<code>redis</code>æœåŠ¡å™¨çš„é¡ºåºæŒ‡ä»¤åºåˆ—ï¼Œ<code>AOF</code>æ—¥å¿—<strong>åªè®°å½•å¯¹å†…å­˜è¿›è¡Œä¿®æ”¹çš„æŒ‡ä»¤è®°å½•(æŸ¥è¯¢/åˆ é™¤æŒ‡ä»¤æ˜¯ä¸è®°å½•çš„)</strong>ã€‚<br>å‡è®¾ <code>AOF</code> æ—¥å¿—è®°å½•äº†è‡ª<code>redis</code>å®ä¾‹åˆ›å»ºä»¥æ¥æ‰€æœ‰çš„ä¿®æ”¹æ€§æŒ‡ä»¤åºåˆ—ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªç©ºçš„<code>redis</code> å®ä¾‹é¡ºåºæ‰§è¡Œæ‰€æœ‰çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯ã€Œé‡æ”¾ã€ï¼Œæ¥æ¢å¤<code>redis</code>å½“å‰å®ä¾‹çš„å†…å­˜æ•°æ®ç»“æ„çš„çŠ¶æ€ã€‚</p><p><code>redis</code>ä¼šåœ¨æ”¶åˆ°å®¢æˆ·ç«¯ä¿®æ”¹æŒ‡ä»¤åï¼Œè¿›è¡Œå‚æ•°æ ¡éªŒè¿›è¡Œé€»è¾‘å¤„ç†åï¼Œå¦‚æœæ²¡é—®é¢˜ï¼Œå°±ç«‹å³å°†è¯¥æŒ‡ä»¤æ–‡æœ¬å­˜å‚¨åˆ°<code>AOF</code>æ—¥å¿—ä¸­ï¼Œä¹Ÿå°±æ˜¯å…ˆæ‰§è¡ŒæŒ‡ä»¤æ‰å°†æ—¥å¿—å­˜ç›˜ã€‚è¿™ç‚¹ä¸åŒäº<code>leveldbã€hbase</code>ç­‰å­˜å‚¨å¼•æ“ï¼Œå®ƒä»¬éƒ½æ˜¯å…ˆå­˜å‚¨æ—¥å¿—å†åšé€»è¾‘å¤„ç†ã€‚</p><p><code>redis</code> åœ¨é•¿æœŸè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œ<code>AOF</code> çš„æ—¥å¿—ä¼šè¶Šå˜è¶Šé•¿ã€‚å¦‚æœå®ä¾‹å®•æœºé‡å¯ï¼Œé‡æ”¾æ•´ä¸ª <code>AOF</code> æ—¥å¿—ä¼šéå¸¸è€—æ—¶ï¼Œå¯¼è‡´é•¿æ—¶é—´<code>redis</code>æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ã€‚æ‰€ä»¥éœ€è¦å¯¹ <code>AOF</code> æ—¥å¿—ç˜¦èº«ã€‚</p><p><strong>AOFé‡å†™</strong><br><code>redis</code> æä¾›äº†<code>bgrewrite AOF</code>æŒ‡ä»¤ç”¨äºå¯¹ <code>AOF</code> æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚å…¶åŸç†å°±æ˜¯å¼€è¾Ÿä¸€ä¸ªå­è¿›ç¨‹å¯¹å†…å­˜è¿›è¡Œéå†è½¬æ¢æˆä¸€ç³»åˆ— <code>redis</code> çš„æ“ä½œæŒ‡ä»¤ï¼Œåºåˆ—åŒ–åˆ°ä¸€ä¸ªæ–°çš„ <code>AOF</code> æ—¥å¿—æ–‡ä»¶ä¸­ã€‚åºåˆ—åŒ–å®Œæ¯•åå†å°†æ“ä½œæœŸé—´å‘ç”Ÿçš„å¢é‡ <code>AOF</code> æ—¥å¿—è¿½åŠ åˆ°è¿™ä¸ªæ–°çš„ <code>AOF</code> æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¿½åŠ å®Œæ¯•åå°±ç«‹å³æ›¿ä»£æ—§çš„ <code>AOF</code> æ—¥å¿—æ–‡ä»¶äº†ï¼Œç˜¦èº«å·¥ä½œå°±å®Œæˆäº†ã€‚</p><p><strong>fsync</strong><br><code>AOF</code> æ—¥å¿—æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨çš„ï¼Œå½“ç¨‹åºå¯¹ <code>AOF</code> æ—¥å¿—æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå®é™…ä¸Šæ˜¯å°†å†…å®¹å†™åˆ°äº†å†…æ ¸ä¸ºæ–‡ä»¶æè¿°ç¬¦åˆ†é…çš„ä¸€ä¸ªå†…å­˜ç¼“å­˜ä¸­ï¼Œç„¶åå†…æ ¸ä¼šå¼‚æ­¥å°†è„æ•°æ®åˆ·å›åˆ°ç£ç›˜çš„ã€‚</p><p>è¿™å°±æ„å‘³ç€å¦‚æœæœºå™¨çªç„¶å®•æœºï¼Œ<code>AOF</code> æ—¥å¿—å†…å®¹å¯èƒ½è¿˜æ²¡æœ‰æ¥å¾—åŠå®Œå…¨åˆ·åˆ°ç£ç›˜ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå‡ºç°æ—¥å¿—ä¸¢å¤±ã€‚é‚£è¯¥æ€ä¹ˆåŠï¼Ÿ å¯ä»¥é€šè¿‡å¼€å¯<code>fsync</code>é…ç½®æ¥å¼ºåˆ¶åŒæ­¥åˆ·ç›˜, è¿‡äºé¢‘ç¹çš„<code>fsync</code>ä¼šä¸¥é‡æ‹–æ…¢<code>redis</code>æ€§èƒ½ï¼Œæ‰€ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸­ï¼Œ<code>redis</code> é€šå¸¸æ˜¯æ¯éš”<code>1s</code>å·¦å³æ‰§è¡Œä¸€æ¬¡<code>fsync</code>æ“ä½œ, åœ¨ä¿æŒé«˜æ€§èƒ½çš„åŒæ—¶ï¼Œå°½å¯èƒ½ä½¿å¾—æ•°æ®å°‘ä¸¢å¤±ã€‚</p><h5 id="æ··åˆæŒä¹…åŒ–"><a href="#æ··åˆæŒä¹…åŒ–" class="headerlink" title="æ··åˆæŒä¹…åŒ–"></a>æ··åˆæŒä¹…åŒ–</h5><p>é‡å¯ <code>redis</code> æ—¶ï¼Œæˆ‘ä»¬å¾ˆå°‘ä½¿ç”¨ <code>RDB</code> æ¥æ¢å¤å†…å­˜çŠ¶æ€ï¼Œå› ä¸ºä¼šä¸¢å¤±å¤§é‡æ•°æ®ã€‚æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ <code>AOF</code> æ—¥å¿—é‡æ”¾ï¼Œä½†æ˜¯é‡æ”¾ <code>AOF</code> æ—¥å¿—æ€§èƒ½ç›¸å¯¹ <code>RDB</code> æ¥è¯´è¦æ…¢å¾ˆå¤šï¼Œè¿™æ ·åœ¨<code>redis</code> å®ä¾‹å¾ˆå¤§çš„æƒ…å†µä¸‹ï¼Œå¯åŠ¨éœ€è¦èŠ±è´¹å¾ˆé•¿çš„æ—¶é—´ã€‚</p><p><code>redis4.0</code>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚å°† <code>RDB</code> æ–‡ä»¶çš„å†…å®¹å’Œå¢é‡çš„ <code>AOF</code> æ—¥å¿—æ–‡ä»¶å­˜åœ¨ä¸€èµ·ã€‚è¿™é‡Œçš„ <code>AOF</code> æ—¥å¿—ä¸å†æ˜¯å…¨é‡çš„æ—¥å¿—ï¼Œè€Œæ˜¯è‡ªæŒä¹…åŒ–å¼€å§‹åˆ°æŒä¹…åŒ–ç»“æŸçš„è¿™æ®µæ—¶é—´å‘ç”Ÿçš„å¢é‡ <code>AOF</code> æ—¥å¿—ï¼Œé€šå¸¸è¿™éƒ¨åˆ† <code>AOF</code> æ—¥å¿—å¾ˆå°ã€‚</p><p>äºæ˜¯åœ¨<code>redis</code> é‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆåŠ è½½ <code>RDB</code> çš„å†…å®¹ï¼Œç„¶åå†é‡æ”¾å¢é‡ <code>AOF</code> æ—¥å¿—å°±å¯ä»¥å®Œå…¨æ›¿ä»£ä¹‹å‰çš„ <code>AOF</code> å…¨é‡æ–‡ä»¶é‡æ”¾ï¼Œé‡å¯æ•ˆç‡å› æ­¤å¤§å¹…å¾—åˆ°æå‡ã€‚</p><h5 id="RDBä¼˜åŠ¿"><a href="#RDBä¼˜åŠ¿" class="headerlink" title="RDBä¼˜åŠ¿"></a>RDBä¼˜åŠ¿</h5><blockquote><p> ä¸€æ—¦é‡‡ç”¨è¯¥æ–¹å¼ï¼Œé‚£ä¹ˆä½ çš„æ•´ä¸ªRedisæ•°æ®åº“å°†åªåŒ…å«ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™å¯¹äºæ–‡ä»¶å¤‡ä»½è€Œè¨€æ˜¯éå¸¸å®Œç¾çš„ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½æ‰“ç®—æ¯ä¸ªå°æ—¶å½’æ¡£ä¸€æ¬¡æœ€è¿‘24å°æ—¶çš„æ•°æ®ï¼ŒåŒæ—¶è¿˜è¦æ¯å¤©å½’æ¡£ä¸€æ¬¡æœ€è¿‘30å¤©çš„æ•°æ®ã€‚é€šè¿‡è¿™æ ·çš„å¤‡ä»½ç­–ç•¥ï¼Œä¸€æ—¦ç³»ç»Ÿå‡ºç°ç¾éš¾æ€§æ•…éšœï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å®¹æ˜“çš„è¿›è¡Œæ¢å¤ã€‚</p></blockquote><blockquote><p>å¯¹äºç¾éš¾æ¢å¤è€Œè¨€ï¼ŒRDBæ˜¯éå¸¸ä¸é”™çš„é€‰æ‹©ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥éå¸¸è½»æ¾çš„å°†ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å‹ç¼©åå†è½¬ç§»åˆ°å…¶å®ƒå­˜å‚¨ä»‹è´¨ä¸Šã€‚</p></blockquote><blockquote><p> æ€§èƒ½æœ€å¤§åŒ–ã€‚å¯¹äºRedisçš„æœåŠ¡è¿›ç¨‹è€Œè¨€ï¼Œåœ¨å¼€å§‹æŒä¹…åŒ–æ—¶ï¼Œå®ƒå”¯ä¸€éœ€è¦åšçš„åªæ˜¯forkå‡ºå­è¿›ç¨‹ï¼Œä¹‹åå†ç”±å­è¿›ç¨‹å®Œæˆè¿™äº›æŒä¹…åŒ–çš„å·¥ä½œï¼Œè¿™æ ·å°±å¯ä»¥æå¤§çš„é¿å…æœåŠ¡è¿›ç¨‹æ‰§è¡ŒIOæ“ä½œäº†ã€‚</p></blockquote><blockquote><p> ç›¸æ¯”äºAOFæœºåˆ¶ï¼Œå¦‚æœæ•°æ®é›†å¾ˆå¤§ï¼ŒRDBçš„å¯åŠ¨æ•ˆç‡ä¼šæ›´é«˜ã€‚</p></blockquote><h5 id="RDBåŠ£åŠ¿"><a href="#RDBåŠ£åŠ¿" class="headerlink" title="RDBåŠ£åŠ¿"></a>RDBåŠ£åŠ¿</h5><blockquote><p>å¦‚æœä½ æƒ³ä¿è¯æ•°æ®çš„é«˜å¯ç”¨æ€§ï¼Œå³æœ€å¤§é™åº¦çš„é¿å…æ•°æ®ä¸¢å¤±ï¼Œé‚£ä¹ˆRDBå°†ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å› ä¸ºç³»ç»Ÿä¸€æ—¦åœ¨å®šæ—¶æŒä¹…åŒ–ä¹‹å‰å‡ºç°å®•æœºç°è±¡ï¼Œæ­¤å‰æ²¡æœ‰æ¥å¾—åŠå†™å…¥ç£ç›˜çš„æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚</p></blockquote><blockquote><p>ç”±äºRDBæ˜¯é€šè¿‡forkå­è¿›ç¨‹æ¥ååŠ©å®Œæˆæ•°æ®æŒä¹…åŒ–å·¥ä½œçš„ï¼Œå› æ­¤ï¼Œå¦‚æœå½“æ•°æ®é›†è¾ƒå¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨åœæ­¢æœåŠ¡å‡ ç™¾æ¯«ç§’ï¼Œç”šè‡³æ˜¯1ç§’é’Ÿã€‚</p></blockquote><h4 id="AOFä¼˜åŠ¿"><a href="#AOFä¼˜åŠ¿" class="headerlink" title="AOFä¼˜åŠ¿"></a>AOFä¼˜åŠ¿</h4><blockquote><p>è¯¥æœºåˆ¶å¯ä»¥å¸¦æ¥æ›´é«˜çš„æ•°æ®å®‰å…¨æ€§ï¼Œå³æ•°æ®æŒä¹…æ€§ã€‚Redisä¸­æä¾›äº†3ä¸­åŒæ­¥ç­–ç•¥ï¼Œå³æ¯ç§’åŒæ­¥ã€æ¯ä¿®æ”¹åŒæ­¥å’Œä¸åŒæ­¥ã€‚äº‹å®ä¸Šï¼Œæ¯ç§’åŒæ­¥ä¹Ÿæ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œå…¶æ•ˆç‡ä¹Ÿæ˜¯éå¸¸é«˜çš„ï¼Œæ‰€å·®çš„æ˜¯ä¸€æ—¦ç³»ç»Ÿå‡ºç°å®•æœºç°è±¡ï¼Œé‚£ä¹ˆè¿™ä¸€ç§’é’Ÿä¹‹å†…ä¿®æ”¹çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚è€Œæ¯ä¿®æ”¹åŒæ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è§†ä¸ºåŒæ­¥æŒä¹…åŒ–ï¼Œå³æ¯æ¬¡å‘ç”Ÿçš„æ•°æ®å˜åŒ–éƒ½ä¼šè¢«ç«‹å³è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å¯ä»¥é¢„è§ï¼Œè¿™ç§æ–¹å¼åœ¨æ•ˆç‡ä¸Šæ˜¯æœ€ä½çš„ã€‚è‡³äºæ— åŒæ­¥ï¼Œæ— éœ€å¤šè¨€ï¼Œæˆ‘æƒ³å¤§å®¶éƒ½èƒ½æ­£ç¡®çš„ç†è§£å®ƒã€‚</p></blockquote><blockquote><p>ç”±äºè¯¥æœºåˆ¶å¯¹æ—¥å¿—æ–‡ä»¶çš„å†™å…¥æ“ä½œé‡‡ç”¨çš„æ˜¯appendæ¨¡å¼ï¼Œå› æ­¤åœ¨å†™å…¥è¿‡ç¨‹ä¸­å³ä½¿å‡ºç°å®•æœºç°è±¡ï¼Œä¹Ÿä¸ä¼šç ´åæ—¥å¿—æ–‡ä»¶ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ã€‚ç„¶è€Œå¦‚æœæˆ‘ä»¬æœ¬æ¬¡æ“ä½œåªæ˜¯å†™å…¥äº†ä¸€åŠæ•°æ®å°±å‡ºç°äº†ç³»ç»Ÿå´©æºƒé—®é¢˜ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œåœ¨Redisä¸‹ä¸€æ¬¡å¯åŠ¨ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡redis-check-aofå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬è§£å†³æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</p></blockquote><blockquote><p> å¦‚æœæ—¥å¿—è¿‡å¤§ï¼ŒRediså¯ä»¥è‡ªåŠ¨å¯ç”¨rewriteæœºåˆ¶ã€‚å³Redisä»¥appendæ¨¡å¼ä¸æ–­çš„å°†ä¿®æ”¹æ•°æ®å†™å…¥åˆ°è€çš„ç£ç›˜æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶Redisè¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ç”¨äºè®°å½•æ­¤æœŸé—´æœ‰å“ªäº›ä¿®æ”¹å‘½ä»¤è¢«æ‰§è¡Œã€‚å› æ­¤åœ¨è¿›è¡Œrewriteåˆ‡æ¢æ—¶å¯ä»¥æ›´å¥½çš„ä¿è¯æ•°æ®å®‰å…¨æ€§ã€‚</p></blockquote><blockquote><p>AOFåŒ…å«ä¸€ä¸ªæ ¼å¼æ¸…æ™°ã€æ˜“äºç†è§£çš„æ—¥å¿—æ–‡ä»¶ç”¨äºè®°å½•æ‰€æœ‰çš„ä¿®æ”¹æ“ä½œã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶å®Œæˆæ•°æ®çš„é‡å»ºã€‚</p></blockquote><h5 id="AOFåŠ£åŠ¿"><a href="#AOFåŠ£åŠ¿" class="headerlink" title="AOFåŠ£åŠ¿"></a>AOFåŠ£åŠ¿</h5><blockquote><p> å¯¹äºç›¸åŒæ•°é‡çš„æ•°æ®é›†è€Œè¨€ï¼ŒAOFæ–‡ä»¶é€šå¸¸è¦å¤§äºRDBæ–‡ä»¶ã€‚RDB åœ¨æ¢å¤å¤§æ•°æ®é›†æ—¶çš„é€Ÿåº¦æ¯” AOF çš„æ¢å¤é€Ÿåº¦è¦å¿«ã€‚</p></blockquote><blockquote><p>æ ¹æ®åŒæ­¥ç­–ç•¥çš„ä¸åŒï¼ŒAOFåœ¨è¿è¡Œæ•ˆç‡ä¸Šå¾€å¾€ä¼šæ…¢äºRDBã€‚æ€»ä¹‹ï¼Œæ¯ç§’åŒæ­¥ç­–ç•¥çš„æ•ˆç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼ŒåŒæ­¥ç¦ç”¨ç­–ç•¥çš„æ•ˆç‡å’ŒRDBä¸€æ ·é«˜æ•ˆã€‚</p></blockquote><h5 id="å¸¸ç”¨é…ç½®"><a href="#å¸¸ç”¨é…ç½®" class="headerlink" title="å¸¸ç”¨é…ç½®"></a>å¸¸ç”¨é…ç½®</h5><p><strong>RDBæŒä¹…åŒ–é…ç½®</strong><br>Redisä¼šå°†æ•°æ®é›†çš„å¿«ç…§dumpåˆ°dump.rdbæ–‡ä»¶ä¸­ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥ä¿®æ”¹RedisæœåŠ¡å™¨dumpå¿«ç…§çš„é¢‘ç‡ï¼Œåœ¨æ‰“å¼€6379.confæ–‡ä»¶ä¹‹åï¼Œæˆ‘ä»¬æœç´¢saveï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„é…ç½®ä¿¡æ¯:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save 900 1              #åœ¨900ç§’(15åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 300 10            #åœ¨300ç§’(5åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br><span class="line"></span><br><span class="line">save 60 10000        #åœ¨60ç§’(1åˆ†é’Ÿ)ä¹‹åï¼Œå¦‚æœè‡³å°‘æœ‰10000ä¸ªkeyå‘ç”Ÿå˜åŒ–ï¼Œåˆ™dumpå†…å­˜å¿«ç…§ã€‚</span><br></pre></td></tr></table></figure></p><p><strong>AOFæŒä¹…åŒ–é…ç½®</strong><br>åœ¨Redisçš„é…ç½®æ–‡ä»¶ä¸­å­˜åœ¨ä¸‰ç§åŒæ­¥æ–¹å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">appendfsync always     #æ¯æ¬¡æœ‰æ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶éƒ½ä¼šå†™å…¥AOFæ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line">appendfsync everysec  #æ¯ç§’é’ŸåŒæ­¥ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ä¸ºAOFçš„ç¼ºçœç­–ç•¥ã€‚</span><br><span class="line"></span><br><span class="line">appendfsync no          #ä»ä¸åŒæ­¥ã€‚é«˜æ•ˆä½†æ˜¯æ•°æ®ä¸ä¼šè¢«æŒä¹…åŒ–ã€‚</span><br></pre></td></tr></table></figure></p><h5 id="è¿‡æœŸç­–ç•¥"><a href="#è¿‡æœŸç­–ç•¥" class="headerlink" title="è¿‡æœŸç­–ç•¥"></a>è¿‡æœŸç­–ç•¥</h5><p><strong>RDBè¿‡æœŸkeyå¤„ç†ç­–ç•¥</strong></p><blockquote><p>å·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°åˆ›å»ºçš„RDBæ–‡ä»¶ä¸­ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ•°æ®åº“ä¸­åŒ…å«ä¸‰ä¸ªé”®k1ã€k2ã€k3ï¼Œå¹¶ä¸”k2å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆå½“æ‰§è¡ŒSAVEå‘½ä»¤æˆ–è€…BGSAVEå‘½ä»¤æ—¶ï¼Œç¨‹åºåªä¼šå°†k1å’Œk3çš„æ•°æ®ä¿å­˜åˆ°RDBæ–‡ä»¶ä¸­ï¼Œè€Œk2åˆ™ä¼šè¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œæ•°æ®åº“ä¸­åŒ…å«è¿‡æœŸé”®ä¸ä¼šå¯¹ç”Ÿæˆæ–°çš„RDBæ–‡ä»¶é€ æˆå½±å“ã€‚</p></blockquote><p>åœ¨å¯åŠ¨RedisæœåŠ¡å™¨æ—¶ï¼Œå¦‚æœæœåŠ¡å™¨å¼€å¯äº†RDBåŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å¯¹RDBæ–‡ä»¶è¿›è¡Œè½½å…¥:</p><blockquote><p>å¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥RDBæ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œæœªè¿‡æœŸçš„é”®ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ï¼Œè€Œè¿‡æœŸé”®åˆ™ä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥è¿‡æœŸé”®å¯¹è½½å…¥RDBæ–‡ä»¶çš„ä¸»æœåŠ¡å™¨ä¸ä¼šé€ æˆå½±å“ï¼›</p></blockquote><blockquote><p>å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥RDBæ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ä¸­ä¿å­˜çš„æ‰€æœ‰é”®ï¼Œä¸è®ºæ˜¯å¦è¿‡æœŸï¼Œéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­ã€‚ä¸è¿‡ï¼Œå› ä¸ºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥çš„æ—¶å€™ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®åº“å°±ä¼šè¢«æ¸…ç©ºï¼Œæ‰€ä»¥ä¸€èˆ¬æ¥è®²ï¼Œè¿‡æœŸé”®å¯¹è½½å…¥RDBæ–‡ä»¶çš„ä»æœåŠ¡å™¨ä¹Ÿä¸ä¼šé€ æˆå½±å“ï¼›</p></blockquote><p><strong>AOFè¿‡æœŸkeyå¤„ç†ç­–ç•¥</strong></p><blockquote><p>å½“æœåŠ¡å™¨ä»¥AOFæŒä¹…åŒ–æ¨¡å¼è¿è¡Œæ—¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„æŸä¸ªé”®å·²ç»è¿‡æœŸï¼Œä½†å®ƒè¿˜æ²¡æœ‰è¢«æƒ°æ€§åˆ é™¤æˆ–è€…å®šæœŸåˆ é™¤ï¼Œé‚£ä¹ˆAOFæ–‡ä»¶ä¸ä¼šå› ä¸ºè¿™ä¸ªè¿‡æœŸé”®è€Œäº§ç”Ÿä»»ä½•å½±å“ã€‚<strong>å½“è¿‡æœŸé”®è¢«æƒ°æ€§åˆ é™¤æˆ–è€…å®šæœŸåˆ é™¤ä¹‹åï¼Œç¨‹åºä¼šå‘AOFæ–‡ä»¶è¿½åŠ ï¼ˆappendï¼‰ä¸€æ¡DELå‘½ä»¤ï¼Œæ¥æ˜¾å¼åœ°è®°å½•è¯¥é”®å·²è¢«åˆ é™¤ã€‚</strong></p></blockquote><blockquote><p>å’Œç”ŸæˆRDBæ–‡ä»¶æ—¶ç±»ä¼¼ï¼Œåœ¨æ‰§è¡ŒAOFé‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„AOFæ–‡ä»¶ä¸­ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæ•°æ®åº“ä¸­åŒ…å«ä¸‰ä¸ªé”®k1ã€k2ã€k3ï¼Œå¹¶ä¸”k2å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œé‡å†™å·¥ä½œæ—¶ï¼Œç¨‹åºåªä¼šå¯¹k1å’Œk3è¿›è¡Œé‡å†™ï¼Œè€Œk2åˆ™ä¼šè¢«å¿½ç•¥ã€‚</p></blockquote><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>åœ¨<code>redis</code>æ•°æ®å­˜å‚¨æŒä¹…åŒ–æœºåˆ¶ä¸Š, æ¢è®¨äº†<code>RDBå¿«ç…§</code> å’Œ <code>AOF</code>ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼Œå¯¹å…¶åŸç†,åŒºåˆ«ç­‰è¿›è¡Œäº†è¿›ä¸€æ­¥çš„è¯´æ˜;</li><li>è¿›ä¸€æ­¥æ¢è®¨äº†<code>redis.4.0</code>æä¾›çš„æ··åˆæŒä¹…åŒ–æ–¹æ¡ˆ;</li><li>å½’ç±»æ€»ç»“äº†<code>RDB</code>å’Œ<code>AOF</code>ä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹;</li><li>ä»ç»éªŒå‡ºå‘ï¼Œ è¿›ä¸€æ­¥æ€»ç»“äº†å®é™…ä¸­å¸¸ç”¨çš„é…ç½®æ–¹æ¡ˆ;</li><li>è¿›ä¸€æ­¥æ€»ç»“äº†<code>RDB</code>å’Œ<code>AOF</code>å¯¹è¿‡æœŸkeyçš„å¤„ç†ç­–ç•¥;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;redis&lt;/code&gt;æä¾›ä¸¤ç§æ–¹å¼è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¸€ç§æ˜¯&lt;code&gt;RDB&lt;/code&gt;å¿«ç…§æŒä¹…åŒ–(åŸç†æ˜¯å°†Reidsåœ¨å†…å­˜ä¸­çš„æ•°æ®åº“è®°å½•å‹ç¼©åå®šæ—¶dumpåˆ°ç£ç›˜ä¸Šçš„&lt;code&gt;RDB&lt;/code&gt;æŒä¹…åŒ–,å­˜å‚¨ç´§å‡‘)ï¼Œå¦å¤–ä¸€ç§æ˜¯&lt;code&gt;AOF&lt;/code&gt;(append only file)æŒä¹…åŒ–(åŸç†æ˜¯å°†Reidsçš„æ“ä½œæ—¥å¿—ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥æ–‡ä»¶), &lt;code&gt;AOF&lt;/code&gt; æ—¥å¿—åœ¨é•¿æœŸçš„è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå˜çš„æ— æ¯”åºå¤§ï¼Œæ•°æ®åº“é‡å¯æ—¶éœ€è¦åŠ è½½&lt;code&gt;AOF&lt;/code&gt;æ—¥å¿—è¿›è¡ŒæŒ‡ä»¤é‡æ”¾ï¼Œè¿™ä¸ªæ—¶é—´å°±ä¼šæ— æ¯”æ¼«é•¿ã€‚æ‰€ä»¥éœ€è¦å®šæœŸè¿›è¡Œ&lt;code&gt;AOF&lt;/code&gt;é‡å†™ï¼Œç»™&lt;code&gt;AOF&lt;/code&gt;æ—¥å¿—è¿›è¡Œç˜¦èº«ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜12 redisé€šä¿¡åè®®</title>
    <link href="http://researchlab.github.io/2018/10/09/redis-12-resp/"/>
    <id>http://researchlab.github.io/2018/10/09/redis-12-resp/</id>
    <published>2018-10-09T15:34:03.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>Redisçš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é‡‡ç”¨ä¸€ç§å«åš<code>RESP(REdis Serialization Protocol)</code>çš„ç½‘ç»œé€šä¿¡åè®®äº¤æ¢æ•°æ®ã€‚ è¿™ç§åè®®é‡‡ç”¨æ˜æ–‡ä¼ è¾“ï¼Œæ˜“è¯»ä¹Ÿæ˜“è§£æã€‚<code>Redis</code>å®¢æˆ·ç«¯é‡‡ç”¨æ­¤åè®®æ ¼å¼æ¥å¯¹æœåŠ¡ç«¯å‘é€ä¸åŒçš„å‘½ä»¤ï¼ŒæœåŠ¡ç«¯ä¼šæ ¹æ®å…·ä½“çš„æ“ä½œè€Œè¿”å›å…·ä½“çš„ç­”å¤ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é‡‡ç”¨çš„æ˜¯ç®€å•çš„<code>è¯·æ±‚-å“åº”</code>æ¨¡å‹è¿›è¡Œé€šä¿¡çš„ã€‚<br><a id="more"></a></p><h5 id="RESP"><a href="#RESP" class="headerlink" title="RESP"></a>RESP</h5><p><code>RESP(Redis Serialization Protocol)</code>æ˜¯ Redisåºåˆ—åŒ–åè®®çš„ç®€å†™ã€‚å®ƒæ˜¯ä¸€ç§ç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œä¼˜åŠ¿åœ¨äºå®ç°å¼‚å¸¸ç®€å•ï¼Œè§£ææ€§èƒ½æå¥½ã€‚</p><p>Redisåè®®å°†ä¼ è¾“çš„ç»“æ„æ•°æ®åˆ†ä¸º<code>5</code>ç§æœ€å°å•å…ƒç±»å‹ï¼Œå•å…ƒç»“æŸæ—¶ç»Ÿä¸€åŠ ä¸Šå›è½¦æ¢è¡Œç¬¦å·<code>\r\n</code>ã€‚</p><blockquote><p>å•è¡Œå­—ç¬¦ä¸² ä»¥<code>+</code>ç¬¦å·å¼€å¤´ã€‚<br>å¤šè¡Œå­—ç¬¦ä¸² ä»¥<code>$</code>ç¬¦å·å¼€å¤´ï¼Œåè·Ÿå­—ç¬¦ä¸²é•¿åº¦ã€‚<br>æ•´æ•°å€¼ ä»¥<code>:</code>ç¬¦å·å¼€å¤´ï¼Œåè·Ÿæ•´æ•°çš„å­—ç¬¦ä¸²å½¢å¼ã€‚<br>é”™è¯¯æ¶ˆæ¯ ä»¥<code>-</code>ç¬¦å·å¼€å¤´ã€‚<br>æ•°ç»„ ä»¥<code>*</code>å·å¼€å¤´ï¼Œåè·Ÿæ•°ç»„çš„é•¿åº¦ã€‚</p></blockquote><p><strong>å•è¡Œå­—ç¬¦ä¸²</strong> <code>hello world</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+hello world\r\n</span><br></pre></td></tr></table></figure></p><p><strong>å¤šè¡Œå­—ç¬¦ä¸²</strong> <code>hello world</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">11\r\nhello world\r\n</span></span><br></pre></td></tr></table></figure></p><p>å¤šè¡Œå­—ç¬¦ä¸²å½“ç„¶ä¹Ÿå¯ä»¥è¡¨ç¤ºå•è¡Œå­—ç¬¦ä¸²ã€‚</p><p><strong>æ•´æ•°</strong> <code>1024</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:1024\r\n</span><br></pre></td></tr></table></figure></p><p><strong>é”™è¯¯</strong> å‚æ•°ç±»å‹é”™è¯¯<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-WRONGTYPE Operation against a key holding the wrong kind of value\r\n</span><br></pre></td></tr></table></figure></p><p><strong>æ•°ç»„</strong> <code>[1,2,3]</code><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n:1\r\n:2\r\n:3\r\n</span><br></pre></td></tr></table></figure></p><p><code>NULL</code>ç”¨å¤šè¡Œå­—ç¬¦ä¸²è¡¨ç¤ºï¼Œä¸è¿‡é•¿åº¦è¦å†™æˆ<code>-1</code>ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">-1\r\n</span></span><br></pre></td></tr></table></figure></p><p><strong>ç©ºä¸²</strong> ç”¨å¤šè¡Œå­—ç¬¦ä¸²è¡¨ç¤ºï¼Œé•¿åº¦å¡«<code>0</code>ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">0\r\n\r\n</span></span><br></pre></td></tr></table></figure></p><p><strong>æ³¨:</strong> è¿™é‡Œæœ‰ä¸¤ä¸ª<code>\r\n</code>ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ª?å› ä¸ºä¸¤ä¸ª<code>\r\n</code>ä¹‹é—´,éš”çš„æ˜¯ç©ºä¸²ã€‚</p><h5 id="å®¢æˆ·ç«¯-gt-æœåŠ¡å™¨"><a href="#å®¢æˆ·ç«¯-gt-æœåŠ¡å™¨" class="headerlink" title="å®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨"></a>å®¢æˆ·ç«¯ -&gt; æœåŠ¡å™¨</h5><p><strong>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€çš„æŒ‡ä»¤åªæœ‰ä¸€ç§æ ¼å¼ï¼Œå¤šè¡Œå­—ç¬¦ä¸²æ•°ç»„</strong>ã€‚æ¯”å¦‚ä¸€ä¸ªç®€å•çš„<code>set</code>æŒ‡ä»¤<code>set learn redis</code>ä¼šè¢«åºåˆ—åŒ–æˆä¸‹é¢çš„å­—ç¬¦ä¸²ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n$3\r\nset\r\n$6\r\nlearn\r\n$8\r\nredis\r\n</span><br></pre></td></tr></table></figure></p><h5 id="æœåŠ¡å™¨-gt-å®¢æˆ·ç«¯"><a href="#æœåŠ¡å™¨-gt-å®¢æˆ·ç«¯" class="headerlink" title="æœåŠ¡å™¨ -&gt; å®¢æˆ·ç«¯"></a>æœåŠ¡å™¨ -&gt; å®¢æˆ·ç«¯</h5><p>æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å›å¤çš„å“åº”è¦æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥æ¶ˆæ¯å“åº”åœ¨ç»“æ„ä¸Šè¦å¤æ‚ä¸å°‘ã€‚ä¸è¿‡å†å¤æ‚çš„å“åº”æ¶ˆæ¯ä¹Ÿæ˜¯ä»¥ä¸Š<code>5</code>ä¸­åŸºæœ¬ç±»å‹çš„ç»„åˆã€‚</p><p><strong>1.å•è¡Œå­—ç¬¦ä¸²å“åº”</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set learn redis</span><br><span class="line">OK</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œçš„<code>OK</code>å°±æ˜¯å•è¡Œå“åº”ï¼Œæ²¡æœ‰ä½¿ç”¨å¼•å·æ‹¬èµ·æ¥ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+OK</span><br></pre></td></tr></table></figure></p><p><strong>2.é”™è¯¯å“åº”</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; incr learn </span><br><span class="line">(error) ERR value is not an integer or out of range</span><br></pre></td></tr></table></figure></p><p>è¯•å›¾å¯¹ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œè‡ªå¢ï¼ŒæœåŠ¡å™¨æŠ›å‡ºä¸€ä¸ªé€šç”¨çš„é”™è¯¯ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-ERR value is not an integer or out of range</span><br></pre></td></tr></table></figure></p><p><strong>3.æ•´æ•°å“åº”</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; incr books</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œçš„<code>1</code>å°±æ˜¯æ•´æ•°å“åº”<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:1</span><br></pre></td></tr></table></figure></p><p><strong>4.å¤šè¡Œå­—ç¬¦ä¸²å“åº”</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get learn </span><br><span class="line">"redis"</span><br></pre></td></tr></table></figure></p><p><u>è¿™é‡Œä½¿ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦ä¸²å°±æ˜¯å¤šè¡Œå­—ç¬¦ä¸²å“åº”</u></p><p><strong>5.æ•°ç»„å“åº”</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset shanghai num 021</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset shanghai date 10.1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset shanghai abbr sh</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall shanghai</span><br><span class="line">1) "num"</span><br><span class="line">2) "021"</span><br><span class="line">3) "date"</span><br><span class="line">4) "10.1"</span><br><span class="line">5) "abbr"</span><br><span class="line">6) "sh"</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œçš„<code>hgetall</code>å‘½ä»¤è¿”å›çš„å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç¬¬<code>0|2|4</code>ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯<code>hash</code>è¡¨çš„<code>key</code>ï¼Œç¬¬<code>1|3|5</code>ä½ç½®çš„å­—ç¬¦ä¸²æ˜¯<code>value</code>ï¼Œå®¢æˆ·ç«¯è´Ÿè´£å°†æ•°ç»„ç»„è£…æˆå­—å…¸å†è¿”å›ã€‚</p><p><strong>6.åµŒå¥—</strong><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "shanghai"</span><br><span class="line">   2) "learn"</span><br></pre></td></tr></table></figure></p><p><code>scan</code>å‘½ä»¤ç”¨æ¥æ‰«ææœåŠ¡å™¨åŒ…å«çš„æ‰€æœ‰<code>key</code>åˆ—è¡¨ï¼Œå®ƒæ˜¯ä»¥æ¸¸æ ‡çš„å½¢å¼è·å–ï¼Œä¸€æ¬¡åªè·å–ä¸€éƒ¨åˆ†ã€‚</p><p><code>scan</code>å‘½ä»¤è¿”å›çš„æ˜¯ä¸€ä¸ªåµŒå¥—æ•°ç»„ã€‚æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºæ¸¸æ ‡çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå€¼ä¸ºé›¶ï¼Œè¯´æ˜å·²ç»éå†å®Œæ¯•ã€‚å¦‚æœä¸ä¸ºé›¶ï¼Œä½¿ç”¨è¿™ä¸ªå€¼ä½œä¸º<code>scan</code>å‘½ä»¤çš„å‚æ•°è¿›è¡Œä¸‹ä¸€æ¬¡éå†ã€‚æ•°ç»„çš„ç¬¬äºŒä¸ªå€¼åˆæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„å°±æ˜¯<code>key</code>åˆ—è¡¨ã€‚</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li><code>Redis</code>åè®®é‡Œæœ‰å¤§é‡å†—ä½™çš„å›è½¦æ¢è¡Œç¬¦ï¼Œä½†æ˜¯è¿™ä¸å½±å“å®ƒæˆä¸ºäº’è”ç½‘æŠ€æœ¯é¢†åŸŸéå¸¸å—æ¬¢è¿çš„ä¸€ä¸ªæ–‡æœ¬åè®®ã€‚æœ‰å¾ˆå¤šå¼€æºé¡¹ç›®ä½¿ç”¨<code>RESP</code>ä½œä¸ºå®ƒçš„é€šè®¯åè®®ã€‚åœ¨æŠ€æœ¯é¢†åŸŸæ€§èƒ½å¹¶ä¸æ€»æ˜¯ä¸€åˆ‡ï¼Œè¿˜æœ‰ç®€å•æ€§ã€æ˜“ç†è§£æ€§å’Œæ˜“å®ç°æ€§ï¼Œè¿™äº›éƒ½éœ€è¦è¿›è¡Œé€‚å½“æƒè¡¡ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Redisçš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é‡‡ç”¨ä¸€ç§å«åš&lt;code&gt;RESP(REdis Serialization Protocol)&lt;/code&gt;çš„ç½‘ç»œé€šä¿¡åè®®äº¤æ¢æ•°æ®ã€‚ è¿™ç§åè®®é‡‡ç”¨æ˜æ–‡ä¼ è¾“ï¼Œæ˜“è¯»ä¹Ÿæ˜“è§£æã€‚&lt;code&gt;Redis&lt;/code&gt;å®¢æˆ·ç«¯é‡‡ç”¨æ­¤åè®®æ ¼å¼æ¥å¯¹æœåŠ¡ç«¯å‘é€ä¸åŒçš„å‘½ä»¤ï¼ŒæœåŠ¡ç«¯ä¼šæ ¹æ®å…·ä½“çš„æ“ä½œè€Œè¿”å›å…·ä½“çš„ç­”å¤ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é‡‡ç”¨çš„æ˜¯ç®€å•çš„&lt;code&gt;è¯·æ±‚-å“åº”&lt;/code&gt;æ¨¡å‹è¿›è¡Œé€šä¿¡çš„ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜11 çº¿ç¨‹IOæ¨¡å‹</title>
    <link href="http://researchlab.github.io/2018/10/08/redis-11-redisio/"/>
    <id>http://researchlab.github.io/2018/10/08/redis-11-redisio/</id>
    <published>2018-10-08T15:31:15.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p><code>Redis</code>æ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹çš„KVæ•°æ®åº“,é‚£ä¸ºä»€ä¹ˆè¿˜å¸¸åº”ç”¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­? å…¶ä¸­ä¸€ä¸ªé‡è¦åŸå› æ˜¯<code>Redis</code>æ˜¯ä¸€ä¸ª<strong>å•è¿›ç¨‹å•çº¿ç¨‹</strong>ä¸”é‡‡ç”¨<strong>å¤šè·¯I/Oå¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡IO</strong>æŠ€æœ¯, ä½¿ä¹‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¿æ¥è¯·æ±‚(å‡å°‘ç½‘ç»œIOè€—æ—¶), ä¹Ÿä¸éœ€è¦å…³å¿ƒé”ï¼Œçº¿ç¨‹åˆ‡æ¢ç­‰èµ„æºæ¶ˆè€—é—®é¢˜;<br><a id="more"></a></p><h5 id="redisä¸ºä»€ä¹ˆè®¾è®¡ä¸ºå•çº¿ç¨‹"><a href="#redisä¸ºä»€ä¹ˆè®¾è®¡ä¸ºå•çº¿ç¨‹" class="headerlink" title="redisä¸ºä»€ä¹ˆè®¾è®¡ä¸ºå•çº¿ç¨‹"></a>redisä¸ºä»€ä¹ˆè®¾è®¡ä¸ºå•çº¿ç¨‹</h5><p>å®˜æ–¹FAQè¡¨ç¤ºï¼Œå› ä¸ºRedisæ˜¯åŸºäºå†…å­˜çš„æ“ä½œï¼ŒCPUä¸æ˜¯Redisçš„ç“¶é¢ˆï¼Œ<strong>Redisçš„ç“¶é¢ˆæœ€æœ‰å¯èƒ½æ˜¯æœºå™¨å†…å­˜çš„å¤§å°æˆ–è€…ç½‘ç»œå¸¦å®½</strong>ã€‚æ—¢ç„¶å•çº¿ç¨‹å®¹æ˜“å®ç°ï¼Œè€Œä¸”CPUä¸ä¼šæˆä¸ºç“¶é¢ˆï¼Œé‚£å°±é¡ºç†æˆç« åœ°é‡‡ç”¨å•çº¿ç¨‹çš„æ–¹æ¡ˆäº†ï¼ˆæ¯•ç«Ÿé‡‡ç”¨å¤šçº¿ç¨‹ä¼šæœ‰å¾ˆå¤šéº»çƒ¦)ã€‚</p><blockquote><p>æ­£å› ä¸º<code>Redis</code>æ˜¯å•çº¿ç¨‹ï¼Œæ‰€ä»¥è¦å°å¿ƒä½¿ç”¨é‚£äº›æ—¶é—´å¤æ‚åº¦ä¸º<code>O(n)</code>çº§åˆ«çš„<code>Redis</code>æŒ‡ä»¤ï¼Œä¸€ä¸å°å¿ƒå°±å¯èƒ½ä¼šå¯¼è‡´<code>Redis</code>å¡é¡¿ã€‚</p></blockquote><blockquote><p>ä½†å•çº¿ç¨‹çš„æ–¹å¼æ— æ³•å‘æŒ¥å¤šæ ¸CPU æ€§èƒ½ï¼Œä¸è¿‡å¯é€šè¿‡åœ¨å•æœºå¼€å¤šä¸ªRedis å®ä¾‹æ¥å®Œå–„;</p></blockquote><blockquote><p>å¤šçº¿ç¨‹å¤„ç†å¯èƒ½æ¶‰åŠåˆ°é”, å¤šçº¿ç¨‹å¤„ç†ä¼šæ¶‰åŠåˆ°çº¿ç¨‹åˆ‡æ¢è€Œæ¶ˆè€—CPU</p></blockquote><blockquote><p>å¤šè¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹: <code>Nginx</code>(å•è¿›ç¨‹å¯åŠ¨åªæœ‰ä¸€ä¸ªè¿›ç¨‹, å¤šè¿›ç¨‹å¯åŠ¨æ—¶ä¼šæœ‰ä¸€ä¸ªMaster,å¤šä¸ªworkerè¿›ç¨‹), <code>Node.js</code></p></blockquote><blockquote><p>å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹: <code>MySQL</code>, <code>Memcached</code></p></blockquote><blockquote><p>è¿›ç¨‹æ˜¯ä¸€ä¸ªå®ä½“ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰å®ƒè‡ªå·±çš„åœ°å€ç©ºé—´ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒåŒ…æ‹¬æ–‡æœ¬åŒºåŸŸï¼ˆtext regionï¼‰ã€æ•°æ®åŒºåŸŸï¼ˆdata regionï¼‰å’Œå †æ ˆï¼ˆstack region)</p></blockquote><blockquote><p>ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹å¯ä»¥åˆ©ç”¨è¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œåœ¨å¼•å…¥çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸éƒ½æ˜¯æŠŠè¿›ç¨‹ä½œä¸ºåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€ŒæŠŠçº¿ç¨‹ä½œä¸ºç‹¬ç«‹è¿è¡Œå’Œç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œç”±äºçº¿ç¨‹æ¯”è¿›ç¨‹æ›´å°ï¼ŒåŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œæ•…å¯¹å®ƒçš„è°ƒåº¦æ‰€ä»˜å‡ºçš„å¼€é”€å°±ä¼šå°å¾—å¤šï¼Œèƒ½æ›´é«˜æ•ˆçš„æé«˜ç³»ç»Ÿå¤šä¸ªç¨‹åºé—´å¹¶å‘æ‰§è¡Œçš„ç¨‹åº¦ã€‚</p></blockquote><blockquote><p>è¿›ç¨‹å’Œçº¿ç¨‹çš„ä¸»è¦å·®åˆ«åœ¨äºå®ƒä»¬æ˜¯ä¸åŒçš„æ“ä½œç³»ç»Ÿèµ„æºç®¡ç†æ–¹å¼ã€‚è¿›ç¨‹æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹äº§ç”Ÿå½±å“ï¼Œè€Œçº¿ç¨‹åªæ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„ä¸åŒæ‰§è¡Œè·¯å¾„ã€‚çº¿ç¨‹æœ‰è‡ªå·±çš„å †æ ˆå’Œå±€éƒ¨å˜é‡ï¼Œä½†çº¿ç¨‹ä¹‹é—´æ²¡æœ‰å•ç‹¬çš„åœ°å€ç©ºé—´ï¼Œä¸€ä¸ªçº¿ç¨‹æ­»æ‰å°±ç­‰äºæ•´ä¸ªè¿›ç¨‹æ­»æ‰ï¼Œæ‰€ä»¥å¤šè¿›ç¨‹çš„ç¨‹åºè¦æ¯”å¤šçº¿ç¨‹çš„ç¨‹åºå¥å£®ï¼Œä½†åœ¨è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œè€—è´¹èµ„æºè¾ƒå¤§ï¼Œæ•ˆç‡è¦å·®ä¸€äº›ã€‚ä½†å¯¹äºä¸€äº›è¦æ±‚åŒæ—¶è¿›è¡Œå¹¶ä¸”åˆè¦å…±äº«æŸäº›å˜é‡çš„å¹¶å‘æ“ä½œï¼Œåªèƒ½ç”¨çº¿ç¨‹ï¼Œä¸èƒ½ç”¨è¿›ç¨‹ã€‚</p></blockquote><h5 id="Rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ"><a href="#Rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ" class="headerlink" title="Rediså•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ"></a><code>Redis</code>å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ</h5><ul><li><p>å®Œå…¨åŸºäºå†…å­˜ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚æ˜¯çº¯ç²¹çš„å†…å­˜æ“ä½œï¼Œéå¸¸å¿«é€Ÿã€‚æ•°æ®å­˜åœ¨å†…å­˜ä¸­ï¼Œç±»ä¼¼äºHashMapï¼ŒHashMapçš„ä¼˜åŠ¿å°±æ˜¯æŸ¥æ‰¾å’Œæ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ï¼›</p></li><li><p>æ•°æ®ç»“æ„ç®€å•ï¼Œå¯¹æ•°æ®æ“ä½œä¹Ÿç®€å•ï¼ŒRedisä¸­çš„æ•°æ®ç»“æ„æ˜¯ä¸“é—¨è¿›è¡Œè®¾è®¡çš„ï¼›</p></li><li><p>é‡‡ç”¨å•çº¿ç¨‹ï¼Œé¿å…äº†ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç«äº‰æ¡ä»¶ï¼Œä¹Ÿä¸å­˜åœ¨å¤šè¿›ç¨‹æˆ–è€…å¤šçº¿ç¨‹å¯¼è‡´çš„åˆ‡æ¢è€Œæ¶ˆè€—CPUï¼Œä¸ç”¨å»è€ƒè™‘å„ç§é”çš„é—®é¢˜ï¼Œä¸å­˜åœ¨åŠ é”é‡Šæ”¾é”æ“ä½œï¼Œæ²¡æœ‰å› ä¸ºå¯èƒ½å‡ºç°æ­»é”è€Œå¯¼è‡´çš„æ€§èƒ½æ¶ˆè€—ï¼›</p></li><li><p>ä½¿ç”¨å¤šè·¯I/Oå¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡IOï¼›</p></li><li><p>ä½¿ç”¨åº•å±‚æ¨¡å‹ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´åº•å±‚å®ç°æ–¹å¼ä»¥åŠä¸å®¢æˆ·ç«¯ä¹‹é—´é€šä¿¡çš„åº”ç”¨åè®®ä¸ä¸€æ ·ï¼ŒRedisç›´æ¥è‡ªå·±æ„å»ºäº†VM æœºåˆ¶ ï¼Œå› ä¸ºä¸€èˆ¬çš„ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„è¯ï¼Œä¼šæµªè´¹ä¸€å®šçš„æ—¶é—´å»ç§»åŠ¨å’Œè¯·æ±‚ï¼›</p></li></ul><p><code>Redis</code>å•çº¿ç¨‹å¦‚ä½•å¤„ç†é‚£ä¹ˆå¤šçš„å¹¶å‘å®¢æˆ·ç«¯è¿æ¥ï¼Ÿ<br>å› ä¸º<code>Redis</code>é‡‡ç”¨äº†<code>å¤šè·¯IOå¤ç”¨</code>åŠ<code>éé˜»å¡IO</code>æŠ€æœ¯, <code>å¤šè·¯IOå¤ç”¨</code>æ¨¡å‹æ˜¯åˆ©ç”¨<code>selectã€pollã€epoll</code>å¯ä»¥åŒæ—¶ç›‘å¯Ÿå¤šä¸ªæµçš„<code>IO</code>äº‹ä»¶çš„èƒ½åŠ›ï¼Œåœ¨ç©ºé—²çš„æ—¶å€™ï¼Œä¼šæŠŠå½“å‰çº¿ç¨‹é˜»å¡æ‰ï¼Œå½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæµæœ‰I/Oäº‹ä»¶æ—¶ï¼Œå°±ä»é˜»å¡æ€ä¸­å”¤é†’ï¼Œäºæ˜¯ç¨‹åºå°±ä¼šè½®è¯¢ä¸€éæ‰€æœ‰çš„æµï¼ˆepollæ˜¯åªè½®è¯¢é‚£äº›çœŸæ­£å‘å‡ºäº†äº‹ä»¶çš„æµï¼‰ï¼Œå¹¶ä¸”åªä¾æ¬¡é¡ºåºçš„å¤„ç†å°±ç»ªçš„æµï¼Œè¿™ç§åšæ³•å°±é¿å…äº†å¤§é‡çš„æ— ç”¨æ“ä½œã€‚</p><blockquote><p><strong>å¤šè·¯</strong>æŒ‡çš„æ˜¯å¤šä¸ªç½‘ç»œè¿æ¥ï¼Œ<strong>å¤ç”¨</strong>æŒ‡çš„æ˜¯å¤ç”¨åŒä¸€ä¸ªçº¿ç¨‹ã€‚<br>é‡‡ç”¨<code>å¤šè·¯IOå¤ç”¨</code>æŠ€æœ¯å¯ä»¥è®©å•ä¸ªçº¿ç¨‹é«˜æ•ˆçš„å¤„ç†å¤šä¸ªè¿æ¥è¯·æ±‚(å°½é‡å‡å°‘ç½‘ç»œIOçš„æ—¶é—´æ¶ˆè€—)ï¼Œä¸”<code>Redis</code>åœ¨å†…å­˜ä¸­æ“ä½œæ•°æ®çš„é€Ÿåº¦éå¸¸å¿«(å†…å­˜å†…çš„æ“ä½œä¸ä¼šæˆä¸ºè¿™é‡Œçš„æ€§èƒ½ç“¶é¢ˆ)ï¼Œä¸»è¦ä»¥ä¸Šä¸¤ç‚¹é€ å°±äº†<code>Redis</code>å…·æœ‰å¾ˆé«˜çš„ååé‡ã€‚</p></blockquote><h5 id="éé˜»å¡IO"><a href="#éé˜»å¡IO" class="headerlink" title="éé˜»å¡IO"></a>éé˜»å¡IO</h5><p>å½“æˆ‘ä»¬è°ƒç”¨å¥—æ¥å­—çš„è¯»å†™æ–¹æ³•ï¼Œé»˜è®¤å®ƒä»¬æ˜¯é˜»å¡çš„ï¼Œæ¯”å¦‚readæ–¹æ³•è¦ä¼ é€’è¿›å»ä¸€ä¸ªå‚æ•°nï¼Œè¡¨ç¤ºæœ€å¤šè¯»å–è¿™ä¹ˆå¤šå­—èŠ‚åå†è¿”å›ï¼Œå¦‚æœä¸€ä¸ªå­—èŠ‚éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±ä¼šå¡åœ¨é‚£é‡Œï¼Œç›´åˆ°æ–°çš„æ•°æ®åˆ°æ¥æˆ–è€…è¿æ¥å…³é—­äº†ï¼Œreadæ–¹æ³•æ‰å¯ä»¥è¿”å›ï¼Œçº¿ç¨‹æ‰èƒ½ç»§ç»­å¤„ç†ã€‚è€Œwriteæ–¹æ³•ä¸€èˆ¬æ¥è¯´ä¸ä¼šé˜»å¡ï¼Œé™¤éå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å†™ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œwriteæ–¹æ³•å°±ä¼šé˜»å¡ï¼Œç›´åˆ°ç¼“å­˜åŒºä¸­æœ‰ç©ºé—²ç©ºé—´æŒªå‡ºæ¥äº†ã€‚</p><p><strong>éé˜»å¡IO</strong> åœ¨å¥—æ¥å­—å¯¹è±¡ä¸Šæä¾›äº†ä¸€ä¸ªé€‰é¡¹<code>Non_Blocking</code>ï¼Œå½“è¿™ä¸ªé€‰é¡¹æ‰“å¼€æ—¶ï¼Œè¯»å†™æ–¹æ³•ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯èƒ½è¯»å¤šå°‘è¯»å¤šå°‘ï¼Œèƒ½å†™å¤šå°‘å†™å¤šå°‘ã€‚<strong>èƒ½è¯»å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„è¯»ç¼“å†²åŒºå†…éƒ¨çš„æ•°æ®å­—èŠ‚æ•°ï¼Œèƒ½å†™å¤šå°‘å–å†³äºå†…æ ¸ä¸ºå¥—æ¥å­—åˆ†é…çš„å†™ç¼“å†²åŒºçš„ç©ºé—²ç©ºé—´å­—èŠ‚æ•°</strong>ã€‚è¯»æ–¹æ³•å’Œå†™æ–¹æ³•éƒ½ä¼šé€šè¿‡è¿”å›å€¼æ¥å‘ŠçŸ¥ç¨‹åºå®é™…è¯»å†™äº†å¤šå°‘å­—èŠ‚ã€‚</p><p>æœ‰äº†<code>éé˜»å¡IO</code>æ„å‘³ç€çº¿ç¨‹åœ¨è¯»å†™<code>IO</code>æ—¶å¯ä»¥ä¸å¿…å†é˜»å¡äº†ï¼Œè¯»å†™å¯ä»¥ç¬é—´å®Œæˆç„¶åçº¿ç¨‹å¯ä»¥ç»§ç»­å¹²åˆ«çš„äº‹äº†ã€‚</p><h5 id="äº‹ä»¶è½®è¯¢-å¤šè·¯å¤ç”¨"><a href="#äº‹ä»¶è½®è¯¢-å¤šè·¯å¤ç”¨" class="headerlink" title="äº‹ä»¶è½®è¯¢ (å¤šè·¯å¤ç”¨)"></a>äº‹ä»¶è½®è¯¢ (<code>å¤šè·¯å¤ç”¨</code>)</h5><p><code>éé˜»å¡IO</code>æœ‰ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯çº¿ç¨‹è¦è¯»æ•°æ®ï¼Œç»“æœè¯»äº†ä¸€éƒ¨åˆ†å°±è¿”å›äº†ï¼Œçº¿ç¨‹å¦‚ä½•çŸ¥é“ä½•æ—¶æ‰åº”è¯¥ç»§ç»­è¯»ã€‚ä¹Ÿå°±æ˜¯å½“æ•°æ®åˆ°æ¥æ—¶ï¼Œçº¿ç¨‹å¦‚ä½•å¾—åˆ°é€šçŸ¥ã€‚å†™ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¦‚æœç¼“å†²åŒºæ»¡äº†ï¼Œå†™ä¸å®Œï¼Œå‰©ä¸‹çš„æ•°æ®ä½•æ—¶æ‰åº”è¯¥ç»§ç»­å†™ï¼Œçº¿ç¨‹ä¹Ÿåº”è¯¥å¾—åˆ°é€šçŸ¥ã€‚</p><p><strong>äº‹ä»¶è½®è¯¢API</strong> å°±æ˜¯ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œæœ€ç®€å•çš„<code>äº‹ä»¶è½®è¯¢API</code>æ˜¯<code>selectå‡½æ•°</code>ï¼Œå®ƒæ˜¯æ“ä½œç³»ç»Ÿæä¾›ç»™ç”¨æˆ·ç¨‹åºçš„<code>API</code>ã€‚è¾“å…¥æ˜¯è¯»å†™æè¿°ç¬¦åˆ—è¡¨<code>read_fds &amp; write_fds</code>ï¼Œè¾“å‡ºæ˜¯ä¸ä¹‹å¯¹åº”çš„å¯è¯»å¯å†™äº‹ä»¶ã€‚åŒæ—¶è¿˜æä¾›äº†ä¸€ä¸ª<code>timeout</code>å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œé‚£ä¹ˆå°±æœ€å¤šç­‰å¾…<code>timeout</code>æ—¶é—´ï¼Œçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ã€‚ä¸€æ—¦æœŸé—´æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œå°±å¯ä»¥ç«‹å³è¿”å›ã€‚æ—¶é—´è¿‡äº†ä¹‹åè¿˜æ˜¯æ²¡æœ‰ä»»ä½•äº‹ä»¶åˆ°æ¥ï¼Œä¹Ÿä¼šç«‹å³è¿”å›ã€‚æ‹¿åˆ°äº‹ä»¶åï¼Œçº¿ç¨‹å°±å¯ä»¥ç»§ç»­æŒ¨ä¸ªå¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚å¤„ç†å®Œäº†ç»§ç»­è¿‡æ¥è½®è¯¢ã€‚äºæ˜¯çº¿ç¨‹å°±è¿›å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªæ­»å¾ªç¯ç§°ä¸ºäº‹ä»¶å¾ªç¯ï¼Œä¸€ä¸ªå¾ªç¯ä¸ºä¸€ä¸ªå‘¨æœŸã€‚</p><p>æ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—<code>socket</code>éƒ½æœ‰å¯¹åº”çš„è¯»å†™æ–‡ä»¶æè¿°ç¬¦ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">read_events, write_events = select(read_fds, write_fds, timeout)</span><br><span class="line">for event in read_events:</span><br><span class="line">    handle_read(event.fd)</span><br><span class="line">for event in write_events:</span><br><span class="line">    handle_write(event.fd)</span><br><span class="line">handle_others()  # å¤„ç†å…¶å®ƒäº‹æƒ…ï¼Œå¦‚å®šæ—¶ä»»åŠ¡ç­‰</span><br></pre></td></tr></table></figure></p><p>å› ä¸ºæˆ‘ä»¬é€šè¿‡<code>select</code>ç³»ç»Ÿè°ƒç”¨åŒæ—¶å¤„ç†å¤šä¸ªé€šé“æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ï¼Œå› æ­¤æˆ‘ä»¬å°†è¿™ç±»ç³»ç»Ÿè°ƒç”¨ç§°ä¸º<code>å¤šè·¯å¤ç”¨</code> APIã€‚ç°ä»£æ“ä½œç³»ç»Ÿçš„<code>å¤šè·¯å¤ç”¨</code> API å·²ç»ä¸å†ä½¿ç”¨<code>select</code>ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œæ”¹ç”¨<code>epoll(linux)</code>å’Œ<code>kqueue(freebsd &amp; macosx)</code>ï¼Œå› ä¸º<code>select</code>ç³»ç»Ÿè°ƒç”¨çš„æ€§èƒ½åœ¨æè¿°ç¬¦ç‰¹åˆ«å¤šæ—¶æ€§èƒ½ä¼šéå¸¸å·®ã€‚å®ƒä»¬ä½¿ç”¨èµ·æ¥å¯èƒ½åœ¨å½¢å¼ä¸Šç•¥æœ‰å·®å¼‚ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šéƒ½æ˜¯å·®ä¸å¤šçš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„ä¼ªä»£ç é€»è¾‘è¿›è¡Œç†è§£ã€‚</p><p>æœåŠ¡å™¨å¥—æ¥å­—<code>serversocket</code>å¯¹è±¡çš„è¯»æ“ä½œæ˜¯æŒ‡è°ƒç”¨<code>accept</code>æ¥å—å®¢æˆ·ç«¯æ–°è¿æ¥ã€‚ä½•æ—¶æœ‰æ–°è¿æ¥åˆ°æ¥ï¼Œä¹Ÿæ˜¯é€šè¿‡<code>select</code>ç³»ç»Ÿè°ƒç”¨çš„è¯»äº‹ä»¶æ¥å¾—åˆ°é€šçŸ¥çš„ã€‚</p><h5 id="æŒ‡ä»¤é˜Ÿåˆ—"><a href="#æŒ‡ä»¤é˜Ÿåˆ—" class="headerlink" title="æŒ‡ä»¤é˜Ÿåˆ—"></a>æŒ‡ä»¤é˜Ÿåˆ—</h5><p><code>Redis</code> ä¼šå°†æ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—éƒ½å…³è”ä¸€ä¸ªæŒ‡ä»¤é˜Ÿåˆ—ã€‚å®¢æˆ·ç«¯çš„æŒ‡ä»¤é€šè¿‡é˜Ÿåˆ—æ¥æ’é˜Ÿè¿›è¡Œé¡ºåºå¤„ç†ï¼Œå…ˆåˆ°å…ˆæœåŠ¡ã€‚</p><h5 id="å“åº”é˜Ÿåˆ—"><a href="#å“åº”é˜Ÿåˆ—" class="headerlink" title="å“åº”é˜Ÿåˆ—"></a>å“åº”é˜Ÿåˆ—</h5><p><code>Redis</code> åŒæ ·ä¹Ÿä¼šä¸ºæ¯ä¸ªå®¢æˆ·ç«¯å¥—æ¥å­—å…³è”ä¸€ä¸ªå“åº”é˜Ÿåˆ—ã€‚<code>Redis</code> æœåŠ¡å™¨é€šè¿‡å“åº”é˜Ÿåˆ—æ¥å°†æŒ‡ä»¤çš„è¿”å›ç»“æœå›å¤ç»™å®¢æˆ·ç«¯ã€‚ å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£ä¹ˆæ„å‘³ç€è¿æ¥æš‚æ—¶å¤„äºç©ºé—²çŠ¶æ€ï¼Œä¸éœ€è¦å»è·å–å†™äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å°†å½“å‰çš„å®¢æˆ·ç«¯æè¿°ç¬¦ä»<code>write_fds</code>é‡Œé¢ç§»å‡ºæ¥ã€‚ç­‰åˆ°é˜Ÿåˆ—æœ‰æ•°æ®äº†ï¼Œå†å°†æè¿°ç¬¦æ”¾è¿›å»ã€‚é¿å…<code>select</code>ç³»ç»Ÿè°ƒç”¨ç«‹å³è¿”å›å†™äº‹ä»¶ï¼Œç»“æœå‘ç°æ²¡ä»€ä¹ˆæ•°æ®å¯ä»¥å†™ã€‚å‡ºè¿™ç§æƒ…å†µçš„çº¿ç¨‹ä¼šé£™é«˜<code>CPU</code>ã€‚</p><h5 id="å®šæ—¶ä»»åŠ¡"><a href="#å®šæ—¶ä»»åŠ¡" class="headerlink" title="å®šæ—¶ä»»åŠ¡"></a>å®šæ—¶ä»»åŠ¡</h5><p>æœåŠ¡å™¨å¤„ç†è¦å“åº”<code>IO</code>äº‹ä»¶å¤–ï¼Œè¿˜è¦å¤„ç†å…¶å®ƒäº‹æƒ…ã€‚æ¯”å¦‚å®šæ—¶ä»»åŠ¡å°±æ˜¯éå¸¸é‡è¦çš„ä¸€ä»¶äº‹ã€‚å¦‚æœçº¿ç¨‹é˜»å¡åœ¨<code>select</code>ç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œå®šæ—¶ä»»åŠ¡å°†æ— æ³•å¾—åˆ°å‡†æ—¶è°ƒåº¦ã€‚é‚£<code>Redis</code>æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿ</p><p><code>Redis</code> çš„å®šæ—¶ä»»åŠ¡ä¼šè®°å½•åœ¨ä¸€ä¸ªç§°ä¸ºæœ€å°å †çš„æ•°æ®ç»“æ„ä¸­ã€‚è¿™ä¸ªå †ä¸­ï¼Œæœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡æ’åœ¨å †çš„æœ€ä¸Šæ–¹ã€‚åœ¨æ¯ä¸ªå¾ªç¯å‘¨æœŸï¼Œ<code>Redis</code> éƒ½ä¼šå°†æœ€å°å †é‡Œé¢å·²ç»åˆ°ç‚¹çš„ä»»åŠ¡ç«‹å³è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œæ¯•åï¼Œå°†æœ€å¿«è¦æ‰§è¡Œçš„ä»»åŠ¡è¿˜éœ€è¦çš„æ—¶é—´è®°å½•ä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯<code>select</code>ç³»ç»Ÿè°ƒç”¨çš„timeoutå‚æ•°ã€‚å› ä¸º <code>Redis</code> çŸ¥é“æœªæ¥timeoutæ—¶é—´å†…ï¼Œæ²¡æœ‰å…¶å®ƒå®šæ—¶ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥å¯ä»¥å®‰å¿ƒç¡çœ timeoutçš„æ—¶é—´ã€‚</p><p><code>Nginx</code>å’Œ<code>Node</code>çš„äº‹ä»¶å¤„ç†åŸç†å’Œ<code>Redis</code>ä¹Ÿæ˜¯ç±»ä¼¼çš„</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>å¼•ç”¨å®˜æ–¹è¯´æ˜ï¼Œé˜è¿°äº†ä¸ºä½•<code>Redis</code>è¢«è®¾è®¡ä¸ºå•çº¿ç¨‹æ¨¡å‹; </li><li>è¿›ä¸€æ­¥é˜è¿°äº†ä¸ºä½•å•çº¿ç¨‹æ¨¡å‹è®¾è®¡çš„<code>Redis</code>å¯ä»¥éå¸¸å¿«çš„å¤„ç†é«˜å¹¶å‘ç­‰åœºæ™¯çš„åŸå› ;</li><li>å¯¹å¤šè·¯å¤ç”¨IOæ¨¡å‹åŠéé˜»å¡IOæŠ€æœ¯è¿›è¡Œäº†åŸç†é˜è¿°åŠåˆ†æ;</li><li>æ­¤å¤–æ³¨æ„åˆ°æˆªæ­¢ç›®å‰æœ€æ–°redisæ–‡æ¡£ç‰ˆæœ¬å·²æ›´æ–°åˆ°redis5.0ï¼Œå¹¶å¼•å…¥æ–°çš„æ•°æ®ç±»å‹<code>stream</code>ï¼Œå¹¶å¯¹<code>HyperLogLog</code>ç­‰ä½œå‡ºäº†å¾ˆå¤šä¼˜åŒ–æ”¹è¿›;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Redis&lt;/code&gt;æ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹çš„KVæ•°æ®åº“,é‚£ä¸ºä»€ä¹ˆè¿˜å¸¸åº”ç”¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­? å…¶ä¸­ä¸€ä¸ªé‡è¦åŸå› æ˜¯&lt;code&gt;Redis&lt;/code&gt;æ˜¯ä¸€ä¸ª&lt;strong&gt;å•è¿›ç¨‹å•çº¿ç¨‹&lt;/strong&gt;ä¸”é‡‡ç”¨&lt;strong&gt;å¤šè·¯I/Oå¤ç”¨æ¨¡å‹ï¼Œéé˜»å¡IO&lt;/strong&gt;æŠ€æœ¯, ä½¿ä¹‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¿æ¥è¯·æ±‚(å‡å°‘ç½‘ç»œIOè€—æ—¶), ä¹Ÿä¸éœ€è¦å…³å¿ƒé”ï¼Œçº¿ç¨‹åˆ‡æ¢ç­‰èµ„æºæ¶ˆè€—é—®é¢˜;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸“é¢˜15 æ€§èƒ½ä¼˜åŒ–ä¹‹æ•°æ®åº“ç»“æ„ä¼˜åŒ–</title>
    <link href="http://researchlab.github.io/2018/10/08/mysql-15-database-structure-optimization/"/>
    <id>http://researchlab.github.io/2018/10/08/mysql-15-database-structure-optimization/</id>
    <published>2018-10-08T10:20:57.000Z</published>
    <updated>2019-08-24T14:25:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>é™¤äº†å¸¸è§çš„SQLè¯­å¥ä¼˜åŒ–åŠç´¢å¼•ä¼˜åŒ–ç­‰æ•°æ®åº“ä¼˜åŒ–æ‰‹æ®µå¤–, å¯¹æ•°æ®åº“ç»“æ„è¿›è¡Œä¼˜åŒ–ä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘çš„ä¸€ä¸ªé‡è¦æ–¹å‘;<br><a id="more"></a></p><p>ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥æ¢è®¨æ•°æ®åº“ç»“æ„æ–¹é¢çš„ä¼˜åŒ–å®è·µ,</p><ul><li>åˆ—<ul><li>æ•°æ®ç±»å‹ä¼˜åŒ–</li></ul></li><li>æ•°æ®è¡¨<ul><li>èŒƒå¼åŒ–ä¼˜åŒ–</li><li>åèŒƒå¼åŒ–ä¼˜åŒ–</li><li>å‚ç›´æ‹†åˆ†</li><li>æ°´å¹³æ‹†åˆ†</li></ul></li></ul><h2 id="åˆ—æ•°æ®ç±»å‹ä¼˜åŒ–"><a href="#åˆ—æ•°æ®ç±»å‹ä¼˜åŒ–" class="headerlink" title="åˆ—æ•°æ®ç±»å‹ä¼˜åŒ–"></a>åˆ—æ•°æ®ç±»å‹ä¼˜åŒ–</h2><p>å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ—æ•°æ®ç±»å‹?</p><ol><li>ä½¿ç”¨å¯ä»¥å­˜ä¸‹ç›®æ ‡æ•°æ®çš„æœ€å°çš„æ•°æ®ç±»å‹;</li><li>ä½¿ç”¨ç®€å•çš„æ•°æ®ç±»å‹, Intè¦æ¯”varcharç±»å‹åœ¨mysqlå¤„ç†ä¸Šç®€å•;</li><li>å°½å¯èƒ½çš„ä½¿ç”¨NOT NULLå®šä¹‰å­—æ®µ;</li><li>å°½é‡å°‘ç”¨textç±»å‹, éç”¨ä¸å¯æ—¶æœ€å¥½è€ƒè™‘åˆ†è¡¨;</li></ol><h3 id="ç¤ºä¾‹åˆ†æ"><a href="#ç¤ºä¾‹åˆ†æ" class="headerlink" title="ç¤ºä¾‹åˆ†æ"></a>ç¤ºä¾‹åˆ†æ</h3><p>ä½¿ç”¨intç±»å‹å­˜å‚¨æ—¥æœŸæ—¶é—´, åˆ©ç”¨FROM_UNIXTIME(), UNIX_TIMESTAMP()ä¸¤ä¸ªå‡½æ•°è¿›è¡Œè½¬æ¢;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">timestr <span class="built_in">int</span>,</span><br><span class="line">primary <span class="keyword">key</span> (<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> (timestr) <span class="keyword">values</span>(<span class="keyword">unix_timestamp</span>(<span class="string">'2016-06-11 12:11:00'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> FROM_UNIXTIME(timestr) <span class="keyword">from</span> <span class="keyword">test</span>;</span><br></pre></td></tr></table></figure><ul><li>åœ¨å…·ä½“ä½¿ç”¨æ—¶ä¹Ÿåº”ç”¨ç»“åˆä¸šåŠ¡ä½¿ç”¨åœºæ™¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚ä¸šåŠ¡ç»å¸¸éœ€è¦å¯¹æ—¶é—´è¿›è¡Œå„ç§æ ¼å¼åŒ–è½¬æ¢, ç”šè‡³éœ€è¦åœ¨ä¸åŒçš„è¯­è¨€ä¸­è½¬æ¢, åˆ™åº”å­˜å‚¨æˆæ ‡å‡†çš„æ—¶é—´æ ¼å¼ time.Time, ä»¥å…å¼•èµ·ç²¾åº¦æŸå¤±é—®é¢˜;</li></ul><p>ä½¿ç”¨bigintæ¥å­˜å‚¨IPåœ°å€, åˆ©ç”¨INET_ATON(), INET_NTOA()ä¸¤ä¸ªå‡½æ•°è¿›è¡Œè½¬æ¢;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sessions(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> auto_increment <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">ipaddr <span class="built_in">bigint</span>,</span><br><span class="line">primary <span class="keyword">key</span> (<span class="keyword">id</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sessions(ipaddr) <span class="keyword">values</span>(<span class="keyword">inet_aton</span>(<span class="string">'192.168.0.1'</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">inet_ntoa</span>(ipaddr) <span class="keyword">from</span> sessions;</span><br></pre></td></tr></table></figure><ul><li>bigint å¤§æ¦‚éœ€è¦8ä¸ªå­—èŠ‚ï¼Œ è€Œvarcharå¤§æ¦‚éœ€è¦15ä¸ªå­—èŠ‚</li></ul><h2 id="è¡¨èŒƒå¼åŒ–ä¼˜åŒ–"><a href="#è¡¨èŒƒå¼åŒ–ä¼˜åŒ–" class="headerlink" title="è¡¨èŒƒå¼åŒ–ä¼˜åŒ–"></a>è¡¨èŒƒå¼åŒ–ä¼˜åŒ–</h2><p>è¡¨èŒƒå¼åŒ–ä¸€èˆ¬æŒ‡ç¬¬ä¸‰è®¾è®¡èŒƒå¼, å³è¦æ±‚æ•°æ®è¡¨ä¸­ä¸å­˜åœ¨éå…³é”®å­—æ®µå¯¹ä»»æ„å€™é€‰é”®å­—æ®µçš„ä¼ é€’å‡½æ•°ä¾èµ–åˆ™ç¬¦åˆç¬¬ä¸‰èŒƒå¼;</p><h3 id="ç¤ºä¾‹åˆ†æ-1"><a href="#ç¤ºä¾‹åˆ†æ-1" class="headerlink" title="ç¤ºä¾‹åˆ†æ"></a>ç¤ºä¾‹åˆ†æ</h3><table><thead><tr><th style="text-align:left">å•†å“å</th><th style="text-align:left">ä»·æ ¼</th><th style="text-align:left">é‡é‡</th><th style="text-align:left">æœ‰æ•ˆæœŸ</th><th style="text-align:left">åˆ†ç±»</th><th style="text-align:left">åˆ†ç±»æè¿°</th></tr></thead><tbody><tr><td style="text-align:left">å¯ä¹</td><td style="text-align:left">3.00</td><td style="text-align:left">250ml</td><td style="text-align:left">2015.6</td><td style="text-align:left">é¥®æ–™</td><td style="text-align:left">ç¢³é…¸é¥®æ–™</td></tr><tr><td style="text-align:left">é›ªç¢§</td><td style="text-align:left">3.00</td><td style="text-align:left">250ml</td><td style="text-align:left">2015.6</td><td style="text-align:left">é¥®æ–™</td><td style="text-align:left">ç¢³é…¸é¥®æ–™</td></tr></tbody></table><p>æ˜¾ç„¶ä¸Šè¿°å•†å“è¡¨ä¸­å­˜åœ¨å¦‚ä¸‹ä¼ é€’å‡½æ•°ä¾èµ–å…³ç³»<br>(å•†å“å)â€“&gt;(åˆ†ç±»)â€“&gt;(åˆ†ç±»æè¿°)</p><p>ä¹Ÿå°±æ˜¯è¯´å­˜åœ¨éå…³é”®å­—â€åˆ†ç±»æè¿°â€å¯¹å…³é”®å­—â€å•†å“åâ€çš„ä¼ é€’å‡½æ•°ä¾èµ–; æ˜¾ç„¶ä¸ç¬¦åˆç¬¬ä¸‰è®¾è®¡èŒƒå¼, ä¸ç¬¦åˆè®¾è®¡èŒƒå¼ä¸€èˆ¬å­˜åœ¨4å¤§é—®é¢˜, </p><ol><li>æ•°æ®å†—ä½™(åˆ†ç±», åˆ†ç±»æè¿°) å¯¹åŒä¸€åˆ†ç±»å•†å“æ˜¯ä¸€æ ·çš„;</li><li>æ•°æ®æ’å…¥å¼‚å¸¸; æ’å…¥äº†å°±èƒ½æŸ¥åˆ°, æ²¡æœ‰æ•°æ®å°±æŸ¥ä¸åˆ°æŸäº›å…³é”®ä¿¡æ¯;</li><li>æ›´æ–°å¼‚å¸¸;</li><li>åˆ é™¤å¼‚å¸¸;</li></ol><p>ä¸€èˆ¬è¿™ç§é—®é¢˜å¯ä»¥é€šè¿‡å°†è¡¨è®¾è®¡æ‹†åˆ†ä¸ºä¸¤å¼ å®ä½“è¡¨, å¦å¤–åœ¨å¢åŠ ä¸€ä¸ªå…³ç³»è¡¨; å¦‚, </p><p>å•†å“è¡¨(å•†å“ming,ä»·æ ¼,é‡é‡,æœ‰æ•ˆæœŸ)</p><p>åˆ†ç±»è¡¨(åˆ†ç±»,åˆ†ç±»æè¿°)</p><p>å•†å“åˆ†ç±»(åˆ†ç±», å•†å“å)</p><h2 id="è¡¨åèŒƒå¼åŒ–ä¼˜åŒ–"><a href="#è¡¨åèŒƒå¼åŒ–ä¼˜åŒ–" class="headerlink" title="è¡¨åèŒƒå¼åŒ–ä¼˜åŒ–"></a>è¡¨åèŒƒå¼åŒ–ä¼˜åŒ–</h2><p>åèŒƒå¼åŒ–æ˜¯æŒ‡ä¸ºäº†æŸ¥è¯¢æ•ˆç‡çš„è€ƒè™‘æŠŠåŸæœ¬ç¬¦åˆç¬¬ä¸‰èŒƒå¼çš„è¡¨é€‚å½“çš„å¢åŠ å†—ä½™, ä»¥è¾¾åˆ°ä¼˜åŒ–æŸ¥è¯¢æ•ˆç‡çš„ç›®çš„, åèŒƒå¼åŒ–æ˜¯ä¸€ç§ä»¥ç©ºé—´æ¥æ¢å–æ—¶é—´çš„æ“ä½œ;</p><h3 id="ç¤ºä¾‹åˆ†æ-2"><a href="#ç¤ºä¾‹åˆ†æ-2" class="headerlink" title="ç¤ºä¾‹åˆ†æ"></a>ç¤ºä¾‹åˆ†æ</h3><p>ç”¨æˆ·è¡¨(ç”¨æˆ·ID,å§“å,ç”µè¯,åœ°å€,é‚®ç¼–)<br>è®¢å•è¡¨(è®¢å•ID,ç”¨æˆ·ID,ä¸‹å•æ—¶é—´,æ”¯ä»˜ç±»å‹,è®¢å•çŠ¶æ€)<br>è®¢å•å•†å“è¡¨(è®¢å•ID, å•†å“ID, å•†å“æ•°é‡,å•†å“ä»·æ ¼)<br>å•†å“è¡¨(å•†å“ID,åç§°,æè¿°,è¿‡æœŸæ—¶é—´)</p><p>é—®é¢˜: æŸ¥è¯¢è®¢å•è¯¦æƒ…</p><p>å¸¸è§„sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> b.ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•<span class="keyword">ID</span>, <span class="keyword">sum</span>(c.å•†å“ä»·æ ¼*c.å•†å“æ•°é‡) <span class="keyword">as</span> è®¢å•ä»·æ ¼ <span class="keyword">from</span> è®¢å•è¡¨ a </span><br><span class="line"><span class="keyword">join</span> ç”¨æˆ·è¡¨ b <span class="keyword">on</span> a.ç”¨æˆ·<span class="keyword">ID</span> = b.ç”¨æˆ·<span class="keyword">ID</span> </span><br><span class="line"><span class="keyword">join</span> è®¢å•å•†å“è¡¨ c <span class="keyword">on</span> c.è®¢å•<span class="keyword">ID</span> = b.è®¢å•<span class="keyword">ID</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> b.ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•<span class="keyword">ID</span>;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æŸ¥è¯¢æ˜¾ç„¶è¦å…³è”å¤šå¼ è¡¨; æ­¤å¤–åœ¨group by ä¸­å¦‚æœå­˜åœ¨éå…³é”®å­—ç´¢å¼•å­—æ®µï¼Œ åˆ™å¯èƒ½ä½¿ç”¨ä¸´æ—¶è¡¨æ¥è¾…åŠ©æŸ¥è¯¢, é‚£è¿™æ ·æ•ˆç‡å°±æ¯”è¾ƒä½; </p><p>å¯ä»¥é€šè¿‡å°†è®¢å•è¡¨ä¸­å†—ä½™ä¸€éƒ¨åˆ†ç”¨æˆ·ä¿¡æ¯, è¿™æ ·å¯ä»¥é€šè¿‡æŸ¥è¯¢è®¢å•è¡¨ä¸€å¼ è¡¨å³å¯å®ŒæˆæŸ¥è¯¢éœ€æ±‚;</p><p>è®¢å•è¡¨(è®¢å•ID,ç”¨æˆ·ID,ä¸‹å•æ—¶é—´,æ”¯ä»˜ç±»å‹,è®¢å•çŠ¶æ€,è®¢å•ä»·æ ¼,ç”¨æˆ·å,ç”µè¯,åœ°å€)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ç”¨æˆ·å, ç”µè¯, åœ°å€, è®¢å•<span class="keyword">ID</span>,  è®¢å•ä»·æ ¼ <span class="keyword">from</span> è®¢å•è¡¨</span><br></pre></td></tr></table></figure><h2 id="è¡¨å‚ç›´æ‹†åˆ†"><a href="#è¡¨å‚ç›´æ‹†åˆ†" class="headerlink" title="è¡¨å‚ç›´æ‹†åˆ†"></a>è¡¨å‚ç›´æ‹†åˆ†</h2><p>è¡¨çš„å‚ç›´æ‹†åˆ†, å°±æ˜¯æŠŠåŸæ¥æœ‰å¾ˆå¤šåˆ—çš„è¡¨æ‹†åˆ†ä¸ºå¤šä¸ªè¡¨, å‚ç›´æ‹†åˆ†åŸåˆ™, </p><ol><li>æŠŠä¸å¸¸ç”¨çš„å­—æ®µå•ç‹¬å­˜æ”¾åˆ°ä¸€å¼ è¡¨ä¸­;</li><li>æŠŠå¤§å­—æ®µç‹¬ç«‹æ”¾åˆ°ä¸€ä¸ªè¡¨ä¸­;</li><li>æŠŠå¯èƒ½å­˜åœ¨å…³è”å…³ç³»å¸¸ç”¨å­—æ®µæ”¾åˆ°ä¸€å¼ è¡¨ä¸­;</li></ol><h2 id="è¡¨æ°´å¹³æ‹†åˆ†"><a href="#è¡¨æ°´å¹³æ‹†åˆ†" class="headerlink" title="è¡¨æ°´å¹³æ‹†åˆ†"></a>è¡¨æ°´å¹³æ‹†åˆ†</h2><p>è¡¨çš„æ°´å¹³æ‹†åˆ†æ˜¯ä¸ºäº†è§£å†³å•è¡¨çš„æ•°æ®é‡è¿‡å¤§çš„é—®é¢˜, æ°´å¹³æ‹†åˆ†çš„è¡¨æ¯ä¸€ä¸ªè¡¨çš„ç»“æ„éƒ½æ˜¯å®Œå…¨ä¸€è‡´çš„; é€šè¿‡å–æŸä¸ªprimary key æˆ–è€…uniquekey çš„å€¼è¿›è¡Œhashè®¡ç®—ç„¶åå†³å®šæŠŠæ•°æ®å­˜å…¥tb1,tb2,â€¦,tbnä¸­æŸä¸ªè¡¨ä¸­; </p><p>ä½†åœ¨ä»¥ä¸‹åœºæ™¯ä¸­å¯¹sqlæ“ä½œä¼šå¸¦æ¥ä¸€äº›æŒ‘æˆ˜,<br>1.è·¨åˆ†åŒºè¡¨è¿›è¡Œæ•°æ®æŸ¥è¯¢;<br>2.ç»Ÿè®¡åŠåå°æŠ¥è¡¨æ“ä½œ;</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>é€‰æ‹©åˆé€‚çš„åˆ—å­—æ®µç±»å‹; </li><li>å¯ç”¨ç©ºé—´æ¢æ—¶é—´çš„åŠæ³•, åšä¸€äº›åèŒƒå¼åŒ–è®¾è®¡å†—ä½™å­—æ®µæé«˜æŸ¥è¯¢ç­‰æ“ä½œæ•ˆç‡;</li><li>é’ˆå¯¹æ•°æ®è¡¨å­—æ®µè¿‡å¤šåŠæ•°æ®é‡è¿‡å¤šçš„æƒ…å†µçš„ä¸¤ç§ç®€å•è®¾è®¡æŠ€å·§çš„è¯´æ˜, å®é™…æƒ…å†µä¸­ä¼šé€šè¿‡åˆ†åº“åˆ†è¡¨æ¥åš, å¯ä»¥å°è£…ä¸€å¥—mysqlæ¥æ”¯æŒï¼Œ ä¹Ÿå¯ä»¥é‡‡ç”¨ç°æˆçš„å¼€æºdb, å¦‚tidbç­‰æ–¹æ¡ˆ;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;é™¤äº†å¸¸è§çš„SQLè¯­å¥ä¼˜åŒ–åŠç´¢å¼•ä¼˜åŒ–ç­‰æ•°æ®åº“ä¼˜åŒ–æ‰‹æ®µå¤–, å¯¹æ•°æ®åº“ç»“æ„è¿›è¡Œä¼˜åŒ–ä¹Ÿæ˜¯å¯ä»¥è€ƒè™‘çš„ä¸€ä¸ªé‡è¦æ–¹å‘;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysqlä¸“é¢˜" scheme="http://researchlab.github.io/categories/mysql%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="mysql" scheme="http://researchlab.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜10 æµ·é‡æ•°æ®æ‰«æç¥å™¨ä¹‹scan</title>
    <link href="http://researchlab.github.io/2018/10/07/redis-10-scan/"/>
    <id>http://researchlab.github.io/2018/10/07/redis-10-scan/</id>
    <published>2018-10-07T17:11:41.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨<code>redis</code>æ¨¡ç³ŠåŒ¹é…<code>key</code>æ—¶ï¼Œå®˜æ–¹å»ºè®®ä¸è¦ä½¿ç”¨<code>keys</code>æˆ–<code>smembers</code>ï¼Œä»–ä»¬çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯<code>O(N)</code>,ä½¿ç”¨<code>scan</code>ï¼Œ<code>zscan</code>ï¼Œ<code>hscan</code>ç­‰ã€‚<code>scan</code>ç³»åˆ—å¢é‡å¼è¿­ä»£å‘½ä»¤æ¯æ¬¡æ‰§è¡Œçš„å¤æ‚åº¦ä¸º<code>O(1)</code>ï¼Œ å¯¹æ•°æ®é›†è¿›è¡Œä¸€æ¬¡å®Œæ•´è¿­ä»£çš„å¤æ‚åº¦ä¸º<code>O(N)</code>ï¼Œ å…¶ä¸­<code>N</code>ä¸ºæ•°æ®é›†ä¸­çš„å…ƒç´ æ•°é‡ã€‚ç›¸æ¯”<code>keys</code>å‘½ä»¤æ‰§è¡Œæ—¶ä¼šé˜»å¡æ‰æ•´ä¸ª<code>redis</code>çº¿ç¨‹è€Œè¨€ï¼Œ<code>scan</code>ç³»åˆ—åˆ™æ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡<code>redis</code>çº¿ç¨‹, ä¸”åœ¨åŒä¸€æ—¶é—´ï¼Œå¯ä»¥æœ‰ä»»æ„å¤šä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€æ•°æ®é›†è¿›è¡Œè¿­ä»£ã€‚<br><a id="more"></a></p><p><code>keys</code>æœ‰ä¸¤ä¸ªæ˜¾è‘—ç¼ºç‚¹,</p><ul><li>æ²¡æœ‰<code>offset, limit</code>å‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„<code>key</code>, ä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾wä¸ª<code>key</code>æ»¡è¶³æ¡ä»¶, å½“ä½ çœ‹åˆ°æ»¡å±çš„å­—ç¬¦ä¸²åˆ·çš„æ²¡æœ‰å°½å¤´æ—¶ï¼Œä½ å°±çŸ¥é“éš¾å—äº†ã€‚</li><li><code>keys</code>ç®—æ³•æ˜¯éå†ç®—æ³•, å¤æ‚åº¦æ˜¯<code>O(n)</code>ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰åƒä¸‡çº§ä»¥ä¸Šçš„<code>key</code>ï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´<code>Redis</code>æœåŠ¡å¡é¡¿, æ‰€æœ‰è¯»å†™<code>Redis</code>çš„å…¶å®ƒçš„æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³ä¼šè¶…æ—¶æŠ¥é”™ï¼Œå› ä¸º<code>Redis</code>æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶å®ƒæŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰çš„<code>keys</code>æŒ‡ä»¤æ‰§è¡Œå®Œäº†æ‰å¯ä»¥ç»§ç»­ã€‚</li></ul><p><code>redis</code>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, å®ƒåœ¨2.8ç‰ˆæœ¬ä¸­åŠ å…¥äº†<code>scan</code>ç³»åˆ—å¢é‡å¼è¿­ä»£å‘½ä»¤ã€‚<code>scan</code>ç›¸æ¯”<code>keys</code>å…·å¤‡æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</p><ul><li>å¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯<code>O(n)</code>ï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹;</li><li>æä¾›<code>limit</code>å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°, <code>limit</code>åªæ˜¯ä¸€ä¸ª<code>hint</code>ï¼Œè¿”å›çš„ç»“æœå¯å¤šå¯å°‘;</li><li>åŒ<code>keys</code>ä¸€æ ·ï¼Œå®ƒä¹Ÿæä¾›æ¨¡å¼åŒ¹é…åŠŸèƒ½;</li><li>æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œæ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯<code>scan</code>è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°;</li><li>è¿”å›çš„ç»“æœå¯èƒ½ä¼šæœ‰é‡å¤ï¼Œéœ€è¦å®¢æˆ·ç«¯å»é‡å¤ï¼Œè¿™ç‚¹éå¸¸é‡è¦;</li><li>éå†çš„è¿‡ç¨‹ä¸­å¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½éå†åˆ°æ˜¯ä¸ç¡®å®šçš„;</li><li>å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œè€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶;</li></ul><blockquote><p>å½“ç„¶<code>å¢é‡å¼è¿­ä»£å‘½ä»¤</code>ä¹Ÿä¸æ˜¯æ²¡æœ‰ç¼ºç‚¹, å¦‚ä½¿ç”¨<code>SMEMBERS</code>å‘½ä»¤å¯ä»¥è¿”å›é›†åˆé”®å½“å‰åŒ…å«çš„æ‰€æœ‰å…ƒç´ ï¼Œ ä½†æ˜¯å¯¹äº<code>SCAN</code>è¿™ç±»å¢é‡å¼è¿­ä»£å‘½ä»¤æ¥è¯´ï¼Œ å› ä¸ºåœ¨å¯¹é”®è¿›è¡Œå¢é‡å¼è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œé”®å¯èƒ½ä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥å¢é‡å¼è¿­ä»£å‘½ä»¤åªèƒ½å¯¹è¢«è¿”å›çš„å…ƒç´ æä¾›æœ‰é™çš„ä¿è¯(offer limited guarantees about the returned elements)ã€‚</p></blockquote><blockquote><p>åŒä¸€ä¸ªå…ƒç´ å¯èƒ½ä¼šè¢«è¿”å›å¤šæ¬¡ã€‚<code>scan</code>ç³»åˆ—å‘½ä»¤æ— æ³•ä¿è¯åŒä¸€å…ƒç´ è¢«å¤šæ¬¡è¿”å›, æ‰€ä»¥å¤„ç†é‡å¤å…ƒç´ çš„å·¥ä½œäº¤ç”±åº”ç”¨ç¨‹åºè´Ÿè´£å¤„ç†(è¿‡æ»¤/å¹‚ç­‰æ“ä½œ)ã€‚</p></blockquote><p><strong>scan</strong></p><blockquote><p>å‘½ä»¤: <code>SCAN cursor [MATCH pattern] [COUNT count]</code></p><blockquote><p><code>count</code>è¡¨ç¤ºæ¯æ¬¡è¿­ä»£ä¸­åº”è¯¥ä»æ•°æ®é›†é‡Œæœ€å¤šè¿”å›å¤šå°‘å…ƒç´ , é»˜è®¤å€¼ä¸º10, ç”¨æˆ·å¯ä»¥åœ¨æ¯æ¬¡è¿­ä»£æ—¶éšæœºä¿®æ”¹æ­¤å€¼;</p></blockquote></blockquote><blockquote><blockquote><p>åœ¨è¿­ä»£ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ã€ç”±å“ˆå¸Œè¡¨å®ç°çš„æ•°æ®åº“ã€é›†åˆé”®ã€å“ˆå¸Œé”®æˆ–è€…æœ‰åºé›†åˆé”®æ—¶, å¦‚æœç”¨æˆ·æ²¡æœ‰ä½¿ç”¨<code>match</code>é€‰é¡¹, é‚£ä¹ˆå‘½ä»¤è¿”å›çš„å…ƒç´ æ•°é‡é€šå¸¸å’Œ<code>COUNT</code>é€‰é¡¹æŒ‡å®šçš„ä¸€æ ·, æˆ–è€…æ¯”<code>COUNT</code>é€‰é¡¹æŒ‡å®šçš„æ•°é‡ç¨å¤šä¸€äº›ã€‚</p></blockquote></blockquote><blockquote><blockquote><p>åœ¨è¿­ä»£ä¸€ä¸ªç¼–ç ä¸ºæ•´æ•°é›†åˆ(<code>intset</code>, ä¸€ä¸ªåªç”±æ•´æ•°å€¼æ„æˆçš„å°é›†åˆ), æˆ–è€…ç¼–ç ä¸ºå‹ç¼©åˆ—è¡¨<code>ziplist</code>, ç”±ä¸åŒå€¼æ„æˆçš„ä¸€ä¸ªå°å“ˆå¸Œæˆ–è€…ä¸€ä¸ªå°æœ‰åºé›†åˆ)æ—¶, å¢é‡å¼è¿­ä»£å‘½ä»¤é€šå¸¸ä¼šæ— è§†<code>COUNT</code>é€‰é¡¹æŒ‡å®šçš„å€¼ï¼Œ åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£å°±å°†æ•°æ®é›†åŒ…å«çš„æ‰€æœ‰å…ƒç´ éƒ½è¿”å›ç»™ç”¨æˆ·ã€‚</p></blockquote></blockquote><blockquote><blockquote><p><code>match</code>è¡¨ç¤ºå¯¹è¿”å›çš„å…ƒç´ å†è¿›è¡Œæ¨¡å¼åŒ¹é…å¹¶å°†åŒ¹é…ç»“æœæœ€ç»ˆè¿”å›, <strong>éœ€è¦æ³¨æ„çš„æ˜¯, å¯¹å…ƒç´ çš„æ¨¡å¼åŒ¹é…å·¥ä½œæ˜¯åœ¨å‘½ä»¤ä»æ•°æ®é›†ä¸­å–å‡ºå…ƒç´ ä¹‹å, å‘å®¢æˆ·ç«¯è¿”å›å…ƒç´ ä¹‹å‰çš„è¿™æ®µæ—¶é—´å†…è¿›è¡Œçš„, æ‰€ä»¥å¦‚æœè¢«è¿­ä»£çš„æ•°æ®é›†ä¸­åªæœ‰å°‘é‡å…ƒç´ å’Œæ¨¡å¼ç›¸åŒ¹é…, é‚£ä¹ˆè¿­ä»£å‘½ä»¤æˆ–è®¸ä¼šåœ¨å¤šæ¬¡æ‰§è¡Œä¸­éƒ½ä¸è¿”å›ä»»ä½•å…ƒç´ ã€‚</strong></p></blockquote></blockquote><blockquote><p>åŠŸèƒ½: ç”¨äºè¿­ä»£å½“å‰æ•°æ®åº“ä¸­çš„æ•°æ®åº“é”®;</p></blockquote><blockquote><p>è¿”å›å€¼: <code>SCAN</code>å‘½ä»¤çš„å›å¤æ˜¯ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„, ç¬¬ä¸€ä¸ªæ•°ç»„å…ƒç´ æ˜¯ç”¨äºè¿›è¡Œä¸‹ä¸€æ¬¡è¿­ä»£çš„æ–°æ¸¸æ ‡, è€Œç¬¬äºŒä¸ªæ•°ç»„å…ƒç´ åˆ™æ˜¯ä¸€ä¸ªæ•°ç»„, è¿™ä¸ªæ•°ç»„ä¸­åŒ…å«äº†æ‰€æœ‰è¢«è¿­ä»£çš„å…ƒç´ ã€‚</p><blockquote><p>å½“è¿”å›çš„æ–°æ¸¸æ ‡ä¸º0 è¡¨ç¤ºå½“å‰è¿­ä»£å…¨éƒ¨å®Œæˆ;</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys key*</span><br><span class="line">1) "key11"</span><br><span class="line">2) "key2"</span><br><span class="line">3) "key22"</span><br><span class="line">4) "key222"</span><br><span class="line">5) "key1"</span><br><span class="line">6) "key111"</span><br><span class="line">127.0.0.1:6379&gt; scan 0 match key1* count 10</span><br><span class="line">1) "0"</span><br><span class="line">2) 1) "key111"</span><br><span class="line">   2) "key11"</span><br><span class="line">   3) "key1"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><h5 id="å­—å…¸ç»“æ„"><a href="#å­—å…¸ç»“æ„" class="headerlink" title="å­—å…¸ç»“æ„"></a>å­—å…¸ç»“æ„</h5><p>åœ¨<code>redis</code>ä¸­æ‰€æœ‰çš„<code>key</code>éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªå¾ˆå¤§çš„å­—å…¸ä¸­, å³ä¸€ç»´æ•°ç»„ + äºŒç»´é“¾è¡¨ç»“æ„, ç¤ºä¾‹,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0</span><br><span class="line">1 -&gt;e-&gt;f-&gt;h</span><br><span class="line">2</span><br><span class="line">3 -&gt;g-&gt;x</span><br><span class="line">4</span><br><span class="line">5 -&gt;a-&gt;c</span><br></pre></td></tr></table></figure></p><p><code>scan</code>æŒ‡ä»¤è¿”å›çš„æ¸¸æ ‡å°±æ˜¯ç¬¬ä¸€ç»´æ•°ç»„çš„ä½ç½®ç´¢å¼•ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä½ç½®ç´¢å¼•ç§°ä¸ºæ§½<code>(slot)</code>ã€‚å¦‚æœä¸è€ƒè™‘å­—å…¸çš„æ‰©å®¹ç¼©å®¹ï¼Œç›´æ¥æŒ‰æ•°ç»„ä¸‹æ ‡æŒ¨ä¸ªéå†å°±è¡Œäº†ã€‚<code>count</code>å‚æ•°å°±è¡¨ç¤ºéœ€è¦éå†çš„æ§½ä½æ•°ï¼Œä¹‹æ‰€ä»¥è¿”å›çš„ç»“æœå¯èƒ½å¤šå¯èƒ½å°‘ï¼Œæ˜¯å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„æ§½ä½ä¸Šéƒ½ä¼šæŒ‚æ¥é“¾è¡¨ï¼Œæœ‰äº›æ§½ä½å¯èƒ½æ˜¯ç©ºçš„ï¼Œè¿˜æœ‰äº›æ§½ä½ä¸ŠæŒ‚æ¥çš„é“¾è¡¨ä¸Šçš„å…ƒç´ å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚æ¯ä¸€æ¬¡éå†éƒ½ä¼šå°†<code>count</code>æ•°é‡çš„æ§½ä½ä¸ŠæŒ‚æ¥çš„æ‰€æœ‰é“¾è¡¨å…ƒç´ è¿›è¡Œæ¨¡å¼åŒ¹é…è¿‡æ»¤åï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><blockquote><p><code>scan</code>çš„éå†é¡ºåºéå¸¸ç‰¹åˆ«ã€‚å®ƒä¸æ˜¯ä»ç¬¬ä¸€ç»´æ•°ç»„çš„ç¬¬<code>0</code>ä½ä¸€ç›´éå†åˆ°æœ«å°¾ï¼Œè€Œæ˜¯é‡‡ç”¨äº†é«˜ä½è¿›ä½åŠ æ³•æ¥éå†ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™æ ·ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œéå†ï¼Œæ˜¯è€ƒè™‘åˆ°å­—å…¸çš„æ‰©å®¹å’Œç¼©å®¹æ—¶é¿å…æ§½ä½çš„éå†é‡å¤å’Œé—æ¼ã€‚</p></blockquote><p>rediså­—å…¸æ‰©å®¹é‡‡ç”¨äº†Â·æ¸è¿›å¼rehash`æ“ä½œã€‚</p><p><code>æ¸è¿›å¼rehash</code>ä¼šåŒæ—¶ä¿ç•™æ—§æ•°ç»„å’Œæ–°æ•°ç»„ï¼Œç„¶ååœ¨å®šæ—¶ä»»åŠ¡ä¸­ä»¥åŠåç»­å¯¹<code>hash</code>çš„æŒ‡ä»¤æ“ä½œä¸­æ¸æ¸åœ°å°†æ—§æ•°ç»„ä¸­æŒ‚æ¥çš„å…ƒç´ è¿ç§»åˆ°æ–°æ•°ç»„ä¸Šã€‚è¿™æ„å‘³ç€è¦æ“ä½œå¤„äº<code>rehash</code>ä¸­çš„å­—å…¸ï¼Œéœ€è¦åŒæ—¶è®¿é—®æ–°æ—§ä¸¤ä¸ªæ•°ç»„ç»“æ„ã€‚å¦‚æœåœ¨æ—§æ•°ç»„ä¸‹é¢æ‰¾ä¸åˆ°å…ƒç´ ï¼Œè¿˜éœ€è¦å»æ–°æ•°ç»„ä¸‹é¢å»å¯»æ‰¾ã€‚</p><p><code>scan</code>ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œå¯¹ä¸<code>rehash</code>ä¸­çš„å­—å…¸ï¼Œå®ƒéœ€è¦åŒæ—¶æ‰«ææ–°æ—§æ§½ä½ï¼Œç„¶åå°†ç»“æœèåˆåè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><p><code>scan</code>ç³»åˆ—å‘½ä»¤ç›®å‰å…±è®¡4æ¡,</p><blockquote><p><code>SCAN</code>  å‘½ä»¤ç”¨äºè¿­ä»£å½“å‰æ•°æ®åº“ä¸­çš„æ•°æ®åº“é”®;<br><code>SSCAN</code> å‘½ä»¤ç”¨äºè¿­ä»£é›†åˆé”®ä¸­çš„å…ƒç´ ;<br><code>HSCAN</code> å‘½ä»¤ç”¨äºè¿­ä»£å“ˆå¸Œé”®ä¸­çš„é”®å€¼å¯¹;<br><code>ZSCAN</code> å‘½ä»¤ç”¨äºè¿­ä»£æœ‰åºé›†åˆä¸­çš„å…ƒç´ (åŒ…æ‹¬å…ƒç´ æˆå‘˜å’Œå…ƒç´ åˆ†å€¼);</p></blockquote><h5 id="å®šä½å¤§key"><a href="#å®šä½å¤§key" class="headerlink" title="å®šä½å¤§key"></a>å®šä½å¤§key</h5><p>ä¸ºäº†é¿å…å¯¹çº¿ä¸Š<code>redis</code>å¸¦æ¥å¡é¡¿ï¼Œè¿™å°±è¦ç”¨åˆ°<code>scan</code>æŒ‡ä»¤ï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„æ¯ä¸€ä¸ª<code>key</code>ï¼Œä½¿ç”¨<code>type</code>æŒ‡ä»¤è·å¾—<code>key</code>çš„ç±»å‹ï¼Œç„¶åä½¿ç”¨ç›¸åº”æ•°æ®ç»“æ„çš„<code>size</code>æˆ–è€…<code>len</code>æ–¹æ³•æ¥å¾—åˆ°å®ƒçš„å¤§å°ï¼Œå¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œä¿ç•™å¤§å°çš„å‰<code>N</code>åä½œä¸ºæ‰«æç»“æœå±•ç¤ºå‡ºæ¥ã€‚</p><p>ä¸Šé¢è¿™æ ·çš„è¿‡ç¨‹<code>redis</code>å®˜æ–¹å·²ç»åœ¨<code>redis-cli</code>æŒ‡ä»¤ä¸­æä¾›äº†è¿™æ ·çš„æ‰«æåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿æ¥å³ç”¨ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 6370 â€“-bigkeys</span><br></pre></td></tr></table></figure></p><p>å¦‚æœä½ æ‹…å¿ƒè¿™ä¸ªæŒ‡ä»¤ä¼šå¤§å¹…æŠ¬å‡<code>redis</code>çš„<code>ops</code>å¯¼è‡´çº¿ä¸ŠæŠ¥è­¦ï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ªä¼‘çœ å‚æ•°ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 6370 â€“-bigkeys -i 0.1</span><br></pre></td></tr></table></figure></p><p>ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤æ¯éš”<code>100</code>æ¡<code>scan</code>æŒ‡ä»¤å°±ä¼šä¼‘çœ <code>0.1s,</code>ops`å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿ã€‚</p><p>å¯è¿›ä¸€æ­¥å‚è€ƒ <a href="https://mp.weixin.qq.com/s/ufoLJiXE0wU4Bc7ZbE9cDQ" target="_blank" rel="noopener">ç¾å›¢é’ˆå¯¹Redis Rehashæœºåˆ¶çš„æ¢ç´¢å’Œå®è·µ</a></p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>ä»<code>redis</code>æ¨¡ç³ŠåŒ¹é…åœºæ™¯åˆ†æå…¥æ‰‹ï¼Œå¼•å…¥<code>keys</code>å’Œ<code>scan</code>ç³»åˆ—å¢é‡è¿­ä»£å¼å‘½ä»¤æ–¹æ³•ï¼Œç»“åˆä½¿ç”¨åœºæ™¯å¯¹å…¶ä¼˜åŠ£è¿›è¡Œäº†æ¯”è¾ƒè¯´æ˜;</li><li>é˜è¿°äº†<code>scan</code>éå†æ–¹æ³•ï¼Œå¹¶å¯¹å­—å…¸æ‰©å®¹è¿›è¡Œäº†ç®€å•æ¢è®¨;</li><li>ä»å®šä½å¤§<code>key</code>åœºæ™¯å‡ºå‘ï¼Œå¼•å‡ºäº†<code>redis-cli</code>å·²æ”¯æŒçš„ <code>--bigkeys</code>å‘½ä»¤ï¼Œ å¯ä»¥éå¸¸æ–¹ä¾¿çš„ååŠ©ç”¨æˆ·å®šä½å¤§<code>key</code>é—®é¢˜;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç”¨&lt;code&gt;redis&lt;/code&gt;æ¨¡ç³ŠåŒ¹é…&lt;code&gt;key&lt;/code&gt;æ—¶ï¼Œå®˜æ–¹å»ºè®®ä¸è¦ä½¿ç”¨&lt;code&gt;keys&lt;/code&gt;æˆ–&lt;code&gt;smembers&lt;/code&gt;ï¼Œä»–ä»¬çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯&lt;code&gt;O(N)&lt;/code&gt;,ä½¿ç”¨&lt;code&gt;scan&lt;/code&gt;ï¼Œ&lt;code&gt;zscan&lt;/code&gt;ï¼Œ&lt;code&gt;hscan&lt;/code&gt;ç­‰ã€‚&lt;code&gt;scan&lt;/code&gt;ç³»åˆ—å¢é‡å¼è¿­ä»£å‘½ä»¤æ¯æ¬¡æ‰§è¡Œçš„å¤æ‚åº¦ä¸º&lt;code&gt;O(1)&lt;/code&gt;ï¼Œ å¯¹æ•°æ®é›†è¿›è¡Œä¸€æ¬¡å®Œæ•´è¿­ä»£çš„å¤æ‚åº¦ä¸º&lt;code&gt;O(N)&lt;/code&gt;ï¼Œ å…¶ä¸­&lt;code&gt;N&lt;/code&gt;ä¸ºæ•°æ®é›†ä¸­çš„å…ƒç´ æ•°é‡ã€‚ç›¸æ¯”&lt;code&gt;keys&lt;/code&gt;å‘½ä»¤æ‰§è¡Œæ—¶ä¼šé˜»å¡æ‰æ•´ä¸ª&lt;code&gt;redis&lt;/code&gt;çº¿ç¨‹è€Œè¨€ï¼Œ&lt;code&gt;scan&lt;/code&gt;ç³»åˆ—åˆ™æ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡&lt;code&gt;redis&lt;/code&gt;çº¿ç¨‹, ä¸”åœ¨åŒä¸€æ—¶é—´ï¼Œå¯ä»¥æœ‰ä»»æ„å¤šä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€æ•°æ®é›†è¿›è¡Œè¿­ä»£ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸“é¢˜14 æ€§èƒ½ä¼˜åŒ–ä¹‹ç´¢å¼•ä¼˜åŒ–</title>
    <link href="http://researchlab.github.io/2018/10/07/mysql-14-index-optimization/"/>
    <id>http://researchlab.github.io/2018/10/07/mysql-14-index-optimization/</id>
    <published>2018-10-07T08:53:28.000Z</published>
    <updated>2019-08-24T14:25:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>ç´¢å¼•ä¼˜åŒ–ä¹Ÿæ˜¯æ•°æ®åº“ä¼˜åŒ–çš„ä¸€ä¸ªé‡è¦æ–¹å‘, æœ¬æ–‡å°†ä»å®è·µç»“åˆç†è®ºçš„è§’åº¦å›é¡¾ç´¢å¼•ç›¸å…³çŸ¥è¯†, åŒæ—¶é€šè¿‡å®ä¾‹åˆ†æè¿›ä¸€æ­¥å­¦ä¹ ç´¢å¼•é€‰æ‹©åŠä¼˜åŒ–è¿‡ç¨‹;<br><a id="more"></a></p><h2 id="åˆ›å»ºåˆé€‚ç´¢å¼•åŸåˆ™"><a href="#åˆ›å»ºåˆé€‚ç´¢å¼•åŸåˆ™" class="headerlink" title="åˆ›å»ºåˆé€‚ç´¢å¼•åŸåˆ™"></a>åˆ›å»ºåˆé€‚ç´¢å¼•åŸåˆ™</h2><p>å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ—åˆ›å»ºç´¢å¼•?</p><ol><li><p>åœ¨whereä»å¥, group by ä»å¥, order by ä»å¥, on ä»å¥ä¸­å‡ºç°çš„åˆ—;</p></li><li><p>ç´¢å¼•å­—æ®µè¶Šå°è¶Šå¥½;</p></li><li><p>ç¦»æ•£åº¦å¤§çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å‰é¢;</p></li></ol><p>ä¾‹å¦‚,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> payment <span class="keyword">where</span> staff_id = <span class="number">2</span> <span class="keyword">and</span> customer_id = <span class="number">580</span>;</span><br></pre></td></tr></table></figure><p>æ˜¯index(staff_id, customer_id) å¥½è¿˜æ˜¯index(customer_id, staff_id)å¥½? </p><p>ç”±äºcustomer_idçš„ç¦»æ•£åº¦æ›´å¤§, æ‰€ä»¥åº”è¯¥ä½¿ç”¨index(customer_id, staff_id)</p><h2 id="ç´¢å¼•ä¼˜åŒ–SQL"><a href="#ç´¢å¼•ä¼˜åŒ–SQL" class="headerlink" title="ç´¢å¼•ä¼˜åŒ–SQL"></a>ç´¢å¼•ä¼˜åŒ–SQL</h2><p>é€šå¸¸æƒ…å†µä¸‹, ç´¢å¼•å¯ä»¥æé«˜æŸ¥è¯¢æ•ˆç‡, ä½†æ˜¯ä¼šå½±å“insert/update/deleteè¿™ç§ä¿®æ”¹è¯­å¥, é™ä½å†™å…¥æ•ˆç‡, ç´¢å¼•å¹¶ä¸æ˜¯å»ºç«‹å¾—è¶Šå¤šè¶Šå¥½, ä½†å®é™…æƒ…å†µä¸‹è¿‡å¤šçš„ç´¢å¼•ä¸ä½†ä¼šå½±å“å†™å…¥åŒæ—¶ä¹Ÿä¼šå½±å“æŸ¥è¯¢æ•ˆç‡, å› ä¸ºåœ¨æŸ¥è¯¢æ—¶é¦–é€‰è¦é€‰æ‹©ç”¨å“ªä¸ªç´¢å¼•æ¥è¿›è¡ŒæŸ¥è¯¢, å¦‚æœç´¢å¼•å¤š, åˆ†æçš„å°±å¤š, ä»è€Œåˆ†æè¿‡ç¨‹å°±å¾ˆé•¿;</p><p>æ‰€ä»¥ä¸è§è¦çŸ¥é“å¦‚ä½•é€‰æ‹©åˆé€‚çš„åˆ—åˆ›å»ºç´¢å¼•, ä¹Ÿéœ€è¦çŸ¥é“å¦‚ä½•ç»´æŠ¤å’Œåˆ é™¤é‡å¤å’Œå†—ä½™çš„ç´¢å¼•;</p><h3 id="é‡å¤ç´¢å¼•"><a href="#é‡å¤ç´¢å¼•" class="headerlink" title="é‡å¤ç´¢å¼•"></a>é‡å¤ç´¢å¼•</h3><p>é‡å¤ç´¢å¼•æŒ‡ç›¸åŒçš„åˆ—ä»¥ç›¸åŒçš„é¡ºåºå»ºç«‹çš„åŒç±»å‹çš„ç´¢å¼•, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">title <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">unique</span>(<span class="keyword">id</span>)</span><br><span class="line">) <span class="keyword">engine</span> = <span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šprimary key ä¸IDåˆ—çš„ä¸Šçš„ç´¢å¼•è¿™ç§æƒ…å†µå³ä¸ºé‡å¤ç´¢å¼•;</p><h3 id="å†—ä½™ç´¢å¼•"><a href="#å†—ä½™ç´¢å¼•" class="headerlink" title="å†—ä½™ç´¢å¼•"></a>å†—ä½™ç´¢å¼•</h3><p>å†—ä½™ç´¢å¼•æ˜¯æŒ‡å¤šä¸ªç´¢å¼•çš„å‰ç¼€åˆ—ç›¸åŒ, æˆ–æ˜¯åœ¨è”åˆç´¢å¼•ä¸­åŒ…å«äº†ä¸»é”®çš„ç´¢å¼•, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">title <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="keyword">key</span>(<span class="keyword">name</span>,<span class="keyword">id</span>)</span><br><span class="line">)<span class="keyword">engine</span>=<span class="keyword">InnoDB</span>;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°sqlä¸­key(name,id)å°±æ˜¯ä¸€ä¸ªå†—ä½™ç´¢å¼•; å› ä¸ºè¿™ä¸ªè”åˆç´¢å¼•åŒ…å«äº†ä¸»é”®ç´¢å¼•;</p><h3 id="æŸ¥è¯¢é‡å¤åŠå†—ä½™ç´¢å¼•"><a href="#æŸ¥è¯¢é‡å¤åŠå†—ä½™ç´¢å¼•" class="headerlink" title="æŸ¥è¯¢é‡å¤åŠå†—ä½™ç´¢å¼•"></a>æŸ¥è¯¢é‡å¤åŠå†—ä½™ç´¢å¼•</h3><p>å®ä¾‹åˆ†æ,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use information_schema;</span><br><span class="line"></span><br><span class="line">mysql&gt; select</span><br><span class="line">    -&gt; a.table_schema as 'database',</span><br><span class="line">    -&gt; a.table_name as 'table_name',</span><br><span class="line">    -&gt; a.index_name as 'index_one',</span><br><span class="line">    -&gt; b.index_name as 'index_two',</span><br><span class="line">    -&gt; a.column_name as 'duplicate_col_name'</span><br><span class="line">    -&gt; from statistics a</span><br><span class="line">    -&gt; join statistics b on</span><br><span class="line">    -&gt; a.table_schema = b.table_schema and</span><br><span class="line">    -&gt; a.table_name = b.table_name and</span><br><span class="line">    -&gt; a.seq_in_index = b.seq_in_index and</span><br><span class="line">    -&gt; a.column_name = b.column_name</span><br><span class="line">    -&gt; where a.seq_in_index = 1 and a.index_name &lt;&gt; b.index_name;</span><br><span class="line">+<span class="comment">-----------+--------------+-------------+-------------+--------------------+</span></span><br><span class="line">| database  | table_name   | index_one   | index_two   | duplicate_col_name |</span><br><span class="line">+<span class="comment">-----------+--------------+-------------+-------------+--------------------+</span></span><br><span class="line">| employees | departments  | dept_name   | dept_name_2 | dept_name          |</span><br><span class="line">| employees | departments  | dept_name_2 | dept_name   | dept_name          |</span><br><span class="line">| employees | dept_manager | PRIMARY     | emp_no      | emp_no             |</span><br><span class="line">| employees | dept_manager | emp_no      | PRIMARY     | emp_no             |</span><br><span class="line">+<span class="comment">-----------+--------------+-------------+-------------+--------------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°sqlè¯­å¥ç”¨äºæŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“ä¸­å­˜åœ¨é‡å¤å‰ç¼€ç´¢å¼•, éœ€è¦ç”¨åˆ°information_schema å…ƒæ•°æ®è¡¨ä¸­çš„ä¸€äº›ä¿¡æ¯æ‰€æœ‰éœ€è¦æ³¨æ„use information_schemaæ•°æ®åº“ä¸‹æ‰§è¡Œ;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> departments (</span><br><span class="line">    dept_no     <span class="built_in">CHAR</span>(<span class="number">4</span>)         <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    dept_name   <span class="built_in">VARCHAR</span>(<span class="number">40</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (dept_no),</span><br><span class="line">    <span class="keyword">UNIQUE</span>  <span class="keyword">KEY</span> (dept_name),</span><br><span class="line"><span class="keyword">KEY</span> (dept_name)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept_manager (</span><br><span class="line">   emp_no       <span class="built_in">INT</span>             <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   dept_no      <span class="built_in">CHAR</span>(<span class="number">4</span>)         <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   from_date    <span class="built_in">DATE</span>            <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="keyword">to_date</span>      <span class="built_in">DATE</span>            <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (emp_no)  <span class="keyword">REFERENCES</span> employees (emp_no)    <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">   <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (dept_no) <span class="keyword">REFERENCES</span> departments (dept_no) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">CASCADE</span>,</span><br><span class="line">   PRIMARY <span class="keyword">KEY</span> (emp_no,dept_no),</span><br><span class="line"><span class="keyword">KEY</span> (emp_no)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°åˆ†æåŠè¡¨ç»“æ„å¯ä»¥çœ‹å‡º, </p><ul><li>åœ¨departmentsä¸­UNIQUE KEYå’ŒKEYä¸­å­˜åœ¨é‡å¤ç´¢å¼•;</li><li>åœ¨dept_managerä¸­PRIMARY KEYå’ŒKEYä¸­å­˜åœ¨å†—ä½™ç´¢å¼•;</li></ul><h2 id="pt-duplicate-key-checker"><a href="#pt-duplicate-key-checker" class="headerlink" title="pt-duplicate-key-checker"></a>pt-duplicate-key-checker</h2><p>ä¸Šé¢é€šè¿‡SQLè¯­å¥å¯ä»¥æŸ¥è¯¢åˆ°é‡å¤åŠå†—ä½™ç´¢å¼•, ä¹Ÿå¯ä»¥é€šè¿‡å·¥å…·æ¥æŸ¥è¯¢, å¦‚ä½¿ç”¨pt-duplicate-key-checkerå·¥å…·æ£€æŸ¥é‡å¤åŠå†—ä½™ç´¢å¼•,</p><p>è¿™ä¸ªå·¥å…·ä½¿ç”¨éå¸¸ç®€å•, åªéœ€è¦æä¾›ä¸‹é¢å‡ ä¸ªå‚æ•°å³å¯,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pt-duplicate-key-checker \</span><br><span class="line">-uroot \</span><br><span class="line">-p 'pwd' \</span><br><span class="line">-h 127.0.0.1</span><br></pre></td></tr></table></figure><p>åŒæ—¶è¿™ä¸ªå·¥å…·è¿˜ä¼šæä¾›ä¸€ä¸ªä¿®è®¢çš„SQLæ–¹æ¡ˆä¾›å‚è€ƒ;</p><h2 id="ç´¢å¼•ç»´æŠ¤"><a href="#ç´¢å¼•ç»´æŠ¤" class="headerlink" title="ç´¢å¼•ç»´æŠ¤"></a>ç´¢å¼•ç»´æŠ¤</h2><h3 id="åˆ é™¤ä¸ç”¨ç´¢å¼•"><a href="#åˆ é™¤ä¸ç”¨ç´¢å¼•" class="headerlink" title="åˆ é™¤ä¸ç”¨ç´¢å¼•"></a>åˆ é™¤ä¸ç”¨ç´¢å¼•</h3><p>å› ä¸šåŠ¡å˜æ›´ç­‰å› ç´ , æœ‰äº›ç´¢å¼•ä¼šä¸åœ¨è¢«ä½¿ç”¨, æ­¤æ—¶æœ€å¥½å°†å…¶åˆ é™¤; ç›®å‰MySQLä¸­è¿˜æ²¡æœ‰è®°å½•ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ, ä½†æ˜¯åœ¨PerconMySQLå’ŒMariaDBä¸­å¯ä»¥é€šè¿‡INDEX_STATISTICSè¡¨æ¥æŸ¥çœ‹å“ªäº›ç´¢å¼•æœªä½¿ç”¨, ä½†æ˜¯åœ¨MySQLä¸­ç›®å‰åªèƒ½é€šè¿‡æ…¢æŸ¥æ—¥å¿—é…åˆpt-index-usageå·¥å…·æ¥è¿›è¡Œç´¢å¼•ä½¿ç”¨æƒ…å†µçš„åˆ†æ, pt-index-usage å·¥å…·ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pt-index-usage \ </span><br><span class="line">-uroot -p 'pwd' \</span><br><span class="line">mysql-slow.log</span><br></pre></td></tr></table></figure><p>æ³¨æ„å¦‚æœæ˜¯ä¸»ä»é›†ç¾¤, åˆ™å·¥å…·åˆ†ææ—¶åº”å¯¹æ‰€æœ‰æ…¢æŸ¥æ—¥å¿—è¿›è¡Œåˆ†æ;</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>ä¼˜å…ˆå°†where/group by/order by/onä»å¥ä¸­å‡ºç°çš„åˆ— åˆ›å»ºç´¢å¼•; å¹¶ä¸”ç´¢å¼•å­—æ®µè¶Šå°è¶Šå¥½; å¦‚åˆ›å»ºè”åˆç´¢å¼•æ—¶, å»ºè®®å°†ç¦»æ•£åº¦å¤§çš„åˆ—æ”¾åœ¨è”åˆç´¢å¼•çš„å‰é¢;</li><li>ä¸ä½†è¦é€‰æ‹©åˆé€‚çš„åˆ—åˆ›å»ºç´¢å¼•, åŒæ—¶ä¹Ÿåº”å°†é‡å¤åŠå†—ä½™ç´¢å¼•åˆ é™¤;</li><li>pt-duplicate-key-checkeråŠpt-index-usageå·¥å…·çš„è”åˆä½¿ç”¨, å¯ä»¥å¸®åŠ©æŸ¥è¯¢åˆ°é‡å¤åŠå†—ä½™å’Œæœªä½¿ç”¨çš„ç´¢å¼•;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç´¢å¼•ä¼˜åŒ–ä¹Ÿæ˜¯æ•°æ®åº“ä¼˜åŒ–çš„ä¸€ä¸ªé‡è¦æ–¹å‘, æœ¬æ–‡å°†ä»å®è·µç»“åˆç†è®ºçš„è§’åº¦å›é¡¾ç´¢å¼•ç›¸å…³çŸ¥è¯†, åŒæ—¶é€šè¿‡å®ä¾‹åˆ†æè¿›ä¸€æ­¥å­¦ä¹ ç´¢å¼•é€‰æ‹©åŠä¼˜åŒ–è¿‡ç¨‹;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysqlä¸“é¢˜" scheme="http://researchlab.github.io/categories/mysql%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="mysql" scheme="http://researchlab.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜09 geoåœ°ç†ä½ç½®æ¨¡å—</title>
    <link href="http://researchlab.github.io/2018/10/06/redis-09-geohash/"/>
    <id>http://researchlab.github.io/2018/10/06/redis-09-geohash/</id>
    <published>2018-10-06T17:09:06.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p><code>redis3.2</code>ç‰ˆæœ¬é‡Œé¢æ–°å¢çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å¯¹<code>GEO(åœ°ç†ä½ç½®)</code>çš„æ”¯æŒã€‚æ„å‘³ç€å¯ä»¥ç”¨<code>redis</code>æ¥å®ç°æŸ¥æ‰¾<code>é™„ä»¶çš„äºº</code>çš„ç­‰æœç´¢åŠŸèƒ½äº†ï¼›<br><a id="more"></a><br>åœ°å›¾å…ƒç´ çš„ä½ç½®æ•°æ®ä½¿ç”¨äºŒç»´çš„ç»çº¬åº¦è¡¨ç¤ºï¼Œç»åº¦èŒƒå›´ (-180, 180]ï¼Œçº¬åº¦èŒƒå›´ (-90, 90]ï¼Œçº¬åº¦æ­£è´Ÿä»¥èµ¤é“ä¸ºç•Œï¼ŒåŒ—æ­£å—è´Ÿï¼Œç»åº¦æ­£è´Ÿä»¥æœ¬åˆå­åˆçº¿ (è‹±å›½æ ¼æ—å°¼æ²»å¤©æ–‡å°) ä¸ºç•Œï¼Œä¸œæ­£è¥¿è´Ÿã€‚</p><p>å½“ä¸¤ä¸ªå…ƒç´ çš„è·ç¦»ä¸æ˜¯å¾ˆè¿œæ—¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å‹¾è‚¡å®šç†å°±èƒ½ç®—å¾—å…ƒç´ ä¹‹é—´çš„è·ç¦»ã€‚æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„ã€Œé™„è¿‘çš„äººã€çš„åŠŸèƒ½ï¼Œå…ƒç´ è·ç¦»éƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œå‹¾è‚¡å®šç†ç®—è·ç¦»è¶³çŸ£ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»çº¬åº¦åæ ‡çš„å¯†åº¦ä¸ä¸€æ · (åœ°çƒæ˜¯ä¸€ä¸ªæ¤­åœ†)ï¼Œå‹¾è‚¡å®šå¾‹è®¡ç®—å¹³æ–¹å·®æ—¶ä¹‹åå†æ±‚å’Œæ—¶ï¼Œéœ€è¦æŒ‰ä¸€å®šçš„ç³»æ•°æ¯”åŠ æƒæ±‚å’Œï¼Œå¦‚æœä¸æ±‚ç²¾ç¡®çš„è¯ï¼Œä¹Ÿå¯ä»¥ä¸å¿…åŠ æƒã€‚</p><p>é—®é¢˜ï¼šç»åº¦æ€»å…±360åº¦ï¼Œç»´åº¦æ€»å…±åªæœ‰180åº¦ï¼Œä¸ºä»€ä¹ˆè·ç¦»å¯†åº¦ä¸æ˜¯2:1ï¼Ÿ</p><p>ç°åœ¨ï¼Œå¦‚æœè¦è®¡ç®—ã€Œé™„è¿‘çš„äººã€ï¼Œä¹Ÿå°±æ˜¯ç»™å®šä¸€ä¸ªå…ƒç´ çš„åæ ‡ï¼Œç„¶åè®¡ç®—è¿™ä¸ªåæ ‡é™„è¿‘çš„å…¶å®ƒå…ƒç´ ï¼ŒæŒ‰ç…§è·ç¦»è¿›è¡Œæ’åºï¼Œè¯¥å¦‚ä½•ä¸‹æ‰‹ï¼Ÿ<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‡è®¾å¾…è®¡ç®—åæ ‡ä¸º(x,y),ä»¥è¿™ä¸ªåæ ‡ä¸ºåœ†ç‚¹, rä¸ºåŠå¾„ï¼Œè¿›è¡Œæœç´¢å…¶é™„è¿‘çš„å…ƒç´ </span><br></pre></td></tr></table></figure></p><p>å¦‚æœç°åœ¨å…ƒç´ çš„ç»çº¬åº¦åæ ‡ä½¿ç”¨å…³ç³»æ•°æ®åº“ (å…ƒç´ <code>id</code>, ç»åº¦<code>x</code>, çº¬åº¦<code>y</code>) å­˜å‚¨ï¼Œä½ è¯¥å¦‚ä½•è®¡ç®—ï¼Ÿ</p><p>é¦–å…ˆï¼Œä½ ä¸å¯èƒ½é€šè¿‡éå†æ¥è®¡ç®—æ‰€æœ‰çš„å…ƒç´ å’Œç›®æ ‡å…ƒç´ çš„è·ç¦»ç„¶åå†è¿›è¡Œæ’åºï¼Œè¿™ä¸ªè®¡ç®—é‡å¤ªå¤§äº†ï¼Œæ€§èƒ½æŒ‡æ ‡è‚¯å®šæ— æ³•æ»¡è¶³ã€‚ä¸€èˆ¬çš„æ–¹æ³•éƒ½æ˜¯é€šè¿‡çŸ©å½¢åŒºåŸŸæ¥é™å®šå…ƒç´ çš„æ•°é‡ï¼Œç„¶åå¯¹åŒºåŸŸå†…çš„å…ƒç´ è¿›è¡Œå…¨é‡è·ç¦»è®¡ç®—å†æ’åºã€‚è¿™æ ·å¯ä»¥æ˜æ˜¾å‡å°‘è®¡ç®—é‡ã€‚å¦‚ä½•åˆ’åˆ†çŸ©å½¢åŒºåŸŸå‘¢ï¼Ÿ å¯ä»¥æŒ‡å®šä¸€ä¸ªåŠå¾„<code>r</code>ï¼Œä½¿ç”¨ä¸€æ¡<code>SQL</code>å°±å¯ä»¥åœˆå‡ºæ¥ã€‚å½“ç”¨æˆ·å¯¹ç­›å‡ºæ¥çš„ç»“æœä¸æ»¡æ„ï¼Œé‚£å°±æ‰©å¤§åŠå¾„ç»§ç»­ç­›é€‰ã€‚<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from positions where x0-r &lt; x &lt; x0+r and y0-r &lt; y &lt; y0+r</span><br></pre></td></tr></table></figure></p><p>ä¸ºäº†æ»¡è¶³é«˜æ€§èƒ½çš„çŸ©å½¢åŒºåŸŸç®—æ³•ï¼Œæ•°æ®è¡¨éœ€è¦åœ¨ç»çº¬åº¦åæ ‡åŠ ä¸ŠåŒå‘å¤åˆç´¢å¼•(x, y)ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚</p><p>ä½†æ˜¯æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ¯•ç«Ÿæœ‰é™ï¼Œå¦‚æœã€Œé™„è¿‘çš„äººã€æŸ¥è¯¢è¯·æ±‚éå¸¸å¤šï¼Œåœ¨é«˜å¹¶å‘åœºåˆï¼Œè¿™å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ¡ˆã€‚</p><h5 id="GeoHashç®—æ³•"><a href="#GeoHashç®—æ³•" class="headerlink" title="GeoHashç®—æ³•"></a>GeoHashç®—æ³•</h5><p>ä¸šç•Œæ¯”è¾ƒé€šç”¨çš„åœ°ç†ä½ç½®è·ç¦»æ’åºç®—æ³•æ˜¯<code>GeoHash</code>ç®—æ³•ï¼Œ<code>redis</code>ä¹Ÿä½¿ç”¨<code>GeoHash</code>ç®—æ³•ã€‚<code>GeoHash</code>ç®—æ³•å°†äºŒç»´çš„ç»çº¬åº¦æ•°æ®æ˜ å°„åˆ°ä¸€ç»´çš„æ•´æ•°ï¼Œè¿™æ ·æ‰€æœ‰çš„å…ƒç´ éƒ½å°†åœ¨æŒ‚è½½åˆ°ä¸€æ¡çº¿ä¸Šï¼Œè·ç¦»é è¿‘çš„äºŒç»´åæ ‡æ˜ å°„åˆ°ä¸€ç»´åçš„ç‚¹ä¹‹é—´è·ç¦»ä¹Ÿä¼šå¾ˆæ¥è¿‘ã€‚å½“æˆ‘ä»¬æƒ³è¦è®¡ç®—ã€Œé™„è¿‘çš„äººæ—¶ã€ï¼Œé¦–å…ˆå°†ç›®æ ‡ä½ç½®æ˜ å°„åˆ°è¿™æ¡çº¿ä¸Šï¼Œç„¶ååœ¨è¿™ä¸ªä¸€ç»´çš„çº¿ä¸Šè·å–é™„è¿‘çš„ç‚¹å°±è¡Œäº†ã€‚</p><p>é‚£è¿™ä¸ªæ˜ å°„ç®—æ³•å…·ä½“æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ å®ƒå°†æ•´ä¸ªåœ°çƒçœ‹æˆä¸€ä¸ªäºŒç»´å¹³é¢ï¼Œç„¶ååˆ’åˆ†æˆäº†ä¸€ç³»åˆ—æ­£æ–¹å½¢çš„æ–¹æ ¼ï¼Œå°±å¥½æ¯”å›´æ£‹æ£‹ç›˜ã€‚æ‰€æœ‰çš„åœ°å›¾å…ƒç´ åæ ‡éƒ½å°†æ”¾ç½®äºå”¯ä¸€çš„æ–¹æ ¼ä¸­ã€‚æ–¹æ ¼è¶Šå°ï¼Œåæ ‡è¶Šç²¾ç¡®ã€‚ç„¶åå¯¹è¿™äº›æ–¹æ ¼è¿›è¡Œæ•´æ•°ç¼–ç ï¼Œè¶Šæ˜¯é è¿‘çš„æ–¹æ ¼ç¼–ç è¶Šæ˜¯æ¥è¿‘ã€‚é‚£å¦‚ä½•ç¼–ç å‘¢ï¼Ÿä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ‡è›‹ç³•æ³•ã€‚è®¾æƒ³ä¸€ä¸ªæ­£æ–¹å½¢çš„è›‹ç³•æ‘†åœ¨ä½ é¢å‰ï¼ŒäºŒåˆ€ä¸‹å»å‡åˆ†åˆ†æˆå››å—å°æ­£æ–¹å½¢ï¼Œè¿™å››ä¸ªå°æ­£æ–¹å½¢å¯ä»¥åˆ†åˆ«æ ‡è®°ä¸º 00,01,10,11 å››ä¸ªäºŒè¿›åˆ¶æ•´æ•°ã€‚ç„¶åå¯¹æ¯ä¸€ä¸ªå°æ­£æ–¹å½¢ç»§ç»­ç”¨äºŒåˆ€æ³•åˆ‡å‰²ä¸€ä¸‹ï¼Œè¿™æ—¶æ¯ä¸ªå°å°æ­£æ–¹å½¢å°±å¯ä»¥ä½¿ç”¨ 4bit çš„äºŒè¿›åˆ¶æ•´æ•°äºˆä»¥è¡¨ç¤ºã€‚ç„¶åç»§ç»­åˆ‡ä¸‹å»ï¼Œæ­£æ–¹å½¢å°±ä¼šè¶Šæ¥è¶Šå°ï¼ŒäºŒè¿›åˆ¶æ•´æ•°ä¹Ÿä¼šè¶Šæ¥è¶Šé•¿ï¼Œç²¾ç¡®åº¦å°±ä¼šè¶Šæ¥è¶Šé«˜ã€‚</p><h5 id="redis-Geoæ¨¡å—åº”ç”¨"><a href="#redis-Geoæ¨¡å—åº”ç”¨" class="headerlink" title="redis Geoæ¨¡å—åº”ç”¨"></a>redis Geoæ¨¡å—åº”ç”¨</h5><p><code>Geo</code>åœ°ç†æ¨¡å—åˆ°ç›®å‰ä¸ºæ­¢æä¾›äº†6æ¡å‘½ä»¤:</p><table><thead><tr><th>åºå·</th><th>å‘½ä»¤</th><th>å¤‡æ³¨</th></tr></thead><tbody><tr><td>1</td><td><code>geoadd</code></td><td>å°†æŒ‡å®šçš„åœ°ç†ç©ºé—´ä½ç½®(çº¬åº¦, ç»åº¦, åç§°)æ·»åŠ åˆ°æŒ‡å®šçš„keyä¸­</td></tr><tr><td>2</td><td><code>geodist</code></td><td>è¿”å›ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»</td></tr><tr><td>3</td><td><code>geohash</code></td><td>è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„<code>Geohash</code>è¡¨ç¤º</td></tr><tr><td>4</td><td><code>geopos</code></td><td>ä»keyé‡Œè¿”å›æ‰€æœ‰ç»™å®šä½ç½®å…ƒç´ çš„ä½ç½®(ç»åº¦å’Œçº¬åº¦)</td></tr><tr><td>5</td><td><code>georadius</code></td><td>ä»¥ç»™å®šçš„ç»çº¬åº¦ä¸ºä¸­å¿ƒï¼Œ è¿”å›é”®åŒ…å«çš„ä½ç½®å…ƒç´ å½“ä¸­ï¼Œ ä¸ä¸­å¿ƒçš„è·ç¦»ä¸è¶…è¿‡ç»™å®šæœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ </td></tr><tr><td>6</td><td><code>georadiusbymember</code></td><td>æŸ¥æ‰¾ç»™å®šå…ƒç´ ç»™å®šèŒƒå›´å†…çš„å…ƒç´ å€¼</td></tr></tbody></table><p><strong><code>geoadd</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEOADD key longitude latitude member [longitude latitude member ...]</code><br>å‘½ä»¤æè¿°: å°†æŒ‡å®šçš„åœ°ç†ç©ºé—´ä½ç½®(çº¬åº¦, ç»åº¦, åç§°)æ·»åŠ åˆ°æŒ‡å®šçš„keyä¸­;<br>è¿”å›å€¼: æ·»åŠ åˆ°sorted setå…ƒç´ çš„æ•°ç›®, ä½†ä¸åŒ…æ‹¬å·²æ›´æ–°scoreçš„å…ƒç´ ;<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd location 116.111 39.111 position.one</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd location 116.333 39.333 position.two 116.555 39.556 position.three</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure></p></blockquote><p><strong><code>geodist</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEODIST key member1 member2 [unit]</code><br>å‘½ä»¤æè¿°: è¿”å›ä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´çš„è·ç¦»ã€‚å¦‚æœä¸¤ä¸ªä½ç½®ä¹‹é—´çš„å…¶ä¸­ä¸€ä¸ªä¸å­˜åœ¨,  é‚£ä¹ˆå‘½ä»¤è¿”å›ç©ºå€¼ã€‚æŒ‡å®šå•ä½çš„å‚æ•° unit å¿…é¡»æ˜¯ä»¥ä¸‹å•ä½çš„å…¶ä¸­ä¸€ä¸ª:</p><blockquote><p><code>m</code> è¡¨ç¤ºå•ä½ä¸ºç±³;<br><code>km</code> è¡¨ç¤ºå•ä½ä¸ºåƒç±³;<br><code>mi</code> è¡¨ç¤ºå•ä½ä¸ºè‹±é‡Œ;<br><code>ft</code> è¡¨ç¤ºå•ä½ä¸ºè‹±å°º;</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist location position.one position.three m</span><br><span class="line">"62520.6181"</span><br><span class="line">127.0.0.1:6379&gt; geodist location position.one position.three km</span><br><span class="line">"62.5206"</span><br><span class="line">127.0.0.1:6379&gt; geodist location position.one position.five m</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><p><strong><code>geohash</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEOHASH key member [member ...]</code><br>å‘½ä»¤æè¿°: è¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªä½ç½®å…ƒç´ çš„<code>Geohash</code>è¡¨ç¤ºã€‚é€šå¸¸ä½¿ç”¨è¡¨ç¤ºä½ç½®çš„å…ƒç´ ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯, ä½¿ç”¨<code>Geohash</code>ä½ç½®52ç‚¹æ•´æ•°ç¼–ç ã€‚ç”±äºç¼–ç å’Œè§£ç è¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨çš„åˆå§‹æœ€å°å’Œæœ€å¤§åæ ‡ä¸åŒ, ç¼–ç çš„ç¼–ç ä¹Ÿä¸åŒäºæ ‡å‡†ã€‚æ­¤å‘½ä»¤è¿”å›ä¸€ä¸ªæ ‡å‡†çš„<code>Geohash</code>å€¼<br>è¿”å›å€¼: ä¸€ä¸ªæ•°ç»„, æ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ª<code>Geohash</code> ã€‚ å‘½ä»¤è¿”å›çš„<code>Geohash</code>çš„ä½ç½®ä¸ç”¨æˆ·ç»™å®šçš„ä½ç½®å…ƒç´ çš„ä½ç½®ä¸€ä¸€å¯¹åº”ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash location position.one position.two position.three position.five</span><br><span class="line">1) "wwfw6pvqn60"</span><br><span class="line">2) "wwfxz0r5760"</span><br><span class="line">3) "wx4ch2by2k0"</span><br><span class="line">4) (nil)</span><br></pre></td></tr></table></figure><p><strong><code>geopos</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEOPOS key member [member ...]</code><br>å‘½ä»¤æè¿°: ä»<code>key</code>é‡Œè¿”å›æ‰€æœ‰ç»™å®šä½ç½®å…ƒç´ çš„ä½ç½®(ç»åº¦å’Œçº¬åº¦);<br>è¿”å›å€¼: <code>GEOPOS</code>å‘½ä»¤è¿”å›ä¸€ä¸ªæ•°ç»„, æ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆ: ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºç»™å®šä½ç½®å…ƒç´ çš„ç»åº¦, è€Œç¬¬äºŒä¸ªå…ƒç´ åˆ™ä¸ºç»™å®šä½ç½®å…ƒç´ çš„çº¬åº¦ã€‚å½“ç»™å®šçš„ä½ç½®å…ƒç´ ä¸å­˜åœ¨æ—¶, å¯¹åº”çš„æ•°ç»„é¡¹ä¸ºç©ºå€¼ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos location position.one position.five position.three</span><br><span class="line">1) 1) "116.11100167036056519"</span><br><span class="line">   2) "39.11099969335537452"</span><br><span class="line">2) (nil)</span><br><span class="line">3) 1) "116.55499845743179321"</span><br><span class="line">   2) "39.55600040953122942"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><p><strong><code>georadius</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEORADIUS key longitude latitude radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count]</code><br>å‘½ä»¤æè¿°: ä»¥ç»™å®šçš„ç»çº¬åº¦ä¸ºä¸­å¿ƒ, è¿”å›é”®åŒ…å«çš„ä½ç½®å…ƒç´ å½“ä¸­, ä¸ä¸­å¿ƒçš„è·ç¦»ä¸è¶…è¿‡ç»™å®šæœ€å¤§è·ç¦»çš„æ‰€æœ‰ä½ç½®å…ƒç´ , èŒƒå›´å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å…¶ä¸­ä¸€ä¸ªå•ä½:</p><blockquote><p><code>m</code> è¡¨ç¤ºå•ä½ä¸ºç±³;<br><code>km</code> è¡¨ç¤ºå•ä½ä¸ºåƒç±³;<br><code>mi</code> è¡¨ç¤ºå•ä½ä¸ºè‹±é‡Œ;<br><code>ft</code> è¡¨ç¤ºå•ä½ä¸ºè‹±å°º;</p></blockquote></blockquote><blockquote><p>åœ¨ç»™å®šä»¥ä¸‹å¯é€‰é¡¹æ—¶, å‘½ä»¤ä¼šè¿”å›é¢å¤–çš„ä¿¡æ¯:</p><blockquote><p><code>WITHDIST</code>: åœ¨è¿”å›ä½ç½®å…ƒç´ çš„åŒæ—¶, å°†ä½ç½®å…ƒç´ ä¸ä¸­å¿ƒä¹‹é—´çš„è·ç¦»ä¹Ÿä¸€å¹¶è¿”å›ã€‚ è·ç¦»çš„å•ä½å’Œç”¨æˆ·ç»™å®šçš„èŒƒå›´å•ä½ä¿æŒä¸€è‡´ã€‚<br><code>WITHCOORD</code>: å°†ä½ç½®å…ƒç´ çš„ç»åº¦å’Œç»´åº¦ä¹Ÿä¸€å¹¶è¿”å›ã€‚<br><code>WITHHASH</code>: ä»¥52ä½æœ‰ç¬¦å·æ•´æ•°çš„å½¢å¼, è¿”å›ä½ç½®å…ƒç´ ç»è¿‡åŸå§‹<code>Geohash</code>ç¼–ç çš„æœ‰åºé›†åˆåˆ†å€¼ã€‚è¿™ä¸ªé€‰é¡¹ä¸»è¦ç”¨äºåº•å±‚åº”ç”¨æˆ–è€…è°ƒè¯•, å®é™…ä¸­çš„ä½œç”¨å¹¶ä¸å¤§ã€‚</p></blockquote></blockquote><blockquote><p>å‘½ä»¤é»˜è®¤è¿”å›æœªæ’åºçš„ä½ç½®å…ƒç´ ã€‚é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°, ç”¨æˆ·å¯ä»¥æŒ‡å®šè¢«è¿”å›ä½ç½®å…ƒç´ çš„æ’åºæ–¹å¼:</p><blockquote><p><code>ASC</code>: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®, æŒ‰ç…§ä»è¿‘åˆ°è¿œçš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ;<br><code>DESC</code>: æ ¹æ®ä¸­å¿ƒçš„ä½ç½®, æŒ‰ç…§ä»è¿œåˆ°è¿‘çš„æ–¹å¼è¿”å›ä½ç½®å…ƒç´ ;</p></blockquote></blockquote><blockquote><p>åœ¨é»˜è®¤æƒ…å†µä¸‹, <code>GEORADIUS</code>å‘½ä»¤ä¼šè¿”å›æ‰€æœ‰åŒ¹é…çš„ä½ç½®å…ƒç´ ;<br>è™½ç„¶ç”¨æˆ·å¯ä»¥ä½¿ç”¨<code>COUNT &lt;count&gt;</code>é€‰é¡¹å»è·å–å‰<code>N</code> ä¸ªåŒ¹é…å…ƒç´ ,  ä½†æ˜¯å› ä¸ºå‘½ä»¤åœ¨å†…éƒ¨å¯èƒ½ä¼šéœ€è¦å¯¹æ‰€æœ‰è¢«åŒ¹é…çš„å…ƒç´ è¿›è¡Œå¤„ç†<code>æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ªéå¸¸å¤§çš„åŒºåŸŸè¿›è¡Œæœç´¢æ—¶, å³ä½¿åªä½¿ç”¨</code>COUNT<code>é€‰é¡¹å»è·å–å°‘é‡å…ƒç´ ,  å‘½ä»¤çš„æ‰§è¡Œé€Ÿåº¦ä¹Ÿå¯èƒ½ä¼šéå¸¸æ…¢ã€‚ ä½†æ˜¯ä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œ ä½¿ç”¨</code>COUNT<code>é€‰é¡¹å»å‡å°‘éœ€è¦è¿”å›çš„å…ƒç´ æ•°é‡</code> å¯¹äºå‡å°‘å¸¦å®½æ¥è¯´ä»ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p></blockquote><blockquote><p>è¿”å›å€¼:<br>åœ¨æ²¡æœ‰ç»™å®šä»»ä½•<code>WITH</code>é€‰é¡¹çš„æƒ…å†µä¸‹, å‘½ä»¤åªä¼šè¿”å›ä¸€ä¸ªåƒ<code>[&quot;New York&quot;, &quot;Milan&quot;,&quot;Paris&quot;] è¿™æ ·çš„çº¿æ€§(linear)åˆ—è¡¨ã€‚åœ¨æŒ‡å®šäº†</code>WITHCOORD<code>,</code>WITHDIST<code>,</code>WITHHASH`ç­‰é€‰é¡¹çš„æƒ…å†µä¸‹, å‘½ä»¤è¿”å›ä¸€ä¸ªäºŒå±‚åµŒå¥—æ•°ç»„, å†…å±‚çš„æ¯ä¸ªå­æ•°ç»„å°±è¡¨ç¤ºä¸€ä¸ªå…ƒç´ ã€‚<br>åœ¨è¿”å›åµŒå¥—æ•°ç»„æ—¶, å­æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ€»æ˜¯ä½ç½®å…ƒç´ çš„åå­—ã€‚ è‡³äºé¢å¤–çš„ä¿¡æ¯, åˆ™ä¼šä½œä¸ºå­æ•°ç»„çš„åç»­å…ƒç´ , æŒ‰ç…§ä»¥ä¸‹é¡ºåºè¢«è¿”å›:</p><blockquote><p>1.ä»¥æµ®ç‚¹æ•°æ ¼å¼è¿”å›çš„ä¸­å¿ƒä¸ä½ç½®å…ƒç´ ä¹‹é—´çš„è·ç¦», å•ä½ä¸ç”¨æˆ·æŒ‡å®šèŒƒå›´æ—¶çš„å•ä½ä¸€è‡´ã€‚<br>2.<code>Geohash</code>æ•´æ•°ã€‚<br>3.ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆçš„åæ ‡, åˆ†åˆ«ä¸ºç»åº¦å’Œçº¬åº¦ã€‚</p></blockquote></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius location 116.111 39.111 50 km withcoord withdist withhash</span><br><span class="line">1) 1) "position.one"</span><br><span class="line">   2) "0.0001"</span><br><span class="line">   3) (integer) 4069074382584591</span><br><span class="line">   4) 1) "116.11100167036056519"</span><br><span class="line">      2) "39.11099969335537452"</span><br><span class="line">2) 1) "position.two"</span><br><span class="line">   2) "31.2350"</span><br><span class="line">   3) (integer) 4069124900607885</span><br><span class="line">   4) 1) "116.33299738168716431"</span><br><span class="line">      2) "39.33300071137491472"</span><br><span class="line">127.0.0.1:6379&gt; georadius location 116.111 39.111 50 km withcoord withdist withhash  count 1</span><br><span class="line">1) 1) "position.one"</span><br><span class="line">   2) "0.0001"</span><br><span class="line">   3) (integer) 4069074382584591</span><br><span class="line">   4) 1) "116.11100167036056519"</span><br><span class="line">      2) "39.11099969335537452"</span><br><span class="line">127.0.0.1:6379&gt; georadius location 116.111 39.111 50 km withcoord withdist withhash  count 2 asc</span><br><span class="line">1) 1) "position.one"</span><br><span class="line">   2) "0.0001"</span><br><span class="line">   3) (integer) 4069074382584591</span><br><span class="line">   4) 1) "116.11100167036056519"</span><br><span class="line">      2) "39.11099969335537452"</span><br><span class="line">2) 1) "position.two"</span><br><span class="line">   2) "31.2350"</span><br><span class="line">   3) (integer) 4069124900607885</span><br><span class="line">   4) 1) "116.33299738168716431"</span><br><span class="line">      2) "39.33300071137491472"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><p><strong><code>georadiusbymember</code></strong></p><blockquote><p>å‘½ä»¤: <code>GEORADIUSBYMEMBER key member radius m|km|ft|mi [WITHCOORD] [WITHDIST] [WITHHASH] [COUNT count]</code><br>å‘½ä»¤æè¿°: è¿™ä¸ªå‘½ä»¤å’Œ<code>GEORADIUS</code>å‘½ä»¤ä¸€æ ·, éƒ½å¯ä»¥æ‰¾å‡ºä½äºæŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ , ä½†æ˜¯<code>GEORADIUSBYMEMBER</code>çš„ä¸­å¿ƒç‚¹æ˜¯ç”±ç»™å®šçš„ä½ç½®å…ƒç´ å†³å®šçš„ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è¡¨ç¤ºå¯¹key `location` ä»¥`position.one`ä¸ºåŸç‚¹, 100kmä¸ºåŠå¾„, å¸…é€‰å‡ºæœ€å¤š5ä¸ªposition å¹¶ä¸”å¯¹ç»“æœè¿›è¡Œæ­£å‘(ç”±è¿‘åˆ°è¿œ)æ’åº</span></span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember location position.one 100 km count 5 asc</span><br><span class="line">1) "position.one"</span><br><span class="line">2) "position.two"</span><br><span class="line">3) "position.three"</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember location position.one 100 km count 5 asc withcoord withdist withhash</span><br><span class="line">1) 1) "position.one"</span><br><span class="line">   2) "0.0000"</span><br><span class="line">   3) (integer) 4069074382584591</span><br><span class="line">   4) 1) "116.11100167036056519"</span><br><span class="line">      2) "39.11099969335537452"</span><br><span class="line">2) 1) "position.two"</span><br><span class="line">   2) "31.2349"</span><br><span class="line">   3) (integer) 4069124900607885</span><br><span class="line">   4) 1) "116.33299738168716431"</span><br><span class="line">      2) "39.33300071137491472"</span><br><span class="line">3) 1) "position.three"</span><br><span class="line">   2) "62.5206"</span><br><span class="line">   3) (integer) 4069148683788633</span><br><span class="line">   4) 1) "116.55499845743179321"</span><br><span class="line">      2) "39.55600040953122942"</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure><h5 id="é—®é¢˜åŠå»ºè®®"><a href="#é—®é¢˜åŠå»ºè®®" class="headerlink" title="é—®é¢˜åŠå»ºè®®"></a>é—®é¢˜åŠå»ºè®®</h5><p>åœ¨ä¸€ä¸ªåœ°å›¾åº”ç”¨ä¸­ï¼Œè½¦çš„æ•°æ®ã€é¤é¦†çš„æ•°æ®ã€äººçš„æ•°æ®å¯èƒ½ä¼šæœ‰ç™¾ä¸‡åƒä¸‡æ¡ï¼Œå¦‚æœä½¿ç”¨<code>redis</code>çš„<code>Geo</code>æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å°†å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ª<code>zset</code> é›†åˆä¸­ã€‚åœ¨<code>redis</code>çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œé›†åˆå¯èƒ½ä¼šä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœå•ä¸ª<code>key</code>çš„æ•°æ®è¿‡å¤§ï¼Œä¼šå¯¹é›†ç¾¤çš„è¿ç§»å·¥ä½œé€ æˆè¾ƒå¤§çš„å½±å“ï¼Œåœ¨é›†ç¾¤ç¯å¢ƒä¸­å•ä¸ª<code>key</code>å¯¹åº”çš„æ•°æ®é‡ä¸å®œè¶…è¿‡<code>1M</code>ï¼Œå¦åˆ™ä¼šå¯¼è‡´é›†ç¾¤è¿ç§»å‡ºç°å¡é¡¿ç°è±¡ï¼Œå½±å“çº¿ä¸ŠæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚</p><p>æ‰€ä»¥ï¼Œè¿™é‡Œå»ºè®®<code>Geo</code>çš„æ•°æ®ä½¿ç”¨å•ç‹¬çš„<code>redis</code>å®ä¾‹éƒ¨ç½²ï¼Œä¸ä½¿ç”¨é›†ç¾¤ç¯å¢ƒã€‚</p><p>å¦‚æœæ•°æ®é‡è¿‡äº¿ç”šè‡³æ›´å¤§ï¼Œå°±éœ€è¦å¯¹<code>Geo</code>æ•°æ®è¿›è¡Œæ‹†åˆ†ï¼ŒæŒ‰å›½å®¶æ‹†åˆ†ã€æŒ‰çœæ‹†åˆ†ï¼ŒæŒ‰å¸‚æ‹†åˆ†ï¼Œåœ¨äººå£ç‰¹å¤§åŸå¸‚ç”šè‡³å¯ä»¥æŒ‰åŒºæ‹†åˆ†ã€‚è¿™æ ·å°±å¯ä»¥æ˜¾è‘—é™ä½å•ä¸ª<code>zset</code>é›†åˆçš„å¤§å°ã€‚</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>ä»åœ°å›¾ä¸­å…ƒç´ çš„äºŒç»´è¡¨ç¤ºå…¥æ‰‹ï¼Œåˆ†æå¼•å…¥åœ¨<code>redis3.2</code>ä¸­æä¾›çš„<code>Geo</code>åœ°ç†æ¨¡å—,å¹¶å¯¹<code>Geo</code>åœ°ç†æ¨¡å—æä¾›çš„åŸºç¡€å‘½ä»¤åŸç†åŠä½¿ç”¨è¿›è¡Œäº†é˜è¿°è¯´æ˜ï¼Œå¹¶è¿›ä¸€æ­¥é€šè¿‡ç¤ºä¾‹ä½œå‡ºäº†è¯´æ˜ï¼›</li><li><code>Geo</code>åœ°ç†æ¨¡å—å¯¹äºè®¡ç®—åœ°å›¾ä¸­å…ƒç´ ä½ç½®åŠæŸ¥æ‰¾å…ƒç´ éå¸¸æ–¹ä¾¿; </li><li>ä½†å€¼å¾—æ³¨æ„çš„æ—¶ï¼Œæœ‰å…³ä½¿ç”¨ç»éªŒè¡¨æ˜å½“<code>redis</code>é›†ç¾¤ä¸­å•ä¸ª<code>key</code>æ•°æ®é‡æ¯”è¾ƒå¤§å¦‚è¶…å‡º<code>1M</code>æ—¶ï¼Œå»ºè®®æŒ‰ç…§ä¸šåŠ¡ç‰¹æ€§è¿›è¡Œæ‹†åˆ†ï¼Œåˆ†æµåˆ°å¤šä¸ª<code>redis</code>å®ä¾‹ä¸­å»ï¼Œä»¥å…åœ¨è¿›è¡Œè¿ç§»æ—¶å½±å“è¿è¥æœåŠ¡;</li></ul><p>æ­¤å¤–ï¼Œå¯è¿›ä¸€æ­¥å‚è€ƒ</p><hr><p>[1] <a href="https://www.cnblogs.com/zhenbianshu/p/6817569.html" target="_blank" rel="noopener">ç©ºé—´ç´¢å¼• - å„æ•°æ®åº“ç©ºé—´ç´¢å¼•ä½¿ç”¨æŠ¥å‘Š</a><br>[2] <a href="https://www.cnblogs.com/zhenbianshu/p/6863405.html" target="_blank" rel="noopener">ç©ºé—´ç´¢å¼• - GeoHashç®—æ³•åŠå…¶å®ç°ä¼˜åŒ–</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;redis3.2&lt;/code&gt;ç‰ˆæœ¬é‡Œé¢æ–°å¢çš„ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯å¯¹&lt;code&gt;GEO(åœ°ç†ä½ç½®)&lt;/code&gt;çš„æ”¯æŒã€‚æ„å‘³ç€å¯ä»¥ç”¨&lt;code&gt;redis&lt;/code&gt;æ¥å®ç°æŸ¥æ‰¾&lt;code&gt;é™„ä»¶çš„äºº&lt;/code&gt;çš„ç­‰æœç´¢åŠŸèƒ½äº†ï¼›&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸“é¢˜13 æ€§èƒ½ä¼˜åŒ–ä¹‹sqlè¯­å¥ä¼˜åŒ–</title>
    <link href="http://researchlab.github.io/2018/10/06/mysql-13-sql-optimization/"/>
    <id>http://researchlab.github.io/2018/10/06/mysql-13-sql-optimization/</id>
    <published>2018-10-06T10:01:54.000Z</published>
    <updated>2019-08-24T14:25:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ºåº”ç”¨æœåŠ¡æä¾›ç¨³å®šçš„æ•°æ®CURDæœåŠ¡,åŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥æå‡CURDæ€§èƒ½åŠæ½œåœ¨çš„é—®é¢˜, å°±éœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µåŠæ•°æ®ä½“é‡è¿›è¡Œæ•°æ®åº“ä¼˜åŒ–ä¿®è®¢å·¥ä½œ, å…³äºæ•°æ®åº“ä¼˜åŒ–çš„æ“ä½œå¯ä»¥ä»å¤šä¸ªæ–¹é¢æ¥æ€»ç»“å½’çº³, å¦‚å¯¹SQLè¯­å¥çš„ä¼˜åŒ–, ç´¢å¼•çš„ä¼˜åŒ–, è¡¨ç»“æ„çš„ä¼˜åŒ–, é…ç½®çš„ä¼˜åŒ–ç­‰ç­‰; æœ¬æ–‡ä»æ€»ç»“å®è·µç»éªŒåŠå½’çº³å›é¡¾çŸ¥è¯†è¦ç‚¹çš„è§’åº¦æ¥æ¢è®¨å…³äºSQLè¯­å¥ä¼˜åŒ–çš„ç›¸å…³é—®é¢˜;<br><a id="more"></a></p><h2 id="ä¼˜åŒ–ç›®çš„"><a href="#ä¼˜åŒ–ç›®çš„" class="headerlink" title="ä¼˜åŒ–ç›®çš„"></a>ä¼˜åŒ–ç›®çš„</h2><ul><li>é¿å…å‡ºç°é¡µé¢è®¿é—®é”™è¯¯<ol><li>ç”±äºæ•°æ®åº“è¿æ¥timeoutäº§ç”Ÿé¡µé¢5xxé”™è¯¯;</li><li>ç”±äºæ…¢æŸ¥è¯¢é€ æˆé¡µé¢æ— æ³•åŠ è½½;</li><li>ç”±äºé˜»å¡é€ æˆæ•°æ®æ— æ³•æäº¤;</li></ol></li><li>å¢åŠ æ•°æ®åº“çš„ç¨³å®šæ€§<ol><li>å¾ˆå¤šæ•°æ®åº“é—®é¢˜éƒ½æ˜¯ç”±äºä½æ•ˆçš„æŸ¥è¯¢å¼•èµ·çš„;</li></ol></li><li>ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ<ol><li>æµç•…é¡µé¢çš„è®¿é—®é€Ÿåº¦;</li><li>è‰¯å¥½çš„ä¸šåŠ¡åŠŸèƒ½ä½“éªŒ;</li></ol></li></ul><h2 id="ä¼˜åŒ–æ–¹å‘åŠæˆæœ¬"><a href="#ä¼˜åŒ–æ–¹å‘åŠæˆæœ¬" class="headerlink" title="ä¼˜åŒ–æ–¹å‘åŠæˆæœ¬"></a>ä¼˜åŒ–æ–¹å‘åŠæˆæœ¬</h2><p>å¤§è‡´å¯ä»¥ä»å¦‚ä¸‹å‡ ä¸ªæ–¹å‘è¿›è¡Œä¼˜åŒ–, </p><ul><li>SQLè¯­å¥ä¼˜åŒ–;</li><li>ç´¢å¼•ä¼˜åŒ–;</li><li>æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–;</li><li>é…ç½®ä¼˜åŒ–(è¿æ¥æ•°é™åˆ¶/æ–‡ä»¶æ•°é™åˆ¶ç­‰);</li><li>ç¡¬ä»¶ä¼˜åŒ–(SSDæ˜¾ç„¶èƒ½æé«˜IOæ€§èƒ½);</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æˆæœ¬(ä½) <span class="comment">--- &gt; é«˜</span></span><br><span class="line">SQLåŠç´¢å¼• <span class="comment">---&gt; æ•°æ®åº“è¡¨ç»“æ„ ---&gt; ç³»ç»Ÿé…ç½® ---&gt; ç¡¬ä»¶</span></span><br><span class="line">æ•ˆæœ(é«˜) &lt;---  ä½</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®å‡†å¤‡"><a href="#æ•°æ®å‡†å¤‡" class="headerlink" title="æ•°æ®å‡†å¤‡"></a>æ•°æ®å‡†å¤‡</h2><p>å®éªŒæ•°æ®åº“é‡‡ç”¨mysqlå®˜æ–¹æä¾›çš„ç¤ºä¾‹æ•°æ®åº“ sakila database,</p><ul><li>installation: <a href="https://dev.mysql.com/doc/sakila/en/sakila-installation.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/sakila/en/sakila-installation.html</a></li><li>sakila database zip: <a href="https://dev.mysql.com/doc/index-other.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/index-other.html</a></li></ul><p>å¯¼å…¥sakilaæ•°æ®åº“åŠæ•°æ®<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@(none)&gt;source /sqls/sakila-db/sakila-schema.sql;</span><br><span class="line">root@sakila&gt;source /sqls/sakila-db/sakila-data.sql;</span><br><span class="line">root@sakila&gt;select count(*) from film;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|     1000 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><ul><li>æ™®é€šè´¦å·æ²¡æœ‰è®¾ç½®åˆ›å»ºschemaçš„æƒé™ä¹Ÿä¸åº”è®¾ç½®å…¶å…·æœ‰è¿™æ ·çš„æƒé™, æ‰€ä»¥å…ˆç™»å½•rootè´¦å·å¯¼å…¥sakilaæ•°æ®åº“åŠç¤ºä¾‹æ•°æ®;</li></ul><p>æˆæƒæ™®é€šè´¦å·devæ“ä½œsakilaæ•°æ®åº“çš„æƒé™<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant all privileges on sakila.* to 'dev'@'%' with grant option;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure></p><ul><li>å¯¼å…¥æˆåŠŸå, éœ€è¦å¯¹æ™®é€šè´¦å·devæˆæƒ,devè´¦å·æ‰å¯ä»¥ä½¿ç”¨sakilaæ•°æ®åº“, åœ¨mysql8.0+ä¸­æˆæƒåˆ†ä¸ºåˆ›å»ºè´¦å·å’Œæˆæƒä¸¤ä¸ªè¿‡ç¨‹; </li><li>å› ä¸ºdevè´¦å·å·²åˆ›å»º; æ‰€ä»¥è¿™é‡Œåªéœ€è¦æˆæƒå³å¯;</li><li>å»ºè®®å…»æˆå¯¹æ™®é€šè´¦å·æ¯æ¬¡åªé’ˆå¯¹æŸä¸ªæ•°æ®åº“çš„æŸäº›æ“ä½œè¿›è¡Œæˆæƒçš„ä¹ æƒ¯; åªè¦éœ€è¦æ—¶æ‰è¿›è¡Œè¿›ä¸€æ­¥æˆæƒ; </li></ul><p>ç™»å½•devæ™®é€šè´¦å·;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dev@(none)&gt;use sakila;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup <span class="keyword">with</span> -A</span><br><span class="line"></span><br><span class="line"><span class="keyword">Database</span> <span class="keyword">changed</span></span><br><span class="line">dev@sakila&gt;</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;<span class="keyword">select</span> @@<span class="keyword">version</span>;</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| @@version |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 8.0.12    |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>å¦‚ä½•å‘ç°æœ‰é—®é¢˜çš„SQL?<br>åœ¨è¿›è¡ŒSQLè¯­å¥åŠç´¢å¼•ä¼˜åŒ–ä¹‹å‰, éœ€è¦çŸ¥é“å“ªäº›æŸ¥è¯¢æ˜¯éœ€è¦ä¼˜åŒ–çš„,æ˜¯æœ‰æ•ˆç‡é—®é¢˜çš„, åœ¨mysqlä¸­å¯ä»¥ç”¨å…¶æä¾›çš„æ…¢æŸ¥è¯¢æ—¥å¿—æŠŠé‚£äº›æœ‰æ•ˆç‡çš„æ—¥å¿—è®°å½•ä¸‹æ¥, ç„¶åè¿›è¡Œåˆ†æä¼˜åŒ–, </p><h2 id="æ…¢æŸ¥æ—¥å¿—"><a href="#æ…¢æŸ¥æ—¥å¿—" class="headerlink" title="æ…¢æŸ¥æ—¥å¿—"></a>æ…¢æŸ¥æ—¥å¿—</h2><p>ä½¿ç”¨Mysqlæ…¢æŸ¥æ—¥å¿—å¯¹æœ‰æ•ˆç‡çš„SQLè¿›è¡Œç›‘æ§,</p><p>å¼€å¯æ…¢æŸ¥æ—¥å¿—</p><ul><li>show variables like â€˜slow_query_logâ€™</li><li>set global slow_query_log_file = â€˜/var/log/mysql/mysql-slow.logâ€™</li><li>set global log_queries_not_using_indexes = on;</li><li>set global long_query_time =1 #å³è¶…è¿‡ä¸€ç§’çš„æŸ¥è¯¢æ—¥å¿—è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­;</li></ul><h3 id="æŸ¥çœ‹æ…¢æŸ¥è¯¢å¼€å¯çŠ¶æ€"><a href="#æŸ¥çœ‹æ…¢æŸ¥è¯¢å¼€å¯çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹æ…¢æŸ¥è¯¢å¼€å¯çŠ¶æ€"></a>æŸ¥çœ‹æ…¢æŸ¥è¯¢å¼€å¯çŠ¶æ€</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;show variables like 'slow_query_log';</span><br><span class="line">+<span class="comment">----------------+-------+</span></span><br><span class="line">| Variable_name  | Value |</span><br><span class="line">+<span class="comment">----------------+-------+</span></span><br><span class="line">| slow_query_log | OFF   |</span><br><span class="line">+<span class="comment">----------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹åˆ°slow_query_log å’Œ log_queries_not_using_indexes éƒ½æ˜¯æœªå¼€å¯çŠ¶æ€;</span></span><br><span class="line">dev@sakila&gt;<span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%log%'</span>;</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------------------+</span></span><br><span class="line">| Variable_name                              | Value                                       |</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------------------+</span></span><br><span class="line">| activate_all_roles_on_login                | OFF                                         |</span><br><span class="line">| back_log                                   | 151                                         |</span><br><span class="line">| log_error                                  | stderr                                      |</span><br><span class="line">| log_error_services                         | log_filter_internal; log_sink_internal      |</span><br><span class="line">| log_error_verbosity                        | 2                                           |</span><br><span class="line">| log_output                                 | FILE                                        |</span><br><span class="line">| log_queries_not_using_indexes              | OFF                                         |</span><br><span class="line">| slow_query_log_file                        | /var/lib/mysql/2139b750c3f3-slow.log        |</span><br><span class="line">...</span><br><span class="line">+<span class="comment">--------------------------------------------+---------------------------------------------+</span></span><br><span class="line">81 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><code>slow_query_log OFF</code> æ…¢æŸ¥æ—¥å¿—  çŠ¶æ€ - æœªå¼€å¯</li><li><code>log_queries_not_using_indexes</code>  å°†æ²¡æœ‰åˆ›å»ºç´¢å¼•çš„SQLæŸ¥è¯¢æ—¥å¿—è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­ çŠ¶æ€ - æœªå¼€å¯ </li></ul><p>æŸ¥çœ‹æ‰§è¡Œæ—¶é—´è¶…è¿‡å¤šå°‘sçš„SQLæŸ¥è¯¢æ—¥å¿—ä¼šè®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'long_query_time';</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br><span class="line">| Variable_name   | Value     |</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br><span class="line">| long_query_time | 10.000000 |</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><code>long_query_time</code>é»˜è®¤æ˜¯æ‰§è¡Œæ—¶é—´è¶…è¿‡10sçš„SQLæŸ¥è¯¢å°†è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­;</li></ul><h3 id="æ…¢æŸ¥æ—¥å¿—ä½ç½®"><a href="#æ…¢æŸ¥æ—¥å¿—ä½ç½®" class="headerlink" title="æ…¢æŸ¥æ—¥å¿—ä½ç½®"></a>æ…¢æŸ¥æ—¥å¿—ä½ç½®</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'slow_query_log_file';</span><br><span class="line">+<span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line">| Variable_name       | Value                                |</span><br><span class="line">+<span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line">| slow_query_log_file |/var/lib/mysql/2139b750c3f3-slow.log  |</span><br><span class="line">+<span class="comment">---------------------+--------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li><code>slow_query_log_file</code> æ…¢æŸ¥æ—¥å¿—é»˜è®¤ä½ç½®åœ¨<code>/var/lib/mysql/2139b750c3f3-slow.log</code></li></ul><p>ä¸ºä¾¿äºå­¦ä¹ å®éªŒ å°†è®¾ç½®long_query_time=0s; å³å°†æ‰€æœ‰æŸ¥è¯¢æ—¥å¿—éƒ½è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­, å®é™…ä½¿ç”¨ä¸­ä¸€èˆ¬è®¾ç½®è¶…è¿‡100msçš„SQLæŸ¥è¯¢è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global long_query_time=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">#é€€å‡ºé‡æ–°ç™»å½•åœ¨æŸ¥è¯¢</span><br><span class="line">mysql&gt; show variables like &apos;long_query_time&apos;;</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| Variable_name   | Value    |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| long_query_time | 0.000000 |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><ul><li>è®¾ç½®long_query_timeå‚æ•°æ—¶ï¼Œéœ€è¦é‡æ–°è¿æ¥æ‰èƒ½ç”Ÿæ•ˆï¼Œä¸éœ€è¦é‡å¯æœåŠ¡; å¦åˆ™é€šè¿‡<code>show variables like &#39;long_query_time&#39;</code> æŸ¥çœ‹ä¸åˆ°å˜åŒ–;</li></ul><p>å¼€å¯å°†æ²¡æœ‰åˆ›å»ºç´¢å¼•çš„sqlæŸ¥è¯¢æ—¥å¿—è®°å½•åˆ°æ…¢æŸ¥æ—¥å¿—ä¸­<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global log_queries_not_using_indexes=on;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>è®¾ç½®æ…¢æŸ¥æ—¥å¿—æ–‡ä»¶ä½ç½® </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow_query_log_file="/var/log/mysql/mysql-slow.log";</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; show variables like 'slow_query_log_file';</span><br><span class="line">+<span class="comment">---------------------+-------------------------------+</span></span><br><span class="line">| Variable_name       | Value                         |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------+</span></span><br><span class="line">| slow_query_log_file | /var/log/mysql/mysql-slow.log |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½®<code>slow_query_log_file</code>æ—¶, ç›®å½•å¿…é¡»å­˜åœ¨, å¹¶ä¸”mysqlæœ‰æƒè¯»å†™è¯¥ç›®å½•,</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/log/mysql</span><br><span class="line">chown mysql:mysql /var/log/mysql</span><br></pre></td></tr></table></figure><p>å¦åˆ™æŠ¥é”™</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow_query_log_file="/var/log/mysql/mysql-slow.log";</span><br><span class="line">ERROR 1231 (42000): Variable 'slow_query_log_file' can't be <span class="keyword">set</span> <span class="keyword">to</span> the <span class="keyword">value</span> <span class="keyword">of</span> <span class="string">'/var/log/mysql/mysql-slow.log'</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å¯æ…¢æŸ¥æ—¥å¿—"><a href="#å¼€å¯æ…¢æŸ¥æ—¥å¿—" class="headerlink" title="å¼€å¯æ…¢æŸ¥æ—¥å¿—"></a>å¼€å¯æ…¢æŸ¥æ—¥å¿—</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow_query_log=on;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹æ…¢æŸ¥æ—¥å¿—"><a href="#æŸ¥çœ‹æ…¢æŸ¥æ—¥å¿—" class="headerlink" title="æŸ¥çœ‹æ…¢æŸ¥æ—¥å¿—"></a>æŸ¥çœ‹æ…¢æŸ¥æ—¥å¿—</h3><p>è¿›è¡Œç®€å•çš„æŸ¥è¯¢æ“ä½œæŸ¥çœ‹æ…¢æ—¥å¿—æ–‡ä»¶æ˜¯å¦æœ‰è®°å½•<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;show tables;</span><br><span class="line">dev@sakila&gt;select * from film limit 10;</span><br></pre></td></tr></table></figure></p><h3 id="è°ƒæ•´æ—¶åŒº"><a href="#è°ƒæ•´æ—¶åŒº" class="headerlink" title="è°ƒæ•´æ—¶åŒº"></a>è°ƒæ•´æ—¶åŒº</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;show variables like '%time_zone%';</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">| Variable_name    | Value  |</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">| system_time_zone | UTC    |</span><br><span class="line">| time_zone        | SYSTEM |</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;<span class="keyword">set</span> <span class="keyword">time_zone</span>=<span class="string">'+8:00'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;show variables like '%time_zone%';</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">| Variable_name    | Value  |</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">| system_time_zone | UTC    |</span><br><span class="line">| time_zone        | +08:00 |</span><br><span class="line">+<span class="comment">------------------+--------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>åœ¨å‘½ä»¤ä¸€ä¸ªç»ˆç«¯å¯ä»¥æŸ¥çœ‹åˆ°SQLæŸ¥è¯¢æ—¥å¿—è®°å½•åˆ°äº†æ…¢æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it mysql-db tail -f /var/log/mysql/mysql-slow.log</span><br><span class="line"><span class="comment"># Time: 2018-11-03T06:12:56.235450Z</span></span><br><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br><span class="line"><span class="comment"># Query_time: 0.000182  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225576</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATABASE</span>();</span><br><span class="line"><span class="comment"># Time: 2018-11-03T06:12:56.235855Z</span></span><br><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br><span class="line"><span class="comment"># Query_time: 0.000160  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225576</span>;</span><br><span class="line"><span class="comment"># administrator command: Init DB;</span></span><br><span class="line"><span class="comment"># Time: 2018-11-03T06:13:34.376262Z</span></span><br><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br><span class="line"><span class="comment"># Query_time: 0.000779  Lock_time: 0.000337 Rows_sent: 10  Rows_examined: 10</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225614</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> film <span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment"># Time: 2018-11-03T06:14:21.627579Z</span></span><br><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br><span class="line"><span class="comment"># Query_time: 0.000388  Lock_time: 0.000121 Rows_sent: 1  Rows_examined: 0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225661</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> film;</span><br></pre></td></tr></table></figure><h3 id="æ…¢æŸ¥æ—¥å¿—å­˜å‚¨æ ¼å¼"><a href="#æ…¢æŸ¥æ—¥å¿—å­˜å‚¨æ ¼å¼" class="headerlink" title="æ…¢æŸ¥æ—¥å¿—å­˜å‚¨æ ¼å¼"></a>æ…¢æŸ¥æ—¥å¿—å­˜å‚¨æ ¼å¼</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Time: 2018-11-03T06:14:21.627579Z</span></span><br><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br><span class="line"><span class="comment"># Query_time: 0.000388  Lock_time: 0.000121 Rows_sent: 1  Rows_examined: 0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225661</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> film;</span><br></pre></td></tr></table></figure><p>ä¸€æ¡æ…¢æŸ¥æ—¥å¿—ä¸»è¦åŒ…æ‹¬äº”ä¸ªéƒ¨åˆ†</p><ol><li>æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Time: 2018-11-03T06:14:21.627579Z</span></span><br></pre></td></tr></table></figure><ol start="2"><li>æ‰§è¡ŒSQLçš„ä¸»æœºä¿¡æ¯</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User@Host: dev[dev] @ localhost []  Id:    28</span></span><br></pre></td></tr></table></figure><ol start="3"><li>SQLçš„æ‰§è¡Œä¿¡æ¯</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Query_time: 0.000388  Lock_time: 0.000121 Rows_sent: 1  Rows_examined: 0</span></span><br></pre></td></tr></table></figure><ol start="4"><li>SQLçš„æ‰§è¡Œæ—¶é—´</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1541225661</span>;</span><br></pre></td></tr></table></figure><ol start="5"><li>SQLçš„å†…å®¹</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> film;</span><br></pre></td></tr></table></figure><h2 id="æ…¢æŸ¥æ—¥å¿—åˆ†æ"><a href="#æ…¢æŸ¥æ—¥å¿—åˆ†æ" class="headerlink" title="æ…¢æŸ¥æ—¥å¿—åˆ†æ"></a>æ…¢æŸ¥æ—¥å¿—åˆ†æ</h2><p>æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·æœ‰å¾ˆå¤š, å¦‚mysqlsla, pt-query-digestä»¥åŠå®˜æ–¹é»˜è®¤æä¾›çš„mysqldumpslowç­‰, </p><h3 id="mysqldumpslow"><a href="#mysqldumpslow" class="headerlink" title="mysqldumpslow"></a>mysqldumpslow</h3><p>mysqldumpslow æ˜¯ä¸€ä¸ªMySQLå®˜æ–¹æä¾›çš„æ…¢æŸ¥æ—¥å¿—åˆ†æå·¥å…·</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it mysql-db mysqldumpslow -h</span><br><span class="line">Option h requires an argument</span><br><span class="line">ERROR: bad option</span><br><span class="line"></span><br><span class="line">Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]</span><br><span class="line"></span><br><span class="line">Parse and summarize the MySQL slow query log. Options are</span><br><span class="line"></span><br><span class="line">  <span class="comment">--verbose    verbose</span></span><br><span class="line">  <span class="comment">--debug      debug</span></span><br><span class="line">  <span class="comment">--help       write this text to standard output</span></span><br><span class="line"></span><br><span class="line">  -v           verbose</span><br><span class="line">  -d           debug</span><br><span class="line">  -s ORDER     what to sort by (al, at, ar, c, l, r, t), 'at' is default</span><br><span class="line">                al: average <span class="keyword">lock</span> <span class="built_in">time</span></span><br><span class="line">                ar: average <span class="keyword">rows</span> sent</span><br><span class="line">                <span class="keyword">at</span>: average <span class="keyword">query</span> <span class="built_in">time</span></span><br><span class="line">                 c: <span class="keyword">count</span></span><br><span class="line">                 l: <span class="keyword">lock</span> <span class="built_in">time</span></span><br><span class="line">                 r: <span class="keyword">rows</span> sent</span><br><span class="line">                 t: <span class="keyword">query</span> <span class="built_in">time</span></span><br><span class="line">  -r           <span class="keyword">reverse</span> the <span class="keyword">sort</span> <span class="keyword">order</span> (largest <span class="keyword">last</span> instead <span class="keyword">of</span> <span class="keyword">first</span>)</span><br><span class="line">  -t <span class="keyword">NUM</span>       just <span class="keyword">show</span> the top n queries</span><br><span class="line">  -a           don<span class="string">'t abstract all numbers to N and strings to '</span>S<span class="string">'</span></span><br><span class="line"><span class="string">  -n NUM       abstract numbers with at least n digits within names</span></span><br><span class="line"><span class="string">  -g PATTERN   grep: only consider stmts that include this string</span></span><br><span class="line"><span class="string">  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),</span></span><br><span class="line"><span class="string">               default is '</span>*<span class="string">', i.e. match all</span></span><br><span class="line"><span class="string">  -i NAME      name of server instance (if using mysql.server startup script)</span></span><br><span class="line"><span class="string">  -l           don'</span>t subtract <span class="keyword">lock</span> <span class="built_in">time</span> <span class="keyword">from</span> total <span class="built_in">time</span></span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥é€šè¿‡<code>s</code>æŒ‡å®šæ’åºè§„åˆ™;</li><li>é€šè¿‡<code>t</code>æŒ‡å®šæœ€å‰é¢çš„næ¡æŸ¥è¯¢è®°å½•;</li></ul><p>ä¸‹é¢é€šè¿‡å®ä¾‹åˆ†æä¸€æ¡æ—¥å¿—,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ docker exec -it mysql-db mysqldumpslow -t 1 /var/log/mysql/mysql-slow.log;</span><br><span class="line"></span><br><span class="line">Reading mysql slow query log from /var/log/mysql/mysql-slow.log</span><br><span class="line">Count: 1  Time=0.02s (0s)  <span class="keyword">Lock</span>=<span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span>=<span class="number">0.0</span> (<span class="number">0</span>), dev[dev]@localhost</span><br><span class="line">  <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`ins_film`</span> <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`film`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">BEGIN</span></span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> film_text (film_id, title, description)</span><br><span class="line">  <span class="keyword">VALUES</span> (new.film_id, new.title, new.description);</span><br><span class="line">  <span class="keyword">END</span></span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">å…³é”®å­—</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>Count</code></td><td style="text-align:left">è¿™æ¡SQLæ‰§è¡Œçš„æ¬¡æ•°</td></tr><tr><td style="text-align:left"><code>Time</code></td><td style="text-align:left">æ‰§è¡Œè€—æ—¶</td></tr><tr><td style="text-align:left"><code>Lock</code></td><td style="text-align:left">é”å®šæ—¶é—´</td></tr><tr><td style="text-align:left"><code>Rows</code></td><td style="text-align:left">å‘é€çš„è¡Œæ•°</td></tr></tbody></table><h3 id="pt-query-digest"><a href="#pt-query-digest" class="headerlink" title="pt-query-digest"></a>pt-query-digest</h3><p>pt-query-digestæ˜¯ç”¨äºåˆ†æmySQLæ…¢æŸ¥è¯¢çš„ä¸€ä¸ªå·¥å…·ï¼Œå®ƒå¯ä»¥åˆ†æbinlogã€General logã€slowlogï¼Œä¹Ÿå¯ä»¥é€šè¿‡SHOWPROCESSLISTæˆ–è€…é€šè¿‡tcpdumpæŠ“å–çš„MySQLåè®®æ•°æ®æ¥è¿›è¡Œåˆ†æã€‚å¯ä»¥æŠŠåˆ†æç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œåˆ†æè¿‡ç¨‹æ˜¯å…ˆå¯¹æŸ¥è¯¢è¯­å¥çš„æ¡ä»¶è¿›è¡Œå‚æ•°åŒ–ï¼Œç„¶åå¯¹å‚æ•°åŒ–ä»¥åçš„æŸ¥è¯¢è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ï¼Œç»Ÿè®¡å‡ºå„æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ã€æ¬¡æ•°ã€å æ¯”ç­‰ï¼Œå¯ä»¥å€ŸåŠ©åˆ†æç»“æœæ‰¾å‡ºé—®é¢˜è¿›è¡Œä¼˜åŒ–ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">è¾“å‡ºåˆ°æ–‡ä»¶</span><br><span class="line">pt-query-digest slow.log &gt; slow_log.report</span><br><span class="line"></span><br><span class="line">è¾“å‡ºåˆ°æ•°æ®åº“è¡¨</span><br><span class="line">pt-query-digest slow.log -review \</span><br><span class="line">h = 127.0.0.1,D=test,p=root,P=3306,u=root,t=query_review \</span><br><span class="line"><span class="comment">--create-reviewtable \</span></span><br><span class="line"><span class="comment">--review-history t=hostname_slow</span></span><br></pre></td></tr></table></figure><p>å¸¸ç”¨é€‰é¡¹<br>pt-query-digestå¸¸ç”¨é€‰é¡¹, </p><table><thead><tr><th style="text-align:left">é€‰é¡¹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>--create-review-table</code></td><td style="text-align:left">å½“ä½¿ç”¨â€”reviewå‚æ•°ï¼ŒæŠŠåˆ†æç»“æœè¾“å‡ºåˆ°è¡¨ä¸­</td></tr><tr><td style="text-align:left"><code>--create-history-table</code></td><td style="text-align:left">ä½†æ˜¯ç”¨â€”historyå‚æ•°ï¼ŒæŠŠåˆ†æç»“æœè¾“å‡ºåˆ°è¡¨ä¸­</td></tr><tr><td style="text-align:left"><code>--filter</code></td><td style="text-align:left">å¯¹è¾“å…¥çš„æ…¢æŸ¥è¯¢æŒ‰æŒ‡å®šçš„å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…è¿‡æ»¤åï¼Œåœ¨è¿›è¡Œåˆ†æ</td></tr><tr><td style="text-align:left"><code>--limit</code></td><td style="text-align:left">é™åˆ¶è¾“å‡ºç»“æœç™¾åˆ†æ¯”æˆ–æ•°é‡ï¼Œé»˜è®¤å€¼æ˜¯20ï¼Œå³å°†æœ€æ…¢çš„20æ¡è¯­å¥è¾“å‡º</td></tr><tr><td style="text-align:left"><code>--host</code></td><td style="text-align:left">HostName</td></tr><tr><td style="text-align:left"><code>--user</code></td><td style="text-align:left">ç”¨æˆ·å</td></tr><tr><td style="text-align:left"><code>--password</code></td><td style="text-align:left">å¯†ç </td></tr><tr><td style="text-align:left"><code>--history</code></td><td style="text-align:left">å°†åˆ†æç»“æœä¿å­˜åˆ°è¡¨ä¸­ï¼Œåˆ†æç»“æœæ¯”è¾ƒè¯¦ç»†</td></tr><tr><td style="text-align:left"><code>--review</code></td><td style="text-align:left">å°†åˆ†æç»“æœä¿å­˜åˆ°è¡¨ä¸­</td></tr><tr><td style="text-align:left"><code>--output</code></td><td style="text-align:left">åˆ†æç»“æœè¾“å‡ºç±»å‹</td></tr><tr><td style="text-align:left"><code>--since</code></td><td style="text-align:left">ä»ä»€ä¹ˆæ—¶é—´å¼€å§‹åˆ†æï¼Œå€¼ä¸ºå­—ç¬¦ä¸²</td></tr><tr><td style="text-align:left"><code>--until</code></td><td style="text-align:left">æˆªæ­¢æ—¶é—´ï¼Œé…åˆsinceä¸€èµ·åˆ†æ</td></tr></tbody></table><p>pt-query-digeståˆ†æç»“æœä¸»è¦æœ‰ä»¥ä¸‹å‡ éƒ¨åˆ†,</p><ul><li>æ€»ä½“ç»Ÿè®¡ç»“æœ;</li><li>æŸ¥è¯¢åˆ†ç»„ç»Ÿè®¡ç»“æœ;</li><li>æ¯ä¸€ç§æŸ¥è¯¢çš„è¯¦ç»†ç»Ÿè®¡ç»“æœ;</li></ul><p>æ€»ä½“ç»Ÿè®¡ç»“æœ,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 59.5s user time, 90ms system time, 51.81M rss, 228.12M vsz</span></span><br><span class="line"><span class="comment"># Current date: Sun Aug  3 16:09:31 2014</span></span><br><span class="line"><span class="comment"># Hostname: db1.test.com</span></span><br><span class="line"><span class="comment"># Files: /var/log/mysql/mysql-slow.log</span></span><br><span class="line"><span class="comment"># Overall: 224.01k total, 570 unique, 0.01 QPS, 0.09x concurrency ________</span></span><br><span class="line"><span class="comment"># Time range: 2013-10-09 17:55:04 to 2014-08-03 15:16:38</span></span><br><span class="line"><span class="comment"># Attribute          total     min     max     avg     95%  stddev  median</span></span><br><span class="line"><span class="comment"># ============     ======= ======= ======= ======= ======= ======= =======</span></span><br><span class="line"><span class="comment"># Exec time        2188385s      2s   7229s     10s     13s     67s      5s</span></span><br><span class="line"><span class="comment"># Lock time        100721s       0    365s   450ms      2s      5s   119us</span></span><br><span class="line"><span class="comment"># Rows sent         26.98G       0   3.30M 126.27k 328.61k 371.66k    4.96</span></span><br><span class="line"><span class="comment"># Rows examine     394.85G       0   3.32G   1.80M   3.03M  20.83M 562.03k</span></span><br><span class="line"><span class="comment"># Query size        78.65M       6   5.54k  368.18  685.39  241.61  271.23</span></span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">é€‰é¡¹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>Overall</code></td><td style="text-align:left">æ€»å…±æœ‰å¤šå°‘æ¡æŸ¥è¯¢</td></tr><tr><td style="text-align:left"><code>unique</code></td><td style="text-align:left">å”¯ä¸€æŸ¥è¯¢æ•°é‡</td></tr><tr><td style="text-align:left"><code>Time range</code></td><td style="text-align:left">æŸ¥è¯¢æ‰§è¡Œçš„æ—¶é—´èŒƒå›´</td></tr><tr><td style="text-align:left"><code>total</code></td><td style="text-align:left">æ€»è®¡</td></tr><tr><td style="text-align:left"><code>min</code></td><td style="text-align:left">æœ€å°</td></tr><tr><td style="text-align:left"><code>max</code></td><td style="text-align:left">æœ€å¤§</td></tr><tr><td style="text-align:left"><code>avg</code></td><td style="text-align:left">å¹³å‡</td></tr><tr><td style="text-align:left"><code>95%</code></td><td style="text-align:left">95%çš„æŸ¥è¯¢æ—¶é—´ï¼Œé‡ç‚¹åˆ†æ</td></tr><tr><td style="text-align:left"><code>median</code></td><td style="text-align:left">ä¸­ä½æ•°ï¼ŒæŠŠæ‰€æœ‰å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼Œä½ç½®ä½äºä¸­é—´é‚£ä¸ªæ•°</td></tr></tbody></table><p>åˆ†ç»„ç»Ÿè®¡ç»“æœ,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Profile</span></span><br><span class="line"><span class="comment"># Rank Query ID           Response time     Calls R/Call    V/M   Item</span></span><br><span class="line"><span class="comment"># ==== ================== ================= ===== ========= ===== ========</span></span><br><span class="line"><span class="comment">#    1 0xA6FE3D6982868655 351140.1266 16.0%   622  564.5340 99... CREATE TABLE dw_user_cache `dw_user_cache`</span></span><br><span class="line"><span class="comment">#    2 0x281C83DE62A11A8B 310896.7675 14.2% 40841    7.6124  6.51 SELECT dw_borrow_tender dw_borrow dw_user dw_credit dw_credit_rank</span></span><br><span class="line"><span class="comment">#    3 0x26BA6BEAE6C74350 279545.6534 12.8%  1305  214.2112 25... SELECT dw_account_log</span></span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">é€‰é¡¹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>Response</code></td><td style="text-align:left">æ€»çš„å“åº”æ—¶é—´</td></tr><tr><td style="text-align:left"><code>time</code></td><td style="text-align:left">è¯¥æŸ¥è¯¢åœ¨æœ¬æ¬¡åˆ†æä¸­å ç”¨çš„æ—¶é—´æ¯”</td></tr><tr><td style="text-align:left"><code>Calls</code></td><td style="text-align:left">æ‰§è¡Œæ¬¡æ•°</td></tr><tr><td style="text-align:left"><code>R/Call</code></td><td style="text-align:left">å¹³å‡æ¯æ¬¡æ‰§è¡Œçš„å“åº”æ—¶é—´</td></tr><tr><td style="text-align:left"><code>Item</code></td><td style="text-align:left">æŸ¥è¯¢å¯¹è±¡</td></tr></tbody></table><p>æ¯ä¸€ç§æŸ¥è¯¢çš„è¯¦ç»†ç»Ÿè®¡ç»“æœ,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Query 172: 0.00 QPS, 0.00x concurrency, ID 0x61199112D48D8F69 at byte 56964086</span></span><br><span class="line"><span class="comment"># This item is included in the report because it matches --outliers.</span></span><br><span class="line"><span class="comment"># Scores: V/M = 0.85</span></span><br><span class="line"><span class="comment"># Time range: 2013-11-20 17:00:38 to 2014-03-23 09:00:45</span></span><br><span class="line"><span class="comment"># Attribute    pct   total     min     max     avg     95%  stddev  median</span></span><br><span class="line"><span class="comment"># ============ === ======= ======= ======= ======= ======= ======= =======</span></span><br><span class="line"><span class="comment"># Count          0      26</span></span><br><span class="line"><span class="comment"># Exec time      0    172s      5s     17s      7s      8s      2s      6s</span></span><br><span class="line"><span class="comment"># Lock time      0     3ms    63us   180us   100us   119us    22us    93us</span></span><br><span class="line"><span class="comment"># Rows sent      0     208       8       8       8       8       0       8</span></span><br><span class="line"><span class="comment"># Rows examine   0 333.82k   6.95k  20.62k  12.84k  18.47k   4.33k  10.80k</span></span><br><span class="line"><span class="comment"># Query size     0   5.59k     220     220     220     220       0     220</span></span><br><span class="line"><span class="comment"># String:</span></span><br><span class="line"><span class="comment"># Databases    test2</span></span><br><span class="line"><span class="comment"># Hosts</span></span><br><span class="line"><span class="comment"># Users        rx1919 (24/92%), tn1819 (2/7%)</span></span><br><span class="line"><span class="comment"># Query_time distribution</span></span><br><span class="line"><span class="comment">#   1us</span></span><br><span class="line"><span class="comment">#  10us</span></span><br><span class="line"><span class="comment"># 100us</span></span><br><span class="line"><span class="comment">#   1ms</span></span><br><span class="line"><span class="comment">#  10ms</span></span><br><span class="line"><span class="comment"># 100ms</span></span><br><span class="line"><span class="comment">#    1s  ################################################################</span></span><br><span class="line"><span class="comment">#  10s+  #####</span></span><br><span class="line"><span class="comment"># Tables</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `test2` LIKE 'dw_bbs_topics'G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `test2`.`dw_bbs_topics`G</span></span><br><span class="line"><span class="comment">#    SHOW TABLE STATUS FROM `test2` LIKE 'dw_bbs_forums'G</span></span><br><span class="line"><span class="comment">#    SHOW CREATE TABLE `test2`.`dw_bbs_forums`G</span></span><br><span class="line"><span class="comment"># EXPLAIN /*!50100 PARTITIONS*/</span></span><br><span class="line"><span class="keyword">select</span> p1.*,p2.name <span class="keyword">as</span> forum_name <span class="keyword">from</span> <span class="string">`dw_bbs_topics`</span> <span class="keyword">as</span> p1 </span><br><span class="line">                                <span class="keyword">left</span> <span class="keyword">join</span> dw_bbs_forums <span class="keyword">as</span> p2 <span class="keyword">on</span> p2.id = p1.fid</span><br><span class="line">                                <span class="keyword">where</span> isrecycle&lt;&gt;<span class="number">1</span> <span class="keyword">and</span> isrecycle&lt;&gt;<span class="number">1</span> <span class="keyword">and</span> p1.status = <span class="number">1</span> <span class="keyword">and</span> p1.isgood = <span class="number">1</span>    <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">rand</span>()   <span class="keyword">limit</span> <span class="number">8</span>G</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">é€‰é¡¹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>ID</code></td><td style="text-align:left">æŸ¥è¯¢çš„IDå·ï¼Œå’Œä¸Šå›¾çš„Query IDå¯¹åº”</td></tr><tr><td style="text-align:left"><code>Databases</code></td><td style="text-align:left">æ•°æ®åº“å</td></tr><tr><td style="text-align:left"><code>Users</code></td><td style="text-align:left">å„ä¸ªç”¨æˆ·æ‰§è¡Œçš„æ¬¡æ•°ï¼ˆå æ¯”ï¼‰</td></tr><tr><td style="text-align:left"><code>Query_time distribution</code></td><td style="text-align:left">æŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ, é•¿çŸ­ä½“ç°åŒºé—´å æ¯”ï¼Œæœ¬ä¾‹ä¸­1s-10sä¹‹é—´æŸ¥è¯¢æ•°é‡æ˜¯10sä»¥ä¸Šçš„ä¸¤å€</td></tr><tr><td style="text-align:left"><code>Tables</code></td><td style="text-align:left">æŸ¥è¯¢æ¶‰åŠåˆ°çš„è¡¨</td></tr><tr><td style="text-align:left"><code>EXPLAIN</code></td><td style="text-align:left">ç¤ºä¾‹</td></tr></tbody></table><h3 id="ç”¨æ³•ä¸¾ä¾‹"><a href="#ç”¨æ³•ä¸¾ä¾‹" class="headerlink" title="ç”¨æ³•ä¸¾ä¾‹"></a>ç”¨æ³•ä¸¾ä¾‹</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">(1)ç›´æ¥åˆ†ææ…¢æŸ¥è¯¢æ–‡ä»¶:</span><br><span class="line">pt-query-digest  slow.log &gt; slow_report.log</span><br><span class="line"></span><br><span class="line">(2)åˆ†ææœ€è¿‘12å°æ—¶å†…çš„æŸ¥è¯¢ï¼š</span><br><span class="line">pt-query-digest  <span class="comment">--since=12h  slow.log &gt; slow_report2.log</span></span><br><span class="line"></span><br><span class="line">(3)åˆ†ææŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æŸ¥è¯¢ï¼š</span><br><span class="line">pt-query-digest slow.log <span class="comment">--since '2014-04-17 09:30:00' --until '2014-04-17 10:00:00'&gt; &gt; slow_report3.log</span></span><br><span class="line"></span><br><span class="line">(4)åˆ†ææŒ‡å«æœ‰<span class="keyword">select</span>è¯­å¥çš„æ…¢æŸ¥è¯¢</span><br><span class="line">pt-<span class="keyword">query</span>-digest<span class="comment">--filter '$event-&gt;&#123;fingerprint&#125; =~ m/^select/i' slow.log&gt; slow_report4.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>) é’ˆå¯¹æŸä¸ªç”¨æˆ·çš„æ…¢æŸ¥è¯¢</span><br><span class="line">pt-<span class="keyword">query</span>-digest<span class="comment">--filter '($event-&gt;&#123;user&#125; || "") =~ m/^root/i' slow.log&gt; slow_report5.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">6</span>) æŸ¥è¯¢æ‰€æœ‰æ‰€æœ‰çš„å…¨è¡¨æ‰«ææˆ–<span class="keyword">full</span> <span class="keyword">join</span>çš„æ…¢æŸ¥è¯¢</span><br><span class="line">pt-<span class="keyword">query</span>-digest<span class="comment">--filter '(($event-&gt;&#123;Full_scan&#125; || "") eq "yes") ||(($event-&gt;&#123;Full_join&#125; || "") eq "yes")' slow.log&gt; slow_report6.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">7</span>)æŠŠæŸ¥è¯¢ä¿å­˜åˆ°query_reviewè¡¨</span><br><span class="line">pt-<span class="keyword">query</span>-digest  <span class="comment">--user=root â€“password=abc123 --review  h=localhost,D=test,t=query_review--create-review-table  slow.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">8</span>)æŠŠæŸ¥è¯¢ä¿å­˜åˆ°query_historyè¡¨</span><br><span class="line">pt-<span class="keyword">query</span>-digest  <span class="comment">--user=root â€“password=abc123 --review  h=localhost,D=test,t=query_ history--create-review-table  slow.log_20140401</span></span><br><span class="line">pt-<span class="keyword">query</span>-digest  <span class="comment">--user=root â€“password=abc123--review  h=localhost,D=test,t=query_history--create-review-table  slow.log_20140402</span></span><br><span class="line"></span><br><span class="line">(<span class="number">9</span>)é€šè¿‡tcpdumpæŠ“å–mysqlçš„tcpåè®®æ•°æ®ï¼Œç„¶åå†åˆ†æ</span><br><span class="line">tcpdump -s <span class="number">65535</span> -x -nn -q -tttt -i <span class="keyword">any</span> -c <span class="number">1000</span> port <span class="number">3306</span> &gt; mysql.tcp.txt</span><br><span class="line">pt-<span class="keyword">query</span>-digest <span class="comment">--type tcpdump mysql.tcp.txt&gt; slow_report9.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">10</span>)åˆ†æ<span class="keyword">binlog</span></span><br><span class="line">mysqlbinlog mysql-<span class="keyword">bin</span><span class="number">.000093</span> &gt; mysql-bin000093.sql</span><br><span class="line">pt-<span class="keyword">query</span>-digest  <span class="comment">--type=binlog  mysql-bin000093.sql &gt; slow_report10.log</span></span><br><span class="line"></span><br><span class="line">(<span class="number">11</span>)åˆ†æ<span class="keyword">general</span> <span class="keyword">log</span></span><br><span class="line">pt-<span class="keyword">query</span>-digest  <span class="comment">--type=genlog  localhost.log &gt; slow_report11.log</span></span><br></pre></td></tr></table></figure><h2 id="é€šè¿‡æ…¢æŸ¥æ—¥å¿—å‘ç°é—®é¢˜SQL"><a href="#é€šè¿‡æ…¢æŸ¥æ—¥å¿—å‘ç°é—®é¢˜SQL" class="headerlink" title="é€šè¿‡æ…¢æŸ¥æ—¥å¿—å‘ç°é—®é¢˜SQL"></a>é€šè¿‡æ…¢æŸ¥æ—¥å¿—å‘ç°é—®é¢˜SQL</h2><p>å¦‚ä½•é€šè¿‡æ…¢æŸ¥æ—¥å¿—å‘ç°æœ‰é—®é¢˜çš„SQLï¼Ÿ ä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥åˆ¤æ–­, </p><ol><li><p>æŸ¥è¯¢æ¬¡æ•°å¤šä¸”æ¯æ¬¡æŸ¥è¯¢å ç”¨æ—¶é—´é•¿çš„SQL<br>é€šå¸¸ä¸ºpt-query-digeståˆ†æçš„å‰å‡ ä¸ªæŸ¥è¯¢</p></li><li><p>IOå¤§çš„SQL<br>æ³¨æ„pt-query-digeståˆ†æä¸­çš„Rows examineé¡¹ (Rows examine æŒ‡ä¸€æ¡æŸ¥è¯¢SQLä¸­æ‰«æçš„è¡Œæ•°), æ‰«æè¡Œæ•°è¶Šå¤š, è¯´æ˜å…¶IOæ¶ˆè€—ä¹Ÿä¼šè¶Šå¤§;</p></li><li><p>æœªå‘½ä¸­ç´¢å¼•çš„SQL<br>æ³¨æ„pt-query-digeståˆ†æä¸­Rows examine å’ŒRows Sendçš„å¯¹æ¯”,  Rows examine(æ‰«æçš„è¡Œæ•°) è¦æ¯”Rows Send(å‘é€çš„è¡Œæ•°)æ•°æ®å¤§å¾—å¤š, è¯´æ˜æ­¤æ¬¡æŸ¥è¯¢åŸºæœ¬é æ‰«ææŸ¥è¯¢å‡ºæ¥çš„;</p></li></ol><h2 id="é€šè¿‡explainæŸ¥è¯¢å’Œåˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’"><a href="#é€šè¿‡explainæŸ¥è¯¢å’Œåˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’" class="headerlink" title="é€šè¿‡explainæŸ¥è¯¢å’Œåˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’"></a>é€šè¿‡explainæŸ¥è¯¢å’Œåˆ†æSQLçš„æ‰§è¡Œè®¡åˆ’</h2><p>å¦‚ä½•åˆ†æSQLæŸ¥è¯¢</p><ol><li>ä½¿ç”¨explainæŸ¥è¯¢SQLçš„æ‰§è¡Œè®¡åˆ’</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select customer_id, first_name, last_name from customer \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: customer</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 599</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: NULL</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:left">åˆ—å</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>select_type</code></td><td style="text-align:left">æŸ¥è¯¢çš„ç±»å‹</td></tr><tr><td style="text-align:left"><code>table</code></td><td style="text-align:left">æ˜¾ç¤ºè¿™ä¸€è¡Œçš„æ•°æ®æ˜¯å…³äºå“ªå¼ è¡¨çš„</td></tr><tr><td style="text-align:left"><code>type</code></td><td style="text-align:left">è¿™æ˜¯é‡è¦çš„åˆ—, æ˜¾ç¤ºè¿æ¥ä½¿ç”¨äº†å“ªç§ç±»å‹, ä»æœ€å¥½åˆ°æœ€å·®çš„è¿æ¥ç±»å‹ä¸ºconst, eq_reg, ref,range, index å’Œ ALL</td></tr><tr><td style="text-align:left"><code>possible_keys</code></td><td style="text-align:left">æ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ã€‚ å¦‚æœä¸ºç©º, æ²¡æœ‰å¯èƒ½çš„ç´¢å¼•</td></tr><tr><td style="text-align:left"><code>key</code></td><td style="text-align:left">å®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœä¸ºNULL, åˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•</td></tr><tr><td style="text-align:left"><code>key_len</code></td><td style="text-align:left">ä½¿ç”¨ç´¢å¼•çš„é•¿åº¦ã€‚åœ¨ä¸æŸå¤±ç²¾ç¡®æ€§çš„æƒ…å†µä¸‹, é•¿åº¦è¶ŠçŸ­è¶Šå¥½</td></tr><tr><td style="text-align:left"><code>ref</code></td><td style="text-align:left">æ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†, å¦‚æœå¯èƒ½çš„è¯, æ˜¯ä¸€ä¸ªå¸¸æ•°</td></tr><tr><td style="text-align:left"><code>rows</code></td><td style="text-align:left">MySQLè®¤ä¸ºå¿…é¡»æ£€æŸ¥çš„ç”¨æ¥è¿”å›è¯·æ±‚æ•°æ®çš„è¡Œæ•°</td></tr><tr><td style="text-align:left"><code>filtered</code></td><td style="text-align:left">æ‰«æå‡½æ•°å æ•°æ®è¡¨çš„æ¯”ä¾‹</td></tr><tr><td style="text-align:left"><code>extra</code></td><td style="text-align:left">æ˜¯å¦éœ€è¦é¢å¤–çš„æ¡ä»¶åŠæ“ä½œæ¥å®Œæˆå½“å‰æŸ¥è¯¢, è¿”å›ä¸ºNULLè¡¨ç¤ºä¸éœ€è¦, å¦‚å€¼ä¸ºUsing filesortæˆ–è€…Using temporaryæ—¶ è¯´æ˜éœ€è¦è¿›è¡Œä¼˜åŒ–äº†</td></tr></tbody></table><p>select_type æŸ¥è¯¢ç±»å‹è¯´æ˜,</p><table><thead><tr><th style="text-align:left">é€‰æ‹©æŸ¥è¯¢ç±»å‹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>SIMPLE</code></td><td style="text-align:left">ç®€å•æŸ¥è¯¢(ä¸é€‚ç”¨unionå’Œå­æŸ¥è¯¢çš„)</td></tr><tr><td style="text-align:left"><code>PRIMARY</code></td><td style="text-align:left">æœ€å¤–å±‚çš„æŸ¥è¯¢</td></tr><tr><td style="text-align:left"><code>UNION</code></td><td style="text-align:left">UNIONä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„SELECTè¯­å¥</td></tr><tr><td style="text-align:left"><code>DEPENDENT</code></td><td style="text-align:left">UNIONä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„SELECTè¯­å¥,ä¾èµ–äºå¤–éƒ¨æŸ¥è¯¢</td></tr><tr><td style="text-align:left"><code>UNION</code></td><td style="text-align:left">UNIONç»“æœ</td></tr><tr><td style="text-align:left"><code>SUBQUERY</code></td><td style="text-align:left">å­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ªSELECTè¯­å¥</td></tr><tr><td style="text-align:left"><code>DEPENDENT</code></td><td style="text-align:left">å­æŸ¥è¯¢ä¸­çš„ç¬¬ä¸€ä¸ªSELECTè¯­å¥ï¼Œä¾èµ–äºå¤–éƒ¨æŸ¥è¯¢</td></tr><tr><td style="text-align:left"><code>DERIVED</code></td><td style="text-align:left">æ´¾ç”Ÿè¡¨çš„SELECT(FROMå­å¥çš„å­æŸ¥è¯¢)</td></tr><tr><td style="text-align:left"><code>MATERIALIZED</code></td><td style="text-align:left">Materialized subquery</td></tr><tr><td style="text-align:left"><code>UNCACHEABLE</code></td><td style="text-align:left">å¯¹äºè¯¥ç»“æœä¸èƒ½è¢«ç¼“å­˜ï¼Œå¿…é¡»é‡æ–°è¯„ä¼°å¤–éƒ¨æŸ¥è¯¢çš„æ¯ä¸€è¡Œå­æŸ¥è¯¢</td></tr><tr><td style="text-align:left"><code>UNCACHEABLE</code></td><td style="text-align:left">UNIONä¸­çš„ç¬¬äºŒä¸ªæˆ–è€…åé¢çš„SELECTè¯­å¥å±äºä¸å¯ç¼“å­˜å­æŸ¥è¯¢ (see UNCACHEABLE SUBQUERY)</td></tr></tbody></table><p>type è¿æ¥ç±»å‹è¯´æ˜, </p><table><thead><tr><th style="text-align:left">è¿æ¥ç±»å‹</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>const</code></td><td style="text-align:left">æŒ‡å¸¸æ•°æŸ¥æ‰¾, ä¸€èˆ¬æŒ‡å¯¹ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•è¿›è¡ŒæŸ¥æ‰¾;</td></tr><tr><td style="text-align:left"><code>eq_reg</code></td><td style="text-align:left">æŒ‡åœ¨ä¸€å®šèŒƒå›´å†…æŸ¥æ‰¾,ä¸€èˆ¬æ˜¯åŸºäºå”¯ä¸€ç´¢å¼•/ä¸»é”®çš„èŒƒå›´æŸ¥æ‰¾;</td></tr><tr><td style="text-align:left"><code>ref</code></td><td style="text-align:left">å¸¸è§äºè¿æ¥æŸ¥è¯¢ä¸­, åŸºäºæŸä¸€ä¸ªç´¢å¼•æŸ¥æ‰¾;</td></tr><tr><td style="text-align:left"><code>range</code></td><td style="text-align:left">åŸºäºç´¢å¼•çš„èŒƒå›´æŸ¥æ‰¾;</td></tr><tr><td style="text-align:left"><code>index</code></td><td style="text-align:left">å¯¹ç´¢å¼•è¿›è¡Œæ‰«ææŸ¥æ‰¾;</td></tr><tr><td style="text-align:left"><code>ALL</code></td><td style="text-align:left">è¿›è¡Œè¡¨æ‰«ææŸ¥æ‰¾;</td></tr></tbody></table><p>extraè¿”å›å€¼è¯´æ˜,</p><table><thead><tr><th style="text-align:left">è¿”å›å€¼</th><th style="text-align:left">è¯´æ˜</th></tr></thead><tbody><tr><td style="text-align:left"><code>Using filesort</code></td><td style="text-align:left">Mysqléœ€è¦è¿›è¡Œé¢å¤–çš„æ­¥éª¤æ¥å‘ç°å¦‚ä½•å¯¹è¿”å›çš„è¡Œæ’åºã€‚å®ƒæ ¹æ®è¿æ¥ç±»å‹ä»¥åŠå­˜å‚¨æ’åºé”®å€¼å’ŒåŒ¹é…æ¡ä»¶çš„å…¨éƒ¨è¡Œçš„è¡ŒæŒ‡é’ˆæ¥æ’åºå…¨éƒ¨è¡Œ</td></tr><tr><td style="text-align:left"><code>Using temporary</code></td><td style="text-align:left">Mysqléœ€è¦åˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨æ¥å­˜å‚¨ç»“æœ, è¿™é€šå¸¸å‘ç”Ÿåœ¨å¯¹ä¸åŒçš„åˆ—é›†è¿›è¡ŒORDER BYä¸Š, è€Œä¸æ˜¯GROUP BY ä¸Š</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select customer_id, first_name, last_name</span><br><span class="line">    -&gt; from customer</span><br><span class="line">    -&gt; where customer_id &gt; 50</span><br><span class="line">    -&gt; group by customer_id, first_name, last_name</span><br><span class="line">    -&gt; having count(customer_id) &gt; 1</span><br><span class="line">    -&gt; order by customer_id, first_name \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: customer</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 2</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 549</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where; Using temporary; Using filesort</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><blockquote><p>Mysqlæ¯æ¬¡è¯»å–æ˜¯ä»¥é¡µä¸ºå•ä½çš„, è€Œä¸€é¡µä¸­å­˜å‚¨çš„ç´¢å¼•è¶Šå¤š, å…¶æŸ¥è¯¢æ•ˆç‡å°±è¶Šé«˜, æ‰€ä»¥ç´¢å¼•é•¿åº¦è¶Šå°è¶Šå¥½;</p></blockquote><h2 id="Max-å‡½æ•°ä¼˜åŒ–"><a href="#Max-å‡½æ•°ä¼˜åŒ–" class="headerlink" title="Max()å‡½æ•°ä¼˜åŒ–"></a>Max()å‡½æ•°ä¼˜åŒ–</h2><p>Max()å‡½æ•°ç»å¸¸ä¼šè¢«ç”¨äºæŸ¥æ‰¾å‡ºæœ€å¤§çš„æˆ–æœ€åçš„æŸä¸ªæ—¶é—´æˆ–æ•°å€¼æ“ä½œ;</p><p>Max()å‡½æ•°ç¤ºä¾‹, æŸ¥è¯¢æœ€åæ”¯ä»˜æ—¶é—´,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select max(payment_date) from payment \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: payment</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 16086</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: NULL</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>typeå€¼ä¸ºALL è¡¨ç¤ºè¿›è¡Œè¡¨æ‰«æ; </li><li>rowså€¼ä¸º16086 è¡¨ç¤ºæ‰«æäº†16086è¡Œæ•°æ®;</li><li>filteredå€¼ä¸º100 è¡¨ç¤ºè¿›è¡Œäº†å®Œæ•´å…¨è¡¨æ‰«æ;</li></ul><p>æ˜¾ç„¶å½“paymentæ•°æ®é‡å¾ˆå¤§æ—¶å°±ä¼šæ¶ˆè€—æ›´å¤šçš„IO, ä»è€Œä¼šæ‹–æ…¢æœåŠ¡å™¨çš„æ€§èƒ½;</p><p>é€šå¸¸æƒ…å†µä¸‹ æ˜¯å¯¹è¿™ä¸ªå­—æ®µå»ºç«‹ç´¢å¼•, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;create index idx_paydate on payment(payment_date);</span><br><span class="line">Query OK, 0 rows affected (0.11 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;explain select max(payment_date) from payment \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: NULL</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: NULL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: NULL</span><br><span class="line">     filtered: NULL</span><br><span class="line">        Extra: <span class="keyword">Select</span> <span class="keyword">tables</span> optimized away</span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>é€šè¿‡å»ºç«‹ç´¢å¼•å, å¯ä»¥çœ‹åˆ°æŸ¥è¯¢ç±»å‹ä¸åœ¨æ˜¯All, åŒæ—¶Extra è¡¨ç¤ºä¸º Select tables optimized away, è¡¨ç¤ºä¸éœ€è¿›è¡Œè¡¨çš„æ“ä½œå°±å¯ä»¥å®ŒæˆæŸ¥è¯¢, å› ä¸ºç´¢å¼•æ˜¯æŒ‰é¡ºåºæ’åºçš„, é€šè¿‡ç´¢å¼•å°±å¯ä»¥çŸ¥é“payment_dateæœ€åä¸€ä¸ªæ•°æ®å€¼, å› æ­¤å¹¶ä¸éœ€è¦è¿›è¡Œè¡¨çš„æ“ä½œ, å¤§å¤§ä¼˜åŒ–äº†æ‰§è¡Œæ•ˆç‡, åŒæ—¶å°½å¯èƒ½å¤§çš„å‡å°‘IOæ“ä½œ, è¿™ç§æƒ…å†µä¸‹ä¸è¿‡payment_dateçš„æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„, ä¸ç®¡å®ƒçš„æ•°æ®é‡æœ‰å¤šå¤§, å®ƒçš„æ‰§è¡Œæ•ˆç‡åŸºæœ¬æ˜¯æ’å®šçš„;</p><p>æ‰€ä»¥åƒMax()å‡½æ•°è¿™ç±»çš„æ“ä½œä¼˜åŒ–çš„æ€è·¯ä¹‹ä¸€å°±æ˜¯ä¸ºå­—æ®µå»ºç«‹ç´¢å¼•æ¥è¿›è¡Œä¼˜åŒ–;</p><h2 id="Count-å‡½æ•°ä¼˜åŒ–"><a href="#Count-å‡½æ•°ä¼˜åŒ–" class="headerlink" title="Count()å‡½æ•°ä¼˜åŒ–"></a>Count()å‡½æ•°ä¼˜åŒ–</h2><p>é—®é¢˜: åœ¨ä¸€æ¡SQLä¸­åŒæ—¶æŸ¥å‡º2006å¹´å’Œ2007å¹´ç”µå½±çš„æ•°é‡</p><p>æ–¹å¼ä¸€</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(release_year=<span class="string">'2006'</span> <span class="keyword">OR</span> release_year=<span class="string">'2007'</span>) <span class="keyword">FROM</span> film;</span><br></pre></td></tr></table></figure><p>æ–¹å¼äºŒ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> film <span class="keyword">WHERE</span> release_year=<span class="string">'2006'</span> <span class="keyword">AND</span> release_year=<span class="string">'2007'</span>;</span><br></pre></td></tr></table></figure><p>æ–¹å¼ä¸€æ— æ³•åŒºåˆ†2006å’Œ2007çš„ç”µå½±æ•°é‡;<br>æ–¹å¼äºŒrelease_yearå€¼ä¸å­˜åœ¨åŒæ—¶ä¸º2006å’Œ2007çš„æƒ…å†µ;</p><p>æ˜¾ç„¶æ–¹å¼ä¸€äºŒéƒ½æ— æ³•æ»¡è¶³éœ€æ±‚, åˆç†çš„æ–¹å¼æ˜¯, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;select</span><br><span class="line">    -&gt; count(release_year='2006' OR NULL) AS '2006å¹´ç”µå½±æ•°é‡',</span><br><span class="line">    -&gt; count(release_year='2007' OR NULL) AS '2007å¹´ç”µå½±æ•°é‡'</span><br><span class="line">    -&gt; from film \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">2006å¹´ç”µå½±æ•°é‡: 1000</span><br><span class="line">2007å¹´ç”µå½±æ•°é‡: 0</span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure><p>é—®é¢˜ä¸€: count()å‡½æ•°å‚æ•°é‡Œé¢æ˜¯ç”¨æ˜Ÿå·(*)å·å¥½è¿˜æ˜¯ç”¨åˆ—åå¥½? </p><p>è¯´æ˜ count()å‡½æ•°å‚æ•°ç”¨æ˜Ÿå·å’Œåˆ—ååˆ†åˆ«æŸ¥è¯¢çš„ç»“æœ æœ‰æ—¶å€™æ˜¯ä¸ä¸€æ ·çš„, éœ€è¦æ³¨æ„,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;create table tbtest(id int, name char(20));</span><br><span class="line">Query OK, 0 rows affected (0.09 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;insert tbtest values(1, 'Tom'), (2,NULL);</span><br><span class="line">Query OK, 2 rows affected (0.08 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;select count(*), count(id), count(name) from tbtest;</span><br><span class="line">+<span class="comment">----------+-----------+-------------+</span></span><br><span class="line">| count(*) | count(id) | count(name) |</span><br><span class="line">+<span class="comment">----------+-----------+-------------+</span></span><br><span class="line">|        2 |         2 |           1 |</span><br><span class="line">+<span class="comment">----------+-----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹è¯´æ˜count(*)æ˜¯æŒ‡å­˜åœ¨çš„å…·ä½“æ•°æ®è¡Œæ•°, è€Œcount(åˆ—å)æ˜¯æŒ‡è¿™åˆ—å€¼ä¸ä¸ºNULLçš„è¡Œæ•°; </p><p>åŒæ—¶è¦æ³¨æ„ count(release_year=â€™2007â€™ OR NULL) åé¢çš„<code>OR NULL</code> è¿™ä¸ªè¡¨ç¤ºå½“å‰é¢çš„æŸ¥è¯¢ä¸å­˜åœ¨æ—¶è¿”å›NULL,<br>å¦‚æœç›´æ¥å†™æˆcount(relase_year=â€™2007â€™) é‚£å½“ä¸å­˜åœ¨â€™2007â€™çš„æ¡ä»¶å€¼æ—¶ è¿”å›çš„ç»“æœæ˜¯count(*)çš„å€¼;</p><p>ä¸‹é¢é€šè¿‡ç¤ºä¾‹è¿›ä¸€æ­¥åˆ†æ, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;create table tb19(name char(20), age tinyint unsigned);</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;insert tb19 values('Tom',19), ('Mike',20),</span><br><span class="line">    -&gt; ('jack',NULL), ('jason',19), ('oliva',19), ('reminer',20);</span><br><span class="line">Query OK, 5 rows affected (0.07 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;select</span><br><span class="line">    -&gt; count(*),</span><br><span class="line">    -&gt; count(age=19),</span><br><span class="line">    -&gt; count(age=19 OR NULL),</span><br><span class="line">    -&gt; count(age=21),</span><br><span class="line">    -&gt; count(age=21 OR NULL),</span><br><span class="line">    -&gt; count(name),</span><br><span class="line">    -&gt; count(age)</span><br><span class="line">    -&gt; from tb19 \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             count(*): 6</span><br><span class="line">        count(age=19): 5</span><br><span class="line">count(age=19 OR NULL): 3</span><br><span class="line">        count(age=21): 5</span><br><span class="line">count(age=21 OR NULL): 0</span><br><span class="line">          count(name): 6</span><br><span class="line">           count(age): 5</span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>count(*) è¿”å›æ•°æ®è¡¨ä¸­å½“å‰çš„æ•°æ®è¡Œæ•°;</li><li>count(age =19) ç›¸å½“äºcount(age), å³ä¸ç®¡count(age= N) éƒ½ç›¸å½“äºcount(age)çš„è¿”å›å€¼,count(age)è®¡ç®—è¿™åˆ—ä¸ä¸ºNULLçš„è®°å½•ä¹‹å’Œ; </li><li>count(age =19 OR NULL) è¡¨ç¤ºåªæœ‰age=19æ¡ä»¶æ—¶æ‰å‚ä¸ç»“æœç»Ÿè®¡, age=NULLæˆ–å…¶å®ƒå€¼å‡ä¸å‚ä¸ç»“æœç»Ÿè®¡;</li><li>count(age=21)  ä¸count(age) å€¼ç›¸åŒ;</li><li>count(åˆ—å) å³ç»Ÿè®¡è¯¥åˆ—å€¼ä¸ä¸ºNULLçš„è®°å½•æ€»æ•°;</li></ul><h2 id="å­æŸ¥è¯¢ä¼˜åŒ–"><a href="#å­æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="å­æŸ¥è¯¢ä¼˜åŒ–"></a>å­æŸ¥è¯¢ä¼˜åŒ–</h2><p>é€šå¸¸æƒ…å†µä¸‹, éœ€è¦æŠŠå­æŸ¥è¯¢ä¼˜åŒ–ä¸ºjoinæŸ¥è¯¢, ä½†æ˜¯åœ¨ä¼˜åŒ–æ—¶è¦æ³¨æ„å…³è”é”®æ˜¯å¦æœ‰ä¸€å¯¹å¤šçš„å…³ç³», éœ€è¦æ³¨æ„é‡å¤æ•°æ®;</p><h3 id="1å¯¹å¤šå…³ç³»å¸¦æ¥çš„é‡å¤æ•°æ®é—®é¢˜"><a href="#1å¯¹å¤šå…³ç³»å¸¦æ¥çš„é‡å¤æ•°æ®é—®é¢˜" class="headerlink" title="1å¯¹å¤šå…³ç³»å¸¦æ¥çš„é‡å¤æ•°æ®é—®é¢˜"></a>1å¯¹å¤šå…³ç³»å¸¦æ¥çš„é‡å¤æ•°æ®é—®é¢˜</h3><p>å…³äºæ•°æ®é‡å¤é—®é¢˜ç¤ºä¾‹, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;create table t(id int);</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;create table t1(tid int);</span><br><span class="line">Query OK, 0 rows affected (0.07 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;insert t values(1);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;insert t1 values(1), (1);</span><br><span class="line">Query OK, 2 row affected (0.07 sec)</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢tè¡¨id, è¦æ±‚tè¡¨idæ˜¯t1è¡¨ä¸­çš„tidçš„å€¼èŒƒå›´;</p><p>å­æŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;select * from t where t.id in (select t1.tid from t1);</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| id   |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|    1 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºè¿æ¥æŸ¥è¯¢, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;select t.id id from t inner join t1 on t.id = t1.tid;</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| id   |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|    1 |</span><br><span class="line">|    1 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>å› ä¸ºt.id ä¸t1.tidå­˜åœ¨1å¯¹å¤šçš„å…³ç³», æ‰€ä»¥ç”¨è¿æ¥æŸ¥è¯¢å‡ºç°äº†é‡å¤æ•°æ®é—®é¢˜, é‚£æ­¤æ—¶å°±éœ€è¦é€šè¿‡distinctæ¥å¤„ç†é‡å¤é—®é¢˜;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;select distinct t.id id from t inner join t1 on t.id = t1.tid;</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">| id   |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">|    1 |</span><br><span class="line">+<span class="comment">------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><h3 id="å®ä¾‹åˆ†æ"><a href="#å®ä¾‹åˆ†æ" class="headerlink" title="å®ä¾‹åˆ†æ"></a>å®ä¾‹åˆ†æ</h3><p>é—®é¢˜: æŸ¥è¯¢sandraå‡ºæ¼”çš„æ‰€æœ‰å½±ç‰‡</p><p>å­æŸ¥è¯¢,</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;select title, release_year, length</span><br><span class="line">    -&gt; from film</span><br><span class="line">    -&gt; where film_id in (</span><br><span class="line">    -&gt; select film_id from film_actor where actor_id in (</span><br><span class="line">    -&gt; select actor_id from actor where first_name = 'sandra'));</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸ºè¿æ¥æŸ¥è¯¢,</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select title, release_year, length</span><br><span class="line">    -&gt; from film</span><br><span class="line">    -&gt; join film_actor fa on film.film_id = fa.film_id</span><br><span class="line">    -&gt; join actor a on fa.actor_id = a.actor_id where a.first_name = 'sandra';</span><br></pre></td></tr></table></figure><p>å­æŸ¥è¯¢ä¸è¿æ¥æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’å¯¹æ¯”,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select title, release_year, length</span><br><span class="line">    -&gt; from film</span><br><span class="line">    -&gt; where film_id in (</span><br><span class="line">    -&gt; select film_id from film_actor where actor_id in (</span><br><span class="line">    -&gt; select actor_id from actor where first_name = 'sandra'));</span><br><span class="line">+<span class="comment">----+--------------+-------------+------------+--------+------------------------+---------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type  | table       | partitions | type   | possible_keys          | key     | key_len | ref                   | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+--------------+-------------+------------+--------+------------------------+---------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE       | &lt;subquery2&gt; | NULL       | ALL    | NULL                   | NULL    | NULL    | NULL                  | NULL |   100.00 | NULL        |</span><br><span class="line">|  1 | SIMPLE       | film        | NULL       | eq_ref | PRIMARY                | PRIMARY | 2       | &lt;subquery2&gt;.film_id   |    1 |   100.00 | NULL        |</span><br><span class="line">|  2 | MATERIALIZED | actor       | NULL       | ALL    | PRIMARY                | NULL    | NULL    | NULL                  |  200 |    10.00 | Using where |</span><br><span class="line">|  2 | MATERIALIZED | film_actor  | NULL       | ref    | PRIMARY,idx_fk_film_id | PRIMARY | 2       | sakila.actor.actor_id |   27 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+--------------+-------------+------------+--------+------------------------+---------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;<span class="keyword">explain</span> <span class="keyword">select</span> title, release_year, <span class="keyword">length</span></span><br><span class="line">    -&gt; <span class="keyword">from</span> film</span><br><span class="line">    -&gt; <span class="keyword">join</span> film_actor fa <span class="keyword">on</span> film.film_id = fa.film_id</span><br><span class="line">    -&gt; <span class="keyword">join</span> actor a <span class="keyword">on</span> fa.actor_id = a.actor_id <span class="keyword">where</span> a.first_name = <span class="string">'sandra'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type   | possible_keys          | key     | key_len | ref               | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | a     | NULL       | ALL    | PRIMARY                | NULL    | NULL    | NULL              |  200 |    10.00 | Using where |</span><br><span class="line">|  1 | SIMPLE      | fa    | NULL       | ref    | PRIMARY,idx_fk_film_id | PRIMARY | 2       | sakila.a.actor_id |   27 |   100.00 | Using index |</span><br><span class="line">|  1 | SIMPLE      | film  | NULL       | eq_ref | PRIMARY                | PRIMARY | 2       | sakila.fa.film_id |    1 |   100.00 | NULL        |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+--------+------------------------+---------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>åŒå¯¹æ¯”ä¸­å¯ä»¥ä¼˜åŒ–åçš„è¿æ¥æŸ¥è¯¢æ¯”å­æŸ¥è¯¢è¦å°‘è¿›è¡Œä¸€æ¬¡å­æŸ¥è¯¢å¼•å‘çš„å…¨è¡¨æ‰«ææŸ¥è¯¢æ“ä½œ, å¦‚æœæ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™, ä¼˜åŒ–æ•ˆæœå°†ç°å¸¸æ˜æ˜¾;</li></ul><h2 id="group-byä¼˜åŒ–"><a href="#group-byä¼˜åŒ–" class="headerlink" title="group byä¼˜åŒ–"></a>group byä¼˜åŒ–</h2><p>å¯¹å…³è”ä¸­çš„æŸä¸€åˆ—è¿›è¡Œgroup by æ—¶, å°½é‡é€‰ç”¨æ¥è‡ªåŒä¸€å¼ è¡¨çš„åˆ—è¿›è¡Œgroup by æ“ä½œ;</p><p>é—®é¢˜: æŸ¥è¯¢æ¯ä¸ªæ¼”å‘˜æ‰€å‚æ¼”çš„å½±ç‰‡çš„æ•°é‡</p><p>æŸ¥è¯¢è¯­å¥, </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> actor.first_name, actor.last_name, <span class="keyword">count</span>(*) <span class="keyword">from</span> sakila.film_actor </span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> sakila.actor <span class="keyword">using</span>(actor_id) <span class="keyword">group</span> <span class="keyword">by</span> film_actor.actor_id;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè®¡åˆ’,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select actor.first_name, actor.last_name, count(*)</span><br><span class="line">    -&gt; from film_actor</span><br><span class="line">    -&gt; join actor using(actor_id)</span><br><span class="line">    -&gt; group by film_actor.actor_id;</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+------------------------+---------+---------+-----------------------+------+----------+-----------------+</span></span><br><span class="line">| id | select_type | table      | partitions | type | possible_keys          | key     | key_len | ref                   | rows | filtered | Extra           |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+------------------------+---------+---------+-----------------------+------+----------+-----------------+</span></span><br><span class="line">|  1 | SIMPLE      | actor      | NULL       | ALL  | PRIMARY                | NULL    | NULL    | NULL                  |  200 |   100.00 | Using temporary |</span><br><span class="line">|  1 | SIMPLE      | film_actor | NULL       | ref  | PRIMARY,idx_fk_film_id | PRIMARY | 2       | sakila.actor.actor_id |   27 |   100.00 | Using index     |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+------------------------+---------+---------+-----------------------+------+----------+-----------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ‰§è¡Œè®¡åˆ’ä¸­å°†ç”¨åˆ°ä¸´æ—¶è¡¨æ¥æ”¯æŒæŸ¥è¯¢æ“ä½œ, é‚£ä¹ˆæœ€å¥½å¯¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥è¿›è¡Œæ”¹å†™, å°½é‡é¿å…ä½¿ç”¨ä¸´æ—¶è¡¨æ¥è¿›è¡Œæ“ä½œ, </p><p>æ”¹å†™åçš„æŸ¥è¯¢è¯­å¥,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> actor.first_name, actor.last_name, c.cnt</span><br><span class="line"><span class="keyword">from</span> actor </span><br><span class="line"><span class="keyword">join</span> (<span class="keyword">select</span> actor_id, <span class="keyword">count</span>(*) <span class="keyword">as</span> cnt <span class="keyword">from</span> film_actor <span class="keyword">group</span> <span class="keyword">by</span> actor_id) <span class="keyword">as</span> c <span class="keyword">using</span>(actor_id);</span><br></pre></td></tr></table></figure><ul><li>using(id) ç­‰ä»·äº on actor.actor_id = c.actor_idçš„æ„æ€;</li></ul><p>å¯¹æ¯”æ‰§è¡Œè®¡åˆ’</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select actor.first_name, actor.last_name, c.cnt</span><br><span class="line">    -&gt; from actor</span><br><span class="line">    -&gt; inner join (</span><br><span class="line">    -&gt; select actor_id, count(*) as cnt from film_actor group by actor_id</span><br><span class="line">    -&gt; ) as c using(actor_id);</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+------------------------+-------------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table      | partitions | type  | possible_keys          | key         | key_len | ref                   | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+------------------------+-------------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY     | actor      | NULL       | ALL   | PRIMARY                | NULL        | NULL    | NULL                  |  200 |   100.00 | NULL        |</span><br><span class="line">|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ref   | &lt;auto_key0&gt;            | &lt;auto_key0&gt; | 2       | sakila.actor.actor_id |   27 |   100.00 | NULL        |</span><br><span class="line">|  2 | DERIVED     | film_actor | NULL       | index | PRIMARY,idx_fk_film_id | PRIMARY     | 4       | NULL                  | 5462 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+------------------------+-------------+---------+-----------------------+------+----------+-------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><ul><li>å¯è§ä¼˜åŒ–å å°±ä¸éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ¥è¾…åŠ©æŸ¥è¯¢æ“ä½œäº†; </li><li>åœ¨ä¸Šè¿°è¯­å¥ä¸­æ˜¯å…ˆé€šè¿‡å­æŸ¥è¯¢æŸ¥è¯¢åˆ°æ¼”å‘˜åŠå…¶å‚æ¼”ç”µå½±æ•°é‡ç„¶åé€šè¿‡è¿æ¥æŸ¥è¯¢è¿æ¥æ¼”å‘˜çš„åŸºæœ¬ä¿¡æ¯, è¿™å°±æ˜¯è¯´ å­æŸ¥è¯¢å¯ä»¥é€šè¿‡ä¿®æ”¹ä¸ºè¿æ¥æŸ¥è¯¢æ¥è¿›ä¸€æ­¥ä¼˜åŒ–, é‚£æœ‰æ—¶å€™æœ‰å¯èƒ½åœ¨è¿æ¥æŸ¥è¯¢ä¸­åº”ç”¨å­æŸ¥è¯¢æ¥æé«˜æŸ¥è¯¢æ•ˆç‡, å…·ä½“ä¼˜åŒ–æ—¶åº”æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œçµæ´»åº”ç”¨;</li></ul><h2 id="limitæŸ¥è¯¢ä¼˜åŒ–"><a href="#limitæŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="limitæŸ¥è¯¢ä¼˜åŒ–"></a>limitæŸ¥è¯¢ä¼˜åŒ–</h2><p>limitå¸¸ç”¨äºåˆ†é¡µå¤„ç†, æ—¶å¸¸ä¼šä¼´éšorder by ä»å¥ä½¿ç”¨, å› æ­¤å¤§å¤šæ—¶å€™ä¼šä½¿ç”¨filesorts, è¿™æ ·ä¼šé€ æˆå¤§é‡IOé—®é¢˜;</p><p>é—®é¢˜: è·å–å½±ç‰‡ä¿¡æ¯,</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> film_id, description <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> title <span class="keyword">limit</span> <span class="number">50</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure><p>ä¼˜åŒ–1,</p><p>ä½¿ç”¨æœ‰ç´¢å¼•çš„åˆ—æˆ–ä¸»é”®è¿›è¡ŒOrder by æ“ä½œ;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select film_id, description from film order by title limit 50, 5 \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: film</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 1000</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using filesort</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">dev@sakila&gt;<span class="keyword">explain</span> <span class="keyword">select</span> film_id, description <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> film_id <span class="keyword">limit</span> <span class="number">50</span>, <span class="number">5</span> \G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">           <span class="keyword">id</span>: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: film</span><br><span class="line">   <span class="keyword">partitions</span>: <span class="literal">NULL</span></span><br><span class="line">         <span class="keyword">type</span>: <span class="keyword">index</span></span><br><span class="line">possible_keys: <span class="literal">NULL</span></span><br><span class="line">          <span class="keyword">key</span>: PRIMARY</span><br><span class="line">      key_len: <span class="number">2</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="literal">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">55</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="literal">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">select</span> film_id, description <span class="keyword">from</span> film <span class="keyword">order</span> <span class="keyword">by</span> film_id <span class="keyword">limit</span> <span class="number">50</span>, <span class="number">5</span>;</span><br></pre></td></tr></table></figure><ul><li>ä¼˜åŒ–å‰éœ€è¦ç”¨åˆ°filesortæ’åº, å°†order by å­—æ®µä¿®æ”¹ä¸ºç´¢å¼•çš„åˆ—æˆ–ä¸»é”®å, å°±ä¸éœ€è¦é¢å¤–çš„filesortæ’åº, ä»è€Œå¯ä»¥å‡å°‘å¾ˆå¤šIOæ“ä½œ;</li></ul><p>ä¸Šè¿°ä¼˜åŒ–å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ å½“è¡¨ä¸­æ•°æ®é‡å¾ˆå¤§æ—¶, è¦æ‰«æçš„è¡Œæ•°ä¹Ÿéšä¹‹å¢å¤§, é‚£å°±éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–,</p><p>ä¼˜åŒ–2,</p><p>è®°å½•ä¸Šæ¬¡è¿”å›çš„ä¸»é”®, åœ¨ä¸‹æ¬¡æŸ¥è¯¢æ—¶ä½¿ç”¨ä¸»é”®è¿‡æ»¤, ä»è€Œå¯ä»¥é¿å…æ•°æ®é‡å¤§æ—¶æ‰«æè¿‡å¤šçš„è®°å½•;</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dev@sakila&gt;explain select film_id, description from film where film_id &gt; 55 and film_id &lt;= 60 order by film_id limit 1, 5 \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: film</span><br><span class="line">   partitions: NULL</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 2</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 5</span><br><span class="line">     filtered: 100.00</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¼˜åŒ–å, å¯ä»¥çœ‹åˆ°è¦æ‰«æçš„è¡Œæ•°å°±æ˜¯è¦æŸ¥è¯¢çš„è¡Œæ•°é‡, ä»è€Œå¯ä»¥é¿å…æ•°æ®é‡å¾ˆå¤§æ—¶è¦æŸ¥è¯¢é åçš„æ•°æ®å¼•å‘æ‰«æå¤šè¡Œçš„é—®é¢˜;</p><p>å½“ç„¶ä¸Šè¿°ä¼˜åŒ–æœ‰ä¸€ä¸ªé™åˆ¶, å°±æ˜¯è¦æ±‚ä¸»é”®æ˜¯è¿ç»­çš„ï¼Œ å¦‚æœä¸»é”®åœ¨ä¸­é—´æ˜¯ä¸è¿ç»­çš„é‚£æŒ‰ç…§ä¸Šè¿°ä¼˜åŒ–, æœ‰å¯èƒ½whereå­æŸ¥è¯¢è¿”å›çš„æ¡æ•°ä¸å¤Ÿè¦æŸ¥è¯¢çš„æ¡æ•°;</p><p>ä¸Šè¿°ä¸¤ä¸ªä¼˜åŒ–çš„æ€æƒ³å°±æ˜¯ä¼˜åŒ–è¿‡å¤šçš„æ‰«æå¸¦æ¥çš„IOæ¶ˆè€—;</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>ç®€è¦æ¦‚è¿°äº†ä¼˜åŒ–çš„ç›®çš„åŠæ–¹å‘;</li><li>å¯¹æ…¢æŸ¥æ—¥å¿—çŸ¥è¯†è¿›è¡Œå›é¡¾å¹¶é€šè¿‡å®ä¾‹å®è·µæ·±å…¥äº†è§£å­¦ä¹ æ…¢æŸ¥æ—¥å¿—åˆ†ææ¥å‘ç°å­˜åœ¨æ•ˆç‡çš„SQL;</li><li>å¯¹max()å‡½æ•°åœºæ™¯è¿›è¡Œä¼˜åŒ–, å®ä¾‹åˆ†æmax()å‡½æ•°åœºæ™¯ä¼˜åŒ–å‰åçš„æ‰§è¡Œè®¡åˆ’;</li><li>å¯¹count()å‡½æ•°åœºæ™¯è¿›è¡Œä¼˜åŒ–, å¹¶å®ä¾‹åˆ†æcount()å‡½æ•°ä¼˜åŒ–çš„æ‰§è¡Œè®¡åˆ’;</li><li>å›é¡¾å­æŸ¥è¯¢ç›¸å…³çŸ¥è¯†å¹¶å®ä¾‹åˆ†æå­æŸ¥è¯¢ä¼˜åŒ–è¿‡ç¨‹;</li><li>å¯¹group byåŠlimitæŸ¥è¯¢è¿›è¡Œå®ä¾‹åˆ†æä¼˜åŒ–è¿‡ç¨‹, æ€»ç»“å‡ºå…¶é€‚ç”¨çš„åœºæ™¯åŠä½¿ç”¨æ—¶åº”æ³¨æ„çš„é™åˆ¶çº§é—®é¢˜;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸ºåº”ç”¨æœåŠ¡æä¾›ç¨³å®šçš„æ•°æ®CURDæœåŠ¡,åŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥æå‡CURDæ€§èƒ½åŠæ½œåœ¨çš„é—®é¢˜, å°±éœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µåŠæ•°æ®ä½“é‡è¿›è¡Œæ•°æ®åº“ä¼˜åŒ–ä¿®è®¢å·¥ä½œ, å…³äºæ•°æ®åº“ä¼˜åŒ–çš„æ“ä½œå¯ä»¥ä»å¤šä¸ªæ–¹é¢æ¥æ€»ç»“å½’çº³, å¦‚å¯¹SQLè¯­å¥çš„ä¼˜åŒ–, ç´¢å¼•çš„ä¼˜åŒ–, è¡¨ç»“æ„çš„ä¼˜åŒ–, é…ç½®çš„ä¼˜åŒ–ç­‰ç­‰; æœ¬æ–‡ä»æ€»ç»“å®è·µç»éªŒåŠå½’çº³å›é¡¾çŸ¥è¯†è¦ç‚¹çš„è§’åº¦æ¥æ¢è®¨å…³äºSQLè¯­å¥ä¼˜åŒ–çš„ç›¸å…³é—®é¢˜;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysqlä¸“é¢˜" scheme="http://researchlab.github.io/categories/mysql%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="mysql" scheme="http://researchlab.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸“é¢˜12 æ•°æ®åº“è¡¨ç‰©ç†è®¾è®¡ç³»åˆ—é—®é¢˜</title>
    <link href="http://researchlab.github.io/2018/10/05/mysql-12-database-physical-design/"/>
    <id>http://researchlab.github.io/2018/10/05/mysql-12-database-physical-design/</id>
    <published>2018-10-05T18:59:22.000Z</published>
    <updated>2019-08-24T14:25:55.678Z</updated>
    
    <content type="html"><![CDATA[<p>æ•°æ®åº“éœ€æ±‚åˆ†æåŠé€»è¾‘è®¾è®¡ä»…ä»…æ˜¯å°†æ•°æ®åŠæ•°æ®å®ä½“ä¹‹é—´çš„å…³ç³»ç†æ¸…æ¥šäº†, æœ€ç»ˆç›®çš„æ˜¯å»ºç«‹åˆé€‚çš„æ•°æ®åº“è¡¨ç»“æ„; åœ¨æ•°æ®åº“è®¾è®¡ç¯èŠ‚ä¸­çš„ç‰©ç†è®¾è®¡çš„é‡è¦å·¥ä½œå°±æ˜¯å»ºç«‹æ•°æ®åº“è¡¨ç»“æ„;<br><a id="more"></a></p><h2 id="ç‰©ç†è®¾è®¡"><a href="#ç‰©ç†è®¾è®¡" class="headerlink" title="ç‰©ç†è®¾è®¡"></a>ç‰©ç†è®¾è®¡</h2><ul><li>é€‰æ‹©åˆé€‚çš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(Mysqlã€Oracle, PgSQLç­‰);</li><li>å®šä¹‰æ•°æ®åº“, è¡¨åŠå­—æ®µçš„å‘½åè§„èŒƒ;</li><li>æ ¹æ®æ‰€é€‰çš„DBMSç³»ç»Ÿé€‰æ‹©åˆé€‚çš„å­—æ®µç±»å‹;</li><li>åèŒƒå¼åŒ–è®¾è®¡(å®é™…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šè®¾è®¡å†—ä½™æ•°æ®æ¥æ¢æ•ˆç‡, å³ç”¨ç©ºé—´æ¢æ—¶é—´)</li></ul><p>é€‰æ‹©åˆé€‚çš„æ•°æ®åº“ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ï¼Œ ä¸€èˆ¬è€Œè¨€å¯ä»¥ä»æˆæœ¬, åŠŸèƒ½ï¼Œåœºæ™¯ç­‰æ–¹é¢è¿›è¡Œè€ƒè™‘</p><ul><li><p>æˆæœ¬<br>å•†ä¸šæ•°æ®åº“(Oracle, SQLServer)éœ€è¦æ”¯æŒå•†ä¸šæˆæœ¬; è€Œå¼€æºæ•°æ®åº“(MySQL, PgSQL) åªè¦ç¬¦åˆç¤¾åŒºåè®®åˆ™å¯å…è´¹ä½¿ç”¨;</p></li><li><p>åŠŸèƒ½<br>å¦‚æœéœ€è¦ç»å¸¸è¿›è¡Œæ¯”è¾ƒå¤§çš„äº‹åŠ¡æ“ä½œ åˆ™ä½¿ç”¨Oracleæ›´åˆé€‚, å› ä¸ºOracleç›¸æ¯”å…¶ä»–æ•°æ®åº“,å…¶äº‹åŠ¡æ‰§è¡Œå¼€é”€æˆæœ¬è¦ä½;</p></li><li><p>åœºæ™¯<br>äº’è”ç½‘é¡¹ç›®ä¸€èˆ¬ä¼šé€‰æ‹©å¼€æºæ•°æ®åº“(MySQl, PgSQL), è€Œä¼ä¸šçº§é¡¹ç›®ä¸€èˆ¬å€¾å‘äºå•†ä¸šæ•°æ®åº“(Oracle, SQLServer)</p></li></ul><h2 id="è¡¨åŠå­—æ®µçš„å‘½ä»¤è§„åˆ™"><a href="#è¡¨åŠå­—æ®µçš„å‘½ä»¤è§„åˆ™" class="headerlink" title="è¡¨åŠå­—æ®µçš„å‘½ä»¤è§„åˆ™"></a>è¡¨åŠå­—æ®µçš„å‘½ä»¤è§„åˆ™</h2><p>æ‰€æœ‰å¯¹è±¡å‘½ååº”è¯¥éµå¾ªä»¥ä¸‹åŸåˆ™:</p><ol><li><p>å¯è¯»æ€§åŸåˆ™<br>ä½¿ç”¨å¤§å†™å’Œå°å†™æ¥æ ¼å¼åŒ–çš„åº“å¯¹è±¡åå­—ä»¥è·å¾—è‰¯å¥½çš„å¯è¯»æ€§;ä¾‹å¦‚ä½¿ç”¨CustAddressè€Œä¸æ˜¯custaddressæ¥æé«˜å¯è¯»æ€§;</p></li><li><p>è¡¨æ„æ€§åŸåˆ™<br>å¯¹è±¡çš„åå­—åº”è¯¥èƒ½æè¿°å®ƒæ‰€æ ‡è¯†çš„å¯¹è±¡; ä¾‹å¦‚å¯¹äºè¡¨, è¡¨çš„åç§°åº”è¯¥èƒ½ä½“ç°è¡¨ä¸­å­˜å‚¨çš„æ•°æ®å†…å®¹; å¯¹äºå­˜å‚¨è¿‡ç¨‹, å­˜å‚¨è¿‡ç¨‹åç§°åº”è¯¥èƒ½å¤Ÿä½“ç°å­˜å‚¨è¿‡ç¨‹çš„åŠŸèƒ½;</p></li><li><p>é•¿ååŸåˆ™<br>å°½å¯èƒ½å°‘ä½¿ç”¨æˆ–è€…ä¸ä½¿ç”¨ç¼©å†™; å› ä¸ºç¼©å†™æœ‰å¯èƒ½å­˜åœ¨æ­§ä¹‰;</p></li></ol><h2 id="å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™"><a href="#å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™" class="headerlink" title="å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™"></a>å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™</h2><p>åˆ—çš„æ•°æ®ç±»å‹ä¸€æ–¹é¢å½±å“æ•°æ®å­˜å‚¨ç©ºé—´çš„å¼€é”€, å¦ä¸€æ–¹é¢ä¹Ÿä¼šå½±å“æ•°æ®æŸ¥è¯¢æ€§èƒ½; å½“ä¸€ä¸ªåˆ—å¯ä»¥é€‰æ‹©å¤šç§æ•°æ®ç±»å‹æ—¶, åº”è¯¥ä¼˜å…ˆè€ƒè™‘æ•°å­—ç±»å‹, å…¶æ¬¡æ˜¯æ—¥æœŸæˆ–äºŒè¿›åˆ¶ç±»å‹, æœ€åæ˜¯å­—ç¬¦ç±»å‹;  å¯¹äºç›¸åŒçº§åˆ«çš„æ•°æ®ç±»å‹, åº”è¯¥ä¼˜å…ˆé€‰æ‹©å ç”¨ç©ºé—´å°çš„æ•°æ®ç±»å‹;</p><p>ç¤ºä¾‹</p><p>birthday å­—æ®µå¯é€‰æ‹©å¦‚ä¸‹å››ç§ç±»å‹,<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Int: 257529600 # æ—¶é—´æˆ³</span><br><span class="line">Datetime: 1978-03-01 #æ—¶é—´ç±»å‹</span><br><span class="line">varchar(20): '1978-03-01' å˜é•¿å­—ç¬¦ç±»å‹</span><br><span class="line">char(10) '1978-03-01' å›ºå®šé•¿åº¦å­—ç¬¦ç±»å‹</span><br></pre></td></tr></table></figure></p><p>æ˜¾ç„¶ä¼˜å…ˆé€‰æ‹©é¡ºåºä¾æ¬¡æ˜¯ æ—¶é—´æˆ³ç±»å‹ &gt; æ—¶é—´ç±»å‹ &gt;  å›ºå®šå­—ç¬¦ç±»å‹ &gt; å˜é•¿å­—ç¬¦ç±»å‹;</p><p>å› ä¸ºbirthday ç±»å‹é•¿åº¦æ¯”è¾ƒå›ºå®š, ä¸”char(10) æ¯”varchar(10)å ç”¨ç©ºé—´å°; </p><table><thead><tr><th style="text-align:left">åˆ—ç±»å‹</th><th style="text-align:left">å­˜å‚¨ç©ºé—´(å•ä½:å­—èŠ‚)</th></tr></thead><tbody><tr><td style="text-align:left"><code>TINYINT</code></td><td style="text-align:left">1</td></tr><tr><td style="text-align:left"><code>SMALLINT</code></td><td style="text-align:left">2</td></tr><tr><td style="text-align:left"><code>MEDIUMINT</code></td><td style="text-align:left">3</td></tr><tr><td style="text-align:left"><code>INT</code></td><td style="text-align:left">4</td></tr><tr><td style="text-align:left"><code>BIGINT</code></td><td style="text-align:left">8</td></tr><tr><td style="text-align:left"><code>DATE</code></td><td style="text-align:left">3</td></tr><tr><td style="text-align:left"><code>DATETIME</code></td><td style="text-align:left">8</td></tr><tr><td style="text-align:left"><code>TIMESTAMP</code></td><td style="text-align:left">4</td></tr><tr><td style="text-align:left"><code>CHAR(M)</code></td><td style="text-align:left">1&lt;=M&lt;=255</td></tr><tr><td style="text-align:left"><code>VARCHAR(M)</code></td><td style="text-align:left">L+1, (å…¶ä¸­ L&lt;=M, 1&lt;=M&lt;=255)</td></tr></tbody></table><p>å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™ä¸»è¦è€ƒè™‘äº†å¦‚ä¸‹ä¸¤æ–¹é¢, </p><p>åœ¨å¯¹æ•°æ®è¿›è¡Œæ¯”è¾ƒ(æŸ¥è¯¢æ¡ä»¶,JOINæ¡ä»¶åŠæ’åº)æ“ä½œæ—¶,</p><p><strong>åŒæ ·çš„æ•°æ®, å­—ç¬¦å¤„ç†å¾€å¾€æ¯”æ•°å­—å¤„ç†æ…¢;</strong> (å­—ç¬¦ä¸²éœ€è¦å‚è€ƒå­—å…¸è¿›è¡Œæ’åº)</p><p>åœ¨æ•°æ®åº“ä¸­, æ•°æ®å¤„ç†ä»¥é¡µä¸ºå•ä½, <strong>åˆ—çš„é•¿åº¦è¶Šå°, åˆ©äºæ€§èƒ½æå‡;</strong> (InnoDBä¸‹é»˜è®¤é¡µé•¿åº¦ä¸º16k)</p><h2 id="æ•°æ®åº“å¦‚ä½•å…·ä½“é€‰æ‹©å­—æ®µç±»å‹"><a href="#æ•°æ®åº“å¦‚ä½•å…·ä½“é€‰æ‹©å­—æ®µç±»å‹" class="headerlink" title="æ•°æ®åº“å¦‚ä½•å…·ä½“é€‰æ‹©å­—æ®µç±»å‹"></a>æ•°æ®åº“å¦‚ä½•å…·ä½“é€‰æ‹©å­—æ®µç±»å‹</h2><h3 id="charä¸varcharçš„é€‰æ‹©"><a href="#charä¸varcharçš„é€‰æ‹©" class="headerlink" title="charä¸varcharçš„é€‰æ‹©"></a>charä¸varcharçš„é€‰æ‹©</h3><p>é€‰æ‹©åŸåˆ™,</p><ol><li><p>å¦‚æœåˆ—ä¸­è¦å­˜å‚¨çš„æ•°æ®é•¿åº¦å·®ä¸å¤šæ˜¯ä¸€è‡´çš„, åˆ™åº”è¯¥è€ƒè™‘ç”¨char; å¦åˆ™åº”è¯¥è€ƒè™‘ç”¨varchar;</p></li><li><p>å¦‚æœåˆ—ä¸­çš„æœ€å¤§æ•°æ®é•¿åº¦å°äº50Byte, åˆ™ä¸€èˆ¬ä¹Ÿè€ƒè™‘ç”¨char (å¦‚æœè¿™ä¸ªåˆ—å¾ˆå°‘ç”¨, åˆ™åŸºäºèŠ‚çœç©ºé—´å’Œå‡å°‘IOçš„è€ƒè™‘, è¿˜æ˜¯å¯ä»¥é€‰æ‹©ç”¨varchar)</p></li><li><p>ä¸€èˆ¬ä¸å®œå®šä¹‰å¤§äº50Byteçš„charç±»å‹åˆ—;</p></li></ol><h3 id="decimalä¸floatçš„é€‰æ‹©"><a href="#decimalä¸floatçš„é€‰æ‹©" class="headerlink" title="decimalä¸floatçš„é€‰æ‹©"></a>decimalä¸floatçš„é€‰æ‹©</h3><p>é€‰æ‹©åŸåˆ™,</p><ol><li><p>decimal ç”¨äºå­˜å‚¨ç²¾ç¡®æ•°æ®, è€Œfloat åªèƒ½ç”¨äºå­˜å‚¨éç²¾ç¡®æ•°æ®; æ•…ç²¾ç¡®æ•°æ®åªèƒ½é€‰æ‹©ç”¨decimalç±»å‹;</p></li><li><p>ç”±äºfloatçš„å­˜å‚¨ç©ºé—´å¼€é”€ä¸€èˆ¬æ¯”decimalå°(ç²¾ç¡®åˆ°7ä½å°æ•°åªéœ€è¦4ä¸ªå­—èŠ‚, è€Œç²¾ç¡®åˆ°15ä½å°æ•°éœ€è¦8ä¸ªå­—èŠ‚) æ•…éç²¾ç¡®æ•°æ®ä¼˜å…ˆé€‰æ‹©floatç±»å‹;</p></li></ol><h3 id="æ—¶é—´ç±»å‹"><a href="#æ—¶é—´ç±»å‹" class="headerlink" title="æ—¶é—´ç±»å‹"></a>æ—¶é—´ç±»å‹</h3><p>é€‰æ‹©åŸåˆ™, </p><ol><li>ä½¿ç”¨intç±»å­˜å‚¨æ—¶é—´å­—æ®µçš„ä¼˜ç¼ºç‚¹,<br>ä¼˜ç‚¹: å­—æ®µé•¿åº¦æ¯”datetimeå°;<br>ç¼ºç‚¹: ä½¿ç”¨ä¸æ–¹ä¾¿, è¦è¿›è¡Œå‡½æ•°è½¬æ¢;<br>é™åˆ¶: åªèƒ½å­˜å‚¨åˆ°2038-1-19 11:14.07 å³2<sup>32</sup>ä¸º2147483648</li></ol><p>2.éœ€è¦å­˜å‚¨çš„æ—¶é—´ç²’åº¦<br>å¹´æœˆæ—¥ æ—¶åˆ†ç§’å‘¨</p><h3 id="å¦‚ä½•é€‰æ‹©ä¸»é”®"><a href="#å¦‚ä½•é€‰æ‹©ä¸»é”®" class="headerlink" title="å¦‚ä½•é€‰æ‹©ä¸»é”®"></a>å¦‚ä½•é€‰æ‹©ä¸»é”®</h3><ol><li><p>åŒºåˆ†ä¸šåŠ¡ä¸»é”®å’Œæ•°æ®åº“ä¸»é”®<br>ä¸šåŠ¡ä¸»é”®ç”¨äºæ ‡è¯†ä¸šåŠ¡æ•°æ®, è¿›è¡Œè¡¨ä¸è¡¨ä¹‹é—´çš„å…³è”;<br>æ•°æ®åº“ä¸»é”®ä¸ºäº†ä¼˜åŒ–æ•°æ®å­˜å‚¨(InnoDBä¼šç”Ÿæˆ6ä¸ªå­—èŠ‚çš„éšå«ä¸»é”®)</p></li><li><p>æ ¹æ®æ•°æ®åº“çš„ç±»å‹, è€ƒè™‘ä¸»é”®æ˜¯å¦è¦é¡ºåºå¢é•¿<br>æœ‰äº›æ•°æ®åº“æ˜¯æŒ‰ä¸»é”®çš„é¡ºåºé€»è¾‘å­˜å‚¨çš„(å¦‚InnoDB);</p></li><li><p>ä¸»é”®çš„å­—æ®µç±»å‹æ‰€å ç©ºé—´è¦å°½å¯èƒ½çš„å°<br>å¯¹äºä½¿ç”¨èšé›†ç´¢å¼•æ–¹å¼å­˜å‚¨çš„è¡¨, æ¯ä¸ªç´¢å¼•åéƒ½ä¼šé™„åŠ ä¸»é”®ä¿¡æ¯;<br>æ•°æ®åº“æ˜¯æŒ‰é¡µæŸ¥è¯¢çš„, æ‰€ä»¥ä¸€é¡µä¸­å­˜åœ¨çš„æ•°æ®ä¹Ÿå¤šçº¦ä¾¿äºæŸ¥è¯¢;</p></li></ol><h2 id="æ•°æ®åº“è®¾è®¡æ³¨æ„äº‹é¡¹"><a href="#æ•°æ®åº“è®¾è®¡æ³¨æ„äº‹é¡¹" class="headerlink" title="æ•°æ®åº“è®¾è®¡æ³¨æ„äº‹é¡¹"></a>æ•°æ®åº“è®¾è®¡æ³¨æ„äº‹é¡¹</h2><h3 id="é¿å…ä½¿ç”¨å¤–é”®çº¦æŸ"><a href="#é¿å…ä½¿ç”¨å¤–é”®çº¦æŸ" class="headerlink" title="é¿å…ä½¿ç”¨å¤–é”®çº¦æŸ"></a>é¿å…ä½¿ç”¨å¤–é”®çº¦æŸ</h3><ol><li><p>é™ä½æ•°æ®å¯¼å…¥çš„æ•ˆç‡; (é«˜å¹¶å‘æ—¶ å»ºè®®ä¸ä½¿ç”¨å¤–é”®çº¦æŸ)</p></li><li><p>å¢åŠ ç»´æŠ¤æˆæœ¬;</p></li><li><p>è™½ç„¶ä¸å»ºè®®ä½¿ç”¨å¤–é”®çº¦æŸ, ä½†æ˜¯ç›¸å…³è”çš„åˆ—ä¸Šä¸€å®šè¦å»ºç«‹ç´¢å¼•;</p></li></ol><h3 id="é¿å…ä½¿ç”¨è§¦å‘å™¨"><a href="#é¿å…ä½¿ç”¨è§¦å‘å™¨" class="headerlink" title="é¿å…ä½¿ç”¨è§¦å‘å™¨"></a>é¿å…ä½¿ç”¨è§¦å‘å™¨</h3><ol><li><p>é™ä½æ•°æ®å¯¼å…¥çš„æ•ˆç‡; (æœ‰äº›å­˜å‚¨å¼•æ“å¯¹è§¦å‘å™¨ä½¿ç”¨çš„æ€»æ•°æ˜¯æœ‰é™çš„)</p></li><li><p>å¯èƒ½ä¼šå‡ºç°æ„æƒ³ä¸åˆ°çš„æ•°æ®å¼‚å¸¸; (å½“é€»è¾‘å˜æ›´å, æ–°é€»è¾‘çš„ä¿®è®¢å¯èƒ½ä¼šå¿½ç•¥åŒæ­¥æ›´æ–°è§¦å‘å™¨è®¾å®šè€Œå¸¦æ¥æ•°æ®å¼‚å¸¸é—®é¢˜);</p></li><li><p>ä½¿ä¸šåŠ¡é€»è¾‘å˜å¾—å¤æ‚;</p></li></ol><h3 id="é¢„ç•™å­—æ®µ"><a href="#é¢„ç•™å­—æ®µ" class="headerlink" title="é¢„ç•™å­—æ®µ"></a>é¢„ç•™å­—æ®µ</h3><ol><li><p>æ— æ³•å‡†ç¡®çš„çŸ¥é“é¢„ç•™å­—æ®µçš„ç±»å‹;</p></li><li><p>æ— æ³•å‡†ç¡®çš„çŸ¥é“é¢„ç•™å­—æ®µä¸­æ‰€å­˜å‚¨çš„å†…å®¹;</p></li><li><p>åæœŸç»´æŠ¤é¢„ç•™å­—æ®µæ‰€è¦çš„æˆæœ¬, åŒå¢åŠ ä¸€ä¸ªå­—æ®µæ‰€éœ€è¦çš„æˆæœ¬æ˜¯ç›¸åŒçš„; </p></li><li><p><strong>ä¸¥ç¦</strong> ä½¿ç”¨é¢„ç•™å­—æ®µ; </p></li></ol><h2 id="åèŒƒå¼åŒ–è¡¨è®¾è®¡"><a href="#åèŒƒå¼åŒ–è¡¨è®¾è®¡" class="headerlink" title="åèŒƒå¼åŒ–è¡¨è®¾è®¡"></a>åèŒƒå¼åŒ–è¡¨è®¾è®¡</h2><h3 id="çŸ¥è¯†å›é¡¾"><a href="#çŸ¥è¯†å›é¡¾" class="headerlink" title="çŸ¥è¯†å›é¡¾"></a>çŸ¥è¯†å›é¡¾</h3><p>åèŒƒå¼åŒ–æ˜¯é’ˆå¯¹èŒƒå¼åŒ–è€Œè¨€, æœ‰æ—¶ä¸ºäº†æ€§èƒ½å’Œè¯»å–æ•ˆç‡çš„è€ƒè™‘è€Œé€‚å½“çš„å¯¹ç¬¬ä¸‰èŒƒå¼çš„è¦æ±‚è¿›è¡Œè¿å, è€Œå……è®¸å­˜åœ¨å°‘é‡çš„æ•°æ®å†—ä½™, æ¢å¥è¯æ¥è¯´åèŒƒå¼åŒ–å°±æ˜¯ä½¿ç”¨ç©ºé—´æ¥æ¢å–æ—¶é—´; </p><h3 id="å®ä¾‹è¯´æ˜"><a href="#å®ä¾‹è¯´æ˜" class="headerlink" title="å®ä¾‹è¯´æ˜"></a>å®ä¾‹è¯´æ˜</h3><p>ç¬¦åˆèŒƒå¼åŒ–è®¾è®¡çš„è¡¨ </p><table><thead><tr><th style="text-align:left">è¡¨å</th><th style="text-align:left">è¡¨å­—æ®µ</th></tr></thead><tbody><tr><td style="text-align:left">ç”¨æˆ·è¡¨</td><td style="text-align:left">ç”¨æˆ·ID, å§“å, ç”µè¯, åœ°å€, é‚®ç¼–</td></tr><tr><td style="text-align:left">è®¢å•è¡¨</td><td style="text-align:left">è®¢å•ID, ç”¨æˆ·ID, ä¸‹å•æ—¶é—´, æ”¯ä»˜ç±»å‹, è®¢å•çŠ¶æ€</td></tr><tr><td style="text-align:left">è®¢å•å•†å“è¡¨</td><td style="text-align:left">è®¢å•ID, å•†å“ID, å•†å“æ•°é‡, å•†å“ä»·æ ¼</td></tr><tr><td style="text-align:left">å•†å“è¡¨</td><td style="text-align:left">å•†å“ID, åç§°, æè¿°, è¿‡æœŸæ—¶é—´</td></tr></tbody></table><p>é—®é¢˜ä¸€,</p><p>æŸ¥è¯¢è®¢å•ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•ID, SUM(c.å•†å“ä»·æ ¼*c.å•†å“æ•°é‡) as è®¢å•ä»·æ ¼</span><br><span class="line">FROM `è®¢å•è¡¨` a</span><br><span class="line">JOIN `ç”¨æˆ·è¡¨` b ON a.ç”¨æˆ·ID = b.ç”¨æˆ·ID</span><br><span class="line">JOIN `è®¢å•å•†å“è¡¨` c ON c.è®¢å•ID = b.è®¢å•ID</span><br><span class="line">GROUP BY b,ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•ID</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢è®¢å•è¯¦æƒ…ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•ID, SUM(c.å•†å“ä»·æ ¼*c.å•†å“æ•°é‡) as è®¢å•ä»·æ ¼, d.åç§° as å•†å“åç§°, c.å•†å“ä»·æ ¼</span><br><span class="line">FROM `è®¢å•è¡¨` a</span><br><span class="line">JOIN `ç”¨æˆ·è¡¨` b ON a.ç”¨æˆ·ID = b.ç”¨æˆ·ID</span><br><span class="line">JOIN `è®¢å•å•†å“è¡¨` c ON c.è®¢å•ID = b.è®¢å•ID</span><br><span class="line">JOIN `å•†å“è¡¨` d on d.å•†å“ID = c.å•†å“ID</span><br></pre></td></tr></table></figure><p>åèŒƒå¼åŒ–çš„å†—ä½™è®¾è®¡</p><table><thead><tr><th style="text-align:left">è¡¨å</th><th style="text-align:left">è¡¨å­—æ®µ</th><th style="text-align:left">å†—ä½™å­—æ®µ</th></tr></thead><tbody><tr><td style="text-align:left">ç”¨æˆ·è¡¨</td><td style="text-align:left">ç”¨æˆ·ID, å§“å, ç”µè¯, åœ°å€, é‚®ç¼–</td><td style="text-align:left"></td></tr><tr><td style="text-align:left">è®¢å•è¡¨</td><td style="text-align:left">è®¢å•ID, ç”¨æˆ·ID, ä¸‹å•æ—¶é—´, æ”¯ä»˜ç±»å‹, è®¢å•çŠ¶æ€</td><td style="text-align:left"><code>è®¢å•ä»·æ ¼, å§“å, åœ°å€, ç”µè¯</code></td></tr><tr><td style="text-align:left">è®¢å•å•†å“è¡¨</td><td style="text-align:left">è®¢å•ID, å•†å“ID, å•†å“æ•°é‡, å•†å“ä»·æ ¼</td><td style="text-align:left"><code>å•†å“åç§°, è¿‡æœŸæ—¶é—´</code></td></tr><tr><td style="text-align:left">å•†å“è¡¨</td><td style="text-align:left">å•†å“ID, åç§°, æè¿°, è¿‡æœŸæ—¶é—´</td></tr></tbody></table><p>æŸ¥è¯¢è®¢å•ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT a.å§“å, a.ç”µè¯, a.åœ°å€, a.è®¢å•ID, a.è®¢å•ä»·æ ¼</span><br><span class="line">FROM `è®¢å•è¡¨` a</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢è®¢å•è¯¦æƒ…ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT b.ç”¨æˆ·å, b.ç”µè¯, b.åœ°å€, a.è®¢å•ID, SUM(c.å•†å“ä»·æ ¼*c.å•†å“æ•°é‡) as è®¢å•ä»·æ ¼, c.å•†å“åç§°, c.å•†å“ä»·æ ¼</span><br><span class="line">FROM `è®¢å•è¡¨` a</span><br><span class="line">JOIN `ç”¨æˆ·è¡¨` b ON a.ç”¨æˆ·ID = b.ç”¨æˆ·ID</span><br><span class="line">JOIN `è®¢å•å•†å“è¡¨` c ON c.è®¢å•ID = b.è®¢å•ID</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹ è¯»å†™æ¯”ç‡ä¸º3:1, å°‘é‡çš„å†™å†—ä½™å¯ä»¥æ¢å–å¤§é‡çš„è¯»å–æ•ˆç‡;</p><p>ä¸ºä»€ä¹ˆè¦è¿›è¡ŒåèŒƒå¼åŒ–è®¾è®¡</p><ol><li><p>å‡å°‘è¡¨çš„å…³è”æ•°é‡; (å‡å°‘è¡¨å…³è”æ•°é‡ æ„å‘³ç€å‡å°‘äº†æ•°æ®åº“å¯¹ç£ç›˜çš„IOæ“ä½œ)</p></li><li><p>å¢åŠ æ•°æ®çš„è¯»å–æ•ˆç‡;</p></li><li><p>åèŒƒå¼åŒ–ä¸€å®šè¦é€‚åº¦;</p></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>ç‰©ç†è®¾è®¡è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„æ•°æ®åº“/è¡¨/å­—æ®µå‘½åè§„èŒƒ; å­—æ®µç±»å‹é€‰æ‹©åŸåˆ™ç­‰é—®é¢˜;</li><li>å¦‚æœè®¾è®¡å­—ç¬¦é•¿åº¦å°äº50Byte, ä¸varcharç›¸æ¯”, å»ºè®®ä¼˜å…ˆé€‰æ‹©charå­—ç¬¦ç±»å‹;</li><li>decimal ç”¨äºç²¾ç¡®æ•°æ®åœºæ™¯, è€Œfloatç”¨äºéç²¾ç¡®æ•°æ®åœºæ™¯, è€ƒè™‘çš„ç‚¹åœ¨äºéç²¾ç¡®floatåªéœ€è¦å ç”¨4å­—èŠ‚, è€Œç²¾ç¡®çš„decimalå­—æ®µéœ€è¦ç”¨åˆ°8å­—èŠ‚;</li><li>æ—¶é—´ç±»å‹é€‰æ‹©, è¯»å æ¯”æ›´å¤šæ—¶,ä¸”å¯¹æ ¼å¼åŒ–æœ‰è¦æ±‚çš„ ä¼˜å…ˆå»ºè®®ä½¿ç”¨æ—¶é—´ç±»å‹, å¦‚æœä»…åšåˆ¤æ–­æˆ–å¯¹æ—¶é—´æ ¼å¼æ²¡æœ‰å¤ªå¤šè¦æ±‚æ—¶ å»ºè®®ä½¿ç”¨intå­˜å‚¨ï¼Œä½†æ˜¯è¦æ³¨æ„intåªèƒ½å­˜å‚¨çš„æœ€å¤§å¹´é™æ—¶é—´, å¦‚æœå¯¹æ—¶é—´æœ‰ç‰¹æ®Šçš„æ ¼å¼åŒ–è¦æ±‚æ—¶å¯ä»¥è€ƒè™‘å­—ç¬¦ä¸²ç±»å‹, å½“æ ¼å¼åŒ–é•¿åº¦ç›¸å¯¹å›ºå®š,ä¸”å°äº50Byteæ—¶, ä¼˜å…ˆé€‰æ‹©charå­—ç¬¦ç±»å‹;</li><li>æ³¨æ„åŒºåˆ†æ•°æ®åº“ä¸»é”®ä¸ä¸šåŠ¡ä¸»é”®, æ•°æ®åº“ä¸»é”®ä¸»è¦æœåŠ¡ä¸æ•°æ®åº“è‡ªèº«æ£€ç´¢æŸ¥è¯¢ç”¨, è€Œä¸šåŠ¡ä¸»é”®ä¸»è¦ç”¨äºå…³è”ä¸šåŠ¡æ•°æ®è¡¨ä½¿ç”¨;</li><li>å°½é‡é¿å…ä½¿ç”¨å¤–é”®çº¦æŸ, å› ä¸ºå¯¼å…¥å¤–é”®çº¦æŸè€—æ—¶é•¿, æ­¤å¤–ä¼šå¢åŠ ç»´æŠ¤æˆæœ¬, è™½ç„¶ä¸å»ºè®®ä½¿ç”¨çº¦æŸ,ä½†ç›¸åº”çš„åˆ—ä¸Šä¹Ÿåº”å»ºç«‹åˆé€‚çš„ç´¢å¼•, ä¾¿äºå¿«é€Ÿæ£€ç´¢æ•°æ®;</li><li>é¿å…ä½¿ç”¨è§¦å‘å™¨, ä¸€å› ä¸ºä¸€äº›å­˜å‚¨å¼•æ“å¦‚InnoDBå¯¹è§¦å‘å™¨çš„ä½¿ç”¨æ•°é‡æ˜¯æœ‰é™çš„; è€Œæ–°éœ€æ±‚æ›´æ–°æ—¶å¯èƒ½å¿˜è®°åŒæ­¥æ›´æ–°è§¦å‘å™¨è€Œå¯¼è‡´æ•°æ®å¼‚å¸¸é—®é¢˜; åŒæ—¶è¿‡å¤šçš„ä½¿ç”¨è§¦å‘å™¨ä¼šä½¿å¾—ä¸šåŠ¡é€»è¾‘å˜å¾—å¤æ‚;</li><li>ä¸¥ç¦ä½¿ç”¨é¢„ç•™å­—æ®µ;</li><li>ä¸ºäº†æ€§èƒ½åŠè¯»å–æ•ˆç‡, åœ¨æ•°æ®åº“è¡¨ç‰©ç†è®¾è®¡æ—¶å¯ä»¥é€‚å½“è¿›è¡Œä¸€äº›åèŒƒå¼åŒ–è®¾è®¡, å…¶æœ¬è´¨ä¸ºå¢åŠ æ•°æ®å†—ä½™, é€šè¿‡ç©ºé—´æ¢æ—¶é—´, å› ä¸ºå¤§å¤šæ•°åœºæ™¯ä¸‹è¯»å æ¯”ä¼šè¾ƒé«˜äºå†™, æ‰€ä»¥å°‘é‡çš„å†™å†—ä½™èƒ½æ¢æ¥è¾ƒé«˜çš„è¯»å–æ•ˆç‡æ˜¯å€¼å¾—çš„; </li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ•°æ®åº“éœ€æ±‚åˆ†æåŠé€»è¾‘è®¾è®¡ä»…ä»…æ˜¯å°†æ•°æ®åŠæ•°æ®å®ä½“ä¹‹é—´çš„å…³ç³»ç†æ¸…æ¥šäº†, æœ€ç»ˆç›®çš„æ˜¯å»ºç«‹åˆé€‚çš„æ•°æ®åº“è¡¨ç»“æ„; åœ¨æ•°æ®åº“è®¾è®¡ç¯èŠ‚ä¸­çš„ç‰©ç†è®¾è®¡çš„é‡è¦å·¥ä½œå°±æ˜¯å»ºç«‹æ•°æ®åº“è¡¨ç»“æ„;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysqlä¸“é¢˜" scheme="http://researchlab.github.io/categories/mysql%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="mysql" scheme="http://researchlab.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>redisä¸“é¢˜08 redisåˆ†å¸ƒå¼é™æµä¹‹redis-cell</title>
    <link href="http://researchlab.github.io/2018/10/05/redis-08-redis-cell/"/>
    <id>http://researchlab.github.io/2018/10/05/redis-08-redis-cell/</id>
    <published>2018-10-05T17:05:32.000Z</published>
    <updated>2019-08-24T14:25:55.682Z</updated>
    
    <content type="html"><![CDATA[<p><code>redis4.0</code>ä»¥åå¼€å§‹æ”¯æŒæ‰©å±•æ¨¡å—ï¼Œ<code>redis-cell</code>æ˜¯ä¸€ä¸ªç”¨<code>rust</code>è¯­è¨€ç¼–å†™çš„åŸºäº<code>ä»¤ç‰Œæ¡¶ç®—æ³•</code>çš„çš„é™æµæ¨¡å—ï¼Œæä¾›åŸå­æ€§çš„é™æµåŠŸèƒ½ï¼Œå¹¶å…è®¸çªå‘æµé‡ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åº”ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒä¸­ã€‚<br><a id="more"></a></p><h5 id="ä»¤ç‰Œæ¡¶é™æµç®—æ³•åŸç†"><a href="#ä»¤ç‰Œæ¡¶é™æµç®—æ³•åŸç†" class="headerlink" title="ä»¤ç‰Œæ¡¶é™æµç®—æ³•åŸç†"></a>ä»¤ç‰Œæ¡¶é™æµç®—æ³•åŸç†</h5><p>ä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯å®šä¹‰ä¸€ä¸ªæŒ‰ä¸€å®šé€Ÿç‡äº§ç”Ÿ<code>token</code>çš„æ¡¶ï¼Œæ¯æ¬¡å»æ¡¶ä¸­ç”³è¯·<code>token</code>ï¼Œè‹¥æ¡¶ä¸­æ²¡æœ‰è¶³å¤Ÿçš„<code>token</code>åˆ™ç”³è¯·å¤±è´¥ï¼Œå¦åˆ™æˆåŠŸã€‚åœ¨è¯·æ±‚ä¸å¤šçš„æƒ…å†µä¸‹ï¼Œæ¡¶ä¸­çš„<code>token</code>åŸºæœ¬ä¼šé¥±å’Œï¼Œæ­¤æ—¶è‹¥æµé‡æ¿€å¢ï¼Œå¹¶ä¸ä¼šé©¬ä¸Šæ‹’ç»è¯·æ±‚ï¼Œæ‰€ä»¥è¿™ç§ç®—æ³•å…è®¸ä¸€å®šçš„æµé‡æ¿€å¢ã€‚</p><p>1.å®šä¹‰ä¸€ä¸ªä»¤ç‰Œæ¡¶<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä»¤ç‰Œæ¡¶å…¶æ‹¥æœ‰å‡ ä¸ªå…³é”®å±æ€§ä¸ºï¼Œ</span><br><span class="line">æ¡¶å®¹é‡</span><br><span class="line">ä»¤ç‰Œäº§ç”Ÿé€Ÿç‡</span><br><span class="line">å½“å‰æ¡¶ä¸­ä»¤ç‰Œæ•°</span><br><span class="line">æœ€è¿‘ä¸€æ¬¡å–ï¼ˆç”Ÿæˆï¼‰ä»¤ç‰Œæ—¶é—´</span><br></pre></td></tr></table></figure></p><p>2.ä»æ¡¶ä¸­ç”³è¯·ä»¤ç‰Œï¼Œè¿™ä¸€æ­¥ä¸­æœ‰ä¸¤ä¸ªå…³é”®åŠ¨ä½œ</p><blockquote><p>æ ¹æ®ä¸Šä¸€æ¬¡ç”Ÿæˆä»¤ç‰Œæ—¶é—´åˆ°ç°åœ¨çš„æ—¶é—´ï¼ŒåŠç”Ÿæˆé€Ÿç‡è®¡ç®—å‡ºå½“å‰ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°<br>åˆ¤æ–­ä»¤ç‰Œæ¡¶ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œå¹¶è¿”å›ç»“æœ</p></blockquote><p>è¿™å‡ ä¸ªæ­¥éª¤å¯ä»¥é‡‡ç”¨<code>redis</code>æä¾›çš„åŸç”Ÿå‘½ä»¤å»å®ç°ï¼Œä½†æ˜¯é«˜å¹¶å‘çš„æ—¶å€™æ•°æ®ä¼šä¸ä¸€è‡´ï¼Œæ‰€ä»¥<code>redis-cell</code>å°†è¿™ä¸ªè¿‡ç¨‹åŸå­åŒ–ï¼Œå®Œç¾è§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚</p><p><code>redis-cell</code>æ¨¡å—åªæä¾›äº†ä¸€ä¸ªå‘½ä»¤<code>cl.throttle</code></p><p>ç¤ºä¾‹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;cl.throttle test 100 500 20 1</span><br></pre></td></tr></table></figure></p><p>å‚æ•°ä¾æ¬¡è¯´æ˜</p><ul><li><p><code>test</code> è¡¨ç¤º<code>redis key</code></p></li><li><p><code>100</code> å®˜æ–¹å«Â·max_burstÂ·ï¼Œå…¶å€¼ä¸ºä»¤ç‰Œæ¡¶çš„å®¹é‡<code>-1</code>ï¼Œ é¦–æ¬¡æ‰§è¡Œæ—¶ä»¤ç‰Œæ¡¶ä¼šé»˜è®¤å¡«æ»¡</p></li><li><p><code>500</code> ä¸ä¸‹ä¸€ä¸ªå‚æ•°ä¸€èµ·ï¼Œè¡¨ç¤ºåœ¨æŒ‡å®šæ—¶é—´çª—å£å†…å…è®¸è®¿é—®çš„æ¬¡æ•°</p></li><li><p><code>20</code> æŒ‡å®šçš„æ—¶é—´çª—å£ï¼Œå•ä½ï¼šç§’</p></li><li><p><code>1</code>  è¡¨ç¤ºæœ¬æ¬¡è¦ç”³è¯·çš„ä»¤ç‰Œæ•°ï¼Œä¸å†™åˆ™é»˜è®¤ä¸º<code>1</code></p></li></ul><blockquote><p>ä»¥ä¸Šå‘½ä»¤è¡¨ç¤ºä»ä¸€ä¸ªåˆå§‹å€¼ä¸º100çš„ä»¤ç‰Œæ¡¶ä¸­å–1ä¸ªä»¤ç‰Œï¼Œè¯¥ä»¤ç‰Œæ¡¶çš„é€Ÿç‡é™åˆ¶ä¸º500æ¬¡/20ç§’ã€‚</p></blockquote><p>ç»“æœç¤ºä¾‹<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; CL.THROTTLE test 100 500 20 1</span><br><span class="line">1) (integer) 0</span><br><span class="line">2) (integer) 101</span><br><span class="line">3) (integer) 98</span><br><span class="line">4) (integer) -1</span><br><span class="line">5) (integer) 0</span><br></pre></td></tr></table></figure></p><ul><li><code>1)</code> æ˜¯å¦æˆåŠŸï¼Œ0ï¼šæˆåŠŸï¼Œ1ï¼šæ‹’ç»</li><li><code>2)</code> ä»¤ç‰Œæ¡¶çš„å®¹é‡ï¼Œå¤§å°ä¸ºåˆå§‹å€¼+1</li><li><code>3)</code> å½“å‰ä»¤ç‰Œæ¡¶ä¸­å¯ç”¨çš„ä»¤ç‰Œ</li><li><code>4)</code> è‹¥è¯·æ±‚è¢«æ‹’ç»ï¼Œè¿™ä¸ªå€¼è¡¨ç¤ºå¤šä¹…åæ‰ä»¤ç‰Œæ¡¶ä¸­ä¼šé‡æ–°æ·»åŠ ä»¤ç‰Œï¼Œå•ä½ï¼šç§’ï¼Œå¯ä»¥ä½œä¸ºé‡è¯•æ—¶é—´</li><li><code>5)</code> è¡¨ç¤ºå¤šä¹…åä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œä¼šå­˜æ»¡</li></ul><blockquote><p>ç”±äº<code>redis-Cell</code>æ˜¯åŸºäºRustè¯­è¨€å†™çš„æ’ä»¶ï¼Œå› æ­¤åœ¨å®‰è£…æ’ä»¶å‰è¦å…ˆå®‰è£…rust, å…·ä½“å¯å‚çœ‹å®˜æ–¹README <a href="https://github.com/brandur/redis-cell" target="_blank" rel="noopener">github</a></p></blockquote><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul><li>ä»é™åˆ¶ç”¨æˆ·è¡Œä¸ºé¢‘ç‡åœºæ™¯å‡ºå‘ï¼Œå¼•å…¥<code>redis-cell</code>åˆ†å¸ƒå¼é™æµè§£å†³æ–¹æ¡ˆï¼Œé˜è¿°äº†å…¶ç®—æ³•åŸç†åŠæ­¥éª¤ï¼Œå¹¶ç»™å‡ºå®ä¾‹è¯´æ˜;</li><li>é¢‘ç‡é™åˆ¶çš„å®ç°æœ‰å¤šç§æ–¹å¼ï¼Œä¾‹å¦‚<code>Nginx</code>å’Œ<code>Haproxy</code>éƒ½æœ‰é™åˆ¶æ¨¡å—ã€é€šè¿‡Redisæ¥å®ç°ä¹Ÿæ˜¯å¸¸è§çš„æ–¹å¼ä¹‹ä¸€;</li><li>é™¤äº†å¼•å…¥<code>redis-cell</code>åˆ†å¸ƒå¼é™æµæ¨¡å—ï¼Œ ä¹Ÿå¯ä»¥å°†ä¸Šè¿°ä»¤ç‰Œé€šçš„å®ç°æ€è·¯é€šè¿‡<code>Lua</code>è„šæœ¬å®ç°ï¼Œç„¶ååµŒå…¥åˆ°<code>redis</code>ä¸­æ‰§è¡Œï¼Œ å®é™…ä¸Šåœ¨<code>redis</code>è¿˜ä¸æ”¯æŒ<code>redis-cell</code>æ¨¡å—æ—¶ï¼Œ å®é™…ä½¿ç”¨åœºæ™¯ä¸­å¤§å¤šé‡‡ç”¨<code>redis+lua</code>æ–¹å¼æ¥å®ç°é™æµç­–ç•¥;</li><li>å°†<code>redis-cell</code>é™æµåº”ç”¨äºå¾®æœåŠ¡æ¥å£è®¿é—®é¢‘æ¬¡ä¸Šä¹Ÿç°å¸¸æ–¹ä¾¿;</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;redis4.0&lt;/code&gt;ä»¥åå¼€å§‹æ”¯æŒæ‰©å±•æ¨¡å—ï¼Œ&lt;code&gt;redis-cell&lt;/code&gt;æ˜¯ä¸€ä¸ªç”¨&lt;code&gt;rust&lt;/code&gt;è¯­è¨€ç¼–å†™çš„åŸºäº&lt;code&gt;ä»¤ç‰Œæ¡¶ç®—æ³•&lt;/code&gt;çš„çš„é™æµæ¨¡å—ï¼Œæä¾›åŸå­æ€§çš„é™æµåŠŸèƒ½ï¼Œå¹¶å…è®¸çªå‘æµé‡ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åº”ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒä¸­ã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redisä¸“é¢˜" scheme="http://researchlab.github.io/categories/redis%E4%B8%93%E9%A2%98/"/>
    
    
      <category term="redis" scheme="http://researchlab.github.io/tags/redis/"/>
    
  </entry>
  
</feed>
